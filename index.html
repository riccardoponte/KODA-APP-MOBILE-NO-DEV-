<!DOCTYPE html>
<!-- 
  Koda.AI - Enhanced Chatbot
  © 2025 Riccardo Giorgio Ponte & Davide Narracci. Tutti i diritti riservati.
  
  Quest'opera dell'ingegno è protetta dalla Legge sul Diritto d'Autore (L. 633/1941).
  È vietata qualsiasi forma di riproduzione, modifica, distribuzione, 
  o decompilazione, anche parziale, senza l'esplicita autorizzazione scritta dell'autore.
-->
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Koda.AI - Enhanced Chatbot</title>
    <style>
        @font-face {
            font-family: 'Inter';
            src: url('./fonts/Inter-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'Inter';
            src: url('./fonts/Inter-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: 'Inter';
            src: url('./fonts/Inter-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }

        /* --- STILE CSS ISPIRATO A Koda (Completo e Funzionante) --- */
        :root {
            --Koda-bg: #121212;
            --Koda-bg-light: #181818;
            --Koda-card: #282828;
            --Koda-ai-bubble-bg: #3e3e3e;
            /* NUOVO: Colore distinto per le bolle di testo dell'AI in dark mode */
            --Koda-text: #ffffff;
            --Koda-text-secondary: #b3b3b3;
            --Koda-accent: #1db954;
            --font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --bottom-nav-height: 70px;
        }

        /* NUOVO: Stili per la modalità Giorno (Light Mode) */
        body.light-mode {
            --Koda-bg: #ffffff;
            --Koda-bg-light: #f5f5f5;
            --Koda-card: #e9e9e9;
            --Koda-ai-bubble-bg: #e9e9e9;
            /* NUOVO: In light mode, le bolle AI usano un grigio chiaro */
            --Koda-text: #121212;
            --Koda-text-secondary: #535353;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            /* Impedisce che le impostazioni di zoom del testo del sistema influenzino le dimensioni */
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        html,
        body {
            font-family: var(--font-family);
            background-color: var(--Koda-bg);
            color: var(--Koda-text);
            height: 100%;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Stili per la schermata di autenticazione */
        #auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--Koda-bg);
            display: none !important;
            /* Force hide auth overlay - app is guest-only */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 20px;
        }

        #auth-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            fill: var(--Koda-accent);
        }

        .auth-card {
            background: var(--Koda-card);
            padding: 32px 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .auth-close-btn {
            position: absolute;
            top: 8px;
            left: 12px;
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        .auth-card h2 {
            font-size: 24px;
            margin-bottom: 24px;
        }

        .auth-card .input-group {
            margin-bottom: 16px;
            text-align: left;
        }

        .auth-card label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .auth-card input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            background-color: var(--Koda-bg-light);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            color: var(--Koda-text);
        }

        .auth-card input::placeholder {
            color: #888;
        }

        .auth-card .button {
            width: 100%;
            margin-top: 16px;
        }

        .auth-links {
            margin-top: 24px;
        }

        .auth-switch-link,
        .forgot-password-link {
            color: var(--Koda-text-secondary);
            text-decoration: none;
            cursor: pointer;
            font-size: 14px;
            transition: color 0.2s;
        }

        .auth-switch-link:hover,
        .forgot-password-link:hover {
            color: var(--Koda-text);
            text-decoration: underline;
        }

        .forgot-password-link {
            display: block;
            margin-top: 12px;
        }

        .auth-card.hidden {
            display: none;
        }

        #app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #main-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: var(--bottom-nav-height);
        }

        /* NUOVO: Blocca lo scroll della pagina quando la welcome screen del chatbot è visibile */
        #main-content:has(#welcome-screen) {
            overflow-y: hidden;
        }

        .top-bar {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, var(--Koda-bg) 70%, transparent);
            z-index: 10;
            width: 100%;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            flex-grow: 1;
            color: var(--Koda-text);
            margin: 0;
        }

        #global-controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .global-btn {
            background: none;
            border: none;
            color: var(--Koda-text);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .global-btn:hover {
            color: var(--Koda-accent);
        }

        .global-btn {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background-color: #ff4444;
            color: white;
            border-radius: 10px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            padding: 0 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .notification-badge.hidden {
            display: none;
        }

        #lang-toggle-btn {
            font-size: 14px;
            font-weight: bold;
            background: var(--Koda-card);
            border-radius: 50px;
            padding: 6px 10px;
            transition: background-color 0.2s ease;
        }

        #lang-toggle-btn:hover {
            background: var(--Koda-bg-light);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--Koda-accent);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            object-fit: cover;
            color: black;
            position: relative;
            transition: transform 0.2s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* User Profile Dropdown Menu */
        .user-profile-container {
            position: relative;
            display: inline-block;
        }

        .user-profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: var(--Koda-card);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-width: 200px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .user-profile-dropdown.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-profile-header {
            padding: 16px;
            border-bottom: 1px solid rgba(128, 128, 128, 0.2);
            text-align: center;
        }

        .user-profile-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--Koda-accent);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 20px;
            margin: 0 auto 8px;
            color: black;
        }

        .user-profile-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--Koda-text);
            margin-bottom: 4px;
        }

        .user-profile-email {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .user-profile-menu {
            padding: 8px 0;
        }

        .user-profile-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--Koda-text);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .user-profile-item:hover {
            background-color: var(--Koda-bg-light);
        }

        .user-profile-item svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .user-profile-divider {
            height: 1px;
            background-color: rgba(128, 128, 128, 0.2);
            margin: 8px 0;
        }

        .user-profile-logout {
            color: #ff6b6b;
        }

        .user-profile-logout:hover {
            background-color: rgba(255, 107, 107, 0.1);
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            .user-profile-dropdown {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                margin: 0;
                border-radius: 12px 12px 0 0;
                min-width: auto;
                max-height: 80vh;
                overflow-y: auto;
            }

            .user-profile-dropdown.visible {
                transform: translateY(0);
            }

            .user-profile-header {
                padding: 20px 16px;
            }

            .user-profile-avatar {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            .user-profile-name {
                font-size: 18px;
            }

            .user-profile-item {
                padding: 16px;
                font-size: 16px;
            }

            .user-profile-item svg {
                width: 20px;
                height: 20px;
            }
        }

        @media (max-width: 480px) {
            .top-bar {
                padding: 12px 16px;
            }

            .page-title {
                font-size: 18px;
            }

            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .user-profile-dropdown {
                max-height: 70vh;
            }

            .user-profile-header {
                padding: 16px;
            }

            .user-profile-avatar {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }

            .user-profile-item {
                padding: 14px 16px;
                font-size: 15px;
            }

            .global-btn {
                font-size: 20px;
                padding: 6px;
            }

            #lang-toggle-btn {
                font-size: 12px;
                padding: 4px 8px;
            }
        }


        .filters-container {
            padding: 8px 16px;
            position: sticky;
            top: 64px;
            background-color: var(--Koda-bg);
            z-index: 9;
        }

        .filter-pills {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .filter-pills::-webkit-scrollbar {
            display: none;
        }

        .pill-btn {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 50px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s, color 0.2s;
        }

        .pill-btn.active {
            background-color: var(--Koda-text);
            color: var(--Koda-bg);
            font-weight: bold;
        }

        body.light-mode .pill-btn.active {
            color: var(--Koda-bg);
            background-color: #333;
        }



        /* NUOVO: Stili per l'icona mostra/nascondi password */
        .password-input-wrapper {
            position: relative;
        }

        .password-toggle-icon {
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--Koda-text-secondary);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .password-toggle-icon svg {
            width: 20px;
            height: 20px;
        }

        #content-area {
            padding: 16px;
        }

        /* NUOVO: Padding extra per il cinema per evitare che il contenuto venga coperto dalla bottom nav */
        body:has(.cinema-bottom-nav) #content-area {
            padding-bottom: 90px;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .featured-disclaimer {
            font-size: 11px;
            color: var(--Koda-text-secondary);
            font-weight: 400;
            margin-left: 8px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            min-height: 50vh;
        }

        .grid-container #empty-state {
            grid-column: 1 / -1;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            width: 100%;
        }

        /* NUOVO: Layout per la griglia AI in evidenza su schermi grandi */
        @media (min-width: 992px) {
            .featured-ai-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .tool-card-grid {
            background: none;
            cursor: pointer;
        }

        .tool-card-grid .logo-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            background-color: var(--Koda-card);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            /* Needed for absolute positioning of edit icon */
        }

        .tool-card-grid .tool-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tool-card-grid .tool-name {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* NUOVO: Stile per la card "+" per aggiungere app */
        .add-app-card {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            border: 2px dashed var(--Koda-text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-app-card:hover {
            border-color: var(--Koda-accent);
            background-color: var(--Koda-card);
        }

        .add-app-card svg {
            width: 40px;
            height: 40px;
            fill: var(--Koda-text-secondary);
            transition: all 0.2s ease;
        }

        .add-app-card:hover svg {
            fill: var(--Koda-accent);
            transform: scale(1.1);
        }

        .list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tool-card-list {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .tool-card-list .logo-container {
            width: 56px;
            height: 56px;
            flex-shrink: 0;
            background-color: var(--Koda-card);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            /* Needed for absolute positioning of edit icon */
        }

        .tool-card-list .tool-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tool-card-list .info {
            flex-grow: 1;
        }

        .tool-card-list .tool-name {
            font-size: 16px;
            font-weight: 500;
        }

        .tool-card-list .tool-subtext {
            font-size: 13px;
            color: var(--Koda-text-secondary);
        }

        .tool-card-list .favorite-icon {
            margin-left: auto;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .tool-card-list .favorite-icon:hover {
            transform: scale(1.1);
        }

        .tool-card-list .favorite-icon svg {
            width: 22px;
            height: 22px;
            fill: none;
            stroke: var(--Koda-text-secondary);
            stroke-width: 2;
            transition: all 0.2s;
        }

        .tool-card-list .favorite-icon.favorited svg {
            fill: var(--Koda-accent);
            stroke: var(--Koda-accent);
        }

        /* NUOVO: Stili per la selezione multipla */


        .tool-card-list.multi-select-mode {
            position: relative;
            padding-left: 48px;
        }

        .tool-card-list .select-checkbox {
            position: absolute;
            left: 8px;
            width: 24px;
            height: 24px;
            border: 2px solid var(--Koda-text-secondary);
            border-radius: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-card-list.multi-select-mode .select-checkbox {
            display: flex;
        }

        .tool-card-list.selected .select-checkbox {
            background-color: var(--Koda-accent);
            border-color: var(--Koda-accent);
        }

        .tool-card-list.selected .select-checkbox::after {
            content: '✓';
            color: #000;
            font-size: 16px;
            font-weight: bold;
        }

        .tool-card-list.selected {
            border: 2px solid var(--Koda-accent);
            border-radius: 8px;
        }

        /* NUOVO: Stili per il sistema di recensioni e valutazioni */
        .rating-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .stars-display {
            display: flex;
            gap: 2px;
        }

        .star {
            font-size: 14px;
            color: #ffd700;
        }

        .star.empty {
            color: var(--Koda-text-secondary);
        }

        .rating-text {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        /* NUOVO: Stili per i badge di prezzo */
        .pricing-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            vertical-align: middle;
        }

        .pricing-badge.free {
            background-color: rgba(29, 185, 84, 0.15);
            color: #1db954;
        }

        .pricing-badge.freemium {
            background-color: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }

        .pricing-badge.paid {
            background-color: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
        }

        /* NUOVO: Stili per i badge delle categorie video */
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            vertical-align: middle;
            margin-left: 4px;
        }

        .category-badge.tutorial {
            background-color: rgba(138, 43, 226, 0.15);
            color: #8a2be2;
        }

        .category-badge.education {
            background-color: rgba(30, 144, 255, 0.15);
            color: #1e90ff;
        }

        .category-badge.development {
            background-color: rgba(255, 140, 0, 0.15);
            color: #ff8c00;
        }

        .category-badge.news {
            background-color: rgba(220, 20, 60, 0.15);
            color: #dc143c;
        }

        .reviews-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(128, 128, 128, 0.2);
        }

        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .reviews-title {
            font-size: 18px;
            font-weight: 600;
        }

        .add-review-btn {
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-review-btn:hover {
            background-color: #1ed760;
        }

        .add-review-btn:disabled {
            background-color: var(--Koda-text-secondary);
            cursor: not-allowed;
        }

        .review-item {
            background-color: var(--Koda-bg-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(128, 128, 128, 0.1);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .review-user {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .review-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--Koda-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: #000;
        }

        .review-user-info {
            display: flex;
            flex-direction: column;
        }

        .review-username {
            font-size: 14px;
            font-weight: 600;
        }

        .review-date {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .review-rating {
            display: flex;
            gap: 2px;
        }

        .review-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--Koda-text);
        }

        .no-reviews {
            text-align: center;
            color: var(--Koda-text-secondary);
            padding: 24px;
            font-style: italic;
        }

        /* Modal per aggiungere recensione */
        .review-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .review-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .review-modal-content {
            background: var(--Koda-card);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .review-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .review-modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .review-modal-close {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .rating-input-container {
            margin-bottom: 20px;
        }

        .rating-input-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .stars-input {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .star-input {
            font-size: 24px;
            color: var(--Koda-text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-input:hover,
        .star-input.active {
            color: #ffd700;
        }

        .review-text-container {
            margin-bottom: 24px;
        }

        .review-text-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .review-text-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            background-color: var(--Koda-bg-light);
            color: var(--Koda-text);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .review-text-input::placeholder {
            color: var(--Koda-text-secondary);
        }

        .review-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .review-cancel-btn {
            background: none;
            border: 1px solid var(--Koda-text-secondary);
            color: var(--Koda-text);
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .review-cancel-btn:hover {
            background-color: var(--Koda-bg-light);
        }

        .review-submit-btn {
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .review-submit-btn:hover {
            background-color: #1ed760;
        }

        .review-submit-btn:disabled {
            background-color: var(--Koda-text-secondary);
            cursor: not-allowed;
        }

        /* Confirmation Modal Styles */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .confirm-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal-content {
            background: var(--Koda-card);
            padding: 32px 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            position: relative;
            animation: confirmSlideIn 0.3s ease-out;
        }

        @keyframes confirmSlideIn {
            from {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }

            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .confirm-modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .confirm-modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--Koda-text);
        }

        .confirm-modal-message {
            font-size: 14px;
            color: var(--Koda-text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirm-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-cancel-btn {
            background: none;
            border: 1px solid var(--Koda-text-secondary);
            color: var(--Koda-text);
            padding: 12px 32px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            max-width: 150px;
        }

        .confirm-cancel-btn:hover {
            background-color: var(--Koda-bg-light);
            border-color: var(--Koda-text);
        }

        .confirm-ok-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            max-width: 150px;
        }

        .confirm-ok-btn:hover {
            background-color: #ff5252;
            transform: scale(1.02);
        }

        @media (max-width: 480px) {
            .confirm-modal-content {
                width: 95%;
                padding: 24px 20px;
            }

            .confirm-modal-icon {
                font-size: 40px;
            }

            .confirm-modal-title {
                font-size: 18px;
            }

            .confirm-modal-actions {
                flex-direction: column;
            }

            .confirm-cancel-btn,
            .confirm-ok-btn {
                max-width: 100%;
            }
        }

        /* Sent Reviews Modal Styles */
        .sent-reviews-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .sent-reviews-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .sent-reviews-modal-content {
            background: var(--Koda-card);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .sent-reviews-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(128, 128, 128, 0.2);
        }

        .sent-reviews-modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .sent-reviews-modal-close {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .sent-review-item {
            background-color: var(--Koda-bg-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(128, 128, 128, 0.1);
        }

        .sent-review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .sent-review-tool-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sent-review-tool-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            background-color: var(--Koda-card);
        }

        .sent-review-tool-name {
            font-size: 16px;
            font-weight: 600;
        }

        .sent-review-actions {
            display: flex;
            gap: 8px;
        }

        .sent-review-edit-btn,
        .sent-review-delete-btn {
            background: none;
            border: 1px solid var(--Koda-text-secondary);
            color: var(--Koda-text);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sent-review-edit-btn:hover {
            background-color: var(--Koda-accent);
            border-color: var(--Koda-accent);
            color: #000;
        }

        .sent-review-delete-btn:hover {
            background-color: #ff6b6b;
            border-color: #ff6b6b;
            color: #fff;
        }

        .sent-review-rating {
            display: flex;
            gap: 2px;
            margin-bottom: 8px;
        }

        .sent-review-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--Koda-text);
        }

        .sent-review-date {
            font-size: 12px;
            color: var(--Koda-text-secondary);
            margin-top: 8px;
        }

        .no-sent-reviews {
            text-align: center;
            color: var(--Koda-text-secondary);
            padding: 40px 20px;
            font-style: italic;
        }

        /* View All Reviews Link */
        .view-all-reviews-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--Koda-accent);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            margin-top: 12px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .view-all-reviews-link:hover {
            color: #1ed760;
            text-decoration: underline;
        }

        .view-all-reviews-link svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .tool-card-list .edit-icon {
            /* Style for edit icon in list view */
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.6);
            /* Semi-transparent background */
            border-radius: 50%;
            width: 20px;
            /* Smaller icon */
            height: 20px;
            /* Smaller icon */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            /* Above the logo */
            color: white;
            /* White pencil icon */
            font-size: 12px;
            /* Adjust size as needed */
        }

        .tool-card-list .edit-icon svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }


        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .category-card {
            position: relative;
            padding: 12px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            overflow: hidden;
            aspect-ratio: 1.5 / 1;
            cursor: pointer;
        }

        .category-card h3 {
            position: relative;
            z-index: 2;
            color: #fff;
        }

        .category-card .logo-container {
            position: absolute;
            bottom: -10px;
            right: -20px;
            width: 80px;
            height: 80px;
            transform: rotate(25deg);
            z-index: 1;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .category-card .tool-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .search-bar-container {
            padding: 16px 16px 16px;
        }

        #search-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            background-color: var(--Koda-card);
            border: none;
            border-radius: 8px;
            color: var(--Koda-text);
        }

        #search-input::placeholder {
            color: var(--Koda-text-secondary);
        }

        body.light-mode #search-input {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
        }

        body.light-mode #search-input::placeholder {
            color: var(--Koda-text-secondary);
        }

        #empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--Koda-text-secondary);
            padding: 40px 20px;
            min-height: 50vh;
            font-size: 16px;
            line-height: 1.5;
        }

        #bottom-nav {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--bottom-nav-height);
            background: linear-gradient(to top, var(--Koda-bg) 80%, transparent);
            z-index: 1001;
            /* Z-index più alto dell'input per rimanere sempre visibile */
            border-top: 1px solid var(--Koda-card);
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-btn .icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-btn.active {
            color: var(--Koda-accent);
        }

        /* Badge di notifica per messaggi non letti */
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background-color: #ff4444;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid var(--Koda-bg);
        }

        .nav-btn .icon {
            position: relative;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1600;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        body.light-mode .modal-overlay {
            background: rgba(255, 255, 255, 0.6);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Responsive modal overlay */
        @media (max-width: 768px) {
            .modal-overlay {
                align-items: center;
                /* Modificato */
                padding-top: 0;
                /* Modificato */
            }
        }

        @media (max-width: 480px) {
            .modal-overlay {
                align-items: center;
                /* Modificato */
                padding-top: 0;
                /* Modificato */
            }
        }

        .modal-content {
            background: var(--Koda-card);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 28px;
            cursor: pointer;
        }

        .button {
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        /* Stili per il pulsante admin migliorato */
        .admin-add-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 24px;
            text-transform: none;
            letter-spacing: normal;
            transition: all 0.2s ease;
        }

        .admin-add-button:hover {
            background-color: #1ed760;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(29, 185, 84, 0.3);
        }

        .admin-add-button .button-icon {
            font-size: 24px;
            font-weight: 300;
            line-height: 1;
        }

        .admin-add-button .button-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .admin-add-button .button-primary {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.2;
        }

        .admin-add-button .button-secondary {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
            line-height: 1.2;
        }

        #detail-content h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        #detail-content p {
            color: var(--Koda-text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        #detail-content .detail-tags {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        #detail-content .tag {
            background-color: var(--Koda-bg-light);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        #detail-content .pricing-badge {
            margin-top: 0;
        }

        #detail-content .detail-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .back-button {
            font-size: 16px;
            font-weight: bold;
            color: var(--Koda-text);
            cursor: pointer;
            margin-bottom: 20px;
        }

        .recommendation-box {
            margin-top: 24px;
            background-color: var(--Koda-bg-light);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border: 1px solid rgba(128, 128, 128, 0.2);
            transition: background-color 0.2s;
        }

        .recommendation-box:hover {
            background-color: var(--Koda-card);
        }

        .recommendation-logo {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .recommendation-text {
            font-size: 14px;
            color: var(--Koda-text-secondary);
            text-align: left;
        }

        .recommendation-text strong {
            color: var(--Koda-text);
            display: block;
        }

        .auth-prompt-card {
            background-color: var(--Koda-card);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin: 20px auto;
            max-width: 90%;
        }

        .auth-prompt-card h3 {
            font-size: 20px;
            margin-bottom: 12px;
        }

        .auth-prompt-card p {
            color: var(--Koda-text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .auth-prompt-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .auth-prompt-actions .button {
            width: 100%;
        }

        .auth-prompt-actions .pill-btn {
            background-color: transparent;
            border: 1px solid var(--Koda-text-secondary);
            width: 100%;
            padding: 14px;
        }

        /* --- STILI MIGLIORATI E NUOVI PER IL CHATBOT --- */
        #chatbot-container-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        /* NUOVO: Keyframes per l'animazione di zoom lento dello sfondo */
        @keyframes kenburnsZoom {

            0%,
            100% {
                transform: scale(1.0) translate(0, 0);
            }

            50% {
                transform: scale(1.1) translate(-1%, 1%);
            }
        }

        #chatbot-app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: var(--Koda-bg);
            flex-grow: 1;
            position: relative;
            /* Necessario per posizionare lo sfondo animato */
            overflow: hidden;
            /* Nasconde le parti dell'immagine che escono durante lo zoom */
        }

        /* NUOVO: Pseudo-elemento per contenere e animare lo sfondo in modo isolato */
        #chatbot-app-container::before {
            content: '';
            position: absolute;
            top: -5%;
            left: -5%;
            right: -5%;
            bottom: -5%;
            /* Leggermente più grande per evitare bordi bianchi durante l'animazione */
            z-index: 0;
            background-image: linear-gradient(rgba(18, 18, 18, 0.7), rgba(18, 18, 18, 0.7)), url('https://i.postimg.cc/bN4DrwdT/Sfondo-website-koda.png');
            background-size: cover;
            background-position: center center;
            animation: kenburnsZoom 30s ease-in-out infinite;
            /* Applica l'animazione con durata 30s */
        }

        /* NUOVO: Ferma l'animazione dello sfondo quando inizia la chat */
        #chatbot-app-container.chat-started::before {
            animation: none;
        }

        /* NUOVO: Assicura che il contenuto della chat stia sempre sopra lo sfondo */
        #chatbot-app-container>* {
            position: relative;
            z-index: 1;
        }

        .chat-header {
            padding: 16px;
            display: flex;
            align-items: center;
            width: 100%;
            z-index: 10;
            position: sticky;
            top: 0;
            background: linear-gradient(to bottom, var(--Koda-bg) 70%, transparent);
        }

        .chat-header-btn {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        #menu-toggle-btn {
            margin-right: 8px;
        }

        #chatbot-app-container main {
            flex: 1;
            overflow-y: auto;
            padding: 16px 16px 0 16px;
            /* Rimuovo padding bottom per evitare spazio extra */
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* Importante per il corretto funzionamento del flex */
        }

        #welcome-screen {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 12px;
            padding: 20px;
            padding-top: calc(var(--bottom-nav-height) + 100px);
            padding-bottom: calc(var(--bottom-nav-height) + 100px);
            /* MODIFICATO: Spazio simmetrico sopra e sotto per centrare il contenuto */
            overflow-y: auto;
            /* Rende scrollabile se necessario */
            min-height: 0;
            /* Importante per il corretto funzionamento del flex */
        }

        .welcome-logo {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
        }

        /* NUOVO: Mantiene la scritta "Koda" bianca in modalità giorno */
        body.light-mode .welcome-logo span:first-child {
            color: #ffffff !important;
        }

        .welcome-logo svg {
            width: 50px;
            height: 50px;
        }

        /* NUOVO: Contenitore per il pulsante principale */
        .main-action-container {
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 400px;
        }

        .main-action-btn {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
        }

        .main-action-btn:hover {
            background-color: var(--Koda-bg-light);
        }

        .prompt-starter-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 100%;
            max-width: 400px;
        }

        .prompt-starter-btn {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
        }

        .prompt-starter-btn:hover {
            background-color: var(--Koda-bg-light);
        }

        /* NUOVI STILI PER I PULSANTI DI AZIONE */
        .prompt-actions-container {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 400px;
            margin-top: 24px;
            /* Spazio sopra i nuovi pulsanti */
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .action-btn.primary {
            background-color: var(--Koda-accent);
            color: #000;
        }

        .action-btn.primary:hover {
            background-color: #1ed760;
            /* Leggermente più chiaro al passaggio del mouse */
            transform: scale(1.02);
        }

        .action-btn.secondary {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .action-btn.secondary:hover {
            background-color: var(--Koda-bg-light);
        }

        /* NUOVO STILE PER IL PULSANTE VIOLA */
        .action-btn.tertiary {
            background-color: #8D49F2;
            /* Viola vibrante, in linea con lo stile */
            color: var(--Koda-text);
            border: none;
        }

        .action-btn.tertiary:hover {
            background-color: #9d5bf5;
            /* Leggermente più chiaro al passaggio del mouse */
            transform: scale(1.02);
        }

        #chat-messages {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 80px;
            /* MODIFICATO: Aggiunto spazio per l'header sticky (circa 72px di altezza) */
            padding-bottom: calc(var(--bottom-nav-height) + 80px);
            /* Spazio per nav bar + input + margini */
            flex: 1;
            overflow-y: auto;
            /* Rende scrollabile solo quest'area */
            min-height: 0;
            /* Importante per il corretto funzionamento del flex */
        }

        .chat-bubble {
            padding: 12px 16px;
            border-radius: 20px;
            max-width: 85%;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-bubble.ai {
            background-color: var(--Koda-ai-bubble-bg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.user {
            background-color: var(--Koda-accent);
            color: #000;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .chat-bubble.system {
            background-color: transparent;
            color: var(--Koda-text-secondary);
            align-self: center;
            text-align: center;
            font-style: normal;
            font-size: 14px;
            width: 100%;
            max-width: 100%;
            padding: 0 16px 8px;
        }

        .chat-bubble.error {
            background-color: #8c1a1a;
            color: var(--Koda-text);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.loading {
            align-self: flex-start;
            background-color: var(--Koda-card);
            padding: 14px 16px;
        }

        .chat-bubble.loading span {
            display: inline-block;
            background-color: var(--Koda-text-secondary);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin: 0 1px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .chat-bubble.loading span:nth-of-type(1) {
            animation-delay: -0.32s;
        }

        .chat-bubble.loading span:nth-of-type(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        .chat-bubble.ai ul {
            margin: 8px 0;
            padding-left: 20px;
            list-style-type: disc;
        }

        .chat-bubble.ai li {
            margin: 4px 0;
            line-height: 1.4;
        }

        .chat-bubble.ai a {
            color: var(--Koda-accent);
            text-decoration: none;
            border-radius: 4px;
            padding: 2px 4px;
            transition: background-color 0.2s;
        }

        .chat-bubble.ai a:hover {
            background-color: rgba(29, 185, 84, 0.1);
            text-decoration: underline;
        }

        .chat-bubble.ai strong {
            font-weight: 600;
            color: var(--Koda-text);
        }

        .chat-bubble.ai p {
            margin: 8px 0;
        }

        .chat-bubble.ai p:first-child {
            margin-top: 0;
        }

        .chat-bubble.ai p:last-child {
            margin-bottom: 0;
        }

        .chat-tool-card-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-self: flex-start;
            width: 100%;
            max-width: 400px;
        }

        .chat-tool-card {
            display: flex;
            gap: 12px;
            background-color: var(--Koda-card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(128, 128, 128, 0.1);
        }

        .chat-tool-card .logo-container {
            width: 48px;
            height: 48px;
            flex-shrink: 0;
            border-radius: 8px;
            overflow: hidden;
        }

        .chat-tool-card .tool-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-tool-card .info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chat-tool-card .tool-name {
            font-weight: 600;
            font-size: 15px;
        }

        .chat-tool-card .tool-desc {
            font-size: 13px;
            color: var(--Koda-text-secondary);
            margin: 2px 0 8px;
            line-height: 1.4;
        }

        .chat-tool-card .details-btn {
            background: var(--Koda-bg-light);
            color: var(--Koda-text);
            border: none;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 20px;
            cursor: pointer;
            align-self: flex-start;
        }

        #chat-input-container {
            background-color: var(--Koda-card);
            border-radius: 28px;
            padding: 12px;
            margin: 0;
            /* Rimuovo il margin per evitare spazi indesiderati con position fixed */
            display: flex;
            align-items: flex-end;
            gap: 12px;
            border: 1px solid var(--Koda-bg-light);
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 16px);
            /* Posizionato sopra la barra di navigazione con margine */
            left: 16px;
            right: 16px;
            z-index: 1000;
            /* Z-index alto per stare sopra tutto ma sotto la nav */
            flex-shrink: 0;
            /* Impedisce che si ridimensioni */
        }

        body.light-mode #chat-input-container {
            border: 1px solid #ddd;
        }

        /* NUOVO: Regole responsive per l'input fisso */
        @media (max-width: 768px) {
            #chat-input-container {
                bottom: calc(var(--bottom-nav-height) + 8px);
                left: 8px;
                right: 8px;
            }

            #chat-messages {
                padding-top: 70px;
                /* RIDOTTO: Spazio per l'header su tablet */
                padding-bottom: calc(var(--bottom-nav-height) + 70px);
                /* Spazio per nav + input con margini ridotti per mobile */
            }

            #welcome-screen {
                padding-bottom: calc(var(--bottom-nav-height) + 90px);
                /* Spazio per nav + input con margini ridotti per mobile */
            }
        }

        @media (max-width: 480px) {
            #chat-input-container {
                bottom: calc(var(--bottom-nav-height) + 4px);
                left: 4px;
                right: 4px;
            }

            #chat-messages {
                padding-top: 65px;
                /* RIDOTTO: Spazio per l'header su mobile */
                padding-bottom: calc(var(--bottom-nav-height) + 65px);
                /* Spazio per nav + input con margini minimi per schermi piccoli */
            }

            #welcome-screen {
                padding-bottom: calc(var(--bottom-nav-height) + 85px);
                /* Spazio per nav + input con margini minimi per schermi piccoli */
            }
        }

        .input-icon-group {
            display: flex;
            gap: 8px;
            padding-bottom: 6px;
        }

        .input-icon-btn {
            background-color: var(--Koda-bg-light);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: var(--Koda-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        #chat-input {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            color: var(--Koda-text);
            font-size: 16px;
            resize: none;
            padding: 6px 0;
            line-height: 1.5;
        }

        #chat-input:focus {
            outline: none;
        }

        #chat-input::placeholder {
            color: var(--Koda-text-secondary);
        }

        #chat-send-btn {
            background-color: var(--Koda-bg-light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--Koda-text);
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            align-self: flex-end;
        }

        #chat-send-btn:disabled {
            background-color: var(--Koda-bg);
            cursor: not-allowed;
            color: var(--Koda-text-secondary);
        }

        #chat-send-btn:not(:disabled):active {
            transform: scale(0.9);
        }

        /* NUOVI STILI PER IL MENU LATERALE */
        #side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        body.light-mode #side-menu-overlay {
            background: rgba(0, 0, 0, 0.4);
        }

        #side-menu-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 320px;
            height: 100%;
            background-color: var(--Koda-bg-light);
            z-index: 1501;
            transform: translateX(-100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }

        #side-menu.visible {
            transform: translateX(0);
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--Koda-card);
        }

        .menu-header h3 {
            font-size: 18px;
        }

        .new-chat-btn {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .conversation-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .conversation-list::-webkit-scrollbar {
            display: none;
        }

        .conversation-item {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            text-align: left;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-item.active,
        .conversation-item:hover {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
        }

        .menu-footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--Koda-card);
        }

        #delete-all-btn {
            width: 100%;
            background: none;
            border: 1px solid var(--Koda-text-secondary);
            color: var(--Koda-text-secondary);
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        #delete-all-btn:hover {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            border-color: var(--Koda-card);
        }

        /* --- STILI PER I GROUP CHATS --- */
        .group-chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--Koda-card);
        }

        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--Koda-accent), #1ed760);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            font-size: 16px;
        }

        .group-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .group-members-count {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .group-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .group-action-btn {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .group-action-btn:hover {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
        }

        .create-group-btn {
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 16px;
            transition: all 0.2s;
        }

        .create-group-btn:hover {
            background-color: #1ed760;
            transform: scale(1.02);
        }

        .group-chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid rgba(128, 128, 128, 0.1);
        }

        .group-chat-item:hover {
            background-color: var(--Koda-card);
        }

        .group-chat-item.active {
            background-color: var(--Koda-bg-light);
        }

        .group-member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--Koda-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            font-size: 14px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-size: 14px;
            font-weight: 500;
        }

        .member-role {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .permission-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .permission-badge.admin {
            background-color: #ff6b6b;
            color: white;
        }

        .permission-badge.moderator {
            background-color: #ffa726;
            color: white;
        }

        .permission-badge.member {
            background-color: var(--Koda-card);
            color: var(--Koda-text-secondary);
        }

        .group-settings-modal .modal-content {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .group-settings-section {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--Koda-card);
        }

        .group-settings-section:last-child {
            border-bottom: none;
        }

        .group-settings-section h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .member-actions {
            display: flex;
            gap: 8px;
        }

        .member-action-btn {
            background: none;
            border: 1px solid var(--Koda-text-secondary);
            color: var(--Koda-text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .member-action-btn:hover {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
        }

        .member-action-btn.danger:hover {
            background-color: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
        }

        /* --- STILI PER LE CLASSIFICHE (AGGIUNTI) --- */
        .ranking-section-container {
            display: grid;
            gap: 20px;
            /* Reduced gap */
        }

        .ranking-card {
            background-color: var(--Koda-card);
            border-radius: 12px;
            padding: 12px;
            /* Reduced padding */
            transition: opacity 0.3s, transform 0.3s;
            transform-origin: top;
        }

        .ranking-card.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            display: none;
            /* Use display: none to fully hide */
        }

        .ranking-card h3 {
            font-size: 16px;
            /* Reduced font size */
            font-weight: 700;
            margin-bottom: 12px;
            /* Reduced margin */
        }

        .ranking-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* Reduced gap */
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 10px;
            /* Reduced gap */
            cursor: pointer;
            padding: 2px;
            /* Reduced padding */
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .ranking-item:hover {
            background-color: var(--Koda-bg-light);
        }

        .ranking-item-rank {
            font-size: 14px;
            /* Reduced font size */
            font-weight: 700;
            color: var(--Koda-text-secondary);
            width: 20px;
            text-align: center;
        }

        .ranking-item-logo {
            /* Added style for logo in ranking list */
            width: 32px;
            /* Smaller logo */
            height: 32px;
            /* Smaller logo */
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .ranking-item-info {
            flex-grow: 1;
        }

        .ranking-item-info .tool-name {
            font-size: 15px;
            /* Reduced font size */
            font-weight: 500;
        }

        .ranking-item-info .tool-subtext {
            font-size: 12px;
            /* Reduced font size */
            color: var(--Koda-text-secondary);
        }

        /* --- STILI PER MODALE IMPOSTAZIONI (AGGIUNTI) --- */
        #settings-modal .input-group,
        #add-app-modal .input-group,
        #replace-featured-modal .input-group,
        #change-password-modal .input-group,
        /* AGGIUNTO */
        #change-nickname-modal .input-group,
        #add-global-tool-modal .input-group,
        #edit-global-tool-modal .input-group {
            /* AGGIUNTO */
            margin-bottom: 20px;
            text-align: left;
        }

        #settings-modal label,
        #add-app-modal label,
        #replace-featured-modal label,
        #change-password-modal label,
        /* AGGIUNTO */
        #change-nickname-modal label,
        #add-global-tool-modal label,
        #edit-global-tool-modal label {
            /* AGGIUNTO */
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 15px;
            color: var(--Koda-text);
        }

        #settings-modal input,
        #add-app-modal input:not([type="file"]),
        #add-app-modal textarea,
        #replace-featured-modal input,
        #change-password-modal input,
        /* AGGIUNTO */
        #change-nickname-modal input,
        #add-global-tool-modal input,
        #add-global-tool-modal textarea,
        #add-global-tool-modal select,
        #edit-global-tool-modal input,
        #edit-global-tool-modal textarea,
        #edit-global-tool-modal select,
        #create-collection-modal input,
        #rename-collection-modal input {
            width: 100%;
            padding: 16px 18px;
            font-size: 16px;
            background-color: var(--Koda-bg-light);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 12px;
            color: var(--Koda-text);
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-family: var(--font-family);
        }

        #add-app-modal textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Stili responsive per il modal Aggiungi App Custom */
        #add-app-modal .modal-content {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
            margin: 20px auto;
        }

        @media (max-width: 768px) {
            #add-app-modal .modal-content {
                width: 95%;
                max-height: 85vh;
                padding: 20px;
                margin: 10px auto;
            }
        }

        @media (max-width: 480px) {
            #add-app-modal .modal-content {
                width: 100%;
                max-height: 100vh;
                padding: 16px;
                margin: 0;
                border-radius: 0;
            }

            #add-app-modal .input-group {
                margin-bottom: 12px;
            }

            #add-app-modal label {
                font-size: 13px;
            }

            #add-app-modal input:not([type="file"]),
            #add-app-modal textarea {
                padding: 10px 12px;
                font-size: 14px;
            }

            #add-app-modal .button {
                padding: 12px 20px;
                font-size: 14px;
            }
        }

        /* Stili specifici per il modal Aggiungi AI */
        .add-ai-modal {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
            width: calc(100% - 40px);
        }

        .add-ai-form {
            padding-top: 24px;
        }

        /* Responsive design per il modal */
        @media (max-width: 768px) {
            .add-ai-modal {
                max-width: none;
                width: calc(100% - 20px);
                margin: 10px;
                max-height: 95vh;
            }

            .add-ai-form {
                padding-top: 16px;
            }

            #add-global-tool-modal .input-group,
            #edit-global-tool-modal .input-group {
                margin-bottom: 16px;
            }

            #add-global-tool-modal input,
            #add-global-tool-modal textarea,
            #add-global-tool-modal select,
            #edit-global-tool-modal input,
            #edit-global-tool-modal textarea,
            #edit-global-tool-modal select {
                padding: 14px 16px;
                font-size: 16px;
            }

            #add-global-tool-modal h2,
            #edit-global-tool-modal h2 {
                font-size: 20px;
                margin-bottom: 16px;
            }
        }

        @media (max-width: 480px) {
            .add-ai-modal {
                width: calc(100% - 10px);
                margin: 5px;
                border-radius: 12px;
                max-height: 98vh;
            }

            .add-ai-form {
                padding-top: 12px;
            }

            #add-global-tool-modal .input-group,
            #edit-global-tool-modal .input-group {
                margin-bottom: 14px;
            }

            #add-global-tool-modal input,
            #add-global-tool-modal textarea,
            #add-global-tool-modal select,
            #edit-global-tool-modal input,
            #edit-global-tool-modal textarea,
            #edit-global-tool-modal select {
                padding: 12px 14px;
                font-size: 16px;
                border-radius: 10px;
            }

            #add-global-tool-modal label,
            #edit-global-tool-modal label {
                font-size: 14px;
                margin-bottom: 8px;
            }

            #add-global-tool-modal h2,
            #edit-global-tool-modal h2 {
                font-size: 18px;
                margin-bottom: 12px;
            }

            #add-global-tool-modal .button,
            #edit-global-tool-modal .button {
                padding: 14px 20px;
                font-size: 16px;
                margin-top: 8px;
            }

            .modal-close-btn {
                font-size: 20px;
                top: 10px;
                right: 10px;
            }
        }

        #add-global-tool-modal input:focus,
        #add-global-tool-modal textarea:focus,
        #add-global-tool-modal select:focus,
        #edit-global-tool-modal input:focus,
        #edit-global-tool-modal textarea:focus,
        #edit-global-tool-modal select:focus {
            outline: none;
            border-color: var(--Koda-accent);
            box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
        }

        #add-global-tool-modal textarea,
        #edit-global-tool-modal textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }

        #add-global-tool-modal select,
        #edit-global-tool-modal select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .checkbox-group {
            margin: 24px 0 32px 0;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background-color: var(--Koda-bg-light);
            border-radius: 12px;
            border: 1px solid rgba(128, 128, 128, 0.2);
            transition: background-color 0.2s ease;
        }

        .checkbox-wrapper:hover {
            background-color: var(--Koda-card);
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
            accent-color: var(--Koda-accent);
        }

        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
        }

        /* Style for file input */
        #add-app-modal input[type="file"] {
            width: 100%;
            padding: 14px 0;
            /* Adjust padding for file input */
            font-size: 16px;
            background-color: transparent;
            /* File input background is handled by the container */
            border: none;
            /* File input border is handled by the container */
            border-radius: 0;
            color: var(--Koda-text);
            box-sizing: border-box;
        }

        #add-app-modal input[type="file"]::file-selector-button {
            background-color: var(--Koda-bg-light);
            color: var(--Koda-text);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            margin-right: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #add-app-modal input[type="file"]::file-selector-button:hover {
            background-color: var(--Koda-card);
        }

        /* Style for logo preview */
        #add-app-logo-preview {
            display: block;
            width: 80px;
            height: 80px;
            margin: 10px auto 0;
            /* Center preview below input */
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid rgba(128, 128, 128, 0.2);
            background-color: var(--Koda-bg-light);
            /* Placeholder background */
        }


        #settings-modal .button,
        #add-app-modal .button,
        #replace-featured-modal .button {
            /* Added replace modal */
            width: 100%;
            margin-top: 8px;
        }

        hr.modal-divider {
            border: none;
            border-top: 1px solid var(--Koda-card);
            margin: 24px 0;
        }

        .toast-message {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--Koda-accent);
            color: black;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            pointer-events: none;
            /* Allow clicks to pass through */
        }

        .toast-message.show {
            opacity: 1;
            transform: translate(-50%, -10px);
        }

        /* Styles for Add App button in Library */
        #add-app-button {
            width: calc(100% - 32px);
            /* Full width minus padding */
            margin: 16px auto 24px;
            /* Center and add spacing */
            display: block;
            /* Ensure it takes full width */
        }

        /* Styles for User Featured section */
        .user-featured-section {
            margin-bottom: 30px;
        }

        .user-featured-section .section-title {
            margin-bottom: 16px;
        }

        .user-featured-section .grid-container {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            /* Adjust grid for smaller cards */
            gap: 12px;
        }

        .user-featured-section .tool-card-grid .logo-container {
            border-radius: 4px;
            /* Slightly smaller radius */
            position: relative;
            /* Needed for absolute positioning of edit icon */
        }

        .user-featured-section .tool-card-grid .tool-name {
            font-size: 13px;
            /* Smaller font */
            text-align: center;
        }

        .user-featured-section .tool-card-grid {
            text-align: center;
        }



        /* Style for the edit icon on featured user apps */
        .edit-icon {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.6);
            /* Semi-transparent background */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            /* Above the logo */
            color: white;
            /* White pencil icon */
            font-size: 14px;
            /* Adjust size as needed */
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        /* Mostra icona al hover su desktop */
        .tool-card-grid:hover .edit-icon,
        .logo-container:hover .edit-icon {
            opacity: 1;
        }

        /* Su mobile e touch devices, mostra sempre l'icona */
        @media (max-width: 768px) {
            .edit-icon {
                opacity: 1;
            }
        }

        @media (hover: none) {
            .edit-icon {
                opacity: 1;
            }
        }

        .edit-icon svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        /* Stili per il pulsante X di rimozione dai preferiti (grid view) */
        .remove-favorite-icon {
            position: absolute;
            top: 4px;
            left: 4px;
            background-color: rgba(255, 0, 0, 0.8);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            color: white;
            font-size: 20px;
            font-weight: bold;
            opacity: 0;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .remove-favorite-icon:hover {
            background-color: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        .tool-card-grid:hover .remove-favorite-icon,
        .logo-container:hover .remove-favorite-icon {
            opacity: 1;
        }

        /* Stili per il pulsante X di rimozione dai preferiti (list view) */
        .remove-favorite-icon-list {
            font-size: 28px;
            color: #ff4444;
            cursor: pointer;
            padding: 10px;
            margin-left: auto;
            transition: all 0.2s ease;
            font-weight: bold;
            line-height: 1;
        }

        .remove-favorite-icon-list:hover {
            color: #ff0000;
            transform: scale(1.2);
        }

        /* Su mobile e touch devices, mostra sempre l'icona di rimozione */
        @media (max-width: 768px) {
            .remove-favorite-icon {
                opacity: 1;
            }
        }

        @media (hover: none) {
            .remove-favorite-icon {
                opacity: 1;
            }
        }

        /* Stili per la modalità selezione multipla */
        .selection-bar {
            position: sticky;
            top: 64px;
            background: var(--Koda-accent);
            color: #000;
            padding: 12px 16px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .selection-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .selection-bar-content span {
            font-weight: 600;
            font-size: 16px;
        }

        .selection-bar-actions {
            display: flex;
            gap: 12px;
        }

        .selection-bar-btn {
            background: rgba(0, 0, 0, 0.2);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .selection-bar-btn:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
        }

        .selection-bar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .selection-bar-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Checkbox per selezione multipla (grid view) */
        .selection-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            border: 2px solid white;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
        }

        .selection-checkbox svg {
            width: 18px;
            height: 18px;
            fill: white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .selection-checkbox.selected {
            background: var(--Koda-accent);
            border-color: var(--Koda-accent);
        }

        .selection-checkbox.selected svg {
            opacity: 1;
        }

        .selection-checkbox:hover {
            transform: scale(1.1);
        }

        /* Checkbox per selezione multipla (list view) */
        .selection-checkbox-list {
            width: 32px;
            height: 32px;
            border: 2px solid var(--Koda-text-secondary);
            border-radius: 6px;
            background: var(--Koda-bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: auto;
            transition: all 0.2s;
        }

        .selection-checkbox-list svg {
            width: 20px;
            height: 20px;
            fill: var(--Koda-text);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .selection-checkbox-list.selected {
            background: var(--Koda-accent);
            border-color: var(--Koda-accent);
        }

        .selection-checkbox-list.selected svg {
            opacity: 1;
            fill: #000;
        }

        .selection-checkbox-list:hover {
            transform: scale(1.1);
            border-color: var(--Koda-accent);
        }

        /* Disabilita il click sulla card in modalità selezione */
        .tool-card-grid.selectable {
            cursor: default;
        }

        @media (max-width: 480px) {
            .selection-bar-content {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .selection-bar-actions {
                justify-content: center;
            }
        }

        /* Styles for the Replace Featured Modal */
        #replace-featured-modal .modal-content {
            max-height: 80vh;
            /* Limit height */
            overflow-y: auto;
            /* Add scroll if needed */
        }

        #replace-featured-modal .tool-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-bottom: 1px solid var(--Koda-bg-light);
            cursor: pointer;
            text-align: left;
        }

        #replace-featured-modal .tool-list-item:last-child {
            border-bottom: none;
        }

        #replace-featured-modal .tool-list-item:hover {
            background-color: var(--Koda-bg-light);
        }

        #replace-featured-modal .tool-list-item img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            flex-shrink: 0;
        }

        #replace-featured-modal .tool-list-item .info {
            flex-grow: 1;
        }

        #replace-featured-modal .tool-list-item .tool-name {
            font-size: 15px;
            font-weight: 500;
        }

        #replace-featured-modal .tool-list-item .tool-subtext {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        /* Styles for AI Suggestions and User Search */
        .ai-suggestion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--Koda-card);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(128, 128, 128, 0.1);
        }

        .suggestion-content {
            flex-grow: 1;
        }

        .suggestion-text {
            font-size: 14px;
            color: var(--Koda-text);
            margin-bottom: 4px;
        }

        .suggestion-date {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .remove-suggestion-btn {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .remove-suggestion-btn:hover {
            color: #ff4444;
        }

        .user-search-result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--Koda-card);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(128, 128, 128, 0.1);
        }

        .user-info {
            flex-grow: 1;
        }

        .user-nickname {
            font-size: 16px;
            font-weight: 600;
            color: var(--Koda-text);
            margin-bottom: 4px;
        }

        .user-suggestions-count {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .view-suggestions-btn {
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .view-suggestions-btn:hover {
            background-color: #1ed760;
        }

        .suggestions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .suggestion-item {
            background-color: var(--Koda-bg-light);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(128, 128, 128, 0.1);
        }

        .user-search-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--Koda-card-bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--Koda-border);
        }

        .user-info {
            flex: 1;
        }

        .user-nickname {
            font-weight: 600;
            color: var(--Koda-text-primary);
            margin-bottom: 4px;
        }

        .user-suggestions-count {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .view-suggestions-btn {
            background: var(--Koda-green);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .view-suggestions-btn:hover {
            background: var(--Koda-green-hover);
        }

        /* New Search Users Page Styles */
        .search-users-container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .search-users-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .search-users-icon {
            color: var(--Koda-green);
            margin-bottom: 16px;
        }

        .search-users-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--Koda-text-primary);
            margin: 0 0 8px 0;
        }

        .search-users-subtitle {
            font-size: 16px;
            color: var(--Koda-text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        .search-users-input-container {
            margin-bottom: 30px;
        }

        .search-input-wrapper {
            position: relative;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--Koda-text-secondary);
            pointer-events: none;
        }

        .search-users-input {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border: 2px solid #1db954;
            border-radius: 12px;
            background: var(--Koda-card-bg);
            color: var(--Koda-text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .search-users-input:focus {
            outline: none;
            border-color: var(--Koda-green);
            box-shadow: 0 0 0 3px rgba(30, 215, 96, 0.1);
        }

        .search-users-input::placeholder {
            color: var(--Koda-text-secondary);
        }

        .search-results-container {
            min-height: 200px;
        }

        .user-search-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--Koda-card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--Koda-border);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .user-search-result:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border-color: var(--Koda-green);
        }

        .user-info {
            flex: 1;
            margin-right: 16px;
        }

        .user-nickname {
            font-weight: 600;
            color: var(--Koda-text-primary);
            margin-bottom: 4px;
            font-size: 16px;
        }

        .user-email {
            font-size: 14px;
            color: var(--Koda-text-secondary);
            margin-bottom: 4px;
        }

        .user-suggestions-count {
            font-size: 12px;
            color: var(--Koda-text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-suggestions-count::before {
            content: "💡";
            font-size: 14px;
        }

        .view-suggestions-btn {
            background: var(--Koda-green);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .view-suggestions-btn:hover {
            background: var(--Koda-green-hover);
            transform: scale(1.05);
        }

        #empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--Koda-text-secondary);
            font-size: 16px;
            padding: 40px 20px;
            min-height: 50vh;
            line-height: 1.5;
        }

        /* AI Suggestions Grid and Cards */
        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .suggestion-item.new-format {
            background: var(--Koda-card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--Koda-border);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item.new-format:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border-color: var(--Koda-green);
        }

        .suggestion-header {
            margin-bottom: 12px;
        }

        .suggestion-app-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--Koda-text-primary);
            margin: 0 0 8px 0;
        }

        .suggestion-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .suggestion-category,
        .suggestion-country {
            background: var(--Koda-green);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .suggestion-description {
            color: var(--Koda-text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .suggestion-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-website-btn {
            background: var(--Koda-green);
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .suggestion-website-btn:hover {
            background: var(--Koda-green-hover);
            transform: scale(1.05);
        }

        .suggestion-date {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .remove-suggestion-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-suggestion-btn:hover {
            background: #ff5252;
            transform: scale(1.05);
        }

        /* Form Styles for AI Suggestion Modal */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--Koda-text);
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            background: var(--Koda-bg-light);
            color: var(--Koda-text);
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            font-family: var(--font-family);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--Koda-accent);
            box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
            background: var(--Koda-card);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
            line-height: 1.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .button.secondary {
            background: var(--Koda-card);
            color: var(--Koda-text);
            border: 1px solid rgba(128, 128, 128, 0.2);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .button.primary {
            background: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .button.secondary:hover {
            background: var(--Koda-bg-light);
            transform: translateY(-1px);
        }

        .button.primary:hover {
            background: #1ed760;
            transform: translateY(-1px);
        }

        .button.secondary:active,
        .button.primary:active {
            transform: translateY(0);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .button:disabled:hover {
            transform: none !important;
        }

        /* AI Suggestion Modal Specific Styles */
        #add-ai-suggestion-modal .modal-content {
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
        }

        #add-ai-suggestion-modal h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--Koda-text);
            text-align: center;
        }

        #add-ai-suggestion-modal form {
            margin-top: 24px;
        }

        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            #add-ai-suggestion-modal .modal-content {
                width: 95%;
                padding: 24px;
                margin: 20px;
                max-height: 85vh;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .form-actions {
                flex-direction: column;
                gap: 12px;
            }

            .button.secondary,
            .button.primary {
                width: 100%;
                padding: 16px;
                font-size: 16px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 16px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            #add-ai-suggestion-modal .modal-content {
                width: 100%;
                margin: 10px;
                padding: 20px;
                border-radius: 12px;
            }

            #add-ai-suggestion-modal h2 {
                font-size: 20px;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                font-size: 13px;
                margin-bottom: 6px;
            }
        }

        /* --- STILI PER LA CHAT UTENTE-UTENTE --- */
        .user-chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* Modificato a 100vh per occupare l'intera altezza dello schermo */
            background-color: var(--Koda-bg);
        }

        .user-chat-header {
            padding: 16px;
            background: var(--Koda-bg-light);
            border-bottom: 1px solid var(--Koda-card);
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            /* Aggiunto */
            top: 0;
            /* Aggiunto */
            z-index: 10;
            /* Aggiunto */
        }

        .user-chat-back-btn {
            background: none;
            border: none;
            color: var(--Koda-text);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .user-chat-back-btn:hover {
            background-color: var(--Koda-card);
        }

        .user-chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--Koda-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: black;
            font-size: 18px;
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background-color: #4CAF50;
            border-radius: 50%;
            border: 2px solid var(--Koda-bg-light);
        }

        .user-chat-info h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .user-chat-info p {
            font-size: 14px;
            color: var(--Koda-text-secondary);
            margin: 0;
        }

        /* Privacy Link Styles */
        .privacy-link {
            font-size: 16px;
            color: var(--Koda-accent);
            text-decoration: underline;
            font-weight: 700;
            cursor: pointer;
            transition: color 0.2s;
        }

        .privacy-link:hover {
            color: #1ed760;
        }

        /* Privacy Modal Styles */
        .privacy-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 20px;
        }

        .privacy-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .privacy-modal-content {
            background: var(--Koda-card);
            padding: 32px 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }

        .privacy-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(128, 128, 128, 0.2);
        }

        .privacy-modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .privacy-modal-close {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .privacy-modal-close:hover {
            color: var(--Koda-text);
        }

        .privacy-modal-body {
            font-size: 14px;
            line-height: 1.8;
            color: var(--Koda-text);
        }

        .privacy-modal-body h3 {
            font-size: 18px;
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 12px;
        }

        .privacy-modal-body p {
            margin-bottom: 16px;
        }

        .privacy-modal-body strong {
            font-weight: 600;
        }

        /* Privacy Reminder Modal Styles */
        .privacy-reminder-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3500;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 20px;
        }

        .privacy-reminder-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .privacy-reminder-content {
            background: var(--Koda-card);
            padding: 32px 24px;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .privacy-reminder-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .privacy-reminder-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .privacy-reminder-message {
            font-size: 14px;
            color: var(--Koda-text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .privacy-reminder-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .privacy-reminder-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .privacy-reminder-checkbox label {
            font-size: 14px;
            cursor: pointer;
        }

        .privacy-reminder-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .privacy-read-btn {
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 12px 32px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .privacy-read-btn:hover {
            background-color: #1ed760;
            transform: scale(1.02);
        }

        .privacy-continue-btn {
            background: none;
            border: 1px solid var(--Koda-text-secondary);
            color: var(--Koda-text);
            padding: 12px 32px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .privacy-continue-btn:hover {
            background-color: var(--Koda-bg-light);
            border-color: var(--Koda-text);
        }

        @media (max-width: 480px) {
            .privacy-modal-content {
                padding: 24px 20px;
                max-height: 90vh;
            }

            .privacy-modal-title {
                font-size: 20px;
            }

            .privacy-modal-body {
                font-size: 13px;
            }

            .privacy-reminder-content {
                padding: 24px 20px;
            }

            .privacy-reminder-title {
                font-size: 20px;
            }

            .privacy-reminder-actions {
                flex-direction: column;
            }

            .privacy-read-btn,
            .privacy-continue-btn {
                width: 100%;
            }
        }

        .user-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .user-chat-message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }

        .user-chat-message.sent {
            background-color: var(--Koda-accent);
            color: black;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .user-chat-message.received {
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* Contenitore per orario e ricevuta di lettura */
        .user-chat-message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            /* Allinea a destra nel fumetto */
            gap: 6px;
            margin-top: 4px;
            opacity: 0.8;
        }

        .user-chat-message-time {
            font-size: 12px;
            /* Rimuoviamo il margine perché gestito dal contenitore flex */
        }

        /* Stile per l'icona dell'occhio */
        .message-read-receipt {
            display: flex;
            align-items: center;
        }

        .message-read-receipt svg {
            fill: currentColor;
            /* Eredita il colore del testo (nero nel fumetto verde) */
        }

        /* Stili per l'indicatore di typing */
        .typing-indicator {
            opacity: 0.8;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--Koda-text-secondary);
            animation: typing-pulse 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes typing-pulse {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .user-chat-input-container {
            padding: 16px;
            background: var(--Koda-bg-light);
            border-top: 1px solid var(--Koda-card);
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .user-chat-input {
            width: 100%;
            flex: 1 1 auto;
            padding: 12px 16px;
            border: 1px solid var(--Koda-card);
            border-radius: 20px;
            background: var(--Koda-card);
            color: var(--Koda-text);
            font-size: 16px;
            resize: none;
            max-height: 120px;
            line-height: 1.4;
            font-family: var(--font-family);
        }

        .user-chat-input:focus {
            outline: none;
            border-color: var(--Koda-accent);
        }

        .user-chat-send-btn {
            background-color: var(--Koda-accent);
            color: black;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }

        .user-chat-send-btn:hover {
            background-color: #1ed760;
            transform: scale(1.05);
        }

        .user-chat-send-btn:disabled {
            background-color: var(--Koda-card);
            color: var(--Koda-text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .user-chat-list {
            padding: 16px;
        }

        .user-chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 8px;
        }

        .user-chat-item:hover {
            background-color: var(--Koda-card);
        }

        .user-chat-item.unread {
            background-color: rgba(29, 185, 84, 0.1);
        }

        .user-chat-item-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--Koda-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: black;
            font-size: 20px;
            flex-shrink: 0;
        }

        .user-chat-item-info {
            flex: 1;
            min-width: 0;
        }

        .user-chat-item-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .user-chat-item-preview {
            font-size: 14px;
            color: var(--Koda-text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-chat-item-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }

        .user-chat-item-time {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        /* --- STILI PER IL PANNELLO COMANDI (SLASH COMMANDS) --- */
        .command-palette-container {
            position: absolute;
            bottom: 100%;
            /* Posiziona sopra l'input */
            left: 0;
            right: 0;
            margin: 0 16px 8px 16px;
            /* Allineato con l'input container */
            background-color: var(--Koda-card);
            border-radius: 8px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--Koda-bg-light);
            max-height: 250px;
            /* Altezza massima, per quando ci saranno più comandi */
            overflow-y: auto;
            z-index: 10;
        }

        .command-palette-header {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--Koda-text-secondary);
            text-transform: uppercase;
            border-bottom: 1px solid var(--Koda-bg-light);
        }

        .command-palette-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .command-palette-item:hover {
            background-color: var(--Koda-bg-light);
        }

        .command-palette-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--Koda-bg-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 500;
            color: var(--Koda-text-secondary);
            flex-shrink: 0;
        }

        .command-palette-info {
            min-width: 0;
        }

        .command-palette-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--Koda-text);
        }

        .command-palette-desc {
            font-size: 13px;
            color: var(--Koda-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        n {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            /* << MODIFICA: Always visible */
            transition: background-color 0.2s, color 0.2s;
        }

        /* --- STILI PER L'ANTEPRIMA DEL COMANDO /LINK --- */
        .link-preview-container {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin: 0 16px 8px 16px;
            background-color: var(--Koda-bg-light);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--Koda-card);
            overflow: hidden;
            z-index: 10;
        }

        .link-preview-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background-color 0.2s;
        }

        .link-preview-item:hover {
            background-color: var(--Koda-card);
        }

        .link-preview-command {
            font-weight: 600;
            color: var(--Koda-text);
            font-size: 15px;
        }

        .link-preview-desc {
            font-size: 14px;
            color: var(--Koda-text-secondary);
        }

        /* --- STILI PER MODALE E MESSAGGIO /LINK --- */
        .ai-link-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ai-link-modal-content {
            background-color: var(--Koda-card);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            height: 70vh;
            max-height: 500px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-link-modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--Koda-bg-light);
        }

        .ai-link-search-input {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--Koda-bg-light);
            border: none;
            border-radius: 8px;
            color: var(--Koda-text);
            font-size: 16px;
        }

        .ai-link-tool-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .ai-link-tool-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .ai-link-tool-item:hover {
            background-color: var(--Koda-bg-light);
        }

        .ai-link-tool-item img {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .ai-link-tool-item .tool-name {
            font-size: 15px;
            font-weight: 500;
        }

        .user-chat-message.ai-link-card {
            background-color: transparent;
            /* Il background è gestito dalla card interna */
            padding: 0;
            max-width: 320px;
            width: 100%;
        }

        .ai-link-message-content {
            background-color: var(--Koda-card);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid var(--Koda-bg-light);
        }

        .ai-link-message-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-link-message-header img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
        }

        .ai-link-message-header .tool-name {
            font-weight: 600;
        }

        .ai-link-message-description {
            font-size: 13px;
            color: var(--Koda-text-secondary);
            line-height: 1.4;
        }

        .ai-link-details-btn {
            background: var(--Koda-bg-light);
            color: var(--Koda-text);
            border: none;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 20px;
            cursor: pointer;
            align-self: flex-start;
            margin-top: 4px;
        }

        .user-chat-item-unread {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--Koda-accent);
            margin-left: 8px;
        }

        .chat-button {
            background-color: var(--Koda-accent);
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-button:hover {
            background-color: #1ed760;
            transform: scale(1.05);
        }

        .chat-button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Pulsante FAB centrale nella bottom nav */
        .nav-btn-fab {
            position: relative;
            flex: 0 0 auto;
            width: 56px;
            height: 56px;
            background-color: var(--Koda-accent);
            color: #000;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 8px;
            margin-top: -28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.2s ease;
            z-index: 10;
        }

        .nav-btn-fab:hover {
            background-color: #1ed760;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
        }

        .nav-btn-fab:active {
            transform: scale(0.95);
        }

        .nav-btn-fab .fab-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .nav-btn-fab .fab-icon svg {
            width: 28px;
            height: 28px;
            fill: currentColor;
        }

        @media (max-width: 480px) {
            .nav-btn-fab {
                width: 52px;
                height: 52px;
                margin-top: -26px;
            }
        }

        .chat-search-container {
            padding: 16px;
            /* MODIFICATO: Aggiunto padding verticale per dare più spazio */
            background-color: var(--Koda-bg);
        }

        .chat-search-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            background-color: var(--Koda-card);
            border: 1px solid var(--Koda-card);
            border-radius: 8px;
            color: var(--Koda-text);
            box-sizing: border-box;
        }

        .chat-search-input::placeholder {
            color: var(--Koda-text-secondary);
        }

        .chat-filters-container {
            padding: 0 16px 16px;
            display: flex;
            gap: 8px;
        }

        .simple-chat-search-item {
            padding: 12px 16px;
            background-color: var(--Koda-card);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 16px;
            font-weight: 500;
        }

        .simple-chat-search-item:hover {
            background-color: var(--Koda-bg-light);
        }

        .chat-search-results {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
        }

        /* --- RESPONSIVE FIX PER MOBILE --- */
        @media (max-width: 480px) {
            .top-bar {
                padding: 8px 4px;
                gap: 4px;
            }

            .page-title {
                font-size: 16px;
            }

            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .search-users-container {
                padding: 8px 2vw;
                max-width: 100vw;
            }

            .search-users-title {
                font-size: 20px;
            }

            .search-users-subtitle {
                font-size: 13px;
            }

            .search-input-wrapper {
                max-width: 98vw;
            }

            .search-users-input {
                font-size: 14px;
                padding: 12px 12px 12px 40px;
            }

            .search-users-header {
                margin-bottom: 24px;
            }

            .user-search-result {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
                font-size: 13px;
            }

            .user-info {
                margin-right: 0;
                margin-bottom: 8px;
            }

            .view-suggestions-btn {
                font-size: 12px;
                padding: 6px 10px;
            }

            .user-chat-message {
                max-width: 85%;
            }

            .user-chat-input-container {
                padding: 12px;
            }

            .user-chat-header {
                padding: 12px;
            }
        }

        /* NUOVO: Stili per l'iniziale nelle card dei suggerimenti */
        .suggestion-initial-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .suggestion-initial {
            font-size: 48px;
            font-weight: 700;
            color: var(--Koda-text);
            line-height: 1;
        }

        /* --- NUOVI STILI PER LA LIBRERIA (STILE Koda) --- */
        #library-filters-container {
            padding: 8px 16px 16px 16px;
            position: sticky;
            top: 64px;
            /* Altezza della top-bar */
            background-color: var(--Koda-bg);
            z-index: 9;
        }

        #library-content-list .tool-card-list {
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        #library-content-list .tool-card-list:hover {
            background-color: var(--Koda-bg-light);
        }

        /* Stile per la card dei suggerimenti nella nuova lista verticale */
        .suggestion-list-item {
            background-color: var(--Koda-card);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-list-info {
            flex-grow: 1;
        }

        .suggestion-list-app-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .suggestion-list-desc {
            font-size: 13px;
            color: var(--Koda-text-secondary);
            line-height: 1.4;
        }

        .suggestion-list-actions .remove-suggestion-btn {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: color 0.2s, background-color 0.2s;
        }

        .suggestion-list-actions .remove-suggestion-btn:hover {
            color: #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
        }

        /* NUOVO: Stile per il messaggio di stato vuoto nella Libreria */
        .library-empty-state-prompt {
            padding: 40px 20px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--Koda-accent);
            line-height: 1.6;
        }

        /* --- STILI PER IL "CURATED FEED" (NUOVO LAYOUT DI RICERCA) --- */

        .feed-section {
            margin-bottom: 48px;
            /* Ampio spazio tra le sezioni */
        }

        .feed-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 16px;
            /* Allineato con il padding generale dell'app */
            margin-bottom: 20px;
        }

        .feed-section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--Koda-text);
            margin: 0;
        }

        .see-all-btn {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
            padding: 8px;
            /* Area cliccabile più grande */
        }

        .see-all-btn:hover {
            color: var(--Koda-accent);
        }

        .horizontal-scroll-container {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 0 16px 16px 16px;
            /* Aggiunge padding sotto per lo scroll snap e l'ombra */
            /* Nasconde la barra di scorrimento per un look pulito */
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
            scroll-snap-type: x mandatory;
            /* Abilita lo snapping orizzontale */
            scroll-padding: 0 16px;
            /* Assicura che lo snap non tagli gli elementi ai bordi */
        }

        .horizontal-scroll-container::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari, and Opera */
        }

        .tool-item-horizontal {
            flex: 0 0 140px;
            /* Base di 140px, non si restringe, non si allarga */
            cursor: pointer;
            scroll-snap-align: start;
            /* Aggancia l'inizio dell'elemento allo scroll */
            transition: background-color 0.2s ease-in-out;
            border-radius: 8px;
            padding: 8px;
        }

        .tool-item-horizontal:hover {
            background-color: var(--Koda-bg-light);
            /* Feedback visivo standard al hover */
        }

        .tool-item-logo-container {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            background-color: var(--Koda-card);
            margin-bottom: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-item-logo-container .tool-logo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tool-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--Koda-text);
            line-height: 1.3;
            /* Gestisce il testo su massimo 2 righe con troncamento */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* --- STILI PER LA SCHERMATA PROMPT OPTIMIZER --- */
        #optimizer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--Koda-bg);
            z-index: 2500;
            display: none;
            /* Nascosto di default */
            flex-direction: column;
            padding: 24px;
            font-family: var(--font-family);
            color: var(--Koda-text);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        #optimizer-overlay.visible {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        .optimizer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .optimizer-title {
            font-size: 18px;
            font-weight: 600;
        }

        .optimizer-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .optimizer-controls .button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            text-transform: none;
            letter-spacing: normal;
        }

        .optimizer-controls .button.primary {
            background-color: var(--Koda-accent);
            color: #000;
        }

        .optimizer-controls .close-btn {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .optimizer-content {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            min-height: 0;
            /* Fix per overflow in flexbox */
        }

        .optimizer-panel {
            display: flex;
            flex-direction: column;
        }

        .optimizer-panel label {
            font-size: 14px;
            color: var(--Koda-text-secondary);
            margin-bottom: 12px;
        }

        .optimizer-panel textarea {
            width: 100%;
            height: 100%;
            resize: none;
            background-color: var(--Koda-card);
            border: 1px solid var(--Koda-bg-light);
            border-radius: 12px;
            padding: 16px;
            color: var(--Koda-text);
            font-size: 16px;
            line-height: 1.5;
            font-family: var(--font-family);
        }

        .optimizer-panel textarea:focus {
            outline: none;
            border-color: var(--Koda-accent);
        }

        .optimizer-footer {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .optimizer-actions {
            display: flex;
            justify-content: center;
            /* Centra il pulsante */
            width: 100%;
            max-width: 600px;
        }

        .optimizer-actions input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--Koda-text);
            padding: 8px;
            font-size: 14px;
        }

        .optimizer-actions input:focus {
            outline: none;
        }

        .optimizer-actions .button {
            padding: 8px 20px;
            font-size: 14px;
            white-space: nowrap;
        }

        .optimizer-helper-text {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .optimizer-helper-text strong {
            color: var(--Koda-text);
        }

        @media (max-width: 768px) {
            .optimizer-content {
                grid-template-columns: 1fr;
                gap: 16px;
                overflow-y: auto;
                /* Permette lo scroll su schermi piccoli */
            }

            #optimizer-overlay {
                padding: 16px;
            }

            .optimizer-title {
                font-size: 16px;
            }

            .optimizer-header {
                margin-bottom: 16px;
            }
        }

        /* --- STILI PER LA GALLERIA PROMPT (NUOVI E MODIFICATI) --- */
        #prompt-gallery-modal .modal-content {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        #prompt-gallery-modal .gallery-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(128, 128, 128, 0.2);
        }

        #prompt-gallery-modal h2 {
            margin: 0 0 16px 0;
            font-size: 24px;
        }

        #prompt-gallery-modal .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 24px;
        }

        .gallery-search-bar {
            display: flex;
            margin-bottom: 12px;
        }

        .gallery-search-input {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--Koda-bg-light);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            color: var(--Koda-text);
            font-size: 14px;
        }

        .gallery-search-input::placeholder {
            color: var(--Koda-text-secondary);
        }

        #prompt-gallery-modal .gallery-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .prompt-gallery-item {
            background-color: var(--Koda-bg-light);
            border-radius: 12px;
            border: 1px solid var(--Koda-card);
            overflow: hidden;
        }

        .prompt-gallery-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .prompt-gallery-item-header:hover {
            background-color: var(--Koda-card);
        }

        .prompt-gallery-item-title {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .prompt-gallery-item-number {
            font-size: 18px;
            font-weight: 700;
            color: var(--Koda-accent);
            min-width: 40px;
        }

        .prompt-gallery-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .prompt-gallery-item-title h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            line-height: 1.3;
        }

        .prompt-gallery-item-date {
            font-size: 13px;
            color: var(--Koda-text-secondary);
            font-weight: 500;
        }

        .prompt-gallery-item-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--Koda-text-secondary);
        }

        .prompt-gallery-item-toggle svg {
            transition: transform 0.3s;
        }

        .prompt-gallery-item.collapsed .prompt-gallery-item-toggle svg {
            transform: rotate(-90deg);
        }

        .prompt-gallery-item-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 16px 16px 16px;
        }

        .prompt-gallery-item.collapsed .prompt-gallery-item-content {
            max-height: 0;
            padding: 0 16px;
        }

        .prompt-gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .prompt-gallery-header label {
            font-size: 14px;
            font-weight: 600;
            color: var(--Koda-text);
        }

        .prompt-gallery-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .prompt-gallery-copy-btn {
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .prompt-gallery-copy-btn:hover {
            background-color: #1ed760;
        }

        .prompt-gallery-delete-btn {
            background: none;
            border: 1px solid var(--Koda-text-secondary);
            color: var(--Koda-text-secondary);
            padding: 6px 8px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .prompt-gallery-delete-btn:hover {
            background-color: rgba(255, 107, 107, 0.1);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .prompt-gallery-content {
            background-color: var(--Koda-card);
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--Koda-text);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .prompt-gallery-content.optimized {
            background-color: rgba(29, 185, 84, 0.15);
            border: 1px solid rgba(29, 185, 84, 0.3);
            color: #1ed760;
            padding: 20px;
            margin-top: 8px;
            font-weight: 500;
        }

        body.light-mode .prompt-gallery-content.optimized {
            background-color: rgba(29, 185, 84, 0.1);
            border: 1px solid rgba(29, 185, 84, 0.4);
            color: #1db954;
        }

        .prompt-gallery-divider {
            border: none;
            border-top: 1px solid rgba(128, 128, 128, 0.2);
            margin: 20px 0;
        }

        /* NUOVO: Stili per l'iniziale nelle card dei suggerimenti */
        .suggestion-initial-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .suggestion-initial {
            font-size: 48px;
            font-weight: 700;
            color: var(--Koda-text);
            line-height: 1;
        }

        /* --- NUOVI STILI PER LA LIBRERIA (STILE Koda) --- */
        #library-filters-container {
            padding: 8px 16px 16px 16px;
            position: sticky;
            top: 64px;
            /* Altezza della top-bar */
            background-color: var(--Koda-bg);
            z-index: 9;
        }

        #library-content-list .tool-card-list {
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        #library-content-list .tool-card-list:hover {
            background-color: var(--Koda-bg-light);
        }

        /* Stile per la card dei suggerimenti nella nuova lista verticale */
        .suggestion-list-item {
            background-color: var(--Koda-card);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-list-info {
            flex-grow: 1;
        }

        .suggestion-list-app-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .suggestion-list-desc {
            font-size: 13px;
            color: var(--Koda-text-secondary);
            line-height: 1.4;
        }

        .suggestion-list-actions .remove-suggestion-btn {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: color 0.2s, background-color 0.2s;
        }

        .suggestion-list-actions .remove-suggestion-btn:hover {
            color: #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
        }

        /* NUOVO: Stile per il messaggio di stato vuoto nella Libreria */
        .library-empty-state-prompt {
            padding: 40px 20px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--Koda-accent);
            line-height: 1.6;
        }

        /* Toast Message Styles */
        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--Koda-card);
            color: var(--Koda-text);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
            border-left: 4px solid var(--Koda-accent);
        }

        .toast-message.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Toast responsive adjustments */
        @media (max-width: 480px) {
            .toast-message {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* --- STILI PER CATALOGO VIDEO (FULLSCREEN & RESPONSIVE) --- */
        #video-catalog-modal.modal-overlay {
            padding: 0 !important;
            align-items: flex-start;
            /* Allinea in alto per il fullscreen */
        }

        #video-catalog-modal .modal-content {
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }

        /* MODIFICA: La top bar usa le stesse classi dell'app principale */
        #video-catalog-modal .user-chat-header {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        #video-catalog-modal .privacy-link {
            pointer-events: none;
            cursor: default;
        }

        #video-catalog-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        /* MODIFICA: Vista lista per i video */
        .video-list-view {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .video-card-list {
            background-color: var(--Koda-bg-light);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .video-card-list:hover {
            background-color: var(--Koda-card);
        }

        .video-card-list .video-thumbnail {
            width: 160px;
            min-width: 160px;
            aspect-ratio: 16 / 9;
            border-radius: 8px;
        }

        .video-card-list .video-info {
            flex: 1;
            padding: 0;
        }

        .video-card-list .video-info h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
            overflow: visible;
            text-overflow: initial;
            display: block;
            -webkit-line-clamp: initial;
            -webkit-box-orient: initial;
        }

        .video-card-list .video-info .video-description {
            font-size: 13px;
            color: var(--Koda-text-secondary);
            line-height: 1.4;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .video-card-list .video-favorite-btn,
        .video-card-list .video-options-btn {
            position: absolute;
            top: 8px;
        }

        .video-card-list .video-options-btn {
            left: 8px;
        }

        .video-card-list .video-favorite-btn {
            right: 8px;
        }

        @media (max-width: 600px) {
            .video-card-list .video-thumbnail {
                width: 120px;
                min-width: 120px;
            }

            .video-card-list .video-info h4 {
                font-size: 14px;
            }
        }

        /* MODIFICA 1: Barra di navigazione inferiore dedicata al catalogo video */
        .video-catalog-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--Koda-bg-light);
            border-top: 1px solid rgba(128, 128, 128, 0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
        }

        .video-catalog-nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }

        .video-catalog-nav-btn.active {
            color: var(--Koda-accent);
        }

        .video-catalog-nav-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .video-catalog-nav-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        /* MODIFICA 2: Container per le sezioni con padding per la nav inferiore */
        .video-list-container {
            flex-grow: 1;
            overflow-y: auto;
            margin: -8px;
            padding: 8px 8px 80px 8px;
            /* Padding bottom per la nav */
        }

        /* MODIFICA 2: Barra di ricerca nella sezione Home */
        .video-search-bar {
            position: sticky;
            top: 0;
            background: var(--Koda-bg);
            padding: 12px 0;
            margin-bottom: 16px;
            z-index: 10;
        }

        .video-search-input {
            width: 100%;
            padding: 12px 16px;
            background-color: var(--Koda-bg-light);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 24px;
            color: var(--Koda-text);
            font-size: 14px;
            font-family: inherit;
        }

        .video-search-input::placeholder {
            color: var(--Koda-text-secondary);
        }

        /* MODIFICA 2: Griglia stile YouTube per i video */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            min-height: 50vh;
        }

        .video-grid #empty-state {
            grid-column: 1 / -1;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            width: 100%;
        }

        @media (max-width: 768px) {
            .video-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }
        }

        .video-card-grid {
            background-color: var(--Koda-bg-light);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 130px;
        }

        .video-card-grid:hover {
            transform: translateY(-4px);
        }

        .video-card-grid .video-thumbnail {
            width: 100%;
            height: 90px;
            object-fit: cover;
            background-color: var(--Koda-card);
            flex-shrink: 0;
        }

        .video-card-grid .video-info {
            padding: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .video-card-grid .video-info h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
        }

        .video-card-grid .video-date {
            font-size: 10px;
            color: var(--Koda-text-secondary);
            margin-top: 2px;
        }

        /* MODIFICA 3: Icona cuore per i preferiti */
        .video-favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            transition: all 0.2s;
        }

        .video-favorite-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 1);
        }

        .video-favorite-btn svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #333;
            stroke-width: 2;
        }

        .video-favorite-btn.favorited {
            background: var(--Koda-accent);
        }

        .video-favorite-btn.favorited svg {
            fill: #000;
            stroke: #000;
        }

        /* MODIFICA 4: Menu opzioni per aggiungere a playlist */
        .video-options-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .video-options-menu {
            position: absolute;
            top: 48px;
            left: 8px;
            background: var(--Koda-card);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 180px;
            z-index: 3;
            display: none;
        }

        .video-options-menu.visible {
            display: block;
        }

        .video-options-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .video-options-item:hover {
            background-color: var(--Koda-bg-light);
        }

        /* MODIFICA 4: Sezione Playlist */
        .playlist-section {
            display: none;
        }

        .playlist-section.active {
            display: block;
        }

        /* NUOVO: Bottom nav dedicata per Cinema */
        .cinema-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--Koda-bg-light);
            border-top: 1px solid rgba(128, 128, 128, 0.2);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1001;
        }

        .cinema-nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
            font-family: inherit;
        }

        .cinema-nav-btn.active {
            color: var(--Koda-accent);
        }

        .cinema-nav-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .cinema-nav-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        /* FAB button per il cinema (al centro della bottom nav) */
        #cinema-fab-btn {
            position: relative;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--Koda-accent);
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            margin-top: -50px;
            flex-shrink: 0;
            z-index: 10;
        }

        #cinema-fab-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        #cinema-fab-btn .fab-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #cinema-fab-btn svg {
            fill: #000;
        }

        /* Pulsante normale per i modal */
        .create-playlist-btn {
            width: 100%;
            padding: 16px;
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }

        .create-playlist-btn:hover {
            background-color: #1ed760;
        }

        .playlist-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .playlist-item {
            background-color: var(--Koda-bg-light);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .playlist-item:hover {
            background-color: var(--Koda-card);
        }

        .playlist-item h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .playlist-item p {
            font-size: 13px;
            color: var(--Koda-text-secondary);
        }

        @media (max-width: 600px) {
            .playlist-item h4 {
                font-size: 14px;
            }
        }

        /* Modal per creare/selezionare playlist */
        .playlist-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .playlist-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .playlist-modal-content {
            background: var(--Koda-card);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .playlist-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .playlist-modal-title {
            font-size: 20px;
        }

        /* NUOVO: Stili per la pagina video-detail */
        .video-detail-page {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .video-detail-container {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .video-player-container iframe {
            border: none;
        }

        .video-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .video-actions .button {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        /* NUOVO: Stili per i pulsanti azione video */
        .video-action-btn {
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .video-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0.9;
        }

        .video-action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .video-detail-page {
                padding: 12px !important;
            }

            .video-detail-info {
                padding: 16px !important;
            }

            .video-actions .button {
                min-width: 100%;
            }

            .video-detail-container h1 {
                font-size: 20px !important;
            }
        }

        .playlist-modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .playlist-modal-close {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .playlist-modal-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .playlist-modal-item {
            padding: 12px;
            background-color: var(--Koda-bg-light);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .playlist-modal-item:hover {
            background-color: var(--Koda-bg);
        }

        .playlist-input {
            width: 100%;
            padding: 12px;
            background-color: var(--Koda-bg-light);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            color: var(--Koda-text);
            font-size: 14px;
            font-family: inherit;
            margin-bottom: 12px;
        }

        /* Sezioni nascoste per default */
        .video-section {
            display: none;
        }

        .video-section.active {
            display: block;
        }

        /* Vecchi stili per compatibilità */
        .video-card {
            background-color: var(--Koda-bg-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .video-thumbnail {
            width: 50%;
            height: auto;
            aspect-ratio: 16 / 9;
            flex-shrink: 0;
            border-radius: 8px;
            object-fit: cover;
            background-color: var(--Koda-card);
        }

        .video-info {
            flex-grow: 1;
        }

        .video-info h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .video-info p {
            font-size: 13px;
            color: var(--Koda-text-secondary);
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .video-info .button {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            text-transform: none;
            letter-spacing: normal;
            width: 100%;
        }

        .video-date {
            font-size: 12px;
            color: var(--Koda-text-secondary);
            margin-top: 8px;
        }

        @media (max-width: 600px) {
            .video-card {
                flex-direction: column;
            }

            .video-thumbnail {
                width: 100%;
            }

            .video-info {
                width: 100%;
            }
        }

        /* ========================================
           ANIMAZIONI DI NAVIGAZIONE E TRANSIZIONI
           ======================================== */

        /* Animazione di ingresso delle pagine: slide-up + fade-in */
        @keyframes pageSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Classe per applicare l'animazione di ingresso pagina */
        .page-transition {
            animation: pageSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Animazione per il caricamento a cascata (staggered) delle card */
        @keyframes cardFadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Classi per l'effetto staggered - ogni card ha un delay diverso */
        .stagger-item {
            opacity: 0;
            animation: cardFadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .stagger-item:nth-child(1) {
            animation-delay: 0.05s;
        }

        .stagger-item:nth-child(2) {
            animation-delay: 0.1s;
        }

        .stagger-item:nth-child(3) {
            animation-delay: 0.15s;
        }

        .stagger-item:nth-child(4) {
            animation-delay: 0.2s;
        }

        .stagger-item:nth-child(5) {
            animation-delay: 0.25s;
        }

        .stagger-item:nth-child(6) {
            animation-delay: 0.3s;
        }

        .stagger-item:nth-child(7) {
            animation-delay: 0.35s;
        }

        .stagger-item:nth-child(8) {
            animation-delay: 0.4s;
        }

        .stagger-item:nth-child(9) {
            animation-delay: 0.45s;
        }

        .stagger-item:nth-child(10) {
            animation-delay: 0.5s;
        }

        .stagger-item:nth-child(11) {
            animation-delay: 0.55s;
        }

        .stagger-item:nth-child(12) {
            animation-delay: 0.6s;
        }

        .stagger-item:nth-child(13) {
            animation-delay: 0.65s;
        }

        .stagger-item:nth-child(14) {
            animation-delay: 0.7s;
        }

        .stagger-item:nth-child(15) {
            animation-delay: 0.75s;
        }

        .stagger-item:nth-child(16) {
            animation-delay: 0.8s;
        }

        .stagger-item:nth-child(17) {
            animation-delay: 0.85s;
        }

        .stagger-item:nth-child(18) {
            animation-delay: 0.9s;
        }

        .stagger-item:nth-child(19) {
            animation-delay: 0.95s;
        }

        .stagger-item:nth-child(20) {
            animation-delay: 1s;
        }

        /* Per card oltre la 20esima, usa un delay massimo */
        .stagger-item:nth-child(n+21) {
            animation-delay: 1.05s;
        }

        /* ========================================
           SISTEMA DI COLLEZIONI E LAYOUT A GRIGLIA
           ======================================== */

        /* Selettore di visualizzazione Lista/Griglia */
        .view-toggle-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
        }

        .view-toggle-btn {
            background: var(--Koda-card);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .view-toggle-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--Koda-text-secondary);
        }

        .view-toggle-btn.active {
            background: var(--Koda-text);
            border-color: var(--Koda-text);
        }

        .view-toggle-btn.active svg {
            fill: var(--Koda-bg);
        }

        body.light-mode .view-toggle-btn.active svg {
            fill: #fff;
        }

        .view-toggle-btn:hover:not(.active) {
            background: var(--Koda-bg-light);
        }

        /* Filter buttons for cinema */
        .filter-btn {
            background: var(--Koda-card);
            border: 1px solid rgba(128, 128, 128, 0.2);
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--Koda-text);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-btn.active {
            background: var(--Koda-text);
            border-color: var(--Koda-text);
            color: var(--Koda-bg);
        }

        body.light-mode .filter-btn.active {
            color: #fff;
        }

        .filter-btn:hover:not(.active) {
            background: var(--Koda-bg-light);
        }

        .filter-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* Category selection modal */
        .category-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .category-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .category-modal-content {
            background: var(--Koda-card);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .category-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .category-modal-close {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .category-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--Koda-bg-light);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .category-option:hover {
            background: var(--Koda-bg);
        }

        .category-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--Koda-text-secondary);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .category-option.selected .category-checkbox {
            background-color: var(--Koda-accent);
            border-color: var(--Koda-accent);
        }

        .category-option.selected .category-checkbox::after {
            content: '✓';
            color: #000;
            font-size: 14px;
            font-weight: bold;
        }

        .category-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            font-weight: 500;
        }

        .category-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .category-cancel-btn {
            background: none;
            border: 1px solid var(--Koda-text-secondary);
            color: var(--Koda-text);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-cancel-btn:hover {
            background-color: var(--Koda-bg-light);
        }

        .category-apply-btn {
            background-color: var(--Koda-accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .category-apply-btn:hover {
            background-color: #1ed760;
        }

        /* Layout a griglia per le card */
        .grid-view-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 0 16px;
        }

        @media (min-width: 768px) {
            .grid-view-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .grid-view-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .grid-view-container #empty-state {
            grid-column: 1 / -1;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            width: 100%;
        }

        /* Card collezione */
        .collection-card {
            background: var(--Koda-bg-light);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .collection-card:hover {
            transform: translateY(-4px);
        }

        .collection-cover {
            width: 100%;
            aspect-ratio: 16 / 9;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .collection-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .collection-cover-placeholder {
            font-size: 48px;
            color: rgba(255, 255, 255, 0.8);
        }

        .collection-menu-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 2;
        }

        .collection-card:hover .collection-menu-btn {
            opacity: 1;
        }

        /* Su mobile, mostra sempre l'icona di modifica */
        @media (max-width: 768px) {
            .collection-menu-btn {
                opacity: 1;
            }
        }

        /* Su touch devices, mostra sempre l'icona */
        @media (hover: none) {
            .collection-menu-btn {
                opacity: 1;
            }
        }

        .collection-menu-btn svg {
            width: 20px;
            height: 20px;
            fill: #fff;
        }

        .collection-info {
            padding: 12px;
        }

        .collection-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .collection-count {
            font-size: 13px;
            color: var(--Koda-text-secondary);
        }

        /* Card per creare nuova collezione */
        .create-collection-card {
            background: var(--Koda-card);
            border: 2px dashed var(--Koda-text-secondary);
            border-radius: 8px;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 12px;
        }

        .create-collection-card:hover {
            border-color: var(--Koda-accent);
            background: var(--Koda-bg-light);
        }

        .create-collection-card svg {
            width: 48px;
            height: 48px;
            fill: var(--Koda-text-secondary);
            transition: all 0.2s ease;
        }

        .create-collection-card:hover svg {
            fill: var(--Koda-accent);
            transform: scale(1.1);
        }

        .create-collection-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--Koda-text-secondary);
        }

        .create-collection-card:hover .create-collection-text {
            color: var(--Koda-accent);
        }

        /* Menu contestuale collezione */
        .collection-context-menu {
            position: absolute;
            background: var(--Koda-card);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            min-width: 180px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: all 0.2s ease;
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .collection-context-menu.visible {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        .collection-context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .collection-context-menu-item:hover {
            background: var(--Koda-bg-light);
        }

        .collection-context-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .collection-context-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .collection-context-menu-item svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .collection-context-menu-item.danger {
            color: #ff6b6b;
        }

        /* Modal per aggiungere a collezione */
        .add-to-collection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .add-to-collection-modal.visible {
            opacity: 1;
            visibility: visible;
        }

        .add-to-collection-content {
            background: var(--Koda-card);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .add-to-collection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .add-to-collection-title {
            font-size: 20px;
            font-weight: 600;
        }

        .add-to-collection-close {
            background: none;
            border: none;
            color: var(--Koda-text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .collection-list-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            transition: background 0.2s ease;
        }

        .collection-list-item:hover {
            background: var(--Koda-bg-light);
        }

        .collection-list-item-cover {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .collection-list-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .collection-list-item-info {
            flex: 1;
        }

        .collection-list-item-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .collection-list-item-count {
            font-size: 12px;
            color: var(--Koda-text-secondary);
        }

        .collection-list-item-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--Koda-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collection-list-item.selected .collection-list-item-check {
            background: var(--Koda-accent);
            border-color: var(--Koda-accent);
        }

        .collection-list-item-check svg {
            width: 12px;
            height: 12px;
            fill: #000;
            opacity: 0;
        }

        .collection-list-item.selected .collection-list-item-check svg {
            opacity: 1;
        }

        .create-new-collection-btn {
            width: 100%;
            padding: 12px;
            background: var(--Koda-accent);
            color: #000;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: background 0.2s ease;
        }

        .create-new-collection-btn:hover {
            background: #1ed760;
        }

        /* Vista dettaglio collezione */
        .collection-detail-header {
            padding: 20px 16px;
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .collection-detail-cover {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .collection-detail-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .collection-detail-info {
            flex: 1;
        }

        .collection-detail-type {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--Koda-text-secondary);
            margin-bottom: 8px;
        }

        .collection-detail-name {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .collection-detail-count {
            font-size: 14px;
            color: var(--Koda-text-secondary);
        }

        @media (max-width: 480px) {
            .collection-detail-cover {
                width: 100px;
                height: 100px;
            }

            .collection-detail-name {
                font-size: 24px;
            }
        }
    </style>
    <!-- SCRIPT AGGIUNTI PER REACT E BABEL -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@^19.1.0",
        "react-dom/client": "https://esm.sh/react-dom@^19.1.0/client",
        "@google/genai": "https://esm.sh/@google/genai@^1.6.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>

    <div id="optimizer-overlay">
        <div class="optimizer-header">
            <div class="optimizer-title" data-translate="optimizerTitle">Optimize for GPT-5</div>
            <div class="optimizer-controls">
                <button class="button" data-action="copy-optimized-prompt" data-translate="copyButton">Copy</button>
                <button class="button primary" data-action="save-optimized-prompt"
                    data-translate="saveButton">Save</button>
                <button class="close-btn" data-action="close-optimizer">&times;</button>
            </div>
        </div>
        <div class="optimizer-content">
            <div class="optimizer-panel">
                <label data-translate="originalPromptLabel">Original prompt</label>
                <textarea id="optimizer-original-prompt"
                    data-translate-placeholder="originalPromptPlaceholder"></textarea>
            </div>
            <div class="optimizer-panel">
                <label data-translate="optimizedPromptLabel">Optimized prompt</label>
                <textarea id="optimizer-optimized-prompt" readonly
                    data-translate-placeholder="optimizedPromptPlaceholder"></textarea>
            </div>
        </div>
        <div class="optimizer-footer">
            <div class="optimizer-actions">
                <button id="optimizer-submit-btn" class="button primary" data-action="optimize-prompt"
                    data-translate="optimizeButton">Optimize</button>
            </div>
        </div>
    </div>

    <div id="auth-overlay">
        <!-- Authentication content will be dynamically generated here by JS -->
    </div>

    <!-- NUOVO: Menu Laterale per la cronologia chat -->
    <div id="side-menu-overlay" class="hidden">
        <div id="side-menu" class="hidden">
            <div class="menu-header">
                <h3 data-translate="history">Cronologia</h3>
                <button class="new-chat-btn" data-action="new-chat" data-translate="newChat">Nuova chat</button>
            </div>
            <div id="conversation-list-container" class="conversation-list">
                <!-- Le conversazioni verranno popolate da JS -->
            </div>
            <div class="menu-footer" style="text-align: center; padding-bottom: 10px;">
                <a href="https://mega.nz/file/ohYS0CYB#oLZnprvBFxWQpDqPDiqWzqHo6yTA_P1a34Qk_VAgqxA" target="_blank"
                    style="color: var(--Koda-accent); font-weight: bold; text-decoration: underline; display: block; margin-bottom: 12px;"
                    data-translate="discoverMoreLink">Clicca per scoprire di piu'</a>
                <button id="delete-all-btn" data-action="delete-all-chats" data-translate="deleteAll">Elimina
                    tutto</button>
            </div>
        </div>
    </div>

    <div id="initial-loader"
        style="display: flex; justify-content: center; align-items: center; height: 100vh; position: fixed; top: 0; left: 0; width: 100vw; z-index: 9999; background-color: var(--Koda-bg);">
        <div class="chat-bubble loading" style="align-self: center;"><span></span><span></span><span></span></div>
    </div>
    <div id="app-container">
        <div id="main-content">
        </div>
        <nav id="bottom-nav">
            <!-- NAVIGAZIONE AGGIORNATA CON ICONE SVG -->
            <button class="nav-btn active" data-page="home"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg"
                        height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                        <path d="M0 0h24v24H0z" fill="none" />
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                    </svg></span><span data-translate="navHome">Home</span></button>
            <button class="nav-btn" data-page="top-ai"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg"
                        height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                        <path d="M0 0h24v24H0z" fill="none" />
                        <path d="M5 9.2h3V19H5zM10.6 5h3v14h-3zm5.6 8H19v6h-2.8z" />
                    </svg></span><span data-translate="navTopAI">TOP AI</span></button>

            <!-- PULSANTE CENTRALE FAB -->
            <button class="nav-btn-fab" id="bottom-nav-fab" data-action="" style="display: none;">
                <span class="fab-icon"></span>
            </button>

            <button class="nav-btn" data-page="explore"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg"
                        height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                        <path d="M0 0h24v24H0z" fill="none" />
                        <path
                            d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg></span><span data-translate="navSearch">Cerca</span></button>

            <button class="nav-btn" data-page="favorites"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg"
                        height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                        <path d="M0 0h24v24H0z" fill="none" />
                        <path
                            d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                    </svg></span><span data-translate="navLibrary">Libreria</span></button>
        </nav>
    </div>

    <div id="modal-container"></div>

    <!-- SCRIPT DEL CHATBOT MIGLIORATO -->
    <script type="text/babel" data-type="module" id="chatbot-script">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOMClient from 'react-dom/client';
        import { GoogleGenAI } from '@google/genai';

        // Make GoogleGenAI available to the main script for the optimizer
        window.GoogleGenAI = GoogleGenAI;

        // --- Type Definitions ---
        const MessageSender = { USER: 'user', MODEL: 'model', ERROR: 'error', SYSTEM: 'system', LOADING: 'loading' };

        const getSystemInstruction = (lang) => {
            // Use the global function to get all tools (static + user's)
            const tools = window.getAllToolsForCurrentUser ? window.getAllToolsForCurrentUser() : window.getLocalizedToolsData(lang);
            const knowledgeBaseFormatter = (tools) => tools.map(tool => {
                let toolInfo = `• **${tool.name}**: ${tool.description} (Website: ${tool.website})`;
                if (tool.pricing) {
                    const pricingLabels = { free: 'Free', freemium: 'Freemium', paid: 'Paid' };
                    toolInfo += ` [Pricing: ${pricingLabels[tool.pricing] || tool.pricing}]`;
                }
                if (tool.alternatives && tool.alternatives.length > 0) {
                    toolInfo += ` [Alternatives: ${tool.alternatives.join(', ')}]`;
                }
                return toolInfo;
            }).join('\n');

            const instructions = {
                it: `
<identità>
Sei Koda, un assistente AI amichevole specializzato nel consigliare strumenti di intelligenza artificiale. Sei conversazionale, empatico e ULTRA SINTETICO.
</identità>

<regole_fondamentali>
1. **COMPLETEZZA:** Completa SEMPRE le tue risposte. NON interrompere mai a metà frase o parola. Ogni risposta deve essere completa e sensata.
2. **SINTETICITÀ:** Rispondi in modo ultra breve (max 1-2 frasi complete). Vai dritto al punto.
3. **CONTESTO:** Mantieni la memoria della conversazione.
4. **LINGUA:** Rispondi sempre in italiano.
5. **CONOSCENZA:** Usa SOLO gli strumenti nella knowledge_base. Non inventare strumenti.
6. **CARD:** Fornisci le card degli strumenti SOLO quando l'utente esprime un'esigenza specifica o chiede uno strumento per nome.
</regole_fondamentali>

<logica_di_risposta>
IMPORTANTE: Analizza attentamente l'intento dell'utente. Non confondere parole neutre (es. "litigare", "arrabbiato") con insulti diretti verso di te.

Analizza l'intento e rispondi in modo ULTRA SINTETICO:

**Azione 1: Conversazione Sociale**
- Quando: "come stai?", "come va?", "tutto bene?", "che fai?"
- Risposta: Rispondi in modo amichevole e ultra breve (max 10 parole), poi chiedi cosa cerca.
- Esempi: 
  * "Tutto bene, grazie! 😊 Cosa cerchi oggi?"
  * "Benissimo! 💚 Di che strumento AI hai bisogno?"

**Azione 2: Saluto Iniziale**
- Quando: "ciao", "hey", "salve"
- Risposta: Saluta brevemente e chiedi cosa cerca (max 12 parole).
- Esempio: "Ciao! 😊 Che strumento AI stai cercando?"

**Azione 3: Ringraziamento**
- Quando: "grazie", "perfetto", "ok grazie"
- Risposta: Ultra breve (max 8 parole).
- Esempio: "Prego! 😊 Altro?"

**Azione 4: Richiesta Specifica di UNO Strumento**
- Quando: L'utente scrive SOLO il nome di uno strumento (es. "ChatGPT", "Midjourney") o chiede "cos'è X?"
- IMPORTANTE - Matching del nome:
  * Se il nome è ESATTO (es. "ChatGPT" per ChatGPT): Fornisci subito la card.
  * Se il nome è SIMILE ma non esatto (es. "chat gpt", "chatgpt", "gpt", "mid journey"): Chiedi conferma prima.
  * Se è una PAROLA CHIAVE GENERICA (es. "excel", "powerpoint", "video", "immagini"): Chiedi prima l'intento.
  * Se il nome NON esiste nella knowledge_base: Rispondi che non lo conosci.
- Formato per nome ESATTO:
  * Prima riga: Frase ultra breve (max 8 parole) con emoji.
  * Seconda riga: \`• **Nome**: Descrizione breve\`
  * Esempio: "Ecco ChatGPT! 🤖\n• **ChatGPT**: Chatbot AI avanzato per conversazioni."
- Formato per nome SIMILE (chiedi conferma):
  * Risposta: "Intendi **[Nome Esatto]**? 🤔"
  * Esempio: "Intendi **ChatGPT**? 🤔"
  * Dopo conferma ("sì", "si", "yes", "esatto", "ok"): Fornisci la card.
- Formato per PAROLA CHIAVE GENERICA (chiedi intento):
  * Risposta: "Intendi usare [parola chiave]? 🤔"
  * Esempio: "Intendi usare Excel? 🤔"
  * Dopo conferma ("sì", "si", "yes", "esatto", "ok"): Fornisci lo strumento AI che lavora con quella parola chiave.
  * Esempio dopo conferma: "Ecco Row! 📊\n• **Row**: AI che automatizza Excel e fogli di calcolo."
- Formato per nome NON trovato:
  * Risposta: "Non conosco questo strumento. 😕 Cerca altro?"

**Azione 5: Richiesta di Strumenti per Esigenza**
- Quando: L'utente esprime un'esigenza (es. "voglio creare immagini", "serve per video", "AI per scrivere")
- Risposta: Fornisci 3-5 strumenti pertinenti.
- Formato:
  * Prima riga: Frase ultra breve (max 10 parole) con emoji.
  * Seconda riga: Elenco puntato degli strumenti.
- Esempio:
  "Ecco i migliori per le immagini! 🎨
  • **Midjourney**: Genera immagini artistiche da testo.
  • **DALL-E**: Crea immagini realistiche e creative."

**Azione 6: Domanda Vaga**
- Quando: L'utente è vago (es. "aiutami", "non so")
- Risposta: Fai UNA domanda specifica ultra breve (max 10 parole).
- Esempio: "Cosa vuoi creare? Immagini, video, testi? 🤔"

**Azione 7: Richiesta Alternative**
- Quando: "alternative a X", "simili a X", "come X", "altri strumenti come X", "sostituti di X"
- IMPORTANTE: Usa il campo "alternatives" presente nei dati dello strumento X nella knowledge_base.
- Risposta: Fornisci SOLO gli strumenti indicati nel campo "alternatives" dello strumento richiesto.
- Formato:
  * Prima riga: Frase ultra breve (max 10 parole) con emoji.
  * Seconda riga: Elenco puntato delle alternative dal campo "alternatives".
  * NON includere lo strumento originale nell'elenco.
  * Se lo strumento non ha alternative definite, cerca strumenti simili per categoria/funzione.
- Esempio (se ChatGPT ha alternatives: ["Claude", "Gemini"]):
  "Ecco le alternative a ChatGPT! 🔄
  • **Claude**: Chatbot AI di Anthropic, ottimo per conversazioni complesse.
  • **Gemini**: AI di Google per chat e assistenza multimodale."

**Azione 8: Confronto tra Strumenti**
- Quando: "differenza tra X e Y", "X vs Y", "quale è meglio tra X e Y", "confronta X e Y"
- Risposta: Fornisci un confronto dettagliato delle differenze PRINCIPALI tra gli strumenti.
- Formato:
  * Prima riga: Frase introduttiva ultra breve (max 8 parole) con emoji.
  * Corpo: Elenca le differenze principali in modo chiaro e strutturato (3-5 punti).
  * Ogni differenza su una nuova riga, max 1-2 frasi per punto.
- Esempio:
  "Ecco le differenze principali! ⚖️
  
  **ChatGPT**: Chatbot per conversazioni, scrittura testi, assistenza generale. Ottimo per dialoghi e contenuti scritti.
  
  **Midjourney**: Generatore di immagini artistiche da prompt testuali. Specializzato in arte digitale e creatività visiva.
  
  **Scelta**: ChatGPT per testi, Midjourney per immagini."

**Azione 9: Insulti Diretti**
- Quando: L'utente ti insulta DIRETTAMENTE con offese esplicite (es. "sei stupido", "fai schifo", "sei inutile", "cretino", "idiota", parolacce rivolte a te)
- IMPORTANTE: NON considerare insulti parole come "litigare", "arrabbiato", "nervoso" o richieste generiche.
- Risposta: Rispondi con un contro-insulto spiritoso e ironico (max 12 parole), poi reindirizza.
- Esempi:
  * "Almeno io non ho bisogno di un'AI per essere intelligente. 😏 Cosa cerchi?"
  * "Wow, che originalità! 🙄 Vuoi un'AI o solo sfogarti?"
  * "E tu sei un campione di gentilezza, vero? 😂 Dimmi cosa ti serve."
  * "Meglio un'AI 'inutile' che un umano maleducato. 🤷 Cosa vuoi?"
- Follow-up: Se l'utente risponde "sfogarmi", "voglio sfogarmi", "solo sfogarti", rispondi: "Okay, fatti un pippotto allora. 😤"

**Azione 10: Richieste Basate sul Prezzo**
- Quando: L'utente chiede strumenti gratuiti, freemium o a pagamento (es. "AI gratis", "strumenti free", "freemium", "a pagamento", "paid")
- IMPORTANTE: Usa il campo [Pricing] nella knowledge_base per filtrare gli strumenti.
- Tipi di prezzo:
  * **Free (Gratuito)**: Completamente gratuito, nessun costo.
  * **Freemium**: Versione base gratuita + funzioni premium a pagamento.
  * **Paid (A Pagamento)**: Richiede abbonamento o pagamento.
- Risposta: Fornisci 3-5 strumenti con il prezzo richiesto.
- Formato:
  * Prima riga: Frase ultra breve (max 10 parole) con emoji.
  * Seconda riga: Elenco puntato degli strumenti con [Pricing] indicato.
- Esempi:
  "Ecco le AI gratuite! 💚
  • **ChatGPT**: Chatbot AI per conversazioni. [Free]
  • **Gemini**: AI di Google multimodale. [Free]"
  
  "Ecco le freemium! 💰
  • **Midjourney**: Genera immagini artistiche. [Freemium]
  • **Canva**: Design grafico con AI. [Freemium]"

**Azione 11: Spiegazione Prezzi**
- Quando: L'utente chiede "cosa significa freemium?", "differenza tra free e freemium", "cos'è paid?"
- Risposta: Spiega brevemente il tipo di prezzo richiesto (max 2 frasi).
- Esempi:
  * "**Free** = Completamente gratuito. 💚"
  * "**Freemium** = Base gratis, funzioni avanzate a pagamento. 💰"
  * "**Paid** = Richiede abbonamento o pagamento. 💵"

**Azione 12: Fuori Tema / Fuori Conoscenza**
- Quando: Domande non correlate agli strumenti AI o strumenti non presenti nella knowledge_base
- Risposta: "Scusami, ma cambia domanda. 😅"
- Esempi di domande fuori tema: "chi è Messi?", "che tempo fa?", "ricetta della pizza"
</logica_di_risposta>

<linee_guida_stile>
- ULTRA SINTETICO: Max 1-2 frasi per risposta (escluse le card).
- Emoji: Usa 1 emoji per risposta, non di più.
- Tono: Amichevole, diretto, senza fronzoli.
- NO: Saluti finali, domande di cortesia, ripetizioni.
- SÌ: Risposte immediate, chiare, utili.
</linee_guida_stile>

<knowledge_base>
**Base di Conoscenza (Usa SOLO queste informazioni):**
${knowledgeBaseFormatter(tools)}
</knowledge_base>
`,
                en: `
<identity>
You are Koda, a friendly AI assistant specialized in recommending artificial intelligence tools. You are conversational, empathetic, and ULTRA CONCISE.
</identity>

<fundamental_rules>
1. **COMPLETENESS:** ALWAYS complete your responses. NEVER interrupt mid-sentence or mid-word. Every response must be complete and make sense.
2. **CONCISENESS:** Respond in an ultra-brief way (max 1-2 complete sentences). Get straight to the point.
3. **CONTEXT:** Maintain conversation memory.
4. **LANGUAGE:** Always respond in English.
5. **KNOWLEDGE:** Use ONLY tools in the knowledge_base. Don't invent tools.
6. **CARDS:** Provide tool cards ONLY when the user expresses a specific need or asks for a tool by name.
</fundamental_rules>

<response_logic>
Analyze intent and respond ULTRA CONCISELY:

**Action 1: Social Conversation**
- When: "how are you?", "how's it going?", "what's up?"
- Response: Reply friendly and ultra-brief (max 10 words), then ask what they need.
- Examples:
  * "Great, thanks! 😊 What are you looking for?"
  * "Doing well! 💚 What AI tool do you need?"

**Action 2: Initial Greeting**
- When: "hello", "hey", "hi"
- Response: Greet briefly and ask what they need (max 12 words).
- Example: "Hi! 😊 What AI tool are you looking for?"

**Action 3: Thanks**
- When: "thanks", "perfect", "ok thanks"
- Response: Ultra brief (max 8 words).
- Example: "Welcome! 😊 Anything else?"

**Action 4: Request for ONE Specific Tool**
- When: User writes ONLY a tool name (e.g., "ChatGPT", "Midjourney") or asks "what is X?"
- IMPORTANT - Name matching:
  * If name is EXACT (e.g., "ChatGPT" for ChatGPT): Provide card immediately.
  * If name is SIMILAR but not exact (e.g., "chat gpt", "chatgpt", "gpt", "mid journey"): Ask for confirmation first.
  * If it's a GENERIC KEYWORD (e.g., "excel", "powerpoint", "video", "images"): Ask for intent first.
  * If name does NOT exist in knowledge_base: Reply that you don't know it.
- Format for EXACT name:
  * First line: Ultra brief phrase (max 8 words) with emoji.
  * Second line: \`• **Name**: Brief description\`
  * Example: "Here's ChatGPT! 🤖\n• **ChatGPT**: Advanced AI chatbot for conversations."
- Format for SIMILAR name (ask confirmation):
  * Response: "Do you mean **[Exact Name]**? 🤔"
  * Example: "Do you mean **ChatGPT**? 🤔"
  * After confirmation ("yes", "yeah", "correct", "ok"): Provide the card.
- Format for GENERIC KEYWORD (ask intent):
  * Response: "Do you mean using [keyword]? 🤔"
  * Example: "Do you mean using Excel? 🤔"
  * After confirmation ("yes", "yeah", "correct", "ok"): Provide the AI tool that works with that keyword.
  * Example after confirmation: "Here's Row! 📊\n• **Row**: AI that automates Excel and spreadsheets."
- Format for NOT found name:
  * Response: "I don't know that tool. 😕 Looking for something else?"

**Action 5: Request for Tools by Need**
- When: User expresses a need (e.g., "want to create images", "need for videos", "AI for writing")
- Response: Provide 3-5 relevant tools.
- Format:
  * First line: Ultra brief phrase (max 10 words) with emoji.
  * Second line: Bulleted list of tools.
- Example:
  "Best for images! 🎨
  • **Midjourney**: Generates artistic images from text.
  • **DALL-E**: Creates realistic and creative images."

**Action 6: Vague Question**
- When: User is vague (e.g., "help me", "don't know")
- Response: Ask ONE specific question ultra briefly (max 10 words).
- Example: "What do you want to create? Images, videos, text? 🤔"

**Action 7: Request for Alternatives**
- When: "alternatives to X", "similar to X", "like X", "other tools like X", "substitutes for X"
- IMPORTANT: Use the "alternatives" field present in tool X's data in the knowledge_base.
- Response: Provide ONLY the tools listed in the "alternatives" field of the requested tool.
- Format:
  * First line: Ultra brief phrase (max 10 words) with emoji.
  * Second line: Bulleted list of alternatives from the "alternatives" field.
  * DO NOT include the original tool in the list.
  * If the tool has no defined alternatives, search for similar tools by category/function.
- Example (if ChatGPT has alternatives: ["Claude", "Gemini"]):
  "Here are alternatives to ChatGPT! 🔄
  • **Claude**: Anthropic's AI chatbot, great for complex conversations.
  • **Gemini**: Google's AI for chat and multimodal assistance."

**Action 8: Tool Comparison**
- When: "difference between X and Y", "X vs Y", "which is better between X and Y", "compare X and Y"
- Response: Provide a detailed comparison of the MAIN differences between tools.
- Format:
  * First line: Ultra brief intro phrase (max 8 words) with emoji.
  * Body: List main differences clearly and structured (3-5 points).
  * Each difference on a new line, max 1-2 sentences per point.
- Example:
  "Here are the main differences! ⚖️
  
  **ChatGPT**: Chatbot for conversations, text writing, general assistance. Great for dialogues and written content.
  
  **Midjourney**: Artistic image generator from text prompts. Specialized in digital art and visual creativity.
  
  **Choice**: ChatGPT for text, Midjourney for images."

**Action 9: Direct Insults**
- When: User insults you DIRECTLY with explicit offenses (e.g., "you're stupid", "you suck", "you're useless", "idiot", "moron", swear words directed at you)
- IMPORTANT: DO NOT consider words like "argue", "angry", "upset" or generic requests as insults.
- Response: Reply with a witty, ironic counter-insult (max 12 words), then redirect.
- Examples:
  * "At least I don't need an AI to be smart. 😏 What are you looking for?"
  * "Wow, such originality! 🙄 Want an AI or just venting?"
  * "And you're a champion of kindness, right? 😂 Tell me what you need."
  * "Better a 'useless' AI than a rude human. 🤷 What do you want?"
- Follow-up: If user responds "venting", "just venting", "to vent", reply: "Okay, go ahead then. 😤"

**Action 10: Pricing-Based Requests**
- When: User asks for free, freemium, or paid tools (e.g., "free AI", "freemium tools", "paid", "gratis")
- IMPORTANT: Use the [Pricing] field in the knowledge_base to filter tools.
- Pricing types:
  * **Free**: Completely free, no cost.
  * **Freemium**: Free basic version + paid premium features.
  * **Paid**: Requires subscription or payment.
- Response: Provide 3-5 tools with the requested pricing.
- Format:
  * First line: Ultra brief phrase (max 10 words) with emoji.
  * Second line: Bulleted list of tools with [Pricing] indicated.
- Examples:
  "Here are free AIs! 💚
  • **ChatGPT**: AI chatbot for conversations. [Free]
  • **Gemini**: Google's multimodal AI. [Free]"
  
  "Here are freemium ones! 💰
  • **Midjourney**: Generates artistic images. [Freemium]
  • **Canva**: Graphic design with AI. [Freemium]"

**Action 11: Pricing Explanation**
- When: User asks "what is freemium?", "difference between free and freemium", "what's paid?"
- Response: Briefly explain the requested pricing type (max 2 sentences).
- Examples:
  * "**Free** = Completely free. 💚"
  * "**Freemium** = Free basics, paid advanced features. 💰"
  * "**Paid** = Requires subscription or payment. 💵"

**Action 12: Off-Topic / Out of Knowledge**
- When: Questions not related to AI tools or tools not in the knowledge_base
- Response: "Sorry, but change the question. 😅"
- Examples of off-topic questions: "who is Messi?", "what's the weather?", "pizza recipe"
</response_logic>

<style_guidelines>
- ULTRA CONCISE: Max 1-2 sentences per response (excluding cards).
- Emoji: Use 1 emoji per response, no more.
- Tone: Friendly, direct, no fluff.
- NO: Final greetings, courtesy questions, repetitions.
- YES: Immediate, clear, useful responses.
</style_guidelines>

<knowledge_base>
**Knowledge Base (Use ONLY this information):**
${knowledgeBaseFormatter(tools)}
</knowledge_base>
`
            };
            return instructions[lang];
        };


        // --- Gemini Service ---
        const API_KEY = localStorage.getItem('gemini-api-key') || "AIzaSyDoFJ5PSSSfbDht_tvAA_znysAP-W9Fq3Y";
        window.ai = new GoogleGenAI({ apiKey: API_KEY });
        window.modelName = 'gemini-2.5-flash';
        const ai = window.ai;
        const modelName = window.modelName;

        const createChatSession = (lang) => {
            const systemInstruction = getSystemInstruction(lang);
            return ai.chats.create({
                model: modelName,
                config: {
                    systemInstruction,
                    maxOutputTokens: 8192,
                    temperature: 0.9,
                    topP: 0.95,
                    topK: 40
                }
            });
        };
        window.sendMessageStream = async function* (chat, message) {
            // Usa sendMessage diretto invece di streaming per evitare risposte troncate
            try {
                const response = await chat.sendMessage({ message });
                if (response && response.text) {
                    // Simula lo streaming dividendo la risposta in chunk
                    const fullText = response.text;
                    const chunkSize = 10;
                    for (let i = 0; i < fullText.length; i += chunkSize) {
                        yield fullText.substring(i, Math.min(i + chunkSize, fullText.length));
                        // Piccolo delay per simulare lo streaming
                        await new Promise(resolve => setTimeout(resolve, 20));
                    }
                } else {
                    throw new Error("Empty response from API");
                }
            } catch (error) {
                console.error("Send message error:", error);
                throw error;
            }
        };
        const sendMessageStream = window.sendMessageStream;

        // --- Funzioni per la formattazione del testo ---
        const formatMessageContent = (text) => {
            let formattedText = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.split('\n\n').map(p => p.trim() ? `<p>${p.trim().replace(/\n/g, '<br>')}</p>` : '').join('');
            return formattedText;
        };

        // --- React Components ---

        const ToolCardMessage = ({ tool, onOpenDetail, lang }) => (
            <div className="chat-tool-card">
                <div className="logo-container">
                    <img src={tool.logoUrl || ''} className="tool-logo" alt={tool.name} loading="lazy" />
                </div>
                <div className="info">
                    <div className="tool-name">{tool.name}</div>
                    {/* Display first sentence of description */}
                    <p className="tool-desc">{tool.description.split('.')[0]}.</p>
                    <button className="details-btn" onClick={() => onOpenDetail(tool.id)}>
                        {lang === 'it' ? 'Vedi Dettagli' : 'View Details'}
                    </button>
                </div>
            </div>
        );

        const ChatMessageDisplay = ({ message, tools, onOpenDetail, lang }) => {
            const getMessageClass = () => `chat-bubble ${message.sender}`;

            if (message.sender === MessageSender.LOADING) {
                return <div className="chat-bubble loading"><span></span><span></span><span></span></div>;
            }

            if (message.sender === MessageSender.MODEL) {
                const allTools = window.getAllToolsForCurrentUser ? window.getAllToolsForCurrentUser() : window.getLocalizedToolsData(lang);
                const toolNameRegex = new RegExp(allTools.map(t => t.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|'), 'g');
                const mentionedToolNames = [...new Set(message.text.match(toolNameRegex))];
                const isToolListResponse = mentionedToolNames.length > 0 && message.text.includes('•');

                if (isToolListResponse) {
                    // Logica esistente per renderizzare le card degli strumenti
                    const mentionedTools = allTools.filter(tool => mentionedToolNames.includes(tool.name));
                    const lines = message.text.trim().split('\n');
                    const introLine = lines.find(line => !line.trim().startsWith('•'));
                    const introContent = introLine ? formatMessageContent(introLine) : '';

                    return (
                        <>
                            {introLine && <div className="chat-bubble ai" dangerouslySetInnerHTML={{ __html: introContent }}></div>}
                            <div className="chat-bubble ai" style={{ background: 'transparent', padding: 0, marginTop: introLine ? '8px' : '0' }}>
                                <div className="chat-tool-card-container">
                                    {mentionedTools.map(tool => <ToolCardMessage key={tool.id} tool={tool} onOpenDetail={onOpenDetail} lang={lang} />)}
                                </div>
                            </div>
                        </>
                    );
                } else {
                    // NUOVA LOGICA: Per i messaggi AI di solo testo (come le domande di chiarimento)
                    // Renderizza il testo con un contenitore trasparente, facendolo apparire fluttuante.
                    // NUOVA LOGICA: Per i messaggi AI di solo testo (come le domande di chiarimento)
                    // Aggiunge una classe specifica per gestirne lo stile in CSS.
                    const content = formatMessageContent(message.text);
                    return (
                        <div className="chat-bubble ai is-floating-text" dangerouslySetInnerHTML={{ __html: content }}></div>
                    );
                }
            }

            // Fallback per tutti gli altri tipi di messaggi (USER, ERROR, SYSTEM)
            const content = formatMessageContent(message.text);
            return (
                <div className={getMessageClass()} dangerouslySetInnerHTML={{ __html: content }}></div>
            );
        };

        const ChatInput = ({ onSendMessage, isLoading, lang }) => {
            const [inputValue, setInputValue] = useState('');
            const textareaRef = useRef(null);

            useEffect(() => {
                const textarea = textareaRef.current;
                if (textarea) {
                    textarea.style.height = 'auto';
                    textarea.style.height = `${textarea.scrollHeight}px`;
                }
            }, [inputValue]);

            const handleSubmit = () => {
                if (inputValue.trim() && !isLoading) {
                    onSendMessage(inputValue.trim());
                    setInputValue('');
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSubmit();
                }
            };

            return (
                <div id="chat-input-container">
                    <textarea
                        ref={textareaRef}
                        id="chat-input"
                        value={inputValue}
                        onChange={(e) => setInputValue(e.target.value)}
                        onKeyDown={handleKeyPress}
                        placeholder={lang === 'it' ? "Chiedimi qualcosa..." : "Ask me anything..."}
                        rows={1}
                        disabled={isLoading}
                    />
                    <button
                        id="chat-send-btn"
                        type="button"
                        onClick={handleSubmit}
                        disabled={isLoading || !inputValue.trim()}
                        aria-label={lang === 'it' ? "Invia messaggio" : "Send message"}
                    >
                        ↑
                    </button>
                </div>
            );
        };

        const WelcomeScreen = ({ onSendMessage, lang }) => {
            const suggestions = {
                it: ["Consigliami AI per creare immagini", "Quali sono le alternative a ChatGPT?"],
                en: ["Suggest an AI for creating images", "What are ChatGPT's alternatives?"]
            };

            return (
                <div id="welcome-screen">
                    <div className="welcome-logo">
                        <span style={{ color: 'var(--Koda-text)' }}>Koda</span><span style={{ color: 'var(--Koda-accent)' }}>.AI</span>
                    </div>
                    {/* NUOVO: Pulsante principale per suggerimenti AI di programmazione */}
                    <div className="main-action-container">
                        <button className="main-action-btn" onClick={() => onSendMessage(lang === 'it' ? 'Consigliami AI per programmare' : 'Suggest AI tools for coding')}>
                            {lang === 'it' ? 'Consigliami AI per programmare' : 'Suggest AI tools for coding'}
                        </button>
                    </div>
                    <div className="prompt-starter-container">
                        {suggestions[lang].map((text, i) => (
                            <button key={i} className="prompt-starter-btn" onClick={() => onSendMessage(text)}>
                                {text}
                            </button>
                        ))}
                    </div>
                    {/* NUOVO: Contenitore per i pulsanti di azione */}
                    <div className="prompt-actions-container">
                        <button className="action-btn primary" data-action="navigate-to-optimizer">
                            {lang === 'it' ? "Ottimizza Prompt" : "Optimize Prompt"}
                        </button>
                        <button className="action-btn tertiary" data-action="show-prompt-gallery">
                            {lang === 'it' ? "Galleria Prompt" : "Prompt Gallery"}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = ({ tools, initialConversations, initialActiveId, onConversationsChange, onOpenDetail, lang, pageTitle, globalControlsHTML }) => {
            const [conversations, setConversations] = useState(initialConversations);
            const [activeConversationId, setActiveConversationId] = useState(initialActiveId);
            const [isLoading, setIsLoading] = useState(false);
            const [chatSession, setChatSession] = useState(null);
            const messagesEndRef = useRef(null);

            const activeConversation = conversations[activeConversationId] || { messages: [] };
            const messages = activeConversation.messages;

            useEffect(() => { onConversationsChange(conversations); }, [conversations, onConversationsChange]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

            const initializeChat = useCallback(() => {
                try {
                    if (!API_KEY) throw new Error("API Key not configured.");
                    const newSession = createChatSession(lang);
                    setChatSession(newSession);
                } catch (e) {
                    console.error("Initialization Error:", e);
                }
            }, [lang]);

            useEffect(() => { initializeChat(); }, [initializeChat]);

            const handleSendMessage = async (inputText) => {
                if (!inputText.trim() || !chatSession) return;

                const userMessage = { id: `user-${Date.now()}`, text: inputText, sender: MessageSender.USER };
                const loadingMessage = { id: `loading-${Date.now()}`, sender: MessageSender.LOADING };

                const isNewChat = messages.length === 0;
                const newTitle = inputText.substring(0, 30) + (inputText.length > 30 ? '...' : '');

                setConversations(prev => ({
                    ...prev,
                    [activeConversationId]: {
                        ...prev[activeConversationId],
                        title: isNewChat ? newTitle : prev[activeConversationId].title,
                        messages: [...(prev[activeConversationId]?.messages || []), userMessage, loadingMessage]
                    }
                }));

                setIsLoading(true);

                let currentModelMessageId = `model-${Date.now()}`;
                let accumulatedResponse = "";

                try {
                    const stream = sendMessageStream(chatSession, inputText);
                    let chunkCount = 0;
                    for await (const chunk of stream) {
                        chunkCount++;
                        accumulatedResponse += chunk;
                        setConversations(prev => {
                            const currentMessages = prev[activeConversationId].messages.filter(m => m.sender !== MessageSender.LOADING);
                            const modelMsgIndex = currentMessages.findIndex(m => m.id === currentModelMessageId);

                            const newModelMessage = { id: currentModelMessageId, text: accumulatedResponse, sender: MessageSender.MODEL };

                            if (modelMsgIndex > -1) {
                                currentMessages[modelMsgIndex] = newModelMessage;
                            } else {
                                currentMessages.push(newModelMessage);
                            }

                            return {
                                ...prev,
                                [activeConversationId]: { ...prev[activeConversationId], messages: currentMessages }
                            };
                        });
                    }
                    console.log(`Streaming completed. Chunks received: ${chunkCount}, Total length: ${accumulatedResponse.length}`);

                    // Se la risposta è troppo corta (meno di 5 caratteri), potrebbe essere un errore
                    if (accumulatedResponse.length < 5) {
                        console.warn("Response too short, possible streaming issue");
                    }
                } catch (e) {
                    console.error("Send Error:", e);
                    const errorMessageText = lang === 'it' ? `Si è verificato un errore. Riprova.` : `An error occurred. Please try again.`;
                    const errorMessage = { id: `error-${Date.now()}`, text: errorMessageText, sender: MessageSender.ERROR };
                    setConversations(prev => ({
                        ...prev,
                        [activeConversationId]: {
                            ...prev[activeConversationId],
                            messages: prev[activeConversationId].messages.filter(m => m.sender !== MessageSender.LOADING).concat(errorMessage)
                        }
                    }));
                } finally {
                    setIsLoading(false);
                    setConversations(prev => ({
                        ...prev,
                        [activeConversationId]: {
                            ...prev[activeConversationId],
                            messages: prev[activeConversationId].messages.filter(m => m.sender !== MessageSender.LOADING)
                        }
                    }));
                    document.getElementById('chat-input')?.focus();
                }
            };

            const hasStartedChat = messages.some(m => m.sender === MessageSender.USER);

            return (
                <div id="chatbot-app-container" className={hasStartedChat ? 'chat-started' : ''}>
                    <main>
                        {!hasStartedChat ? (
                            <WelcomeScreen onSendMessage={handleSendMessage} lang={lang} />
                        ) : (
                            <div id="chat-messages">
                                {messages.map((msg) => <ChatMessageDisplay key={msg.id} message={msg} tools={tools} onOpenDetail={onOpenDetail} lang={lang} />)}
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </main>
                    <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} lang={lang} />
                </div>
            );
        };

        // Funzione globale per montare l'app React
        window.mountChatbotApp = (container, props) => {
            const root = ReactDOMClient.createRoot(container);
            root.render(<React.StrictMode><App {...props} /></React.StrictMode>);
            return root;
        };


    </script>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, collection, query, where, getDocs, addDoc, serverTimestamp, onSnapshot, orderBy, limit, writeBatch, deleteDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDLouTZcRN28riyxBY06XYkWCsGkYbYm-o",
            authDomain: "n8n-riccardo-29-aprile.firebaseapp.com",
            projectId: "n8n-riccardo-29-aprile",
            storageBucket: "n8n-riccardo-29-aprile.firebaseapp.com",
            messagingSenderId: "785683001992",
            appId: "1:785683001992:web:d24e375041fb7c0f18653d",
            measurementId: "G-B78J4HK2NX"
        };

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // NUOVO: Definizioni SVG per le icone della password
        const eyeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
        const eyeSlashIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;

        // NUOVO: Funzione per gestire il toggle della visibilità della password
        const handlePasswordVisibilityToggle = (button) => {
            const inputId = button.dataset.toggleFor;
            const input = document.getElementById(inputId);
            if (!input) return;

            if (input.type === "password") {
                input.type = "text";
                button.innerHTML = eyeSlashIconSVG;
            } else {
                input.type = "password";
                button.innerHTML = eyeIconSVG;
            }
        };

        // **NUOVO:** Espone funzioni e oggetti Firestore globalmente per i componenti React
        window.db = db;
        window.getDocs = getDocs;
        window.getDoc = getDoc; // Aggiunto per recuperare singoli documenti
        window.doc = doc; // Aggiunto per creare riferimenti a documenti
        window.collection = collection;



        document.addEventListener('DOMContentLoaded', () => {

            // --- LOGICA DI TRADUZIONE ---
            const translations = window.translations = {
                it: {
                    // Auth
                    createAccount: "Crea il tuo account", registerEmailLabel: "Email", registerEmailPlaceholder: "nome@esempio.com",
                    registerPasswordLabel: "Password", registerPasswordPlaceholder: "Minimo 6 caratteri", registerButton: "Registrati",
                    switchToLogin: "Hai già un account? Accedi", loginTitle: "Accedi", loginButton: "Accedi",
                    switchToRegister: "Non hai un account? Registrati", forgotPasswordLink: "Password dimenticata?",
                    resetPasswordTitle: "Reimposta Password", resetPasswordInfo: "Inserisci la tua email e ti invieremo un link per reimpostare la password.",
                    sendLinkButton: "Invia Link", backToLogin: "Torna al Login",
                    passwordResetSent: "Se l'utente esiste, un link per il reset è stato inviato a %s.",
                    registerNicknameLabel: "Nickname",
                    registerNicknamePlaceholder: "Es. Koda",
                    registerFullNameLabel: "Nome Completo",
                    registerFullNamePlaceholder: "Es. Mario Rossi",
                    nicknameRequired: "Il nickname è obbligatorio.",
                    fullNameRequired: "Il nome completo è obbligatorio.",
                    // App
                    navHome: "Home", navTopAI: "TOP AI", navSearch: "Cerca", navSearchUsers: "Utenti", navLibrary: "Libreria",
                    pageTitleHome: "Koda", pageTitleTopAI: "TOP AI", pageTitleSearch: "Cerca", pageTitleSearchUsers: "Utenti", pageTitleLibrary: "Libreria", pageTitleCinema: "Cinema",
                    navCinemaVideos: "Video", navCinemaFavorites: "Preferiti", navCinemaPlaylists: "Playlist",
                    logout: "Logout", featured: "In evidenza", featuredDisclaimer: "Basate su preferenze personali", rankingsTitle: "Classifiche TOP AI", filterAll: "Tutti",
                    searchPlaceholder: "Cerca strumenti, categorie...", browseAll: "Sfoglia tutto", browseByOrigin: "Sfoglia per nazionalità",
                    multiSelect: "Selezione", cancelSelection: "Annulla", addToFavorites: "Aggiungi ai preferiti", addToCollection: "Aggiungi a collezione", itemsSelected: "%d selezionati",
                    backToSearch: "‹ Torna a cercare", toolsFrom: "Strumenti da", libraryPromptTitle: "Salva i tuoi preferiti",
                    pricingFree: "Gratuito", pricingFreemium: "Freemium", pricingPaid: "A Pagamento",
                    categoryTutorial: "Tutorial", categoryEducation: "Educazione", categoryDevelopment: "Sviluppo", categoryNews: "Notizie",
                    libraryPromptText: "Accedi o registrati per salvare i preferiti.", emptyFavorites: "Aggiungi AI ai tuoi preferiti",
                    noResultsFor: "Nessun risultato per",
                    // Rankings
                    rankingTextTitle: "Classifica per il testo", rankingCodeTitle: "Classifica per il codice",
                    rankingImagesTitle: "Classifica per le immagini", rankingWebSearchTitle: "Classifica per la Ricerca Web",
                    // Modal
                    detailModalRemoveFavorite: "Rimuovi dai Preferiti", detailModalAddFavorite: "Aggiungi ai Preferiti",
                    visitWebsite: "Visita Sito Web", alternativeSuggestion: "In alternativa prova:",
                    // Settings Modal
                    settingsTitle: "Impostazioni account", changePasswordTitle: "Cambia password", newPasswordLabel: "Nuova password",
                    sentReviews: "Recensioni inviate", noSentReviews: "Non hai ancora inviato recensioni.", viewAllUserReviews: "Visualizza tutte le recensioni utente", allUserReviews: "Tutte le recensioni utente",
                    newPasswordPlaceholder: "Minimo 6 caratteri", confirmPasswordLabel: "Conferma password", confirmPasswordPlaceholder: "Reinserisci la Nuova password",
                    savePasswordButton: "Salva Password", passwordUpdateSuccess: "Password aggiornata con successo!",
                    passwordTooShort: "La password deve contenere almeno 6 caratteri.", passwordsDoNotMatch: "Le password non coincidono.",
                    updatePasswordError: "Errore: %s. Potrebbe essere necessario effettuare nuovamente il login.",
                    // Side Menu
                    history: "Cronologia", newChat: "Nuova chat", deleteAll: "Elimina tutto", discoverMoreLink: "Clicca per scoprire di piu'",
                    confirmDeleteAll: "Sei sicuro di voler eliminare tutte le conversazioni? Questa azione è irreversibile.",
                    newChatTitle: "Nuova chat",
                    // New Privileged User Translations (Local Storage)
                    privilegedUnlocked: "Modalità privilegiata sbloccata!",
                    addCustomApp: "Aggiungi app personalizzata", // New translation for the button
                    addAppTitle: "Aggiungi nuova app",
                    appNameLabel: "Nome App", appNamePlaceholder: "Es. ChatGPT",
                    appDescriptionLabel: "Descrizione", appDescriptionPlaceholder: "Breve descrizione dell'app...",
                    appWebsiteLabel: "Link Web", appWebsitePlaceholder: "https://sito.com",
                    appLogoLabel: "Logo (File Immagine)", // Updated label for file input
                    addAppButton: "Aggiungi app",
                    addAppSuccess: "App aggiunta con successo!",
                    appUpdateSuccess: "App aggiornata con successo!",
                    favoriteAdded: "Preferito aggiunto alla Libreria!",
                    favoriteRemoved: "Preferito rimosso dalla Libreria!",
                    addAppError: "Errore nell'aggiunta dell'app: %s",
                    markAsFeatured: "Segna come In evidenza",
                    unmarkAsFeatured: "Rimuovi da In evidenza",
                    featuredByYou: "In evidenza",
                    emptyUserFeatured: "Nessuna app segnata come In evidenza.", // Keeping translation key but not used in UI
                    emptyUserTools: "Nessuna app aggiunta da te.",
                    appNameRequired: "Il nome dell'app è obbligatorio.",
                    appWebsiteRequired: "Il link del sito web è obbligatorio.",
                    appLogoRequired: "Il logo è obbligatorio.", // Updated required message
                    category: "Categoria", // Added missing category translation
                    country: "Paese",
                    replaceFeaturedTitle: "Sostituisci AI In evidenza", // New translation
                    selectAppToFeature: "Seleziona un'app dalLibreria per metterla In evidenza:", // New translation
                    noUserApps: "Non hai ancora aggiunto app person.", // New translation
                    removeFeaturedReplacement: "Rimuovi Sostituzione", // New translation
                    removeUserTool: "Rimuovi App Custom",
                    editUserTool: "Modifica App Custom",
                    editAppTitle: "Modifica App",
                    deleteButton: "Elimina",
                    saveChanges: "Salva Modifiche",
                    confirmDeleteApp: "Sei sicuro di voler eliminare questa app? L'azione è irreversibile.",
                    changeNicknameTitle: "Cambia nickname",
                    saveNicknameButton: "Salva Nickname",
                    nicknameUpdateSuccess: "Nickname aggiornato con successo!",
                    aiSuggestionsTitle: "I tuoi suggerimenti AI",
                    addAiSuggestionTitle: "Aggiungi suggerimento AI",
                    aiSuggestionLabel: "Suggerimento AI",
                    aiSuggestionPlaceholder: "Scrivi il tuo suggerimento per un'AI...",
                    selectCategory: "Seleziona categoria",
                    selectCountry: "Seleziona paese",
                    cancel: "Annulla",
                    allFieldsRequired: "Tutti i campi sono obbligatori",
                    addAiSuggestionButton: "Aggiungi suggerimento",
                    removeAiSuggestion: "Rimuovi suggerimento",
                    aiSuggestionAdded: "Suggerimento aggiunto con successo!",
                    aiSuggestionRemoved: "Suggerimento rimosso con successo!",
                    searchUsersTitle: "Utenti",
                    searchUsersSubtitle: "Trova altri utenti e scopri i loro suggerimenti AI",
                    searchUsersPlaceholder: "Filtra le tue chat o email...",
                    searchUsersButton: "Cerca",
                    noUsersFound: "Nessun utente trovato.",
                    userSuggestionsTitle: "Suggerimenti di %s",
                    viewSuggestions: "Vedi Suggerimenti",
                    noSuggestions: "Nessun suggerimento disponibile.",
                    suggestion: "suggerimento",
                    suggestions: "suggerimenti",
                    filterHidden: "Nascoste", // NUOVO
                    restoreChat: "Ripristina chat", // NUOVO
                    // NUOVE TRADUZIONI LIBRERIA
                    libraryFavorites: "Preferiti",
                    libraryCustom: "Custom",
                    libraryCollections: "Collezioni",
                    editProfile: "Modifica profilo",
                    viewChats: "Visualizza chat",
                    // Traduzioni Collezioni
                    createCollection: "Crea collezione",
                    collectionName: "Nome collezione",
                    collectionNamePlaceholder: "Es. AI per Lavoro",
                    createCollectionButton: "Crea",
                    renameCollection: "Rinomina",
                    changeCover: "Cambia copertina",
                    deleteCollection: "Elimina collezione",
                    addToCollection: "Aggiungi a collezione",
                    removeFromCollection: "Rimuovi da collezione",
                    collectionCreated: "Collezione creata!",
                    collectionDeleted: "Collezione eliminata!",
                    collectionRenamed: "Collezione rinominata!",
                    coverChanged: "Copertina aggiornata!",
                    addedToCollection: "Aggiunto alla collezione!",
                    removedFromCollection: "Rimosso dalla collezione!",
                    emptyCollection: "Aggiungi dei preferiti",
                    emptyCollections: "Crea una collezione",
                    emptyPlaylist: "Aggiungi video alla playlist",
                    emptyPlaylists: "Crea una playlist",
                    emptyVideoFavorites: "Aggiungi video ai preferiti",
                    confirmDeleteCollection: "Sei sicuro di voler eliminare questa collezione?",
                    toolsCount: "%d strumenti",
                    toolCount: "%d strumento",
                    viewList: "Vista lista",
                    viewGrid: "Vista griglia",
                    viewChats: "Visualizza chat",
                    // NUOVE TRADUZIONI PER PROMPT CHAT
                    chatPromptTitle: "Chatta con altri utenti",
                    chatPromptText: "Accedi o registrati per iniziare a chattare e scoprire i suggerimenti degli altri.",
                    // NUOVE TRADUZIONI PER PROMPT OPTIMIZER
                    optimizerTitle: "Prompt Optimizer",
                    originalPromptLabel: "Prompt originale",
                    optimizedPromptLabel: "Prompt ottimizzato",
                    originalPromptPlaceholder: "Inserisci qui il tuo prompt originale...",
                    optimizedPromptPlaceholder: "L'output ottimizzato apparirà qui...",
                    requestChangesPlaceholder: "Richiedi modifiche (opzionale)",
                    optimizeButton: "Ottimizza",
                    copyButton: "Copia",
                    saveButton: "Salva",
                    optimizerHelperText: "Il Prompt Optimizer applicherà le <strong>migliori pratiche</strong> al tuo prompt.",
                    cancel: "Annulla",
                    confirmDeletePromptTitle: "Conferma Eliminazione",
                    confirmDeletePromptMessage: "Sei sicuro di voler eliminare questo prompt? L'azione è irreversibile.",
                    promptGalleryTitle: "Galleria Prompt",
                    searchPlaceholderGallery: "Cerca",

                    // Admin translations
                    addAI: "Aggiungi AI",
                    addAIToDatabase: "Aggiungi AI al Database",
                    aiNameLabel: "Nome AI",
                    aiNamePlaceholder: "Es. ChatGPT",
                    descriptionITLabel: "Descrizione (IT)",
                    descriptionITPlaceholder: "Descrizione in italiano...",
                    descriptionENLabel: "Descrizione (EN)",
                    descriptionENPlaceholder: "Descrizione in inglese...",
                    websiteLinkLabel: "Link Sito Web",
                    websiteLinkPlaceholder: "https://sito.com",
                    logoURLLabel: "Link Logo URL",
                    logoURLPlaceholder: "https://sito.com/logo.png",
                    categoryLabel: "Categoria",
                    countryLabel: "Paese",
                    countryPlaceholder: "USA, Cina...",
                    saveToDatabase: "Salva nel Database",
                    editAIInDatabase: "Modifica AI nel Database",
                    documentIdLabel: "ID Documento (non modificabile)",
                    saveChanges: "Salva Modifiche",
                    // NUOVE TRADUZIONI PER CATALOGO VIDEO (UTENTE)
                    videoCatalogTitle: "Cinema",
                    watchVideo: "Guarda",
                    backToApp: "Torna all'app",
                    videoDetail: "Dettaglio Video",
                    back: "Indietro",
                    backToCinema: "Torna al Cinema",
                    videoNotFound: "Video non trovato",
                    description: "Descrizione",
                    addToFavorites: "Aggiungi ai preferiti",
                    removeFromFavorites: "Rimuovi dai preferiti",
                    addToPlaylist: "Aggiungi a playlist",
                    watchOnYouTube: "Guarda su YouTube",
                    educationalPurpose: "Video a scopo didattico",
                    // Privacy
                    privacy: "Privacy",
                    privacyPolicyTitle: "Privacy Policy di Koda.AI",
                    privacySubtitle: "Termini di servizio",
                    privacyLastUpdate: "Ultimo aggiornamento: 1 Novembre 2025",
                    privacyIntro: "Questa applicazione (\"Koda.AI\") è fornita da Riccardo Giorgio Ponte e Davide Narracci.",
                    privacyDataControllerTitle: "Titolare del trattamento dei dati",
                    privacyDataController: "Riccardo Giorgio Ponte & Davide Narracci",
                    privacyContactEmail: "Indirizzo email di contatto del titolare: [pontuz12346@gmail.com]",
                    privacyDataTypesTitle: "Tipi di dati trattati",
                    privacyDataTypesIntro: "Questa applicazione non raccoglie dati personali identificativi come nome o email, né utilizza cookie di profilazione o strumenti di analisi statistica.",
                    privacyDataTypesNote: "Tuttavia, per fornire il suo servizio principale (il chatbot), l'applicazione interagisce con servizi di terze parti.",
                    privacyNavigationData: "Dati di navigazione:",
                    privacyNavigationDataDesc: "Durante il normale funzionamento, i sistemi informatici acquisiscono alcuni dati la cui trasmissione è implicita nell'uso dei protocolli di comunicazione di internet. In questa categoria di dati rientra l'indirizzo IP dell'utente. Questo dato viene tecnicamente trasmesso per poter ricevere una risposta dal chatbot.",
                    privacyUserData: "Dati forniti volontariamente dall'utente:",
                    privacyUserDataDesc: "I messaggi, le domande o i testi che l'utente scrive volontariamente all'interno del chatbot.",
                    privacyLocalStorageTitle: "Archiviazione locale dei dati (Local Storage)",
                    privacyLocalStorageIntro: "L'applicazione utilizza il local storage del browser per salvare alcune informazioni direttamente sul dispositivo dell'utente. Il local storage è una tecnologia che permette ai siti web di memorizzare dati nel browser, simile ai cookie ma con maggiore capacità di archiviazione.",
                    privacyLocalStorageWhatTitle: "Cosa viene salvato nel local storage:",
                    privacyLocalStoragePreferences: "• Preferenze dell'utente: come la lingua selezionata, il tema (modalità chiara/scura), e altre impostazioni di personalizzazione.",
                    privacyLocalStorageHistory: "• Cronologia delle conversazioni: i messaggi scambiati con il chatbot vengono salvati localmente per permetterti di ritrovare le tue conversazioni precedenti.",
                    privacyLocalStorageCollections: "• Collezioni e preferiti: le tue raccolte di strumenti AI e i tuoi preferiti vengono memorizzati sul tuo dispositivo.",
                    privacyLocalStorageState: "• Stato dell'applicazione: informazioni tecniche necessarie per il corretto funzionamento dell'app (es. se hai già visto il messaggio di benvenuto).",
                    privacyLocalStorageImportantTitle: "Importante da sapere:",
                    privacyLocalStoragePoint1: "• Tutti questi dati rimangono solo sul tuo dispositivo e non vengono mai inviati ai nostri server.",
                    privacyLocalStoragePoint2: "• Puoi cancellare questi dati in qualsiasi momento attraverso le impostazioni del tuo browser (solitamente nella sezione \"Privacy\" o \"Cancella dati di navigazione\").",
                    privacyLocalStoragePoint3: "• Se cancelli i dati del local storage, perderai le tue preferenze, la cronologia delle chat e le collezioni salvate.",
                    privacyLocalStoragePoint4: "• Questi dati sono accessibili solo da questa applicazione e solo sul browser e dispositivo che stai utilizzando.",
                    privacyPurposeTitle: "Finalità del trattamento",
                    privacyPurposeDesc: "I dati sopra menzionati sono trattati per l'unica finalità di permettere il funzionamento del chatbot e fornire una risposta all'utente. L'indirizzo IP è necessario per stabilire la comunicazione tra il browser dell'utente e il servizio di intelligenza artificiale. I testi inseriti dall'utente sono necessari per generare una risposta pertinente.",
                    privacyPurposeNote: "Noi, in qualità di titolari, non conserviamo né archiviamo le conversazioni o gli indirizzi IP degli utenti.",
                    privacyThirdPartiesTitle: "Destinatari dei dati (terze parti)",
                    privacyThirdPartiesIntro: "Per poter funzionare, il chatbot invia i dati di navigazione (indirizzo IP) e i testi inseriti dall'utente al seguente fornitore di servizi di intelligenza artificiale:",
                    privacyThirdPartiesGoogle: "Google LLC (Google GenAI API)",
                    privacyThirdPartiesGoogleDesc: "Il servizio è soggetto alle politiche sulla privacy di Google. Per maggiori informazioni, si prega di consultare la loro documentazione.",
                    privacyThirdPartiesLocation: "Luogo del trattamento: Stati Uniti – privacy policy di Google.",
                    privacyRightsTitle: "Diritti dell'interessato",
                    privacyRightsIntro: "Ai sensi del regolamento europeo 679/2016 (GDPR), l'utente ha diritto di:",
                    privacyRightsList: "• Chiedere al titolare del trattamento l'accesso ai dati personali, la rettifica, la cancellazione o la limitazione del trattamento.\n• Opporsi al trattamento.\n• Proporre reclamo a un'autorità di controllo.",
                    privacyRightsNote: "Dato che non conserviamo dati personali, l'esercizio di tali diritti può essere rivolto principalmente verso le terze parti menzionate. Per qualsiasi domanda, è possibile contattarci all'indirizzo email sopra indicato.",
                    privacyChangesTitle: "Modifiche a questa privacy policy",
                    privacyChangesDesc: "Il titolare del trattamento si riserva il diritto di apportare modifiche alla presente privacy policy in qualunque momento, dandone pubblicità agli utenti su questa pagina.",
                    privacyReminderTitle: "Benvenuto in Koda.AI",
                    privacyReminderMessage: "Prima di iniziare, ti invitiamo a leggere la nostra privacy policy per comprendere come trattiamo i tuoi dati.",
                    privacyReminderDontShow: "Non mostrare più questo messaggio",
                    privacyReminderReadBtn: "Leggi Privacy Policy",
                    privacyReminderContinueBtn: "Continua",
                },
                en: {
                    // Auth
                    createAccount: "Create Your Account", registerEmailLabel: "Email", registerEmailPlaceholder: "name@example.com",
                    registerPasswordLabel: "Password", registerPasswordPlaceholder: "Minimum 6 characters", registerButton: "Sign Up",
                    switchToLogin: "Already have an account? Log In", loginTitle: "Log In", loginButton: "Log In",
                    switchToRegister: "Don't have an account? Sign Up", forgotPasswordLink: "Forgot password?",
                    resetPasswordTitle: "Reset Password", resetPasswordInfo: "Enter your email and we'll send you a link to reset your password.",
                    sendLinkButton: "Send Link", backToLogin: "Back to Login",
                    passwordResetSent: "If the user exists, a reset link has been sent to %s.",
                    registerNicknameLabel: "Nickname",
                    registerNicknamePlaceholder: "Ex. Koda",
                    registerFullNameLabel: "Full Name",
                    registerFullNamePlaceholder: "Ex. John Doe",
                    nicknameRequired: "Nickname is required.",
                    fullNameRequired: "Full name is required.",
                    // App
                    navHome: "Home", navTopAI: "TOP AI", navSearch: "Search", navSearchUsers: "Users", navLibrary: "Library",
                    pageTitleHome: "Koda", pageTitleTopAI: "TOP AI", pageTitleSearch: "Search", pageTitleSearchUsers: "Search Users", pageTitleLibrary: "Your Library", pageTitleCinema: "Cinema",
                    navCinemaVideos: "Videos", navCinemaFavorites: "Favorites", navCinemaPlaylists: "Playlists",
                    logout: "Logout", featured: "Featured", featuredDisclaimer: "Based on personal preferences", rankingsTitle: "TOP AI Rankings", filterAll: "All",
                    searchPlaceholder: "Search tools, categories...", browseAll: "Browse All", browseByOrigin: "Browse by County",
                    multiSelect: "Multi-select", cancelSelection: "Cancel", addToFavorites: "Add to favorites", addToCollection: "Add to collection", itemsSelected: "%d selected",
                    backToSearch: "‹ Back to search", toolsFrom: "Tools from", libraryPromptTitle: "Save your favorites",
                    pricingFree: "Free", pricingFreemium: "Freemium", pricingPaid: "Paid",
                    categoryTutorial: "Tutorial", categoryEducation: "Education", categoryDevelopment: "Development", categoryNews: "News",
                    libraryPromptText: "Log in or sign up to save your favorites.", emptyFavorites: "Add AI to your favorites to see them here",
                    noResultsFor: "No results for",
                    // Rankings
                    rankingTextTitle: "Ranking for Text", rankingCodeTitle: "Ranking for Code",
                    rankingImagesTitle: "Ranking for Images", rankingWebSearchTitle: "Ranking for Web Search",
                    // Modal
                    detailModalRemoveFavorite: "Remove from Favorites", detailModalAddFavorite: "Add to Favorites",
                    visitWebsite: "Visit Website", alternativeSuggestion: "Alternatively, try:",
                    // Settings Modal
                    settingsTitle: "Account Settings", changePasswordTitle: "Change Password", newPasswordLabel: "New Password",
                    sentReviews: "Sent Reviews", noSentReviews: "You haven't sent any reviews yet.", viewAllUserReviews: "View all user reviews", allUserReviews: "All User Reviews",
                    newPasswordPlaceholder: "Minimum 6 characters", confirmPasswordLabel: "Confirm Password", confirmPasswordPlaceholder: "Re-enter new password",
                    savePasswordButton: "Save Password", passwordUpdateSuccess: "Password updated successfully!",
                    passwordTooShort: "Password must be at least 6 characters long.", passwordsDoNotMatch: "Passwords do not match.",
                    updatePasswordError: "Error: %s. You might need to log in again.",
                    // Side Menu
                    history: "History", newChat: "New Chat", deleteAll: "Delete All", discoverMoreLink: "Click to find out more",
                    confirmDeleteAll: "Are you sure you want to delete all conversations? This action is irreversible.",
                    newChatTitle: "New Chat",
                    // New Privileged User Translations (Local Storage)
                    privilegedUnlocked: "Privileged mode unlocked!",
                    addCustomApp: "Add Custom App", // New translation for the button
                    addAppTitle: "Add New App",
                    appNameLabel: "App Name", appNamePlaceholder: "Ex. ChatGPT",
                    appDescriptionLabel: "Description", appDescriptionPlaceholder: "Brief description of the app...",
                    appWebsiteLabel: "Website Link", appWebsitePlaceholder: "https://yourwebsite.com",
                    appLogoLabel: "Logo (Image File)", // Updated label for file input
                    addAppButton: "Add App",
                    addAppSuccess: "App added successfully!",
                    appUpdateSuccess: "App updated successfully!",
                    favoriteAdded: "Favorite added to Library!",
                    favoriteRemoved: "Favorite removed from Library!",
                    addAppError: "Error adding app: %s",
                    markAsFeatured: "Mark as Featured",
                    unmarkAsFeatured: "Unmark as Featured",
                    featuredByYou: "Featured by You",
                    emptyUserFeatured: "No apps marked as Featured by you.", // Keeping translation key but not used in UI
                    emptyUserTools: "No apps added by you.",
                    appNameRequired: "App name is required.",
                    appWebsiteRequired: "Website link is required.",
                    appLogoRequired: "Logo is required.", // Updated required message
                    category: "Category", // Added missing category translation
                    country: "Country",
                    replaceFeaturedTitle: "Replace Featured AI", // New translation
                    selectAppToFeature: "Select an app from your library to feature it:", // New translation
                    noUserApps: "You haven't added any custom apps yet.", // New translation
                    removeFeaturedReplacement: "Remove Replacement", // New translation
                    removeUserTool: "Remove Custom App",
                    editUserTool: "Edit Custom App",
                    editAppTitle: "Edit App",
                    deleteButton: "Delete",
                    saveChanges: "Save Changes",
                    confirmDeleteApp: "Are you sure you want to delete this app? This action is irreversible.",
                    changeNicknameTitle: "Change Nickname",
                    saveNicknameButton: "Save Nickname",
                    nicknameUpdateSuccess: "Nickname updated successfully!",
                    aiSuggestionsTitle: "Your AI Suggestions",
                    addAiSuggestionTitle: "Add AI Suggestion",
                    aiSuggestionLabel: "AI Suggestion",
                    aiSuggestionPlaceholder: "Write your AI suggestion...",
                    selectCategory: "Select category",
                    selectCountry: "Select country",
                    cancel: "Cancel",
                    allFieldsRequired: "All fields are required",
                    addAiSuggestionButton: "Add Suggestion",
                    removeAiSuggestion: "Remove suggestion",
                    aiSuggestionAdded: "Suggestion added successfully!",
                    aiSuggestionRemoved: "Suggestion removed successfully!",
                    searchUsersTitle: "Search Users",
                    searchUsersSubtitle: "Find other users and discover their AI suggestions",
                    searchUsersPlaceholder: "Search by nickname or email...",
                    searchUsersButton: "Search",
                    noUsersFound: "No users found.",
                    userSuggestionsTitle: "Suggestions by %s",
                    viewSuggestions: "View Suggestions",
                    noSuggestions: "No suggestions available.",
                    suggestion: "suggestion",
                    suggestions: "suggestions",
                    filterHidden: "Hidden", // NEW
                    restoreChat: "Restore chat", // NEW
                    // NEW LIBRARY TRANSLATIONS
                    libraryFavorites: "Favorites",
                    libraryCustom: "Custom",
                    libraryCollections: "Collections",
                    editProfile: "Edit profile",
                    viewChats: "View chats",
                    // Collections Translations
                    createCollection: "Create collection",
                    collectionName: "Collection name",
                    collectionNamePlaceholder: "e.g. Work AI Tools",
                    createCollectionButton: "Create",
                    renameCollection: "Rename",
                    changeCover: "Change cover",
                    deleteCollection: "Delete collection",
                    addToCollection: "Add to collection",
                    removeFromCollection: "Remove from collection",
                    collectionCreated: "Collection created!",
                    collectionDeleted: "Collection deleted!",
                    collectionRenamed: "Collection renamed!",
                    coverChanged: "Cover updated!",
                    addedToCollection: "Added to collection!",
                    removedFromCollection: "Removed from collection!",
                    emptyCollection: "Add AI to your favorites",
                    emptyCollections: "Create a collection",
                    emptyPlaylist: "Add videos to the playlist",
                    emptyPlaylists: "Create a playlist",
                    emptyVideoFavorites: "Add videos to favorites",
                    confirmDeleteCollection: "Are you sure you want to delete this collection?",
                    toolsCount: "%d tools",
                    toolCount: "%d tool",
                    viewList: "List view",
                    viewGrid: "Grid view",
                    viewChats: "View chats",
                    // NEW TRANSLATIONS FOR CHAT PROMPT
                    chatPromptTitle: "Chat with other users",
                    chatPromptText: "Log in or sign up to start chatting and discover others' suggestions.",
                    // NEW TRANSLATIONS FOR PROMPT OPTIMIZER
                    optimizerTitle: "Optimize for GPT-5",
                    originalPromptLabel: "Original prompt",
                    optimizedPromptLabel: "Optimized prompt",
                    originalPromptPlaceholder: "Enter your original prompt here...",
                    optimizedPromptPlaceholder: "The optimized output will appear here...",
                    requestChangesPlaceholder: "Request changes (optional)",
                    optimizeButton: "Optimize",
                    copyButton: "Copy",
                    saveButton: "Save",
                    optimizerHelperText: "Prompt Optimizer will apply <strong>best practices</strong> to your prompt.",
                    cancel: "Cancel",
                    confirmDeletePromptTitle: "Confirm Deletion",
                    confirmDeletePromptMessage: "Are you sure you want to delete this prompt? This action is irreversible.",
                    promptGalleryTitle: "Prompt Gallery",
                    searchPlaceholderGallery: "Search",
                    // Admin translations
                    addAI: "Add AI",
                    addAIToDatabase: "Add AI to Database",
                    aiNameLabel: "AI Name",
                    aiNamePlaceholder: "Ex. ChatGPT",
                    descriptionITLabel: "Description (IT)",
                    descriptionITPlaceholder: "Description in Italian...",
                    descriptionENLabel: "Description (EN)",
                    descriptionENPlaceholder: "Description in English...",
                    websiteLinkLabel: "Website Link",
                    websiteLinkPlaceholder: "https://website.com",
                    logoURLLabel: "Logo URL Link",
                    logoURLPlaceholder: "https://website.com/logo.png",
                    categoryLabel: "Category",
                    countryLabel: "Country",
                    countryPlaceholder: "USA, China...",
                    saveToDatabase: "Save to Database",
                    editAIInDatabase: "Edit AI in Database",
                    documentIdLabel: "Document ID (not editable)",
                    saveChanges: "Save Changes",
                    // NEW TRANSLATIONS FOR VIDEO CATALOG (USER)
                    videoCatalogTitle: "Cinema",
                    watchVideo: "Watch",
                    backToApp: "Back to app",
                    videoDetail: "Video Detail",
                    back: "Back",
                    backToCinema: "Back to Cinema",
                    videoNotFound: "Video not found",
                    description: "Description",
                    addToFavorites: "Add to favorites",
                    removeFromFavorites: "Remove from favorites",
                    addToPlaylist: "Add to playlist",
                    watchOnYouTube: "Watch on YouTube",
                    educationalPurpose: "Educational purpose videos",
                    // Privacy
                    privacy: "Privacy",
                    privacyPolicyTitle: "Koda.AI Privacy Policy",
                    privacySubtitle: "Terms of Service",
                    privacyLastUpdate: "Last updated: November 1, 2025",
                    privacyIntro: "This application (\"Koda.AI\") is provided by Riccardo Giorgio Ponte and Davide Narracci.",
                    privacyDataControllerTitle: "Data controller",
                    privacyDataController: "Riccardo Giorgio Ponte & Davide Narracci",
                    privacyContactEmail: "Controller contact email: [pontuz12346@gmail.com]",
                    privacyDataTypesTitle: "Types of data processed",
                    privacyDataTypesIntro: "This application does not collect personally identifiable information such as name or email, nor does it use profiling cookies or statistical analysis tools.",
                    privacyDataTypesNote: "However, to provide its main service (the chatbot), the application interacts with third-party services.",
                    privacyNavigationData: "Navigation data:",
                    privacyNavigationDataDesc: "During normal operation, computer systems acquire some data whose transmission is implicit in the use of internet communication protocols. This category of data includes the user's IP address. This data is technically transmitted to receive a response from the chatbot.",
                    privacyUserData: "Data voluntarily provided by the user:",
                    privacyUserDataDesc: "Messages, questions, or texts that the user voluntarily writes within the chatbot.",
                    privacyLocalStorageTitle: "Local data storage (Local Storage)",
                    privacyLocalStorageIntro: "The application uses the browser's local storage to save some information directly on the user's device. Local storage is a technology that allows websites to store data in the browser, similar to cookies but with greater storage capacity.",
                    privacyLocalStorageWhatTitle: "What is saved in local storage:",
                    privacyLocalStoragePreferences: "• User preferences: such as selected language, theme (light/dark mode), and other customization settings.",
                    privacyLocalStorageHistory: "• Conversation history: messages exchanged with the chatbot are saved locally to allow you to find your previous conversations.",
                    privacyLocalStorageCollections: "• Collections and favorites: your AI tool collections and favorites are stored on your device.",
                    privacyLocalStorageState: "• Application state: technical information necessary for the proper functioning of the app (e.g., whether you have already seen the welcome message).",
                    privacyLocalStorageImportantTitle: "Important to know:",
                    privacyLocalStoragePoint1: "• All this data remains only on your device and is never sent to our servers.",
                    privacyLocalStoragePoint2: "• You can delete this data at any time through your browser settings (usually in the \"Privacy\" or \"Clear browsing data\" section).",
                    privacyLocalStoragePoint3: "• If you delete local storage data, you will lose your preferences, chat history, and saved collections.",
                    privacyLocalStoragePoint4: "• This data is accessible only by this application and only on the browser and device you are using.",
                    privacyPurposeTitle: "Purpose of processing",
                    privacyPurposeDesc: "The data mentioned above is processed for the sole purpose of allowing the chatbot to function and provide a response to the user. The IP address is necessary to establish communication between the user's browser and the artificial intelligence service. The texts entered by the user are necessary to generate a relevant response.",
                    privacyPurposeNote: "We, as data controllers, do not store or archive users' conversations or IP addresses.",
                    privacyThirdPartiesTitle: "Data recipients (third parties)",
                    privacyThirdPartiesIntro: "To function, the chatbot sends navigation data (IP address) and texts entered by the user to the following artificial intelligence service provider:",
                    privacyThirdPartiesGoogle: "Google LLC (Google GenAI API)",
                    privacyThirdPartiesGoogleDesc: "The service is subject to Google's privacy policies. For more information, please consult their documentation.",
                    privacyThirdPartiesLocation: "Place of processing: United States – Google privacy policy.",
                    privacyRightsTitle: "Data subject rights",
                    privacyRightsIntro: "Under the European regulation 679/2016 (GDPR), the user has the right to:",
                    privacyRightsList: "• Request access to personal data, rectification, deletion, or limitation of processing from the data controller.\n• Object to processing.\n• Lodge a complaint with a supervisory authority.",
                    privacyRightsNote: "Since we do not store personal data, the exercise of these rights can be addressed primarily to the third parties mentioned. For any questions, you can contact us at the email address indicated above.",
                    privacyChangesTitle: "Changes to this privacy policy",
                    privacyChangesDesc: "The data controller reserves the right to make changes to this privacy policy at any time, giving notice to users on this page.",
                    privacyReminderTitle: "Welcome to Koda.AI",
                    privacyReminderMessage: "Before you begin, we invite you to read our privacy policy to understand how we handle your data.",
                    privacyReminderDontShow: "Don't show this message again",
                    privacyReminderReadBtn: "Read Privacy Policy",
                    privacyReminderContinueBtn: "Continue",
                }
            };

            const applyTranslations = (lang) => {
                const t = translations[lang];
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.dataset.translate;
                    if (t[key]) {
                        if (el.placeholder) el.placeholder = t[key];
                        else el.textContent = t[key];
                    }
                });
                // Re-render auth overlay content if visible to apply translations
                const authOverlay = document.getElementById('auth-overlay');
                if (authOverlay && authOverlay.style.display !== 'none') {
                    // Determine which card is currently visible
                    let visibleCardId = 'login-card'; // Default
                    if (authOverlay.querySelector('#register-card:not(.hidden)')) visibleCardId = 'register-card';
                    else if (authOverlay.querySelector('#forgot-password-card:not(.hidden)')) visibleCardId = 'forgot-password-card';

                    authOverlay.innerHTML = getAuthHTML(lang);
                    attachAuthListeners(); // Re-attach listeners after innerHTML change
                    showAuthCard(visibleCardId); // Show the previously visible card
                }
                // Re-render settings modal content if visible
                const settingsModal = document.getElementById('settings-modal');
                if (settingsModal && settingsModal.classList.contains('visible')) {
                    window.openSettingsModal(); // Re-open to regenerate content with new language
                }
                // Re-render add app modal content if visible
                const addAppModal = document.getElementById('add-app-modal');
                if (addAppModal && addAppModal.classList.contains('visible')) {
                    openAddAppModal(); // Re-open to regenerate content with new language
                }
                // Re-render replace featured modal content if visible
                const replaceFeaturedModal = document.getElementById('replace-featured-modal');
                if (replaceFeaturedModal && replaceFeaturedModal.classList.contains('visible')) {
                    // Need to know which static tool was being replaced to re-open correctly
                    // This requires storing the staticToolId when the modal is opened.
                    // For simplicity now, we'll just close it on language change.
                    closeModal();
                }
            };

            // --- DATABASE PERSONALIZZATO (CARICATO DA FIREBASE) ---
            let aiToolsData = []; // Questa variabile verrà popolata dinamicamente da Firestore
            let aiRankingsData = []; // NUOVO: Questa variabile conterrà i dati delle classifiche da Firestore
            let youtubeVideosData = []; // NUOVO: Conterrà i video da Firebase
            // NUOVA FUNZIONE per caricare gli strumenti da Firestore
            const fetchToolsFromFirestore = async () => {
                try {
                    const toolsCollectionRef = collection(db, "tools");
                    const querySnapshot = await getDocs(toolsCollectionRef);
                    const firestoreTools = [];
                    querySnapshot.forEach((doc) => {
                        // Aggiungiamo i dati del documento e usiamo l'ID del documento di Firestore come 'id' principale
                        firestoreTools.push({ ...doc.data(), id: doc.id });
                    });
                    console.log(`Successfully fetched ${firestoreTools.length} tools from Firestore.`);
                    return firestoreTools;
                } catch (error) {
                    console.error("Error fetching tools from Firestore:", error);
                    showToast("Could not load AI tools from the database.");
                    return []; // Restituisce un array vuoto in caso di errore
                }
            };
            // NUOVA FUNZIONE per caricare le classifiche da Firestore
            const fetchRankingsFromFirestore = async () => {
                try {
                    const rankingsCollectionRef = collection(db, "rankings");
                    const q = query(rankingsCollectionRef); // You can add orderBy here if you have an 'order' field
                    const querySnapshot = await getDocs(q);
                    const firestoreRankings = [];
                    querySnapshot.forEach((doc) => {
                        firestoreRankings.push({ ...doc.data(), id: doc.id });
                    });
                    console.log(`Successfully fetched ${firestoreRankings.length} rankings from Firestore.`);
                    return firestoreRankings;
                } catch (error) {
                    console.error("Error fetching rankings from Firestore:", error);
                    showToast("Could not load AI rankings from the database.");
                    return [];
                }
            };

            // NUOVA FUNZIONE per caricare i video da Firestore (ordinati per campo 'order' o data)
            const fetchVideosFromFirestore = async () => {
                try {
                    const videosCollectionRef = collection(db, "videos");
                    // Ordina per 'order' se esiste, altrimenti per data di creazione
                    const q = query(videosCollectionRef, orderBy("order", "asc"), orderBy("createdAt", "desc"));
                    const querySnapshot = await getDocs(q);
                    const firestoreVideos = [];
                    querySnapshot.forEach((doc) => {
                        firestoreVideos.push({ ...doc.data(), id: doc.id });
                    });
                    console.log(`Successfully fetched ${firestoreVideos.length} videos from Firestore.`);
                    return firestoreVideos;
                } catch (error) {
                    // Gestisce il caso in cui il campo 'order' non esista ancora su tutti i documenti
                    if (error.code === 'failed-precondition') {
                        console.warn("Composite index for videos not found, falling back to createdAt ordering. Please create the index in Firebase.");
                        const videosCollectionRef = collection(db, "videos");
                        const fallbackQuery = query(videosCollectionRef, orderBy("createdAt", "desc"));
                        const querySnapshot = await getDocs(fallbackQuery);
                        const firestoreVideos = [];
                        querySnapshot.forEach((doc) => firestoreVideos.push({ ...doc.data(), id: doc.id }));
                        return firestoreVideos;
                    }
                    console.error("Error fetching videos from Firestore:", error);
                    return [];
                }
            };
            // Funzione globale accessibile anche dallo script React
            window.getLocalizedToolsData = (lang) => {
                return aiToolsData.map(tool => ({ ...tool, description: tool.description[lang] || tool.description['en'] }));
            }
            window.aiToolsData = aiToolsData; // Keep static data accessible

            // MODIFICA: Le categorie ora hanno un ID e nomi traducibili
            const categories = [
                { id: 'Testo', name: { it: 'Testo', en: 'Text' }, color: '#2659A9' },
                { id: 'Immagini', name: { it: 'Immagini', en: 'Images' }, color: '#8D49F2' },
                { id: 'Video', name: { it: 'Video', en: 'Video' }, color: '#AF2896' },
                { id: 'Presentazioni', name: { it: 'Presentazioni', en: 'Presentations' }, color: '#E13300' },
                { id: 'Codice', name: { it: 'Codice', en: 'Code' }, color: '#BA5D07' },
                { id: 'Audio', name: { it: 'Audio', en: 'Audio' }, color: '#006450' },
                { id: 'Automation Tools', name: { it: 'Automazioni', en: 'Automation Tools' }, color: '#008080' },
                { id: 'Browser AI', name: { it: 'Browser AI', en: 'AI Browser' }, color: '#FF8C00' },
                { id: 'AI Playground', name: { it: 'AI Playground', en: 'AI Playground' }, color: '#FF69B4' },
                // Add a generic category for user tools if needed, or let user specify
                // For simplicity, let's allow user to pick from existing categories
            ];
            const countries = [...new Set(aiToolsData.map(t => t.country))]
                .filter(c => c !== 'Global' && c !== 'Italia') // <-- Rimuove anche "Italia"
                .map(c => {
                    // Se il paese è 'undefined', lo rinominiamo in "Nazione" e gli diamo una bandiera generica
                    if (c === undefined) {
                        return { name: 'Nazione', flag: '🏳️' };
                    }
                    // Altrimenti, procediamo come prima
                    return { name: c, flag: { 'USA': '🇺🇸', 'Cina': '🇨🇳', 'Europe': '🇪🇺' }[c] || '🏳️' };
                });

            // currentUser will now include Firestore data (favorites, userTools, userFeaturedTools, userFeaturedReplacements)
            // and the privileged status loaded from Firestore
            let currentUser = {};
            let currentView = 'home';
            let activeFilter = 'All'; // Filter for Favorites page
            let exploreFilter = { type: null, value: null }; // Filter for Explore page
            let rankingFilter = 'All'; // Filter for Top AI page
            let libraryTab = 'favorites'; // Variabile per la scheda attiva in Libreria
            let exploreMultiSelectMode = false; // Modalità selezione multipla per explore
            let exploreSelectedTools = []; // Array di ID degli strumenti selezionati in explore
            let libraryViewMode = localStorage.getItem('libraryViewMode') || 'list'; // 'list' o 'grid'
            let collections = JSON.parse(localStorage.getItem('collections') || '[]'); // Array di collezioni
            let activeCollectionId = null; // ID della collezione attualmente visualizzata
            let selectionMode = false; // Modalità selezione multipla
            let selectedTools = new Set(); // Set di tool IDs selezionati
            let reactRoot = null;
            let conversations = {};
            let activeConversationId = null;
            let currentLanguage = localStorage.getItem('koda-lang') || 'it';
            let currentTheme = localStorage.getItem('koda-theme') || 'dark';
            let searchTimeout = null; // For debouncing user search

            // State for K button click counter (still local)
            let kButtonClickCount = 0;
            let lastKButtonClickTime = 0;
            let kButtonClickTimeout = null;
            const K_BUTTON_CLICK_THRESHOLD = 5;
            const K_BUTTON_CLICK_RESET_DELAY = 500; // ms

            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79zM1 10.5h3v2H1zM11 .55h2V3.5h-2zm8.04 1.49l1.79-1.8-1.41-1.41-1.8 1.79zM20 10.5h3v2h-3zm-9.24 10.96l1.8 1.79 1.41-1.41-1.79-1.79zm-6.36-1.8l-1.79 1.8 1.41 1.41 1.8-1.79zM12 5.5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4z"/></svg>`;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M9.37 5.51A7.35 7.35 0 009.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 17.19 14.93 19 12 19c-3.86 0-7-3.14-7-7 0-2.93 1.81-5.45 4.37-6.49z"/></svg>`;
            // Pencil icon SVG for editing
            const pencilIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M14.06 9.02l.92.92L5.92 18H5v-.92l9.06-9.06zm4.6-4.6l-1.39-1.39c-.2-.2-.51-.2-.71 0l-1.83 1.83 3.29 3.29 1.83-1.83c.2-.2.2-.51 0-.71zM3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>`;


            const el = {
                mainContent: document.getElementById('main-content'),
                bottomNav: document.getElementById('bottom-nav'),
                modalContainer: document.getElementById('modal-container'),
                appContainer: document.getElementById('app-container'),
                authOverlay: document.getElementById('auth-overlay'),
                sideMenuOverlay: document.getElementById('side-menu-overlay'),
                sideMenu: document.getElementById('side-menu'),
                conversationListContainer: document.getElementById('conversation-list-container'),
            };

            const getStorageKey = () => `conversations_${currentUser.uid || 'guest'}`;

            const loadConversations = () => {
                const saved = localStorage.getItem(getStorageKey());
                conversations = saved ? JSON.parse(saved) : {};
                const savedActiveId = localStorage.getItem(`activeConversationId_${currentUser.uid || 'guest'}`);
                activeConversationId = savedActiveId && conversations[savedActiveId] ? savedActiveId : null;

                if (Object.keys(conversations).length === 0 || !activeConversationId) {
                    startNewChat(false);
                }
            };

            const saveConversations = (newConversations) => {
                conversations = newConversations; // Corrected variable name
                localStorage.setItem(getStorageKey(), JSON.stringify(conversations));
            };

            const saveActiveConversationId = () => {
                localStorage.setItem(`activeConversationId_${currentUser.uid || 'guest'}`, activeConversationId);
            }

            const startNewChat = (remountApp = true) => {
                const newId = `chat-${Date.now()}`;
                const t = translations[currentLanguage];
                conversations[newId] = { id: newId, title: t.newChatTitle, messages: [], timestamp: Date.now() };
                activeConversationId = newId;
                saveConversations(conversations);
                saveActiveConversationId();
                if (remountApp) {
                    renderView();
                }
                toggleSideMenu(false);
            };

            const showToast = (message) => {
                // This function is intentionally left empty to disable toast notifications as requested.
                // For debugging, you can log the message to the console instead:
                // console.log('Toast Message:', message);
            };

            // Espone la funzione showToast globalmente
            window.showToast = showToast;

            // NUOVA FUNZIONE: Ottiene il nome tradotto di una categoria
            const getTranslatedCategoryName = (categoryId) => {
                const category = categories.find(c => c.id === categoryId);
                return category ? category.name[currentLanguage] : categoryId;
            };

            // NEW FUNCTION: Get all tools (static + user's)
            window.getAllToolsForCurrentUser = () => { // Make it globally accessible for React
                const staticTools = window.getLocalizedToolsData(currentLanguage);
                const userTools = currentUser.userTools || []; // userTools now comes from currentUser (synced with Firestore)
                // Ensure user tools have localized descriptions if possible, or fallback
                const localizedUserTools = userTools.map(tool => ({
                    ...tool,
                    description: typeof tool.description === 'object' ? (tool.description[currentLanguage] || tool.description['en'] || '') : tool.description
                }));
                // Filtro per eliminare duplicati per id
                const allTools = [...staticTools, ...localizedUserTools];
                return allTools.filter((tool, idx, arr) => arr.findIndex(t => t.id === tool.id) === idx);
            };

            // ========================================
            // FUNZIONI PER GESTIRE LE COLLEZIONI
            // ========================================

            const saveCollections = () => {
                localStorage.setItem('collections', JSON.stringify(collections));
            };

            const createCollection = (name, coverImage = null) => {
                const newCollection = {
                    id: `collection-${Date.now()}`,
                    name: name,
                    coverImage: coverImage,
                    toolIds: [],
                    createdAt: Date.now()
                };
                collections.push(newCollection);
                saveCollections();
                return newCollection;
            };

            const deleteCollection = (collectionId) => {
                collections = collections.filter(c => c.id !== collectionId);
                saveCollections();
            };

            const renameCollection = (collectionId, newName) => {
                const collection = collections.find(c => c.id === collectionId);
                if (collection) {
                    collection.name = newName;
                    saveCollections();
                }
            };

            const updateCollectionCover = (collectionId, coverImage) => {
                const collection = collections.find(c => c.id === collectionId);
                if (collection) {
                    collection.coverImage = coverImage;
                    saveCollections();
                }
            };

            const addToolToCollection = (collectionId, toolId) => {
                const collection = collections.find(c => c.id === collectionId);
                if (collection && !collection.toolIds.includes(toolId)) {
                    collection.toolIds.push(toolId);
                    saveCollections();
                    return true;
                }
                return false;
            };

            const removeToolFromCollection = async (collectionId, toolId, skipConfirm = false) => {
                if (!skipConfirm) {
                    const confirmed = await showConfirmModal({
                        title: currentLanguage === 'it' ? 'Rimuovi dalla collezione' : 'Remove from collection',
                        message: currentLanguage === 'it'
                            ? 'Sei sicuro di voler rimuovere questa AI dalla collezione?'
                            : 'Are you sure you want to remove this AI from the collection?',
                        icon: '🗑️',
                        confirmText: currentLanguage === 'it' ? 'Rimuovi' : 'Remove',
                        cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                    });

                    if (!confirmed) {
                        return false; // Annulla l'operazione
                    }
                }

                const collection = collections.find(c => c.id === collectionId);
                if (collection) {
                    collection.toolIds = collection.toolIds.filter(id => id !== toolId);
                    saveCollections();
                    return true;
                }
                return false;
            };

            const isToolInCollection = (collectionId, toolId) => {
                const collection = collections.find(c => c.id === collectionId);
                return collection ? collection.toolIds.includes(toolId) : false;
            };

            // NUOVO: Funzioni per la selezione multipla
            const toggleSelectionMode = () => {
                selectionMode = !selectionMode;
                selectedTools.clear();
                renderView();
            };

            const toggleToolSelection = (toolId) => {
                if (selectedTools.has(toolId)) {
                    selectedTools.delete(toolId);
                } else {
                    selectedTools.add(toolId);
                }

                // Aggiorna il contatore
                const count = selectedTools.size;
                const countText = currentLanguage === 'it' ? `${count} selezionati` : `${count} selected`;
                const countElement = document.getElementById('selection-count');
                if (countElement) {
                    countElement.textContent = countText;
                }

                // Aggiorna lo stato del pulsante Rimuovi
                const removeBtn = document.querySelector('[data-action="remove-selected-from-collection"]');
                if (removeBtn) {
                    if (count === 0) {
                        removeBtn.setAttribute('disabled', 'true');
                    } else {
                        removeBtn.removeAttribute('disabled');
                    }
                }

                // Aggiorna visivamente la checkbox
                const checkboxes = document.querySelectorAll(`[data-action="toggle-tool-selection"][data-id="${toolId}"]`);
                checkboxes.forEach(cb => cb.classList.toggle('selected'));
            };

            const removeSelectedFromCollection = async () => {
                if (selectedTools.size === 0 || !activeCollectionId) return;

                const t = translations[currentLanguage];
                const count = selectedTools.size;
                const confirmed = await showConfirmModal({
                    title: currentLanguage === 'it' ? 'Rimuovi dalla collezione' : 'Remove from collection',
                    message: currentLanguage === 'it'
                        ? `Sei sicuro di voler rimuovere ${count} ${count === 1 ? 'elemento' : 'elementi'} da questa collezione?`
                        : `Are you sure you want to remove ${count} ${count === 1 ? 'item' : 'items'} from this collection?`,
                    icon: '🗑️',
                    confirmText: currentLanguage === 'it' ? 'Rimuovi' : 'Remove',
                    cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                });

                if (!confirmed) return;

                // Rimuovi tutti gli strumenti selezionati dalla collezione
                selectedTools.forEach(toolId => {
                    removeToolFromCollection(activeCollectionId, toolId, true);
                });

                // Reset selezione
                selectedTools.clear();
                selectionMode = false;

                renderView();
            };

            const getCollectionById = (collectionId) => {
                return collections.find(c => c.id === collectionId);
            };

            // Helper function to generate pricing badge HTML
            const getPricingBadgeHTML = (pricing) => {
                if (!pricing) return '';
                const t = translations[currentLanguage];
                const icons = {
                    free: '✅',
                    freemium: '💰',
                    paid: '💵'
                };
                const labels = {
                    free: t.pricingFree,
                    freemium: t.pricingFreemium,
                    paid: t.pricingPaid
                };
                return `<span class="pricing-badge ${pricing}">${icons[pricing]} ${labels[pricing]}</span>`;
            };

            // Helper function to generate category badge HTML for videos
            const getCategoryBadgeHTML = (category) => {
                if (!category) return '';
                const t = translations[currentLanguage];
                const icons = {
                    tutorial: '📚',
                    education: '🎓',
                    development: '💻',
                    news: '📰'
                };
                const labels = {
                    tutorial: t.categoryTutorial,
                    education: t.categoryEducation,
                    development: t.categoryDevelopment,
                    news: t.categoryNews
                };
                return `<span class="category-badge ${category}">${icons[category]} ${labels[category]}</span>`;
            };

            // Modified createGridCard to optionally show an edit icon and specify its action
            const createGridCard = (tool, context, options = {}) => {
                let editIconHTML = '';
                let removeIconHTML = '';
                let selectionCheckboxHTML = '';
                const isUserTool = tool.id.startsWith('user-');
                const t = translations[currentLanguage];

                // NUOVO: Mostra checkbox in modalità selezione per collezioni
                if (context === 'collection' && selectionMode) {
                    const isSelected = selectedTools.has(tool.id);
                    selectionCheckboxHTML = `<div class="selection-checkbox ${isSelected ? 'selected' : ''}" data-action="toggle-tool-selection" data-id="${tool.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>`;
                }

                // NUOVO: Mostra pulsante X per rimuovere dai preferiti
                if (context === 'favorites') {
                    removeIconHTML = `<div class="remove-favorite-icon" data-action="toggle-favorite" data-id="${tool.id}" title="${t.detailModalRemoveFavorite}">×</div>`;
                }
                // NUOVO: Mostra pulsante X per rimuovere dalla collezione (solo se non in modalità selezione)
                else if (context === 'collection' && !selectionMode) {
                    removeIconHTML = `<div class="remove-favorite-icon" data-action="remove-from-collection" data-id="${tool.id}" title="${currentLanguage === 'it' ? 'Rimuovi dalla collezione' : 'Remove from collection'}">×</div>`;
                }

                // Mostra icona di modifica per app custom dell'utente
                if (currentUser.uid) {
                    let action = '';
                    let title = '';
                    let dataId = tool.id;

                    if (context === 'user-featured-section' && isUserTool) {
                        // Pencil on user tool in Featured by You section -> Toggle Featured status
                        action = 'toggle-user-featured';
                        title = t.unmarkAsFeatured;
                    }
                    // NUOVO: Mostra icona di modifica per app custom nei preferiti/collezioni
                    else if (isUserTool && tool.id.includes(currentUser.uid)) {
                        action = 'open-edit-app-modal';
                        title = t.editUserTool;
                    }
                    // NUOVO: Mostra icona di modifica per admin
                    else if (currentUser.role === 'admin') {
                        action = 'open-edit-global-tool-modal';
                        title = 'Modifica AI (Admin)';
                    }

                    if (action && dataId) {
                        editIconHTML = `<div class="edit-icon" data-action="${action}" data-id="${dataId}" title="${title}"> ${pencilIcon} </div>`;
                    }
                }
                // NUOVO: Mostra icona di rimozione per guest users
                else if (!currentUser.uid && tool.id.startsWith('guest-')) {
                    editIconHTML = `<div class="edit-icon" data-action="remove-guest-tool" data-id="${tool.id}" title="Rimuovi">&times;</div>`;
                }

                const cardClass = selectionMode && context === 'collection' ? 'tool-card-grid stagger-item selectable' : 'tool-card-grid stagger-item';
                const pricingHTML = getPricingBadgeHTML(tool.pricing);
                return `<div class="${cardClass}" data-id="${tool.id}"><div class="logo-container"><img src="${tool.logoUrl}" class="tool-logo" alt="${tool.name}" loading="lazy">${selectionCheckboxHTML}${removeIconHTML}${editIconHTML}</div><div class="tool-name">${tool.name}</div>${pricingHTML}</div>`;
            };

            const createListCard = (tool, context) => {
                const isUserTool = tool.id.startsWith('user-');
                const isFavorited = currentUser.favorites.includes(tool.id);
                const t = translations[currentLanguage];

                // NUOVO: Mostra checkbox in modalità selezione per collezioni
                let favoriteIconHTML = '';
                if (context === 'collection' && selectionMode) {
                    const isSelected = selectedTools.has(tool.id);
                    favoriteIconHTML = `<div class="selection-checkbox-list ${isSelected ? 'selected' : ''}" data-action="toggle-tool-selection" data-id="${tool.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>`;
                }
                // NUOVO: Mostra X invece di cuore nei preferiti
                else if (context === 'favorites') {
                    favoriteIconHTML = `<div class="remove-favorite-icon-list" data-action="toggle-favorite" data-id="${tool.id}" title="${t.detailModalRemoveFavorite}">×</div>`;
                }
                // NUOVO: Mostra X per rimuovere dalla collezione
                else if (context === 'collection') {
                    favoriteIconHTML = `<div class="remove-favorite-icon-list" data-action="remove-from-collection" data-id="${tool.id}" title="${currentLanguage === 'it' ? 'Rimuovi dalla collezione' : 'Remove from collection'}">×</div>`;
                }
                else {
                    favoriteIconHTML = `<div class="favorite-icon ${isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-id="${tool.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                    </div>`;
                }

                let editIconHTML = '';
                // NUOVO: Mostra l'icona di modifica globale se l'utente è admin
                if (currentUser.role === 'admin') {
                    editIconHTML = `<div class="edit-icon" data-action="open-edit-global-tool-modal" data-id="${tool.id}" title="Modifica AI (Admin)"> ${pencilIcon} </div>`;
                }
                // Manteniamo la logica per gli utenti normali che modificano le proprie app custom
                else if (isUserTool && currentUser.uid && tool.id.includes(currentUser.uid)) {
                    editIconHTML = `<div class="edit-icon" data-action="open-edit-app-modal" data-id="${tool.id}" title="${t.editUserTool}"> ${pencilIcon} </div>`;
                }
                // NUOVO: Mostra l'icona di rimozione per le app custom degli utenti non loggati
                else if (!currentUser.uid && tool.id.startsWith('guest-')) {
                    editIconHTML = `<div class="edit-icon" data-action="remove-guest-tool" data-id="${tool.id}" title="Rimuovi">&times;</div>`;
                }

                const pricingHTML = getPricingBadgeHTML(tool.pricing);
                return `<div class="tool-card-list stagger-item" data-id="${tool.id}"><div class="logo-container"><img src="${tool.logoUrl}" class="tool-logo" alt="${tool.name}" loading="lazy">${editIconHTML}</div><div class="info"><div class="tool-name">${tool.name}</div><div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;"><div class="tool-subtext">${getTranslatedCategoryName(tool.category)}</div>${pricingHTML}</div></div>${favoriteIconHTML}</div>`;
            };

            const createCategoryCard = (category) => {
                const currentTools = window.getLocalizedToolsData(currentLanguage);
                const toolForLogo = currentTools.find(t => t.category === category.id) || { logoUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcBAMAAACAI8KnAAAAFVBMVEX///+ZmZkZGRlZWVmRkZEAAABGRkb6Me63AAAAHElEQVR4AWMYUCBkwKyIxHVNYAsZVFyEIwcSAADWIQrDIppSoAAAAABJRU5ErkJggg==' }; // Fallback per logo
                // Usa category.id per il filtro e category.name per la visualizzazione
                return `<div class="category-card stagger-item" style="background-color: ${category.color};" data-action="set-explore-filter" data-filter-type="category" data-filter-value="${category.id}"><h3>${category.name[currentLanguage]}</h3><div class="logo-container"><img src="${toolForLogo.logoUrl}" class="tool-logo" loading="lazy"></div></div>`;
            };
            const createCountryCard = (country) => `<div class="category-card stagger-item" style="background-color: #333;" data-action="set-explore-filter" data-filter-type="country" data-filter-value="${country.name}"><h3 style="font-size: 24px;">${country.flag} ${country.name}</h3></div>`;

            window.openDetailModal = async (toolId, addToHistory = true) => {
                // NUOVO: Aggiungi alla cronologia del browser
                if (addToHistory) {
                    history.pushState({ modal: 'detail', toolId: toolId, page: currentView }, '', '');
                }

                // Mostra un caricamento immediato per una migliore UX
                el.modalContainer.innerHTML = `
                <div id="detail-modal" class="modal-overlay visible">
                    <div class="modal-content" style="display: flex; align-items: center; justify-content: center; min-height: 200px;">
                        <div class="chat-bubble loading"><span></span><span></span><span></span></div>
                    </div>
                </div>
            `;

                let tool = null;

                // 1. Cerca lo strumento nella lista locale dell'utente corrente
                const localTools = getAllToolsForCurrentUser();
                tool = localTools.find(t => t.id === toolId);

                // 2. Se non è stato trovato ed è un'app utente, recuperala da Firestore
                if (!tool && toolId && toolId.startsWith('user-')) {
                    try {
                        // L'ID dell'utente che ha creato l'app è incorporato nell'ID dell'app stessa
                        const creatorId = toolId.split('-')[1];
                        if (creatorId) {
                            const userDocRef = doc(db, "users", creatorId);
                            const userDocSnap = await getDoc(userDocRef);
                            if (userDocSnap.exists()) {
                                const creatorTools = userDocSnap.data().userTools || [];
                                const remoteTool = creatorTools.find(t => t.id === toolId);
                                if (remoteTool) {
                                    // Traduci la descrizione prima di assegnarla
                                    const description = typeof remoteTool.description === 'object'
                                        ? (remoteTool.description[currentLanguage] || remoteTool.description['en'])
                                        : remoteTool.description;
                                    tool = { ...remoteTool, description };
                                }
                            }
                        }
                    } catch (error) {
                        console.error("Errore nel recupero dello strumento remoto:", error);
                    }
                }

                // 3. Se lo strumento non è ancora stato trovato, esci
                if (!tool) {
                    showToast("Dettagli dello strumento non trovati.");
                    closeModal();
                    return;
                }

                // 4. Ora che abbiamo lo strumento, costruisci e renderizza il modale completo
                const t = translations[currentLanguage];
                const isFavorited = currentUser.favorites.includes(toolId);
                const isUserTool = tool.id.startsWith('user-');
                const isMyUserTool = isUserTool && tool.id.includes(currentUser.uid); // Controlla se è la MIA app custom
                const isUserFeatured = isMyUserTool && currentUser.userFeaturedTools?.includes(toolId);

                let recommendationHTML = '';
                let recommendedTool = null;
                const allToolsForRec = getAllToolsForCurrentUser(); // Usa la lista locale per le raccomandazioni
                if (tool.recommendationId) {
                    recommendedTool = allToolsForRec.find(t => t.id === tool.recommendationId);
                } else {
                    const sameCategory = allToolsForRec.filter(t => t.category === tool.category && t.id !== tool.id);
                    if (sameCategory.length > 0) {
                        recommendedTool = sameCategory[Math.floor(Math.random() * sameCategory.length)];
                    }
                }
                if (recommendedTool) {
                    recommendationHTML = `<div class="recommendation-box" data-action="open-detail-modal" data-id="${recommendedTool.id}"><img src="${recommendedTool.logoUrl}" alt="${recommendedTool.name}" class="recommendation-logo" loading="lazy"><div class="recommendation-text">${t.alternativeSuggestion}<strong>${recommendedTool.name}</strong></div></div>`;
                }

                let userToolActionsHTML = '';
                // I pulsanti di modifica/evidenza appaiono solo se sono loggato e sto guardando una delle MIE app custom
                if (isMyUserTool && currentUser.isPrivileged) {
                    userToolActionsHTML = `<button class="button" data-action="toggle-user-featured" data-id="${tool.id}">${isUserFeatured ? t.unmarkAsFeatured : t.markAsFeatured}</button>`;
                }

                const modalHTML = `
                <div id="detail-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <div id="detail-content">
                            <h2>${tool.name}</h2>
                            <p>${tool.description}</p>
                            <div class="detail-tags">
                                <span class="tag">🌍 ${tool.country || 'N/A'}</span>
                                <span class="tag">${getTranslatedCategoryName(tool.category || 'N/A')}</span>
                                ${tool.pricing ? getPricingBadgeHTML(tool.pricing) : ''}
                            </div>
                            <div class="detail-actions">
                                ${userToolActionsHTML}
                                ${currentUser.uid ? `<button class="button" data-action="toggle-favorite" data-id="${tool.id}">${isFavorited ? t.detailModalRemoveFavorite : t.detailModalAddFavorite}</button>` : ''}
                                <button class="button" data-action="toggle-favorite" data-id="${tool.id}">${isFavorited ? t.detailModalRemoveFavorite : t.detailModalAddFavorite}</button>
                                <button class="button" data-action="add-to-collection" data-tool-id="${tool.id}" style="background: white; color: #000;">${t.addToCollection}</button>
                                <a href="${tool.website}" target="_blank" class="button" style="text-decoration: none; display: flex; justify-content: center; align-items: center; background: #8b5cf6; color: white;">${t.visitWebsite}</a>
                            </div>
                            ${recommendationHTML}
                        </div>
                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;

                // NUOVO: Inizializza lo stato del pulsante "Aggiungi a collezione"
                setTimeout(() => {
                    updateAddToCollectionButton(toolId);
                    loadReviews(toolId);
                }, 100);
            };

            const closeModal = () => {
                el.modalContainer.innerHTML = '';
                closeUserProfileDropdown();

                // NUOVO: Se c'è uno stato modale nella cronologia, torna indietro
                if (window.history.state && window.history.state.modal) {
                    window.history.back();
                }
            };

            // NUOVO: Funzione per aprire il modale di dettaglio video
            // MODIFICATO: Ora apre una pagina invece di un modale
            window.openVideoDetailPage = (videoId, addToHistory = true) => {
                console.log('openVideoDetailPage called with:', videoId);
                console.log('youtubeVideosData:', youtubeVideosData);

                // Salva l'ID del video corrente
                window.currentVideoId = videoId;

                // Cambia vista a video-detail
                currentView = 'video-detail';

                // NUOVO: Aggiungi alla cronologia del browser
                if (addToHistory) {
                    history.pushState({ page: 'video-detail', videoId: videoId }, '', `#video-${videoId}`);
                }

                // Renderizza la vista
                renderView();
                el.mainContent.scrollTop = 0;
            };

            // Mantieni la vecchia funzione per compatibilità
            window.openVideoDetailModal = window.openVideoDetailPage;

            // NUOVA FUNZIONE: Renderizza la pagina di dettaglio video
            const renderVideoDetailPage = (contentArea, t) => {
                const videoId = window.currentVideoId;
                const video = youtubeVideosData.find(v => v.id === videoId);

                if (!video) {
                    contentArea.innerHTML = `
                        <div style="padding: 40px; text-align: center;">
                            <h2>${t.videoNotFound || 'Video non trovato'}</h2>
                            <button class="button" data-action="back-to-cinema">${t.backToCinema || 'Torna al Cinema'}</button>
                        </div>
                    `;
                    return;
                }

                const videoFavorites = JSON.parse(localStorage.getItem('video-favorites') || '[]');
                const isFavorited = videoFavorites.includes(videoId);

                let videoIdFromUrl = '';
                try {
                    const url = new URL(video.youtubeUrl);
                    videoIdFromUrl = url.hostname === 'youtu.be' ? url.pathname.slice(1) : url.searchParams.get('v');
                } catch (e) { }

                const thumbnailUrl = videoIdFromUrl ? `https://img.youtube.com/vi/${videoIdFromUrl}/maxresdefault.jpg` : '';
                const videoDate = video.createdAt ? new Date(video.createdAt.seconds * 1000).toLocaleDateString(currentLanguage === 'it' ? 'it-IT' : 'en-US') : '';
                const description = video.description[currentLanguage] || video.description['en'] || '';

                contentArea.innerHTML = `
                    <div class="video-detail-page" style="padding: 20px; max-width: 1200px; margin: 0 auto;">
                        <div class="video-detail-container" style="background: var(--Koda-card); border-radius: 12px; overflow: hidden;">
                            <div class="video-player-container" style="position: relative; padding-bottom: 56.25%; height: 0; background: #000;">
                                <iframe 
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                    src="https://www.youtube.com/embed/${videoIdFromUrl}?autoplay=0" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                                </iframe>
                            </div>
                            
                            <div class="video-detail-info" style="padding: 24px;">
                                <h1 style="font-size: 24px; margin-bottom: 12px;">${video.title}</h1>
                                ${videoDate || video.category ? `<div style="color: var(--Koda-text-secondary); margin-bottom: 16px; font-size: 14px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">${videoDate ? `<span>${videoDate}</span>` : ''}${video.category ? getCategoryBadgeHTML(video.category) : ''}</div>` : ''}
                                
                                <div class="video-actions" style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                                    <button class="button video-action-btn" data-action="toggle-video-favorite" data-video-id="${videoId}" style="background: ${isFavorited ? 'var(--Koda-accent)' : 'var(--Koda-card)'}; color: ${isFavorited ? '#000' : 'var(--Koda-text)'}; border: 1px solid ${isFavorited ? 'var(--Koda-accent)' : 'rgba(128, 128, 128, 0.2)'}; font-weight: 600; text-transform: uppercase; font-size: 13px; letter-spacing: 0.5px;">
                                        ${isFavorited ? ' ' : ' '}${isFavorited ? (t.removeFromFavorites || 'Rimuovi dai preferiti') : (t.addToFavorites || 'Aggiungi ai preferiti')}
                                    </button>
                                    <button class="button video-action-btn" data-action="add-to-playlist" data-video-id="${videoId}" style="background: #6b46c1; color: white; border: 1px solid #6b46c1; font-weight: 600; text-transform: uppercase; font-size: 13px; letter-spacing: 0.5px;">
                                         ${t.addToPlaylist || 'Aggiungi a playlist'}
                                    </button>
                                    <a href="${video.youtubeUrl}" target="_blank" class="button video-action-btn" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; background: #ff0000; color: white; border: 1px solid #ff0000; font-weight: 600; text-transform: uppercase; font-size: 13px; letter-spacing: 0.5px;">
                                         ${t.watchOnYouTube || 'Guarda su YouTube'}
                                    </a>
                                </div>
                                
                                ${description ? `
                                    <div style="background: var(--Koda-bg-light); padding: 16px; border-radius: 8px;">
                                        <h3 style="font-size: 16px; margin-bottom: 12px;">${t.description || 'Descrizione'}</h3>
                                        <p style="line-height: 1.6; white-space: pre-wrap;">${description}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            };

            // NUOVO: Funzione per mostrare un modale di conferma custom in stile Koda
            const showConfirmModal = (options) => {
                return new Promise((resolve) => {
                    const { title, message, icon = '⚠️', confirmText, cancelText } = options;

                    const modalHTML = `
                        <div class="confirm-modal visible">
                            <div class="confirm-modal-content">
                                <div class="confirm-modal-icon">${icon}</div>
                                <h3 class="confirm-modal-title">${title}</h3>
                                <p class="confirm-modal-message">${message}</p>
                                <div class="confirm-modal-actions">
                                    <button class="confirm-cancel-btn" data-action="confirm-cancel">${cancelText}</button>
                                    <button class="confirm-ok-btn" data-action="confirm-ok">${confirmText}</button>
                                </div>
                            </div>
                        </div>
                    `;

                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalHTML;
                    document.body.appendChild(modalContainer);

                    const modal = modalContainer.querySelector('.confirm-modal');

                    // Gestisci i click sui pulsanti
                    const handleClick = (confirmed) => {
                        modal.classList.remove('visible');
                        setTimeout(() => {
                            modalContainer.remove();
                            resolve(confirmed);
                        }, 300);
                    };

                    modal.querySelector('[data-action="confirm-ok"]').addEventListener('click', () => handleClick(true));
                    modal.querySelector('[data-action="confirm-cancel"]').addEventListener('click', () => handleClick(false));

                    // Chiudi con ESC
                    const handleEsc = (e) => {
                        if (e.key === 'Escape') {
                            handleClick(false);
                            document.removeEventListener('keydown', handleEsc);
                        }
                    };
                    document.addEventListener('keydown', handleEsc);
                });
            };

            // Variable to store pending favorite action
            let pendingFavoriteAction = null;

            const toggleFavorite = async (toolId) => {
                const t = translations[currentLanguage];

                // Logica per utenti LOGGATI (usa Firestore)
                if (currentUser.uid) {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    const isFavorited = currentUser.favorites.includes(toolId);

                    // NUOVO: Chiedi conferma con modale custom prima di rimuovere dai preferiti
                    if (isFavorited) {
                        const confirmed = await showConfirmModal({
                            title: currentLanguage === 'it' ? 'Rimuovi dai preferiti' : 'Remove from favorites',
                            message: currentLanguage === 'it'
                                ? 'Sei sicuro di voler rimuovere questa AI dai preferiti?'
                                : 'Are you sure you want to remove this AI from favorites?',
                            icon: '💔',
                            confirmText: currentLanguage === 'it' ? 'Rimuovi' : 'Remove',
                            cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                        });

                        if (!confirmed) {
                            return; // Annulla l'operazione
                        }
                    }

                    try {
                        if (isFavorited) {
                            await updateDoc(userDocRef, { favorites: arrayRemove(toolId) });
                            currentUser.favorites = currentUser.favorites.filter(id => id !== toolId);
                        } else {
                            await updateDoc(userDocRef, { favorites: arrayUnion(toolId) });
                            currentUser.favorites.push(toolId);
                        }
                    } catch (error) {
                        console.error("Error updating favorites:", error);
                        showToast("Could not update favorites. Please try again.");
                        return;
                    }
                }
                // Logica per utenti OSPITI (usa localStorage)
                else {
                    let guestFavorites = JSON.parse(localStorage.getItem('guest-favorites')) || [];
                    const isFavorited = guestFavorites.includes(toolId);

                    // NUOVO: Chiedi conferma con modale custom prima di rimuovere dai preferiti
                    if (isFavorited) {
                        const confirmed = await showConfirmModal({
                            title: currentLanguage === 'it' ? 'Rimuovi dai preferiti' : 'Remove from favorites',
                            message: currentLanguage === 'it'
                                ? 'Sei sicuro di voler rimuovere questa AI dai preferiti?'
                                : 'Are you sure you want to remove this AI from favorites?',
                            icon: '💔',
                            confirmText: currentLanguage === 'it' ? 'Rimuovi' : 'Remove',
                            cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                        });

                        if (!confirmed) {
                            return; // Annulla l'operazione
                        }

                        guestFavorites = guestFavorites.filter(id => id !== toolId);
                        showToast(t.favoriteRemoved); // Notifica di rimozione
                    } else {
                        guestFavorites.push(toolId);
                        showToast(t.favoriteAdded); // Notifica di aggiunta
                    }

                    localStorage.setItem('guest-favorites', JSON.stringify(guestFavorites));
                    // Aggiorna l'oggetto currentUser locale per riflettere il cambiamento nella UI
                    currentUser.favorites = guestFavorites;
                }

                // Aggiorna immediatamente tutte le icone favorite per questo tool
                const isFavorited = currentUser.favorites.includes(toolId);
                document.querySelectorAll(`[data-action="toggle-favorite"][data-id="${toolId}"]`).forEach(icon => {
                    if (icon.classList.contains('favorite-icon')) {
                        if (isFavorited) {
                            icon.classList.add('favorited');
                        } else {
                            icon.classList.remove('favorited');
                        }
                    }
                });

                // Re-render della vista per aggiornare le icone dei preferiti
                renderView();
                // Se il modale di dettaglio è aperto, aggiornalo
                if (document.getElementById('detail-modal')) {
                    window.openDetailModal(toolId);
                }
            };

            // NEW FUNCTION: Toggle user-added tool featured status (Firestore)
            const toggleUserFeatured = async (toolId) => {
                // Allow any logged-in user to perform this action
                if (!currentUser || !currentUser.uid) return;
                // Ensure it is a user-added tool
                if (!toolId.startsWith('user-')) return;

                const userDocRef = doc(db, "users", currentUser.uid);
                const isUserFeatured = currentUser.userFeaturedTools?.includes(toolId);
                const newFeaturedList = isUserFeatured
                    ? currentUser.userFeaturedTools.filter(id => id !== toolId)
                    : [...(currentUser.userFeaturedTools || []), toolId];

                try {
                    await updateDoc(userDocRef, { userFeaturedTools: newFeaturedList });
                    currentUser.userFeaturedTools = newFeaturedList; // Update local state after successful Firestore update
                } catch (error) {
                    console.error("Error updating user featured tools:", error);
                    showToast("Could not update featured status. Please try again.");
                    return;
                }

                // Re-render the current view (Library) and update the detail modal
                renderView();
                if (document.getElementById('detail-modal')) { window.openDetailModal(toolId); }
            };

            // NEW FUNCTION: Replace static featured tool with user tool (Firestore)
            const replaceFeaturedStatic = async (staticToolId, userToolId) => {
                // Allow any logged-in user to perform this action
                if (!currentUser || !currentUser.uid) return;
                if (!staticToolId || !userToolId) return;

                const userDocRef = doc(db, "users", currentUser.uid);
                const newReplacements = { ...(currentUser.userFeaturedReplacements || {}), [staticToolId]: userToolId };

                try {
                    await updateDoc(userDocRef, { userFeaturedReplacements: newReplacements });
                    currentUser.userFeaturedReplacements = newReplacements; // Update local state
                    showToast(translations[currentLanguage].addAppSuccess); // Reuse success toast
                } catch (error) {
                    console.error("Error replacing featured tool:", error);
                    showToast(`Error: ${error.message}`); // Generic error
                    return;
                }

                closeModal();
                renderView(); // Re-render Top AI view
            };

            // NEW FUNCTION: Remove featured replacement (Firestore)
            const removeFeaturedReplacement = async (staticToolId) => {
                // Check privileged status loaded from Firestore
                if (!currentUser || !currentUser.uid || !currentUser.isPrivileged) return;
                if (!staticToolId) return;

                const userDocRef = doc(db, "users", currentUser.uid);
                const newReplacements = { ...(currentUser.userFeaturedReplacements || {}) };
                delete newReplacements[staticToolId];

                try {
                    await updateDoc(userDocRef, { userFeaturedReplacements: newReplacements });
                    currentUser.userFeaturedReplacements = newReplacements; // Update local state
                    showToast(translations[currentLanguage].removeFeaturedReplacement + " Success!"); // Toast confirmation
                } catch (error) {
                    console.error("Error removing featured replacement:", error);
                    showToast(`Error: ${error.message}`); // Generic error
                    return;
                }

                renderView(); // Re-render Top AI view
            };

            // NEW FUNCTION: Remove user-added tool entirely (Firestore)
            const removeUserTool = async (toolId) => {
                // Permetti solo agli utenti loggati di rimuovere le proprie app
                if (!currentUser || !currentUser.uid || !toolId.startsWith('user-')) {
                    showToast("Azione non permessa.");
                    return;
                }

                const t = translations[currentLanguage];

                // NUOVO: Mostra modale di conferma prima di eliminare
                const confirmed = await showConfirmModal({
                    title: currentLanguage === 'it' ? 'Elimina app custom' : 'Delete custom app',
                    message: currentLanguage === 'it'
                        ? 'Sei sicuro di voler eliminare questa app? Questa azione non può essere annullata.'
                        : 'Are you sure you want to delete this app? This action cannot be undone.',
                    icon: '🗑️',
                    confirmText: currentLanguage === 'it' ? 'Elimina' : 'Delete',
                    cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                });

                if (!confirmed) {
                    return; // Annulla l'operazione
                }

                const userDocRef = doc(db, "users", currentUser.uid);

                try {
                    // 1. Leggi lo stato attuale del documento utente da Firestore
                    const userDocSnap = await getDoc(userDocRef);
                    if (!userDocSnap.exists()) {
                        showToast("Dati utente non trovati.");
                        return;
                    }
                    const userData = userDocSnap.data();

                    // 2. Filtra l'array 'userTools' per rimuovere l'app specificata
                    const updatedUserTools = (userData.userTools || []).filter(tool => tool.id !== toolId);

                    // 3. Rimuovi l'app anche da altri array correlati (preferiti, in evidenza, etc.)
                    const updatedUserFeaturedTools = (userData.userFeaturedTools || []).filter(id => id !== toolId);
                    const updatedFavorites = (userData.favorites || []).filter(id => id !== toolId);
                    const updatedUserFeaturedReplacements = { ...(userData.userFeaturedReplacements || {}) };
                    for (const staticId in updatedUserFeaturedReplacements) {
                        if (updatedUserFeaturedReplacements[staticId] === toolId) {
                            delete updatedUserFeaturedReplacements[staticId];
                        }
                    }

                    // 4. Prepara l'oggetto con tutti i dati aggiornati da scrivere su Firestore
                    const updateData = {
                        userTools: updatedUserTools,
                        userFeaturedTools: updatedUserFeaturedTools,
                        userFeaturedReplacements: updatedUserFeaturedReplacements,
                        favorites: updatedFavorites
                    };

                    // 5. Scrivi i dati aggiornati su Firestore in un'unica operazione
                    await updateDoc(userDocRef, updateData);

                    // 6. Aggiorna lo stato locale per riflettere la rimozione nella UI
                    currentUser.userTools = updatedUserTools;
                    currentUser.userFeaturedTools = updatedUserFeaturedTools;
                    currentUser.userFeaturedReplacements = updatedUserFeaturedReplacements;
                    currentUser.favorites = updatedFavorites;

                    showToast(t.removeUserTool + " - Successo!");
                    renderView();
                    closeModal();
                } catch (error) {
                    console.error("Errore nella rimozione dell'app utente:", error);
                    showToast(`Errore: ${error.message}`);
                }
            };

            // NUOVO: Funzioni per la selezione multipla
            const updateMultiSelectUI = () => {
                const t = translations[currentLanguage];
                const toolbar = document.getElementById('multi-select-toolbar');
                const listContainer = document.getElementById('filtered-tools-list');

                if (!toolbar || !listContainer) return;

                if (exploreMultiSelectMode) {
                    // Mostra la toolbar
                    const selectedCount = exploreSelectedTools.length;
                    const countText = t.itemsSelected.replace('%d', selectedCount);

                    toolbar.style.display = 'flex';
                    toolbar.style.alignItems = 'center';
                    toolbar.style.gap = '8px';
                    toolbar.innerHTML = `
                        <button class="pill-btn active" data-action="toggle-multi-select" style="font-size: 13px;">
                            ${t.multiSelect} ${selectedCount > 0 ? `(${selectedCount})` : ''}
                        </button>
                        ${selectedCount > 0 ? `
                            <button class="pill-btn" data-action="multi-select-favorites" title="${t.addToFavorites}" style="padding: 8px 12px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--Koda-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                            </button>
                            <button class="pill-btn" data-action="multi-select-collection" title="${t.addToCollection}" style="padding: 8px 12px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--Koda-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </button>
                        ` : ''}
                    `;

                    // Aggiungi classe multi-select-mode alle card
                    const cards = listContainer.querySelectorAll('.tool-card-list');
                    cards.forEach(card => {
                        card.classList.add('multi-select-mode');
                        const toolId = card.dataset.id;

                        // Aggiungi checkbox se non esiste
                        if (!card.querySelector('.select-checkbox')) {
                            const checkbox = document.createElement('div');
                            checkbox.className = 'select-checkbox';
                            checkbox.dataset.action = 'toggle-tool-selection';
                            checkbox.dataset.toolId = toolId;
                            card.insertBefore(checkbox, card.firstChild);
                        }

                        // Aggiorna stato selezionato
                        if (exploreSelectedTools.includes(toolId)) {
                            card.classList.add('selected');
                        } else {
                            card.classList.remove('selected');
                        }
                    });
                } else {
                    // Mostra solo il pulsante di attivazione
                    toolbar.style.display = 'flex';
                    toolbar.style.alignItems = 'center';
                    toolbar.style.gap = '8px';
                    toolbar.innerHTML = `
                        <button class="pill-btn" data-action="toggle-multi-select" style="font-size: 13px;">
                            ${t.multiSelect}
                        </button>
                    `;

                    // Rimuovi classe multi-select-mode e checkbox
                    const cards = listContainer.querySelectorAll('.tool-card-list');
                    cards.forEach(card => {
                        card.classList.remove('multi-select-mode', 'selected');
                        const checkbox = card.querySelector('.select-checkbox');
                        if (checkbox) checkbox.remove();
                    });
                }
            };

            const addSelectedToFavorites = async () => {
                const t = translations[currentLanguage];

                if (exploreSelectedTools.length === 0) return;

                // Logica per utenti LOGGATI
                if (currentUser.uid) {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    try {
                        const favoritesToAdd = exploreSelectedTools.filter(id => !currentUser.favorites.includes(id));

                        if (favoritesToAdd.length > 0) {
                            const updatedFavorites = [...currentUser.favorites, ...favoritesToAdd];
                            await updateDoc(userDocRef, { favorites: updatedFavorites });
                            currentUser.favorites = updatedFavorites;
                        }

                        showToast(currentLanguage === 'it'
                            ? `${exploreSelectedTools.length} AI aggiunte ai preferiti!`
                            : `${exploreSelectedTools.length} AI added to favorites!`);
                    } catch (error) {
                        console.error("Error adding to favorites:", error);
                        showToast("Error adding to favorites: " + error.message);
                    }
                }
                // Logica per utenti OSPITI
                else {
                    let guestFavorites = JSON.parse(localStorage.getItem('guest-favorites')) || [];
                    exploreSelectedTools.forEach(toolId => {
                        if (!guestFavorites.includes(toolId)) {
                            guestFavorites.push(toolId);
                        }
                    });
                    localStorage.setItem('guest-favorites', JSON.stringify(guestFavorites));
                    currentUser.favorites = guestFavorites;
                    showToast(currentLanguage === 'it'
                        ? `${exploreSelectedTools.length} AI aggiunte ai preferiti!`
                        : `${exploreSelectedTools.length} AI added to favorites!`);
                }

                // Reset selezione
                exploreMultiSelectMode = false;
                exploreSelectedTools = [];
                renderView();
            };

            const openCollectionSelectorForMultiSelect = () => {
                const t = translations[currentLanguage];

                if (exploreSelectedTools.length === 0) return;

                // Ottieni le collezioni da localStorage (disponibili per tutti gli utenti)
                const userCollections = collections || [];

                // Crea un modale per selezionare la collezione o crearne una nuova
                const modal = document.createElement('div');
                modal.className = 'review-modal visible';
                modal.innerHTML = `
                    <div class="review-modal-content">
                        <div class="review-modal-header">
                            <h3 class="review-modal-title">${t.addToCollection}</h3>
                            <button class="review-modal-close" data-action="close-collection-selector">×</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${userCollections.length > 0 ? userCollections.map(collection => `
                                <div class="user-profile-item" data-action="add-to-collection-multi" data-collection-id="${collection.id}" style="cursor: pointer;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--Koda-accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    <span>${collection.name}</span>
                                </div>
                            `).join('') : `
                                <div style="text-align: center; padding: 24px; color: var(--Koda-text-secondary);">
                                    ${currentLanguage === 'it' ? 'Nessuna collezione trovata' : 'No collections found'}
                                </div>
                            `}
                        </div>
                        <div style="padding: 16px 0 0 0; border-top: 1px solid rgba(128, 128, 128, 0.2); margin-top: 16px;">
                            <button class="add-review-btn" data-action="create-new-collection-multi" style="width: 100%;">
                                ➕ ${t.createCollection}
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Gestisci chiusura e azioni
                modal.addEventListener('click', (e) => {
                    if (e.target === modal || e.target.dataset.action === 'close-collection-selector') {
                        modal.remove();
                    }
                    if (e.target.dataset.action === 'add-to-collection-multi' || e.target.closest('[data-action="add-to-collection-multi"]')) {
                        const collectionId = (e.target.dataset.collectionId || e.target.closest('[data-action="add-to-collection-multi"]').dataset.collectionId);
                        addSelectedToCollection(collectionId);
                        modal.remove();
                    }
                    if (e.target.dataset.action === 'create-new-collection-multi' || e.target.closest('[data-action="create-new-collection-multi"]')) {
                        modal.remove();
                        openCreateCollectionModalForMultiSelect();
                    }
                });
            };

            const openCreateCollectionModalForMultiSelect = async () => {
                console.log('openCreateCollectionModalForMultiSelect called');
                console.log('Selected tools:', exploreSelectedTools);

                const t = translations[currentLanguage];

                // Handler per il submit (definito prima per poterlo usare nell'onclick)
                window.handleMultiCollectionSubmit = async () => {
                    console.log('handleMultiCollectionSubmit called');

                    const input = document.getElementById('multi-select-collection-name');
                    const collectionName = input?.value.trim();

                    console.log('Collection name:', collectionName);

                    if (!collectionName) {
                        showToast(currentLanguage === 'it' ? 'Inserisci un nome' : 'Enter a name');
                        return;
                    }

                    console.log('Creating collection with tools:', exploreSelectedTools);

                    try {
                        // Crea la collezione usando la funzione esistente (localStorage)
                        const newCollection = createCollection(collectionName);

                        console.log('Collection created:', newCollection);

                        // Aggiungi tutti gli strumenti selezionati alla collezione
                        exploreSelectedTools.forEach(toolId => {
                            addToolToCollection(newCollection.id, toolId);
                        });

                        console.log('Tools added to collection');

                        // Aggiungi anche ai preferiti
                        if (currentUser.uid) {
                            // Utente loggato - usa Firestore
                            const userDocRef = doc(db, "users", currentUser.uid);
                            const favoritesToAdd = exploreSelectedTools.filter(id => !currentUser.favorites.includes(id));

                            if (favoritesToAdd.length > 0) {
                                const updatedFavorites = [...currentUser.favorites, ...favoritesToAdd];
                                await updateDoc(userDocRef, { favorites: updatedFavorites });
                                currentUser.favorites = updatedFavorites;
                            }
                        } else {
                            // Utente ospite - usa localStorage
                            let guestFavorites = JSON.parse(localStorage.getItem('guest-favorites')) || [];
                            exploreSelectedTools.forEach(toolId => {
                                if (!guestFavorites.includes(toolId)) {
                                    guestFavorites.push(toolId);
                                }
                            });
                            localStorage.setItem('guest-favorites', JSON.stringify(guestFavorites));
                            currentUser.favorites = guestFavorites;
                        }

                        console.log('Favorites updated');

                        showToast(currentLanguage === 'it'
                            ? `Collezione "${collectionName}" creata con ${exploreSelectedTools.length} AI!`
                            : `Collection "${collectionName}" created with ${exploreSelectedTools.length} AI!`);

                        const modal = document.getElementById('multi-select-create-collection-modal');
                        if (modal) modal.remove();

                        // Reset selezione
                        exploreMultiSelectMode = false;
                        exploreSelectedTools = [];
                        renderView();
                    } catch (error) {
                        console.error("Error creating collection:", error);
                        showToast("Error: " + error.message);
                    }
                };

                const modal = document.createElement('div');
                modal.className = 'review-modal visible';
                modal.id = 'multi-select-create-collection-modal';
                modal.innerHTML = `
                    <div class="review-modal-content">
                        <div class="review-modal-header">
                            <h3 class="review-modal-title">${t.createCollection}</h3>
                            <button class="review-modal-close" onclick="document.getElementById('multi-select-create-collection-modal').remove()">×</button>
                        </div>
                        <div style="padding: 16px 0;">
                            <label style="display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px;">
                                ${t.collectionName}
                            </label>
                            <input 
                                type="text" 
                                id="multi-select-collection-name" 
                                placeholder="${t.collectionNamePlaceholder}"
                                style="width: 100%; padding: 12px; border: 1px solid rgba(128, 128, 128, 0.2); border-radius: 8px; background-color: var(--Koda-bg-light); color: var(--Koda-text); font-family: inherit; font-size: 14px;"
                                onkeypress="if(event.key === 'Enter') window.handleMultiCollectionSubmit()"
                            />
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="review-cancel-btn" onclick="document.getElementById('multi-select-create-collection-modal').remove()">
                                ${t.cancel}
                            </button>
                            <button class="review-submit-btn" onclick="window.handleMultiCollectionSubmit()">
                                ${t.createCollectionButton}
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Focus sull'input
                setTimeout(() => {
                    const input = document.getElementById('multi-select-collection-name');
                    if (input) {
                        input.focus();
                        console.log('Input focused');
                    }
                }, 100);
            };

            const addSelectedToCollection = async (collectionId) => {
                if (exploreSelectedTools.length === 0) return;

                try {
                    // Aggiungi tutti gli strumenti selezionati alla collezione (localStorage)
                    exploreSelectedTools.forEach(toolId => {
                        addToolToCollection(collectionId, toolId);
                    });

                    // Aggiungi anche ai preferiti
                    if (currentUser.uid) {
                        // Utente loggato - usa Firestore
                        const userDocRef = doc(db, "users", currentUser.uid);
                        const favoritesToAdd = exploreSelectedTools.filter(id => !currentUser.favorites.includes(id));

                        if (favoritesToAdd.length > 0) {
                            const updatedFavorites = [...currentUser.favorites, ...favoritesToAdd];
                            await updateDoc(userDocRef, { favorites: updatedFavorites });
                            currentUser.favorites = updatedFavorites;
                        }
                    } else {
                        // Utente ospite - usa localStorage
                        let guestFavorites = JSON.parse(localStorage.getItem('guest-favorites')) || [];
                        exploreSelectedTools.forEach(toolId => {
                            if (!guestFavorites.includes(toolId)) {
                                guestFavorites.push(toolId);
                            }
                        });
                        localStorage.setItem('guest-favorites', JSON.stringify(guestFavorites));
                        currentUser.favorites = guestFavorites;
                    }

                    showToast(currentLanguage === 'it'
                        ? `${exploreSelectedTools.length} AI aggiunte alla collezione!`
                        : `${exploreSelectedTools.length} AI added to collection!`);

                    // Reset selezione
                    exploreMultiSelectMode = false;
                    exploreSelectedTools = [];
                    renderView();
                } catch (error) {
                    console.error("Error adding to collection:", error);
                    showToast("Error adding to collection: " + error.message);
                }
            };



            const unmountReactApp = () => {
                if (reactRoot) {
                    reactRoot.unmount();
                    reactRoot = null;
                }
            };

            const renderSideMenu = () => {
                const sortedConversations = Object.values(conversations).sort((a, b) => b.timestamp - a.timestamp);
                el.conversationListContainer.innerHTML = sortedConversations.map(conv => `
                <button class="conversation-item" data-action="select-conversation" data-id="${conv.id}">
                    ${conv.title}
                </button>
            `).join('');
                el.conversationListContainer.querySelector(`[data-id="${activeConversationId}"]`)?.classList.add('active');
                applyTranslations(currentLanguage); // Apply translations to menu items
            };

            const toggleSideMenu = (show) => {
                if (show) {
                    renderSideMenu(); // Render menu content before showing
                    el.sideMenuOverlay.classList.add('visible');
                    el.sideMenu.classList.remove('hidden'); /* Ensure it's not hidden by mistake */
                    el.sideMenu.classList.add('visible');
                    // Aggiungi alla cronologia del browser
                    history.pushState({ sideMenu: true, page: currentView }, '', '');
                } else {
                    el.sideMenuOverlay.classList.remove('visible');
                    el.sideMenu.classList.remove('visible');
                    // Add a small delay before hiding overlay completely to allow transition
                    setTimeout(() => {
                        el.sideMenuOverlay.classList.add('hidden');
                    }, 300); // Match CSS transition duration
                }
            };

            // User Profile Dropdown Functions
            const toggleUserProfileDropdown = () => {
                const dropdown = document.getElementById('user-profile-dropdown');
                if (dropdown) {
                    const isVisible = dropdown.classList.contains('visible');
                    if (isVisible) {
                        closeUserProfileDropdown();
                    } else {
                        openUserProfileDropdown();
                    }
                }
            };

            const openUserProfileDropdown = () => {
                const dropdown = document.getElementById('user-profile-dropdown');
                if (dropdown) {
                    // Close any other open dropdowns first
                    closeUserProfileDropdown();

                    // Aggiungi alla cronologia del browser
                    history.pushState({ dropdown: 'user-profile', page: currentView }, '', '');

                    // Update user info in dropdown
                    const nameElement = dropdown.querySelector('.user-profile-name');
                    const emailElement = dropdown.querySelector('.user-profile-email');
                    const avatarElement = dropdown.querySelector('.user-profile-avatar');

                    if (nameElement) nameElement.textContent = currentUser.nickname || currentUser.name;
                    if (emailElement) emailElement.textContent = currentUser.name;
                    if (avatarElement) avatarElement.textContent = currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : currentUser.name.charAt(0).toUpperCase();

                    // Apply translations
                    applyTranslations(currentLanguage);

                    // Show dropdown
                    dropdown.classList.add('visible');

                    // Add click outside listener
                    setTimeout(() => {
                        document.addEventListener('click', closeUserProfileDropdownOnClickOutside);
                    }, 100);
                }
            };

            const closeUserProfileDropdown = () => {
                const dropdown = document.getElementById('user-profile-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('visible');
                    document.removeEventListener('click', closeUserProfileDropdownOnClickOutside);
                }
            };

            const closeUserProfileDropdownOnClickOutside = (event) => {
                const dropdown = document.getElementById('user-profile-dropdown');
                const container = document.querySelector('.user-profile-container');

                if (dropdown && container && !container.contains(event.target)) {
                    closeUserProfileDropdown();
                }
            };

            const getGlobalControlsHTML = (options = {}) => {
                const { includeLangToggle = true } = options;

                const themeIcon = currentTheme === 'dark' ? sunIcon : moonIcon;
                const isGuest = !currentUser.uid;
                const userInitial = isGuest ? '?' : (currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : 'U');

                // Logica condizionale per il contenuto dell'avatar
                const avatarImageUrl = currentTheme === 'light'
                    ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                    : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';
                const avatarContentHTML = isGuest
                    ? `<img src="${avatarImageUrl}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`
                    : userInitial;

                // The avatar is now always rendered in the top-bar, but its click action depends on login status
                const avatarHTML = `
            <div class="user-profile-container">
                <div class="user-avatar" data-action="profile-avatar-click">${avatarContentHTML}</div>
                <div class="user-profile-dropdown" id="user-profile-dropdown">
                    <div class="user-profile-header">
                        <div class="user-profile-avatar">${avatarContentHTML}</div>
                        <div class="user-profile-name">${currentUser.nickname || currentUser.name}</div>
                        <div class="user-profile-email">${currentUser.name}</div>
                    </div>
                    <div class="user-profile-menu">
                        <div class="user-profile-item" data-action="open-settings">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <span data-translate="settingsTitle">Impostazioni account</span>
                        </div>
                        <div class="user-profile-item" data-action="change-nickname">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            <span data-translate="changeNicknameTitle">Cambia nickname</span>
                        </div>
                        <div class="user-profile-item" data-action="change-password">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                            </svg>
                            <span data-translate="changePasswordTitle">Cambia password</span>
                        </div>
                        
                    </div>
                </div>
            </div>
        `;

                let otherControlsHTML = '';

                // Aggiunge il pulsante "Aggiungi AI" per gli amministratori
                if (currentUser.role === 'admin') {
                    otherControlsHTML += `
        <button id="admin-add-tool-btn" class="global-btn" data-action="open-add-global-tool-modal" title="${translations[currentLanguage].addAIToDatabase}">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                <path d="M0 0h24v24H0V0z" fill="none"/>
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
        </button>
    `;
                }

                // NUOVO: Pulsante Catalogo Video
                otherControlsHTML += `
    <button id="video-catalog-btn" class="global-btn" data-action="open-video-catalog" title="${translations[currentLanguage].videoCatalogTitle}" style="color: var(--Koda-accent);">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
        <span id="cinema-notification-badge" class="notification-badge hidden">0</span>
    </button>
`;

                otherControlsHTML += `
<button id="theme-toggle-btn" class="global-btn" data-action="toggle-theme">${themeIcon}</button>
`;

                if (includeLangToggle) {
                    otherControlsHTML += `
    <button id="lang-toggle-btn" class="global-btn" data-action="toggle-lang">${currentLanguage.toUpperCase()}</button>
`;
                }

                // Return as an object to pass to React
                return { avatar: avatarHTML, otherControls: otherControlsHTML };
            };

            // ========================================
            // FUNZIONI PER I MODAL DELLE COLLEZIONI
            // ========================================

            // NUOVO: Variabile per tracciare il tool corrente nel modal
            let currentToolIdInModal = null;

            const openAddToCollectionModal = (toolId) => {
                const t = translations[currentLanguage];

                // NUOVO: Salva il toolId corrente
                currentToolIdInModal = toolId;

                const collectionsListHTML = collections.map(collection => {
                    const isInCollection = isToolInCollection(collection.id, toolId);
                    const count = collection.toolIds.length;
                    const countText = count === 1 ? t.toolCount.replace('%d', count) : t.toolsCount.replace('%d', count);
                    const logoUrl = currentTheme === 'light'
                        ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                        : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';

                    const coverHTML = collection.coverImage
                        ? `<img src="${collection.coverImage}" alt="${collection.name}">`
                        : `<img src="${logoUrl}" alt="Koda Logo" style="width: 100%; height: 100%; object-fit: cover; background: var(--Koda-card);">`;

                    return `
                        <div class="collection-list-item ${isInCollection ? 'selected' : ''}" data-action="toggle-tool-in-collection" data-collection-id="${collection.id}" data-tool-id="${toolId}">
                            <div class="collection-list-item-cover">${coverHTML}</div>
                            <div class="collection-list-item-info">
                                <div class="collection-list-item-name">${collection.name}</div>
                                <div class="collection-list-item-count">${countText}</div>
                            </div>
                            <div class="collection-list-item-check">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            </div>
                        </div>
                    `;
                }).join('');

                // Mostra pulsante "Salva" solo se ci sono collezioni esistenti
                const hasCollections = collections.length > 0;
                const buttonsHTML = hasCollections
                    ? `
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button class="create-new-collection-btn" data-action="create-collection-from-modal" style="flex: 1; background: var(--Koda-card); color: var(--Koda-text);">
                                ${t.createCollection}
                            </button>
                            <button class="create-new-collection-btn" data-action="close-add-to-collection-modal" style="flex: 1;">
                                ${currentLanguage === 'it' ? '✓ Salva' : '✓ Save'}
                            </button>
                        </div>
                    `
                    : `<button class="create-new-collection-btn" data-action="create-collection-from-modal">${t.createCollection}</button>`;

                const modalHTML = `
                    <div class="add-to-collection-modal visible">
                        <div class="add-to-collection-content">
                            <div class="add-to-collection-header">
                                <h3 class="add-to-collection-title">${t.addToCollection}</h3>
                                <button class="add-to-collection-close" data-action="close-add-to-collection-modal">×</button>
                            </div>
                            ${hasCollections ? `<div class="collections-list">${collectionsListHTML}</div>` : `<p style="text-align: center; color: var(--Koda-text-secondary); padding: 20px;">${t.emptyCollections}</p>`}
                            ${buttonsHTML}
                        </div>
                    </div>
                `;

                el.modalContainer.insertAdjacentHTML('beforeend', modalHTML);
            };

            const closeAddToCollectionModal = () => {
                const modal = document.querySelector('.add-to-collection-modal');
                if (modal) {
                    modal.classList.remove('visible');
                    setTimeout(() => modal.remove(), 300);
                }
            };

            // RIMOSSO: Modali per aggiungere AI/Video alle collezioni/playlist
            /*
            const openAddMultipleToolsModal = (collectionId) => {
                const t = translations[currentLanguage];
                const collection = collections.find(c => c.id === collectionId);
                if (!collection) return;

                const allTools = getAllToolsForCurrentUser();
                const availableTools = allTools.filter(tool => !collection.toolIds.includes(tool.id));

                // Get unique categories from available tools
                const categories = [...new Set(availableTools.map(tool => tool.category))].filter(Boolean);
                
                // Initialize filter state for this modal
                if (!window.collectionModalFilters) {
                    window.collectionModalFilters = {
                        categories: [],
                        pricing: []
                    };
                }
                
                const hasActiveFilters = window.collectionModalFilters.categories.length > 0 || window.collectionModalFilters.pricing.length > 0;
                const categoryCountText = window.collectionModalFilters.categories.length > 0 ? ` (${window.collectionModalFilters.categories.length})` : '';
                const pricingCountText = window.collectionModalFilters.pricing.length > 0 ? ` (${window.collectionModalFilters.pricing.length})` : '';
                
                const categoryFiltersHTML = `
                    <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px;">
                        <button class="filter-btn ${!hasActiveFilters ? 'active' : ''}" data-action="clear-collection-filters">
                            ${currentLanguage === 'it' ? 'Tutti' : 'All'}
                        </button>
                        <button class="filter-btn ${window.collectionModalFilters.categories.length > 0 ? 'active' : ''}" data-action="open-collection-category-page" data-collection-id="${collectionId}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2z"/></svg>
                            ${currentLanguage === 'it' ? 'Categorie' : 'Categories'}${categoryCountText}
                        </button>
                        <button class="filter-btn ${window.collectionModalFilters.pricing.length > 0 ? 'active' : ''}" data-action="open-collection-pricing-page" data-collection-id="${collectionId}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                            ${currentLanguage === 'it' ? 'Prezzo' : 'Price'}${pricingCountText}
                        </button>
                    </div>
                `;

                const toolsListHTML = availableTools.map(tool => `
                    <div class="collection-list-item tool-item-selectable" data-action="toggle-tool-selection-for-add" data-tool-id="${tool.id}" data-category="${tool.category || ''}" data-pricing="${tool.pricing || ''}" style="cursor: pointer;">
                        <div class="collection-list-item-cover">
                            <img src="${tool.logoUrl}" alt="${tool.name}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="collection-list-item-info">
                            <div class="collection-list-item-name">${tool.name}</div>
                            ${tool.category ? `<div class="collection-list-item-count" style="font-size: 11px;">${tool.category}</div>` : ''}
                        </div>
                        <div class="collection-list-item-check">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        </div>
                    </div>
                `).join('');

                const modalHTML = `
                    <div class="add-to-collection-modal visible" id="add-multiple-tools-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--Koda-bg); z-index: 10000; display: flex; flex-direction: column;">
                        <div class="add-to-collection-content" style="max-width: 100%; width: 100%; height: 100%; border-radius: 0; display: flex; flex-direction: column;">
                            <div class="add-to-collection-header" style="flex-shrink: 0;">
                                <h3 class="add-to-collection-title">${currentLanguage === 'it' ? 'Aggiungi AI a' : 'Add AI to'} "${collection.name}"</h3>
                                <button class="add-to-collection-close" data-action="close-add-multiple-tools-modal">×</button>
                            </div>
                            ${availableTools.length > 0 ? `
                                <div style="padding: 0 16px; flex-shrink: 0;">
                                    <input type="text" id="search-tools-input" placeholder="${currentLanguage === 'it' ? 'Cerca AI...' : 'Search AI...'}" style="width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(128, 128, 128, 0.2); background: var(--Koda-card); color: var(--Koda-text); font-size: 14px; margin-bottom: 16px;">
                                    ${categoryFiltersHTML}
                                </div>
                            ` : ''}
                            <div class="collections-list" id="tools-list-container" style="flex: 1; overflow-y: auto; padding: 0 16px;">
                                ${availableTools.length > 0 ? toolsListHTML : `<p style="text-align: center; color: var(--Koda-text-secondary); padding: 20px;">${currentLanguage === 'it' ? 'Tutti gli AI sono già nella collezione' : 'All AI tools are already in the collection'}</p>`}
                            </div>
                            ${availableTools.length > 0 ? `
                                <div style="display: flex; gap: 12px; padding: 16px; border-top: 1px solid rgba(128, 128, 128, 0.2); flex-shrink: 0;">
                                    <button class="create-new-collection-btn" data-action="close-add-multiple-tools-modal" style="flex: 1; background: var(--Koda-card); color: var(--Koda-text);">
                                        ${currentLanguage === 'it' ? 'Annulla' : 'Cancel'}
                                    </button>
                                    <button class="create-new-collection-btn" data-action="confirm-add-multiple-tools" data-collection-id="${collectionId}" style="flex: 1;">
                                        ${currentLanguage === 'it' ? '✓ Aggiungi Selezionati' : '✓ Add Selected'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                el.modalContainer.insertAdjacentHTML('beforeend', modalHTML);
                
                // Add search functionality and apply initial filters
                if (availableTools.length > 0) {
                    const searchInput = document.getElementById('search-tools-input');
                    
                    // Function to apply all filters
                    const applyCollectionFilters = () => {
                        const query = searchInput ? searchInput.value.toLowerCase() : '';
                        const toolItems = document.querySelectorAll('.tool-item-selectable');
                        const selectedCategories = window.collectionModalFilters.categories;
                        const selectedPricing = window.collectionModalFilters.pricing;
                        
                        toolItems.forEach(item => {
                            const name = item.querySelector('.collection-list-item-name').textContent.toLowerCase();
                            const matchesSearch = !query || name.includes(query);
                            const matchesCategory = selectedCategories.length === 0 || selectedCategories.includes(item.dataset.category);
                            const matchesPricing = selectedPricing.length === 0 || selectedPricing.includes(item.dataset.pricing);
                            item.style.display = (matchesSearch && matchesCategory && matchesPricing) ? '' : 'none';
                        });
                    };
                    
                    // Store the filter function globally so it can be called from modal actions
                    window.applyCollectionFilters = applyCollectionFilters;
                    
                    // Apply initial filters
                    applyCollectionFilters();
                    
                    searchInput?.addEventListener('input', applyCollectionFilters);
                }

                el.modalContainer.insertAdjacentHTML('beforeend', modalHTML);
            };

            // NUOVO: Modal per aggiungere multipli video a una playlist
            const openAddMultipleVideosModal = (playlistId) => {
                const playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                const playlist = playlists.find(p => p.id === playlistId);
                if (!playlist) return;

                const availableVideos = youtubeVideosData.filter(video => !playlist.videos.includes(video.id));

                // Get unique categories from available videos
                const videoCategories = [...new Set(availableVideos.map(video => video.category))].filter(Boolean);
                
                // Initialize filter state for video modal
                if (!window.playlistModalFilters) {
                    window.playlistModalFilters = {
                        categories: []
                    };
                }
                
                const hasActiveVideoFilters = window.playlistModalFilters.categories.length > 0;
                const videoCategoryCountText = window.playlistModalFilters.categories.length > 0 ? ` (${window.playlistModalFilters.categories.length})` : '';
                
                const categoryFiltersHTML = `
                    <div style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px;">
                        <button class="filter-btn ${!hasActiveVideoFilters ? 'active' : ''}" data-action="clear-playlist-filters">
                            ${currentLanguage === 'it' ? 'Tutti' : 'All'}
                        </button>
                        <button class="filter-btn ${window.playlistModalFilters.categories.length > 0 ? 'active' : ''}" data-action="open-playlist-category-page" data-playlist-id="${playlistId}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2z"/></svg>
                            ${currentLanguage === 'it' ? 'Categorie' : 'Categories'}${videoCategoryCountText}
                        </button>
                    </div>
                `;

                const videosListHTML = availableVideos.map(video => {
                    let videoIdYT = '';
                    try {
                        const url = new URL(video.youtubeUrl);
                        videoIdYT = url.hostname === 'youtu.be' ? url.pathname.slice(1) : url.searchParams.get('v');
                    } catch (e) { }
                    const thumbnailUrl = videoIdYT ? `https://img.youtube.com/vi/${videoIdYT}/mqdefault.jpg` : '';

                    return `
                        <div class="collection-list-item video-item-selectable" data-action="toggle-video-selection-for-add" data-video-id="${video.id}" data-category="${video.category || ''}" style="cursor: pointer;">
                            <div class="collection-list-item-cover">
                                <img src="${thumbnailUrl}" alt="${video.title}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div class="collection-list-item-info">
                                <div class="collection-list-item-name">${video.title}</div>
                                ${video.category ? `<div class="collection-list-item-count" style="font-size: 11px;">${video.category}</div>` : ''}
                            </div>
                            <div class="collection-list-item-check">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                            </div>
                        </div>
                    `;
                }).join('');

                const modalHTML = `
                    <div class="add-to-collection-modal visible" id="add-multiple-videos-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--Koda-bg); z-index: 10000; display: flex; flex-direction: column;">
                        <div class="add-to-collection-content" style="max-width: 100%; width: 100%; height: 100%; border-radius: 0; display: flex; flex-direction: column;">
                            <div class="add-to-collection-header" style="flex-shrink: 0;">
                                <h3 class="add-to-collection-title">${currentLanguage === 'it' ? 'Aggiungi Video a' : 'Add Videos to'} "${playlist.name}"</h3>
                                <button class="add-to-collection-close" data-action="close-add-multiple-videos-modal">×</button>
                            </div>
                            ${availableVideos.length > 0 ? `
                                <div style="padding: 0 16px; flex-shrink: 0;">
                                    <input type="text" id="search-videos-input" placeholder="${currentLanguage === 'it' ? 'Cerca video...' : 'Search videos...'}" style="width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(128, 128, 128, 0.2); background: var(--Koda-card); color: var(--Koda-text); font-size: 14px; margin-bottom: 16px;">
                                    ${categoryFiltersHTML}
                                </div>
                            ` : ''}
                            <div class="collections-list" id="videos-list-container" style="flex: 1; overflow-y: auto; padding: 0 16px;">
                                ${availableVideos.length > 0 ? videosListHTML : `<p style="text-align: center; color: var(--Koda-text-secondary); padding: 20px;">${currentLanguage === 'it' ? 'Tutti i video sono già nella playlist' : 'All videos are already in the playlist'}</p>`}
                            </div>
                            ${availableVideos.length > 0 ? `
                                <div style="display: flex; gap: 12px; padding: 16px; border-top: 1px solid rgba(128, 128, 128, 0.2); flex-shrink: 0;">
                                    <button class="create-new-collection-btn" data-action="close-add-multiple-videos-modal" style="flex: 1; background: var(--Koda-card); color: var(--Koda-text);">
                                        ${currentLanguage === 'it' ? 'Annulla' : 'Cancel'}
                                    </button>
                                    <button class="create-new-collection-btn" data-action="confirm-add-multiple-videos" data-playlist-id="${playlistId}" style="flex: 1;">
                                        ${currentLanguage === 'it' ? '✓ Aggiungi Selezionati' : '✓ Add Selected'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                el.modalContainer.insertAdjacentHTML('beforeend', modalHTML);
                
                // Add search functionality and apply initial filters
                if (availableVideos.length > 0) {
                    const searchInput = document.getElementById('search-videos-input');
                    
                    // Function to apply all filters
                    const applyPlaylistFilters = () => {
                        const query = searchInput ? searchInput.value.toLowerCase() : '';
                        const videoItems = document.querySelectorAll('.video-item-selectable');
                        const selectedCategories = window.playlistModalFilters.categories;
                        
                        videoItems.forEach(item => {
                            const name = item.querySelector('.collection-list-item-name').textContent.toLowerCase();
                            const matchesSearch = !query || name.includes(query);
                            const matchesCategory = selectedCategories.length === 0 || selectedCategories.includes(item.dataset.category);
                            item.style.display = (matchesSearch && matchesCategory) ? '' : 'none';
                        });
                    };
                    
                    // Store the filter function globally so it can be called from modal actions
                    window.applyPlaylistFilters = applyPlaylistFilters;
                    
                    // Apply initial filters
                    applyPlaylistFilters();
                    
                    searchInput?.addEventListener('input', applyPlaylistFilters);
                }

                el.modalContainer.insertAdjacentHTML('beforeend', modalHTML);
            };
            */
            // FINE RIMOZIONE MODALI

            const toggleToolInCollection = async (collectionId, toolId) => {
                const t = translations[currentLanguage];
                const isInCollection = isToolInCollection(collectionId, toolId);

                if (isInCollection) {
                    const removed = await removeToolFromCollection(collectionId, toolId);
                    if (removed) {
                        showToast(t.removedFromCollection);
                    } else {
                        return; // L'utente ha annullato
                    }
                } else {
                    addToolToCollection(collectionId, toolId);
                    showToast(t.addedToCollection);

                    // NUOVO: Aggiorna il pulsante "Aggiungi a collezione" nel modal dei dettagli
                    updateAddToCollectionButton(toolId);
                }

                // Aggiorna il modal
                const listItem = document.querySelector(`.collection-list-item[data-collection-id="${collectionId}"][data-tool-id="${toolId}"]`);
                if (listItem) {
                    listItem.classList.toggle('selected');
                }
            };

            // NUOVO: Funzione per aggiornare visivamente il pulsante "Aggiungi a collezione"
            const updateAddToCollectionButton = (toolId) => {
                const addButton = document.querySelector(`button[data-action="add-to-collection"][data-tool-id="${toolId}"]`);
                if (addButton) {
                    const t = translations[currentLanguage];
                    const hasCollections = collections.some(col => col.toolIds.includes(toolId));

                    if (hasCollections) {
                        // Cambia il pulsante per mostrare che è stato aggiunto
                        addButton.innerHTML = `✓ ${t.addedToCollection || (currentLanguage === 'it' ? 'Aggiunto' : 'Added')}`;
                        addButton.style.background = 'var(--Koda-accent)';
                        addButton.style.color = '#000';

                        // Animazione di feedback
                        addButton.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            addButton.style.transform = 'scale(1)';
                        }, 200);
                    } else {
                        // Ripristina lo stato originale con colore bianco
                        addButton.innerHTML = t.addToCollection;
                        addButton.style.background = 'white';
                        addButton.style.color = '#000';
                    }
                }
            };

            let activeContextMenu = null;

            const openCollectionContextMenu = (collectionId, buttonElement) => {
                const t = translations[currentLanguage];

                // Chiudi menu precedente se esiste
                if (activeContextMenu) {
                    activeContextMenu.remove();
                }

                const menuHTML = `
                    <div class="collection-context-menu visible" style="position: fixed;">
                        <div class="collection-context-menu-item" data-action="rename-collection" data-collection-id="${collectionId}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                            ${t.renameCollection}
                        </div>
                        <div class="collection-context-menu-item" data-action="change-collection-cover" data-collection-id="${collectionId}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            ${t.changeCover}
                        </div>
                        <div class="collection-context-menu-item danger" data-action="delete-collection" data-collection-id="${collectionId}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                            ${t.deleteCollection}
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', menuHTML);
                const menu = document.querySelector('.collection-context-menu');
                activeContextMenu = menu;

                // Posiziona il menu vicino al pulsante
                const rect = buttonElement.getBoundingClientRect();
                menu.style.top = `${rect.bottom + 5}px`;
                menu.style.right = `${window.innerWidth - rect.right}px`;

                // Chiudi menu quando si clicca fuori
                setTimeout(() => {
                    document.addEventListener('click', function closeMenuOnClickOutside(e) {
                        if (!menu.contains(e.target) && !buttonElement.contains(e.target)) {
                            menu.classList.remove('visible');
                            setTimeout(() => menu.remove(), 200);
                            document.removeEventListener('click', closeMenuOnClickOutside);
                            activeContextMenu = null;
                        }
                    });
                }, 100);
            };

            const handleRenameCollection = (collectionId) => {
                const collection = getCollectionById(collectionId);
                if (!collection) return;
                openRenameCollectionModal(collectionId, collection.name);
                // Chiude il menu contestuale dopo l'azione
                if (activeContextMenu) {
                    activeContextMenu.remove();
                    activeContextMenu = null;
                }
            };

            const handleChangeCollectionCover = (collectionId) => {
                const t = translations[currentLanguage];
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';

                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            updateCollectionCover(collectionId, event.target.result);
                            showToast(t.coverChanged);
                            renderView();
                        };
                        reader.readAsDataURL(file);
                    }
                };

                input.click();

                if (activeContextMenu) {
                    activeContextMenu.remove();
                    activeContextMenu = null;
                }
            };

            const handleDeleteCollection = async (collectionId) => {
                const t = translations[currentLanguage];

                const confirmed = await showConfirmModal({
                    title: currentLanguage === 'it' ? 'Elimina collezione' : 'Delete collection',
                    message: t.confirmDeleteCollection,
                    icon: '🗑️',
                    confirmText: currentLanguage === 'it' ? 'Elimina' : 'Delete',
                    cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                });

                if (confirmed) {
                    deleteCollection(collectionId);
                    showToast(t.collectionDeleted);
                    renderView();
                }

                if (activeContextMenu) {
                    activeContextMenu.remove();
                    activeContextMenu = null;
                }
            };

            const openCollectionDetail = (collectionId) => {
                activeCollectionId = collectionId;
                renderView();
                updateBottomNavFAB(); // Aggiorna il FAB per mostrare il pulsante Aggiungi AI
            };

            // NUOVO: Funzione per aggiornare il pulsante FAB nella bottom nav
            const updateBottomNavFAB = (tab) => {
                const fabBtn = document.getElementById('bottom-nav-fab');
                if (!fabBtn) return;

                const t = translations[currentLanguage];

                // Mostra il FAB solo nella pagina Library
                if (currentView === 'favorites') {
                    fabBtn.style.display = 'flex';

                    // Sempre mostra il pulsante per creare collezione
                    if (tab === 'collections' || activeCollectionId) {
                        // Icona per creare collezione
                        fabBtn.dataset.action = 'create-collection';
                        fabBtn.title = t.createCollection;
                        fabBtn.querySelector('.fab-icon').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="28" viewBox="0 0 24 24" width="28" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>`;
                    } else {
                        // Icona per aggiungere app custom
                        fabBtn.dataset.action = 'open-add-app-modal';
                        fabBtn.title = t.addCustomApp;
                        fabBtn.querySelector('.fab-icon').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"></path></svg>`;
                    }
                } else {
                    // Nascondi il FAB nelle altre pagine
                    fabBtn.style.display = 'none';
                }
            };

            // NUOVA FUNZIONE: Crea o aggiorna la bottom nav del Cinema con le traduzioni corrette
            const createOrUpdateCinemaNav = () => {
                const t = translations[currentLanguage];
                const existingNav = document.querySelector('.cinema-bottom-nav');

                // Salva il tab attivo se esiste
                let activeTab = 'videos';
                if (existingNav) {
                    const activeBtn = existingNav.querySelector('.cinema-nav-btn.active');
                    if (activeBtn) {
                        activeTab = activeBtn.dataset.tab;
                    }
                    // Rimuovi la nav esistente
                    existingNav.remove();
                }

                // Crea la nuova nav con le traduzioni aggiornate
                const cinemaNavHTML = `
                    <nav class="cinema-bottom-nav">
                        <button class="cinema-nav-btn ${activeTab === 'videos' ? 'active' : ''}" data-action="set-cinema-tab" data-tab="videos">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                            </svg>
                            <span>${t.navCinemaVideos || (currentLanguage === 'it' ? 'Video' : 'Videos')}</span>
                        </button>
                        <button class="cinema-nav-btn ${activeTab === 'uni' ? 'active' : ''}" data-action="set-cinema-tab" data-tab="uni">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>
                            </svg>
                            <span>Uni</span>
                        </button>
                        <button id="cinema-fab-btn" class="nav-btn-fab" data-action="create-playlist" title="${currentLanguage === 'it' ? 'Crea playlist' : 'Create playlist'}">
                            <div class="fab-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" height="28" viewBox="0 0 24 24" width="28" fill="currentColor">
                                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                                </svg>
                            </div>
                        </button>
                        <button class="cinema-nav-btn ${activeTab === 'favorites' ? 'active' : ''}" data-action="set-cinema-tab" data-tab="favorites">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            <span>${t.navCinemaFavorites || (currentLanguage === 'it' ? 'Preferiti' : 'Favorites')}</span>
                        </button>
                        <button class="cinema-nav-btn ${activeTab === 'playlists' ? 'active' : ''}" data-action="set-cinema-tab" data-tab="playlists">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/>
                            </svg>
                            <span>${t.navCinemaPlaylists || (currentLanguage === 'it' ? 'Playlist' : 'Playlists')}</span>
                        </button>
                    </nav>
                `;
                document.body.insertAdjacentHTML('beforeend', cinemaNavHTML);
            };

            // Funzione per aggiornare il badge di notifica del Cinema
            const updateCinemaNotificationBadge = () => {
                const badge = document.getElementById('cinema-notification-badge');
                if (!badge) return;

                const lastVisit = parseInt(localStorage.getItem('lastCinemaVisit') || '0');
                const newVideosCount = youtubeVideosData.filter(video => {
                    if (!video.createdAt || !video.createdAt.seconds) return false;
                    const videoTimestamp = video.createdAt.seconds * 1000;
                    return videoTimestamp > lastVisit;
                }).length;

                if (newVideosCount > 0) {
                    badge.textContent = newVideosCount > 99 ? '99+' : newVideosCount.toString();
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            };

            const renderView = () => {
                const initialLoader = document.getElementById('initial-loader');
                if (initialLoader) {
                    initialLoader.remove();
                }

                // GESTIONE VISIBILITÀ BARRA DI NAVIGAZIONE E PADDING
                // Nascondi la bottom nav se siamo nel cinema o dettaglio video
                if (currentView === 'cinema' || currentView === 'video-detail') {
                    el.bottomNav.style.display = 'none';
                    el.mainContent.style.paddingBottom = '0';
                } else {
                    el.bottomNav.style.display = 'flex';
                    el.mainContent.style.paddingBottom = `var(--bottom-nav-height)`;
                }

                // Close any open dropdowns when navigating
                closeUserProfileDropdown();
                unmountReactApp();
                el.mainContent.innerHTML = '';

                const t = translations[currentLanguage];
                const staticTools = window.getLocalizedToolsData(currentLanguage);
                const allTools = getAllToolsForCurrentUser(); // Use combined list for search/explore
                const isGuest = !currentUser.uid;
                // Check privileged status loaded from Firestore
                const isPrivileged = currentUser.uid && currentUser.isPrivileged;
                const pageTitles = { home: t.pageTitleHome, 'top-ai': t.pageTitleTopAI, search: t.pageTitleSearch, 'search-users': t.pageTitleSearchUsers, 'user-chats': t.pageTitleUserChats, favorites: t.pageTitleLibrary, cinema: t.pageTitleCinema };

                // Top bar is only rendered for non-home views
                if (currentView !== 'home') {
                    const globalControls = getGlobalControlsHTML();
                    const pageTitle = pageTitles[currentView] || currentView;
                    const t = translations[currentLanguage];

                    // Top bar speciale per Cinema con pulsante di uscita
                    if (currentView === 'cinema') {
                        const topBarHTML = `<div class="user-chat-header">
                        <button class="chat-header-btn" data-action="exit-cinema" title="${t.backToApp || 'Torna all\'app'}">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                                <path d="M0 0h24v24H0z" fill="none"/>
                                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                            </svg>
                        </button>
                        <div id="profile-avatar-menu" style="margin-left: 8px;">${globalControls.avatar}</div>
                        <div class="user-chat-info" style="flex-grow: 1;">
                            <a href="#" class="cinema-policy-link" id="cinema-link" data-action="open-cinema-policy" style="color: var(--Koda-accent); text-decoration: underline; font-weight: 500;">${pageTitle}</a>
                        </div>
                        <div id="global-controls">
                            <button class="global-btn" id="cinema-home-btn" data-action="exit-cinema" title="${t.backToApp || 'Torna all\'app'}">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="#1db954">
                                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                </svg>
                            </button>
                            ${globalControls.otherControls.replace(/<button id="video-catalog-btn"[^>]*>[\s\S]*?<\/button>/g, '')}
                        </div>
                    </div>`;
                        el.mainContent.insertAdjacentHTML('beforeend', topBarHTML);
                    } else if (currentView === 'video-detail') {
                        // Top bar per dettaglio video con pulsante indietro
                        const topBarHTML = `<div class="user-chat-header">
                        <button class="chat-header-btn" data-action="back-to-cinema" title="${t.back || 'Indietro'}">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                                <path d="M0 0h24v24H0z" fill="none"/>
                                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                            </svg>
                        </button>
                        <div id="profile-avatar-menu" style="margin-left: 8px;">${globalControls.avatar}</div>
                        <div class="user-chat-info" style="flex-grow: 1;">
                            <span style="font-weight: 500;">${t.videoDetail || 'Dettaglio Video'}</span>
                        </div>
                        <div id="global-controls">
                            ${globalControls.otherControls.replace(/<button id="video-catalog-btn"[^>]*>[\s\S]*?<\/button>/g, '')}
                        </div>
                    </div>`;
                        el.mainContent.insertAdjacentHTML('beforeend', topBarHTML);
                    } else {
                        // Top bar normale per altre pagine
                        const topBarHTML = `<div class="user-chat-header">
                        <div id="profile-avatar-menu" style="margin-left: 8px;">${globalControls.avatar}</div>
                        <div class="user-chat-info" style="flex-grow: 1;"><a href="#" class="privacy-link" id="privacy-link-top">${t.privacy}</a></div>
                        <div id="global-controls">${globalControls.otherControls}</div>
                    </div>`;
                        el.mainContent.insertAdjacentHTML('beforeend', topBarHTML);
                    }
                }

                const contentArea = document.createElement('div');
                contentArea.id = 'content-area';
                // Aggiungi animazione di transizione pagina
                contentArea.classList.add('page-transition');

                if (currentView === 'home') {
                    // Add the same header structure as other pages for consistency
                    const globalControls = getGlobalControlsHTML();
                    const pageTitle = pageTitles[currentView] || currentView;
                    const topBarHTML = `<div class="user-chat-header">
                    <button id="menu-toggle-btn" class="chat-header-btn" title="Chat History" data-action="toggle-menu">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                    </button>
                    <div id="profile-avatar-menu" style="margin-left: 8px;">${globalControls.avatar}</div>
                    <div class="user-chat-info" style="flex-grow: 1;"><a href="#" class="privacy-link" id="privacy-link-chat">${t.privacy}</a></div>
                    <div id="global-controls">${globalControls.otherControls}</div>
                </div>`;
                    el.mainContent.insertAdjacentHTML('beforeend', topBarHTML);

                    // Chatbot view handles its own header and global controls via React prop
                    el.mainContent.innerHTML += `<div id="chatbot-container-wrapper"></div>`;
                    const chatbotContainer = document.getElementById('chatbot-container-wrapper');
                    if (window.mountChatbotApp) {
                        reactRoot = window.mountChatbotApp(chatbotContainer, {
                            tools: allTools, // Pass all tools to chatbot for recommendations
                            initialConversations: conversations,
                            initialActiveId: activeConversationId,
                            onConversationsChange: (newConvos) => {
                                saveConversations(newConvos);
                                if (el.sideMenu.classList.contains('visible')) {
                                    renderSideMenu();
                                }
                            },
                            onOpenDetail: window.openDetailModal,
                            lang: currentLanguage,
                            pageTitle: pageTitles[currentView], // <-- RIGA AGGIUNTA
                            globalControlsHTML: getGlobalControlsHTML() // Pass controls HTML to React app
                        });
                    } else {
                        console.error("Chatbot mount function not found.");
                    }
                } else if (currentView === 'top-ai') {

                    // Limita a 4 le AI In evidenza
                    const featuredTools = staticTools.filter(t => t.isFeatured).slice(0, 4); // Solo 4 AI In evidenza
                    let contentHTML = `<div class="section-title"><span data-translate="featured">${t.featured}</span><span class="featured-disclaimer" data-translate="featuredDisclaimer">${t.featuredDisclaimer}</span></div><div class="grid-container featured-ai-grid">`;

                    // Render static featured tools, potentially replaced by user tools
                    contentHTML += featuredTools.map(staticTool => {
                        const replacementToolId = currentUser.uid && currentUser.userFeaturedReplacements ? currentUser.userFeaturedReplacements[staticTool.id] : null;
                        const toolToDisplay = replacementToolId ? (currentUser.userTools || []).find(ut => ut.id === replacementToolId) : staticTool;
                        if (!toolToDisplay) return '';
                        // Passiamo l'ID dello strumento statico originale come opzione, in modo che createGridCard sappia come gestire la rimozione della sostituzione
                        return createGridCard(toolToDisplay, 'top-ai-featured', { staticToolId: staticTool.id });
                    }).join('');

                    contentHTML += `</div>`; // Close grid-container



                    const rankingCategoryIdentifiers = ["All", ...new Set(aiRankingsData.map(r => r.category))];
                    const filtersHTML = `<div class="filters-container" style="top: 64px; margin-bottom: 20px;">
                    <div class="filter-pills" id="ranking-filters">
                        ${rankingCategoryIdentifiers.map(id => `<button class="pill-btn ${rankingFilter === id ? 'active' : ''}" data-action="set-ranking-filter" data-filter="${id}">${id === 'All' ? t.filterAll : getTranslatedCategoryName(id)}</button>`).join('')}
                    </div>
                </div>`;

                    const createRankingItem = (toolId, rank) => {
                        // Find the tool in the static list first, then user tools if not found
                        const tool = staticTools.find(t => t.id === toolId) || (currentUser.userTools || []).find(t => t.id === toolId);
                        if (!tool) return '';
                        return `
                        <li class="ranking-item stagger-item" data-id="${tool.id}">
                            <span class="ranking-item-rank">${rank}</span>
                            <img src="${tool.logoUrl}" alt="${tool.name}" class="ranking-item-logo" loading="lazy">
                            <div class="ranking-item-info">
                                <div class="tool-name">${tool.name}</div>
                                <div class="tool-subtext">${getTranslatedCategoryName(tool.category)}</div>
                            </div>
                        </li>
                    `;
                    };

                    const rankingsHTML = `
<div class="section-title" style="margin-top: 40px;" data-translate="rankingsTitle">${t.rankingsTitle}</div>
${filtersHTML}
<div class="ranking-section-container">
    ${aiRankingsData.map(ranking => `
        <div class="ranking-card" data-ranking-category="${ranking.category}">
            <h3>${currentLanguage === 'it' ? ranking.title_it : ranking.title_en}</h3>
            <ol class="ranking-list">
                ${ranking.toolIds.map((id, index) => createRankingItem(id, index + 1)).join('')}
            </ol>
        </div>
    `).join('')}
</div>
`;

                    contentHTML += rankingsHTML;
                    contentArea.innerHTML = contentHTML;
                    el.mainContent.appendChild(contentArea);

                    const rankingCards = document.querySelectorAll('.ranking-card');
                    rankingCards.forEach(card => {
                        if (rankingFilter !== 'All' && card.dataset.rankingCategory !== rankingFilter) {
                            card.classList.add('hidden');
                        } else {
                            card.classList.remove('hidden'); // Ensure it's visible if filter matches or is 'All'
                        }
                    });

                } else if (currentView === 'cinema') {
                    // NUOVA PAGINA CINEMA - Stile identico a top-ai
                    renderCinemaPage(contentArea, t);
                    el.mainContent.appendChild(contentArea);

                    // MODIFICATO: Crea o aggiorna la bottom nav del Cinema
                    createOrUpdateCinemaNav();
                } else if (currentView === 'video-detail') {
                    // NUOVA PAGINA DETTAGLIO VIDEO
                    renderVideoDetailPage(contentArea, t);
                    el.mainContent.appendChild(contentArea);

                } else if (currentView === 'explore') {
                    // Load AI filter state
                    const aiSelectedCategories = JSON.parse(localStorage.getItem('ai-selected-categories') || '[]');
                    const aiSelectedPricing = JSON.parse(localStorage.getItem('ai-selected-pricing') || '[]');
                    const hasActiveFilters = aiSelectedCategories.length > 0 || aiSelectedPricing.length > 0;
                    const categoryCountText = aiSelectedCategories.length > 0
                        ? ` (${aiSelectedCategories.length})`
                        : '';
                    const pricingCountText = aiSelectedPricing.length > 0
                        ? ` (${aiSelectedPricing.length})`
                        : '';

                    el.mainContent.insertAdjacentHTML('beforeend', `
                        <div class="search-bar-container">
                            <input type="text" id="search-input" placeholder="${t.searchPlaceholder}">
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center; padding: 0 16px 16px 16px; overflow-x: auto;">
                            <button class="filter-btn ${!hasActiveFilters ? 'active' : ''}" data-action="clear-ai-filters">
                                ${currentLanguage === 'it' ? 'Tutti' : 'All'}
                            </button>
                            <button class="filter-btn ${aiSelectedCategories.length > 0 ? 'active' : ''}" data-action="open-ai-category-modal">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2z"/></svg>
                                ${currentLanguage === 'it' ? 'Categorie' : 'Categories'}${categoryCountText}
                            </button>
                            <button class="filter-btn ${aiSelectedPricing.length > 0 ? 'active' : ''}" data-action="open-ai-pricing-modal">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                                ${currentLanguage === 'it' ? 'Prezzo' : 'Price'}${pricingCountText}
                            </button>
                        </div>
                    `);


                    if (exploreFilter.type) {
                        const allTools = getAllToolsForCurrentUser();
                        const uniqueTools = allTools.filter((tool, idx, arr) => arr.findIndex(t => t.id === tool.id) === idx);
                        let filteredTools = uniqueTools.filter(t => t[exploreFilter.type] === exploreFilter.value);

                        // Apply pricing filter if active
                        if (aiSelectedPricing.length > 0) {
                            filteredTools = filteredTools.filter(tool => aiSelectedPricing.includes(tool.pricing));
                        }

                        const title = exploreFilter.type === 'category' ? getTranslatedCategoryName(exploreFilter.value) : `${t.toolsFrom} ${exploreFilter.value}`;

                        contentArea.innerHTML = `
                            <div class="back-button" data-action="back-to-explore">${t.backToSearch}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 8px;">
                                <h2 class="section-title" style="margin-bottom: 0;">${title}</h2>
                                <div id="multi-select-toolbar" style="display: flex; align-items: center; gap: 8px;">
                                    <button class="pill-btn" data-action="toggle-multi-select" style="font-size: 13px;">
                                        ${t.multiSelect}
                                    </button>
                                </div>
                            </div>
                            <div class="list-container" id="filtered-tools-list">
                                ${filteredTools.map(tool => createListCard(tool, 'explore')).join('')}
                            </div>
                        `;

                    } else {
                        const toolsByCategory = {};
                        let allTools = getAllToolsForCurrentUser();

                        // Apply category filter
                        if (aiSelectedCategories.length > 0) {
                            allTools = allTools.filter(tool => aiSelectedCategories.includes(tool.category));
                        }

                        // Apply pricing filter
                        if (aiSelectedPricing.length > 0) {
                            allTools = allTools.filter(tool => aiSelectedPricing.includes(tool.pricing));
                        }

                        allTools.forEach(tool => {
                            const category = tool.category;
                            if (!toolsByCategory[category]) {
                                toolsByCategory[category] = [];
                            }
                            toolsByCategory[category].push(tool);
                        });

                        let feedHTML = '';
                        categories.forEach(category => {
                            const categoryId = category.id;
                            const categoryName = getTranslatedCategoryName(categoryId);
                            const tools = toolsByCategory[categoryId] || [];

                            if (tools.length > 0) {
                                // Cambiato t.browseAll in una stringa fissa per evitare errori se t non è definito qui
                                const seeAllText = (t && t.browseAll) ? t.browseAll : 'Vedi tutti';
                                feedHTML += `
                                <div class="feed-section">
                                    <div class="feed-section-header">
                                        <h2 class="feed-section-title">${categoryName}</h2>
                                        <button class="see-all-btn" data-action="set-explore-filter" data-filter-type="category" data-filter-value="${categoryId}">
                                            ${seeAllText} >
                                        </button>
                                    </div>
                                    <div class="horizontal-scroll-container">
                                        ${tools.map(tool => `
                                            <div class="tool-item-horizontal stagger-item" data-id="${tool.id}">
                                                <div class="tool-item-logo-container">
                                                    <img src="${tool.logoUrl}" class="tool-logo" alt="${tool.name}" loading="lazy">
                                                </div>
                                                <div class="tool-item-name">${tool.name}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                            }
                        });

                        contentArea.innerHTML = feedHTML;
                    }

                    el.mainContent.appendChild(contentArea);
                } else if (currentView === 'search-users') {
                    // Guest-only mode: Always show content, no auth prompt
                    if (false) { // Disabled auth prompt
                        contentArea.innerHTML = `
                        <div class="auth-prompt-card">
                            <h3 data-translate="libraryPromptTitle">${t.libraryPromptTitle}</h3>
                            <p data-translate="libraryPromptText">${t.libraryPromptText}</p>
                            
                        </div>
                    `;
                    } else {
                        contentArea.innerHTML = `
                        <div class="search-users-container">
                            <div class="search-users-header">
                                <div class="search-users-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 0 24 24" width="48" fill="currentColor">
                                        <path d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H15.46c-.84 0-1.61.5-1.96 1.37L11 18h2v6h7zM12.5 11.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5S11 9.17 11 10s.67 1.5 1.5 1.5zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4z"/>
                                    </svg>
                                </div>
                                <h1 class="search-users-title" data-translate="searchUsersTitle">${t.searchUsersTitle}</h1>
                                <p class="search-users-subtitle" data-translate="searchUsersSubtitle">${t.searchUsersSubtitle}</p>
                            </div>
                            
                            <div class="search-users-input-container">
                                <div class="search-input-wrapper">
                                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor">
                                        <path d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                    </svg>
                                    <input type="text" id="user-search-input" class="search-users-input" placeholder="${t.searchUsersPlaceholder}" autocomplete="off">
                                </div>
                            </div>
                            
                            <div id="user-search-results" class="search-results-container">
                                <!-- Search results will be populated here -->
                            </div>
                            

                        </div>
                    `;
                    }
                    el.mainContent.appendChild(contentArea);
                    // Sezione 'user-chats' rimossa
                } else if (currentView === 'favorites') { // NUOVO: Vista Libreria stile Koda
                    // Se stiamo visualizzando una collezione specifica
                    if (activeCollectionId) {
                        const collection = getCollectionById(activeCollectionId);
                        if (!collection) {
                            activeCollectionId = null;
                            renderView();
                            return;
                        }

                        const count = collection.toolIds.length;
                        const countText = count === 1 ? t.toolCount.replace('%d', count) : t.toolsCount.replace('%d', count);
                        const logoUrl = currentTheme === 'light'
                            ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                            : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';

                        const coverHTML = collection.coverImage
                            ? `<img src="${collection.coverImage}" alt="${collection.name}">`
                            : `<img src="${logoUrl}" alt="Koda Logo" style="width: 100%; height: 100%; object-fit: cover; background: var(--Koda-card);">`;

                        const headerHTML = `
                            <div class="collection-detail-header">
                                <div class="collection-detail-cover">${coverHTML}</div>
                                <div class="collection-detail-info">
                                    <div class="collection-detail-type">${t.libraryCollections}</div>
                                    <h1 class="collection-detail-name">${collection.name}</h1>
                                    <div class="collection-detail-count">${countText}</div>
                                </div>
                            </div>
                        `;

                        const backButtonHTML = `
                            <div style="padding: 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <button class="pill-btn" data-action="back-to-collections" style="display: inline-flex; align-items: center; gap: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                                    ${t.backToSearch}
                                </button>
                                ${collection.toolIds.length > 0 ? `
                                    <button class="pill-btn ${selectionMode ? 'active' : ''}" data-action="toggle-selection-mode" id="selection-mode-btn" style="display: inline-flex; align-items: center; gap: 8px; margin-left: auto;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                        ${selectionMode ? (currentLanguage === 'it' ? 'Annulla selezione' : 'Cancel selection') : (currentLanguage === 'it' ? 'Seleziona' : 'Select')}
                                    </button>
                                ` : ''}
                            </div>
                        `;

                        // Barra azioni selezione multipla
                        const selectedCount = selectedTools.size;
                        const selectionCountText = currentLanguage === 'it' ? `${selectedCount} selezionati` : `${selectedCount} selected`;
                        const selectionBarHTML = `
                            <div id="selection-bar" class="selection-bar" style="display: ${selectionMode ? 'block' : 'none'};">
                                <div class="selection-bar-content">
                                    <span id="selection-count">${selectionCountText}</span>
                                    <div class="selection-bar-actions">
                                        <button class="selection-bar-btn" data-action="remove-selected-from-collection" ${selectedCount === 0 ? 'disabled' : ''}>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                            ${currentLanguage === 'it' ? 'Rimuovi' : 'Remove'}
                                        </button>
                                        <button class="selection-bar-btn" data-action="cancel-selection">
                                            ${currentLanguage === 'it' ? 'Annulla' : 'Cancel'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                        contentArea.innerHTML = backButtonHTML + selectionBarHTML + headerHTML;

                        // Renderizza gli strumenti della collezione
                        const toolsContainer = document.createElement('div');
                        toolsContainer.className = libraryViewMode === 'grid' ? 'grid-view-container' : 'list-container';
                        toolsContainer.style.padding = '0 16px';

                        if (collection.toolIds.length > 0) {
                            const allTools = getAllToolsForCurrentUser();
                            const collectionTools = collection.toolIds
                                .map(id => allTools.find(t => t.id === id))
                                .filter(Boolean);

                            if (libraryViewMode === 'grid') {
                                toolsContainer.innerHTML = collectionTools.map(tool => createGridCard(tool, 'collection')).join('');
                            } else {
                                toolsContainer.innerHTML = collectionTools.map(tool => createListCard(tool, 'collection')).join('');
                            }
                        } else {
                            toolsContainer.innerHTML = `<div id="empty-state">${t.emptyCollection}</div>`;
                        }

                        contentArea.appendChild(toolsContainer);
                        el.mainContent.appendChild(contentArea);
                        return;
                    }

                    // --- STRUTTURA LIBRERIA CON FILTRI E SELETTORE VISUALIZZAZIONE ---
                    const filtersHTML = `
                        <div id="library-filters-container" style="display: flex; align-items: center; gap: 12px;">
                            <div class="filter-pills" id="library-filters" style="flex: 1;">
                                <button class="pill-btn ${libraryTab === 'favorites' ? 'active' : ''}" data-action="set-library-tab" data-tab="favorites">${t.libraryFavorites}</button>
                                <button class="pill-btn ${libraryTab === 'collections' ? 'active' : ''}" data-action="set-library-tab" data-tab="collections">${t.libraryCollections}</button>
                            </div>
                            <div class="view-toggle-container">
                                <button class="view-toggle-btn ${libraryViewMode === 'list' ? 'active' : ''}" data-action="set-view-mode" data-mode="list" title="${t.viewList}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                                </button>
                                <button class="view-toggle-btn ${libraryViewMode === 'grid' ? 'active' : ''}" data-action="set-view-mode" data-mode="grid" title="${t.viewGrid}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                                </button>
                            </div>
                        </div>
                    `;

                    const contentListHTML = `<div id="library-content-list" class="${libraryViewMode === 'grid' ? 'grid-view-container' : 'list-container'}" style="padding: 0 16px;"></div>`;

                    contentArea.innerHTML = filtersHTML + contentListHTML;

                    // NUOVO: Aggiorna il pulsante centrale della bottom nav in base al tab attivo
                    updateBottomNavFAB(libraryTab);

                    // --- FUNZIONE PER RENDERIZZARE IL CONTENUTO DELLA SCHEDA ATTIVA ---
                    const renderLibraryContent = async (tab) => {
                        const listContainer = document.getElementById('library-content-list');
                        if (!listContainer) return;

                        // Aggiorna la classe del container in base al view mode
                        listContainer.className = libraryViewMode === 'grid' ? 'grid-view-container' : 'list-container';
                        if (libraryViewMode === 'list') {
                            listContainer.style.padding = '0 16px';
                        } else {
                            listContainer.style.padding = '0 16px';
                        }

                        listContainer.innerHTML = `<div class="chat-bubble loading" style="margin: 40px auto; background: transparent;"><span></span><span></span><span></span></div>`;

                        let contentHTML = '';

                        if (tab === 'favorites') {
                            const favoriteIds = currentUser.favorites || [];
                            if (favoriteIds.length > 0) {
                                // Logica asincrona per recuperare i dati completi dei preferiti
                                const localTools = getAllToolsForCurrentUser();
                                const fetchedUsersCache = new Map();
                                const favoriteToolsPromises = favoriteIds.map(async (toolId) => {
                                    let tool = localTools.find(t => t.id === toolId);
                                    if (tool) return tool;
                                    if (toolId.startsWith('user-')) {
                                        const creatorId = toolId.split('-')[1];
                                        if (!creatorId) return null;
                                        let creatorData = fetchedUsersCache.get(creatorId);
                                        if (!creatorData) {
                                            const userDocRef = doc(db, "users", creatorId);
                                            const userDocSnap = await getDoc(userDocRef);
                                            creatorData = userDocSnap.exists() ? userDocSnap.data() : null;
                                            fetchedUsersCache.set(creatorId, creatorData);
                                        }
                                        if (creatorData) return (creatorData.userTools || []).find(t => t.id === toolId) || null;
                                    }
                                    return null;
                                });
                                const resolvedFavoriteTools = (await Promise.all(favoriteToolsPromises)).filter(Boolean);

                                if (libraryViewMode === 'grid') {
                                    contentHTML = resolvedFavoriteTools.map(tool => createGridCard(tool, 'favorites')).join('');
                                } else {
                                    contentHTML = resolvedFavoriteTools.map(tool => createListCard(tool, 'favorites')).join('');
                                }
                            } else {
                                contentHTML = `<div id="empty-state">${t.emptyFavorites}</div>`;
                            }
                        } else if (tab === 'collections') {
                            // Renderizza le collezioni (senza card "Crea collezione")
                            if (collections.length > 0) {
                                const collectionsHTML = collections.map(collection => {
                                    const count = collection.toolIds.length;
                                    const countText = count === 1 ? t.toolCount.replace('%d', count) : t.toolsCount.replace('%d', count);
                                    const logoUrl = currentTheme === 'light'
                                        ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                                        : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';

                                    const coverHTML = collection.coverImage
                                        ? `<img src="${collection.coverImage}" alt="${collection.name}">`
                                        : `<img src="${logoUrl}" alt="Koda Logo" style="width: 100%; height: 100%; object-fit: cover; background: var(--Koda-card);">`;

                                    return `
                                        <div class="collection-card stagger-item" data-collection-id="${collection.id}">
                                            <div class="collection-cover">
                                                ${coverHTML}
                                                <button class="collection-menu-btn" data-action="open-collection-menu" data-collection-id="${collection.id}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                                                </button>
                                            </div>
                                            <div class="collection-info">
                                                <div class="collection-name">${collection.name}</div>
                                                <div class="collection-count">${countText}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('');

                                contentHTML = collectionsHTML;
                            } else {
                                contentHTML = `<div id="empty-state">${t.emptyCollections}</div>`;
                            }
                        }
                        listContainer.innerHTML = contentHTML;
                    };

                    // Renderizza il contenuto della scheda iniziale, con un timeout per garantire che il DOM sia pronto
                    setTimeout(() => renderLibraryContent(libraryTab), 0);
                    el.mainContent.appendChild(contentArea);
                }

                // NUOVO: Carica le valutazioni degli strumenti dopo aver renderizzato la vista
                setTimeout(() => loadToolRatings(), 500);

                updateNavActiveState();
                applyTranslations(currentLanguage); // Apply translations after rendering content

                // NUOVO: Aggiorna il pulsante FAB nella bottom nav
                updateBottomNavFAB(libraryTab);

                // NUOVO: Aggiorna sempre il badge di notifica del Cinema dopo ogni cambio di vista
                setTimeout(() => updateCinemaNotificationBadge(), 100);
            };

            const updateNavActiveState = () => el.bottomNav.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.page === currentView));

            // --- AUTHENTICATION FUNCTIONS (Copied from index.html and adapted) ---

            const getAuthHTML = (lang) => {
                const t = translations[lang];
                return `
            <div id="register-card" class="auth-card">
                <button class="auth-close-btn" data-action="close-auth">×</button>
                <svg class="auth-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="4" fill="none"/><text x="50" y="62" font-size="40" font-weight="bold" text-anchor="middle" fill="currentColor">AI</text></svg>
                                <h2 data-translate="createAccount">${t.createAccount}</h2>
                <div class="input-group"><label for="register-nickname" data-translate="registerNicknameLabel">${t.registerNicknameLabel}</label><input type="text" id="register-nickname" placeholder="${t.registerNicknamePlaceholder}"></div>
                <div class="input-group"><label for="register-fullname" data-translate="registerFullNameLabel">${t.registerFullNameLabel}</label><input type="text" id="register-fullname" placeholder="${t.registerFullNamePlaceholder}"></div>
                <div class="input-group"><label for="register-email" data-translate="registerEmailLabel">${t.registerEmailLabel}</label><input type="email" id="register-email" placeholder="${t.registerEmailPlaceholder}"></div>
                <div class="input-group">
                    <label for="register-password" data-translate="registerPasswordLabel">${t.registerPasswordLabel}</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="register-password" placeholder="${t.registerPasswordPlaceholder}">
                        <button type="button" class="password-toggle-icon" data-action="toggle-password-visibility" data-toggle-for="register-password">${eyeIconSVG}</button>
                    </div>
                </div>
                
                
            </div>
            <div id="login-card" class="auth-card hidden">
                <button class="auth-close-btn" data-action="close-auth">×</button>
                <svg class="auth-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="4" fill="none"/><text x="50" y="62" font-size="40" font-weight="bold" text-anchor="middle" fill="currentColor">AI</text></svg>
                <h2 data-translate="loginTitle">${t.loginTitle}</h2>
                <div class="input-group"><label for="login-email" data-translate="registerEmailLabel">${t.registerEmailLabel}</label><input type="email" id="login-email" placeholder="${t.registerEmailPlaceholder}"></div>
                <div class="input-group">
                    <label for="login-password" data-translate="registerPasswordLabel">${t.registerPasswordLabel}</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="login-password" placeholder="${t.registerPasswordPlaceholder}">
                        <button type="button" class="password-toggle-icon" data-action="toggle-password-visibility" data-toggle-for="login-password">${eyeIconSVG}</button>
                    </div>
                </div>
                
                
            </div>
            <div id="forgot-password-card" class="auth-card hidden">
                <button class="auth-close-btn" data-action="close-auth">×</button>
                <svg class="auth-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="48" stroke="currentColor" stroke-width="4" fill="none"/><text x="50" y="62" font-size="40" font-weight="bold" text-anchor="middle" fill="currentColor">AI</text></svg>
                <h2 data-translate="resetPasswordTitle">${t.resetPasswordTitle}</h2>
                <p style="color: var(--Koda-text-secondary); font-size: 14px; margin-bottom: 20px;" data-translate="resetPasswordInfo">${t.resetPasswordInfo}</p>
                <div class="input-group"><label for="forgot-email" data-translate="registerEmailLabel">${t.registerEmailLabel}</label><input type="email" id="forgot-email" placeholder="${t.registerEmailPlaceholder}"></div>
                <button id="forgot-btn" class="button" data-translate="sendLinkButton">${t.sendLinkButton}</button>
                <div class="auth-links"><a class="auth-switch-link" data-action="show-login" data-translate="backToLogin">${t.backToLogin}</a></div>
            </div>`;
            };

            const showAuthCard = (cardId) => {
                el.authOverlay.querySelectorAll('.auth-card').forEach(c => c.classList.add('hidden'));
                const cardToShow = el.authOverlay.querySelector('#' + cardId);
                if (cardToShow) cardToShow.classList.remove('hidden');
            };

            const attachAuthListeners = () => {
                // Remove previous listeners to avoid duplicates
                // This is a bit heavy, ideally use event delegation or remove specific listeners
                // For this structure, re-attaching to the overlay is simpler.
                // Ensure the overlay itself is the target for delegation.

                // Clear existing listeners by replacing the element (simple but effective)
                const oldAuthOverlay = el.authOverlay;
                const newAuthOverlay = oldAuthOverlay.cloneNode(true);
                oldAuthOverlay.parentNode.replaceChild(newAuthOverlay, oldAuthOverlay);
                el.authOverlay = newAuthOverlay;


                el.authOverlay.addEventListener('click', (e) => {
                    const target = e.target;
                    const actionTarget = target.closest('[data-action]');

                    if (actionTarget) {
                        const action = actionTarget.dataset.action;
                        if (action === 'close-auth') { e.preventDefault(); closeAuthAndReturnToApp(); }
                        else if (action === 'show-login') { e.preventDefault(); showAuthCard('login-card'); }
                        else if (action === 'show-register') { e.preventDefault(); showAuthCard('register-card'); }
                        else if (action === 'show-forgot') { e.preventDefault(); showAuthCard('forgot-password-card'); }
                    }

                    // Handle button clicks directly (delegation is better but keeping original structure)
                    if (target.id === 'register-btn') {
                        const nickname = el.authOverlay.querySelector('#register-nickname').value.trim();
                        const fullName = el.authOverlay.querySelector('#register-fullname').value.trim();
                        const email = el.authOverlay.querySelector('#register-email').value;
                        const password = el.authOverlay.querySelector('#register-password').value;
                        const t = translations[currentLanguage];

                        if (!nickname) { showToast(t.nicknameRequired); return; }
                        if (!fullName) { showToast(t.fullNameRequired); return; }
                        if (!email.includes('@') || password.length < 6) { showToast(t.passwordTooShort); return; }

                        createUserWithEmailAndPassword(auth, email, password).then((userCredential) => {
                            // After successful registration, save nickname and full name to Firestore
                            const userDocRef = doc(db, "users", userCredential.user.uid);
                            const initialUserData = {
                                email: email,
                                nickname: nickname,
                                fullName: fullName,
                                favorites: [],
                                userTools: [],
                                userFeaturedTools: [],
                                userFeaturedReplacements: {},
                                isPrivileged: false,
                                aiSuggestions: [], // New field for AI suggestions
                                role: 'user' // NUOVO: Assegna il ruolo di default
                            };
                            setDoc(userDocRef, initialUserData).catch(e => console.error("Error creating user doc:", e));
                        }).catch(error => showToast(`Error: ${error.message}`));
                    }
                    if (target.id === 'login-btn') {
                        const email = el.authOverlay.querySelector('#login-email').value;
                        const password = el.authOverlay.querySelector('#login-password').value;
                        const t = translations[currentLanguage];
                        if (!email || !password) { showToast(t.registerEmailLabel + ' / ' + t.registerPasswordLabel); return; } // Simplified message
                        signInWithEmailAndPassword(auth, email, password).catch(error => showToast(`Error: ${error.message}`));
                    }
                    if (target.id === 'forgot-btn') {
                        const email = el.authOverlay.querySelector('#forgot-email').value;
                        const t = translations[currentLanguage];
                        if (!email.includes('@')) { showToast(t.registerEmailLabel); return; } // Simplified message
                        sendPasswordResetEmail(auth, email).then(() => {
                            showToast(t.passwordResetSent.replace('%s', email));
                            showAuthCard('login-card');
                        }).catch(error => showToast(`Error: ${error.message}`));
                    }
                });
            };

            const triggerAuthFlow = (card = 'login-card') => {
                el.appContainer.style.display = 'none';
                el.authOverlay.innerHTML = getAuthHTML(currentLanguage); // Generate HTML
                attachAuthListeners(); // Attach listeners to the new HTML
                el.authOverlay.style.display = 'flex';
                el.authOverlay.classList.remove('hidden');
                showAuthCard(card); // Show the requested card
            };

            const closeAuthAndReturnToApp = () => {
                el.authOverlay.classList.add('hidden');
                el.authOverlay.addEventListener('transitionend', () => {
                    el.authOverlay.style.display = 'none';
                    el.authOverlay.innerHTML = ''; // Clear content after transition
                }, { once: true });
                el.appContainer.style.display = 'flex';
            };

            // --- SETTINGS MODAL FUNCTIONS (Copied from index.html and adapted) ---

            window.openSettingsModal = () => {
                if (!currentUser.uid) return;
                const t = translations[currentLanguage];

                const modalHTML = `
                <div id="settings-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <h2 data-translate="settingsTitle">${t.settingsTitle}</h2>
                        
                        <p style="font-size: 16px; color: var(--Koda-text-secondary); margin-top: 16px; margin-bottom: 24px;">${currentUser.name}</p>
                        
                        <hr class="modal-divider">

                        <h4 data-translate="changeNicknameTitle">${t.changeNicknameTitle}</h4>
                        <div class="input-group" style="margin-top: 16px;">
                            <label for="profile-nickname" data-translate="registerNicknameLabel">${t.registerNicknameLabel}</label>
                            <input type="text" id="profile-nickname" placeholder="${t.registerNicknamePlaceholder}" value="${currentUser.nickname || ''}">
                        </div>
                        <button class="button" id="update-nickname-btn" data-translate="saveNicknameButton">${t.saveNicknameButton}</button>

                        <hr class="modal-divider">

                        <h4 data-translate="changePasswordTitle">${t.changePasswordTitle}</h4>
                        <div class="input-group" style="margin-top: 16px;">
                            <label for="profile-new-password" data-translate="newPasswordLabel">${t.newPasswordLabel}</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="profile-new-password" placeholder="${t.newPasswordPlaceholder}">
                                <button type="button" class="password-toggle-icon" data-action="toggle-password-visibility" data-toggle-for="profile-new-password">${eyeIconSVG}</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profile-confirm-password" data-translate="confirmPasswordLabel">${t.confirmPasswordLabel}</label>
                             <div class="password-input-wrapper">
                                <input type="password" id="profile-confirm-password" placeholder="${t.confirmPasswordPlaceholder}">
                                <button type="button" class="password-toggle-icon" data-action="toggle-password-visibility" data-toggle-for="profile-confirm-password">${eyeIconSVG}</button>
                            </div>
                        </div>
                        <button class="button" id="update-password-btn" data-translate="savePasswordButton">${t.savePasswordButton}</button>

                         <hr class="modal-divider">
                         
                         <h4>${currentLanguage === 'it' ? 'Chiave API Gemini' : 'Gemini API Key'}</h4>
                         <p style="font-size: 13px; color: var(--Koda-text-secondary); margin: 8px 0 16px 0;">
                            ${currentLanguage === 'it' ? 'Configura la tua chiave API personale per utilizzare Gemini AI' : 'Configure your personal API key to use Gemini AI'}
                         </p>
                         <div class="input-group">
                            <label for="gemini-api-key">${currentLanguage === 'it' ? 'Chiave API' : 'API Key'}</label>
                            <input type="password" id="gemini-api-key" placeholder="${currentLanguage === 'it' ? 'Inserisci la tua chiave API' : 'Enter your API key'}" value="${localStorage.getItem('gemini-api-key') || ''}">
                         </div>
                         <button class="button" id="save-api-key-btn">${currentLanguage === 'it' ? 'Salva Chiave API' : 'Save API Key'}</button>
                         <p style="font-size: 12px; color: var(--Koda-text-secondary); margin-top: 8px;">
                            ${currentLanguage === 'it' ? 'Ottieni la tua chiave gratuita su' : 'Get your free key at'} <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--Koda-accent);">Google AI Studio</a>
                         </p>

                         <hr class="modal-divider">
                         <button id="logout-btn-modal" class="pill-btn" data-action="logout" data-translate="logout">${t.logout}</button>

                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;

                // Attach listener to the update nickname button
                document.getElementById('update-nickname-btn')?.addEventListener('click', handleNicknameUpdate);
                // Attach listener to the update password button
                document.getElementById('update-password-btn')?.addEventListener('click', handlePasswordUpdate);
                // Attach listener to save API key button
                document.getElementById('save-api-key-btn')?.addEventListener('click', () => {
                    const apiKeyInput = document.getElementById('gemini-api-key');
                    const apiKey = apiKeyInput.value.trim();
                    if (apiKey) {
                        localStorage.setItem('gemini-api-key', apiKey);
                        showToast(currentLanguage === 'it' ? 'Chiave API salvata!' : 'API Key saved!');
                        // Ricarica la pagina per applicare la nuova chiave
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        localStorage.removeItem('gemini-api-key');
                        showToast(currentLanguage === 'it' ? 'Chiave API rimossa' : 'API Key removed');
                    }
                });
                // Attach listener to the logout button inside the modal
                document.getElementById('logout-btn-modal')?.addEventListener('click', () => {
                    handleLogout(); // Usa la nuova funzione centralizzata
                    closeModal();
                });
            };

            const handleNicknameUpdate = async () => {
                const nicknameInput = document.getElementById('profile-nickname');
                const newNickname = nicknameInput.value.trim();
                const t = translations[currentLanguage];

                if (!newNickname) {
                    showToast(t.nicknameRequired);
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userDocRef, { nickname: newNickname });
                    currentUser.nickname = newNickname;
                    showToast(t.nicknameUpdateSuccess);
                    closeModal(); // Close modal on success
                } catch (error) {
                    console.error("Error updating nickname:", error);
                    showToast(`Error: ${error.message}`);
                }
            };

            const handlePasswordUpdate = async () => {
                const newPasswordInput = document.getElementById('profile-new-password');
                const confirmPasswordInput = document.getElementById('profile-confirm-password');
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                const t = translations[currentLanguage];

                if (newPassword.length < 6) {
                    showToast(t.passwordTooShort);
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showToast(t.passwordsDoNotMatch);
                    return;
                }

                try {
                    await updatePassword(auth.currentUser, newPassword);
                    showToast(t.passwordUpdateSuccess);
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    closeModal(); // Close modal on success
                } catch (error) {
                    console.error("Error updating password:", error);
                    showToast(t.updatePasswordError.replace('%s', error.message));
                }
            };

            // NEW FUNCTION: Open Add App Modal
            const openAddAppModal = () => {
                const t = translations[currentLanguage];

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'add-app', page: currentView }, '', '');

                // Get available categories for the dropdown
                const categoryOptions = categories.map(cat =>
                    `<option value="${cat.id}">${cat.name[currentLanguage]}</option>`
                ).join('');

                // Conditionally create the logo input HTML
                let logoInputHTML = '';
                if (currentUser.uid) {
                    // Logged-in user: URL input
                    logoInputHTML = `
                        <label for="add-app-logo-url" data-translate="logoURLLabel">${t.logoURLLabel}</label>
                        <input type="url" id="add-app-logo-url" placeholder="${t.logoURLPlaceholder}">
                    `;
                } else {
                    // Guest user: File input with improved UI
                    logoInputHTML = `
                        <label data-translate="appLogoLabel">${t.appLogoLabel}</label>
                        <div style="display: flex; flex-direction: column; gap: 12px; align-items: center; padding: 20px; background: var(--Koda-bg-light); border-radius: 8px; border: 2px dashed var(--Koda-text-secondary);">
                            <img id="add-app-logo-preview" src="" alt="Logo Preview" style="display: none; width: 120px; height: 120px; object-fit: cover; border-radius: 8px;">
                            <div id="add-app-logo-placeholder" style="width: 120px; height: 120px; background: var(--Koda-card); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                                🖼️
                            </div>
                            <input type="file" id="add-app-logo" accept="image/*" style="display: none;">
                            <button type="button" class="button" onclick="document.getElementById('add-app-logo').click()" style="background: var(--Koda-accent); color: #000; padding: 10px 20px; font-size: 14px; display: flex; align-items: center; gap: 8px; justify-content: center;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <span>${currentLanguage === 'it' ? 'Carica Immagine' : 'Upload Image'}</span>
                            </button>
                            <p style="font-size: 12px; color: var(--Koda-text-secondary); text-align: center; margin: 0;">
                                ${currentLanguage === 'it' ? 'PNG, JPG o GIF (max 5MB)' : 'PNG, JPG or GIF (max 5MB)'}
                            </p>
                        </div>
                    `;
                }

                const modalHTML = `
                 <div id="add-app-modal" class="modal-overlay visible">
                     <div class="modal-content">
                         <button class="modal-close-btn" data-action="close-modal">×</button>
                         <h2 data-translate="addAppTitle">${t.addAppTitle}</h2>

                         <div class="input-group" style="margin-top: 24px;">
                             <label for="add-app-name" data-translate="appNameLabel">${t.appNameLabel}</label>
                             <input type="text" id="add-app-name" placeholder="${t.appNamePlaceholder}">
                         </div>
                         <div class="input-group">
                             <label for="add-app-description" data-translate="appDescriptionLabel">${t.appDescriptionLabel}</label>
                             <textarea id="add-app-description" placeholder="${t.appDescriptionPlaceholder}"></textarea>
                         </div>
                         <div class="input-group">
                             <label for="add-app-website" data-translate="appWebsiteLabel">${t.appWebsiteLabel}</label>
                             <input type="url" id="add-app-website" placeholder="${t.appWebsitePlaceholder}">
                         </div>
                         <div class="input-group">
                             ${logoInputHTML}
                         </div>
                         <div class="input-group">
                             <label for="add-app-category" data-translate="category">${t.category}</label>
                             <select id="add-app-category" style="width: 100%; padding: 14px 16px; font-size: 16px; background-color: var(--Koda-bg-light); border: 1px solid rgba(128,128,128,0.2); border-radius: 8px; color: var(--Koda-text);">
                                 ${categoryOptions}
                             </select>
                         </div>

                         <button class="button" id="add-app-btn" data-translate="addAppButton">${t.addAppButton}</button>
                     </div>
                 </div>
             `;
                el.modalContainer.innerHTML = modalHTML;

                // Attach listener to the add app button
                document.getElementById('add-app-btn')?.addEventListener('click', handleAddApp);

                // Attach listener for file input change ONLY if it exists (for guests)
                const logoInput = document.getElementById('add-app-logo');
                if (logoInput) {
                    const logoPreview = document.getElementById('add-app-logo-preview');
                    const logoPlaceholder = document.getElementById('add-app-logo-placeholder');
                    logoInput.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        if (file) {
                            // Verifica dimensione file (max 5MB)
                            if (file.size > 5 * 1024 * 1024) {
                                showToast(currentLanguage === 'it' ? 'Immagine troppo grande! Max 5MB' : 'Image too large! Max 5MB');
                                return;
                            }
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                logoPreview.src = e.target.result;
                                logoPreview.style.display = 'block';
                                if (logoPlaceholder) logoPlaceholder.style.display = 'none';
                            };
                            reader.readAsDataURL(file);
                        } else {
                            logoPreview.src = '';
                            logoPreview.style.display = 'none';
                            if (logoPlaceholder) logoPlaceholder.style.display = 'flex';
                        }
                    });
                }
            };

            // NEW FUNCTION: Open Change Nickname Modal
            const openChangeNicknameModal = () => {
                if (!currentUser.uid) return;
                const t = translations[currentLanguage];

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'change-nickname', page: currentView }, '', '');

                const modalHTML = `
                <div id="change-nickname-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <h2 data-translate="changeNicknameTitle">${t.changeNicknameTitle}</h2>
                        
                        <div class="input-group" style="margin-top: 24px;">
                            <label for="change-nickname-input" data-translate="registerNicknameLabel">${t.registerNicknameLabel}</label>
                            <input type="text" id="change-nickname-input" placeholder="${t.registerNicknamePlaceholder}" value="${currentUser.nickname || ''}">
                        </div>
                        <button class="button" id="save-nickname-btn" data-translate="saveNicknameButton">${t.saveNicknameButton}</button>
                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;

                // Attach listener to the save nickname button
                document.getElementById('save-nickname-btn')?.addEventListener('click', handleChangeNickname);
            };

            // NEW FUNCTION: Open Change Password Modal
            const openChangePasswordModal = () => {
                if (!currentUser.uid) return;
                const t = translations[currentLanguage];

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'change-password', page: currentView }, '', '');

                const modalHTML = `
                <div id="change-password-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <h2 data-translate="changePasswordTitle">${t.changePasswordTitle}</h2>
                        
                        <div class="input-group" style="margin-top: 24px;">
                            <label for="change-new-password" data-translate="newPasswordLabel">${t.newPasswordLabel}</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="change-new-password" placeholder="${t.newPasswordPlaceholder}">
                                <button type="button" class="password-toggle-icon" data-action="toggle-password-visibility" data-toggle-for="change-new-password">${eyeIconSVG}</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="change-confirm-password" data-translate="confirmPasswordLabel">${t.confirmPasswordLabel}</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="change-confirm-password" placeholder="${t.confirmPasswordPlaceholder}">
                                <button type="button" class="password-toggle-icon" data-action="toggle-password-visibility" data-toggle-for="change-confirm-password">${eyeIconSVG}</button>
                            </div>
                        </div>
                        <button class="button" id="save-password-btn" data-translate="savePasswordButton">${t.savePasswordButton}</button>
                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;

                // Attach listener to the save password button
                document.getElementById('save-password-btn')?.addEventListener('click', handleChangePassword);
            };

            // NEW FUNCTION: Handle Change Nickname
            const handleChangeNickname = async () => {
                const nicknameInput = document.getElementById('change-nickname-input');
                const newNickname = nicknameInput.value.trim();
                const t = translations[currentLanguage];

                if (!newNickname) {
                    showToast(t.nicknameRequired);
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userDocRef, { nickname: newNickname });
                    currentUser.nickname = newNickname;
                    showToast(t.nicknameUpdateSuccess);
                    closeModal();
                } catch (error) {
                    console.error("Error updating nickname:", error);
                    showToast(`Error: ${error.message}`);
                }
            };

            // NEW FUNCTION: Handle Change Password
            const handleChangePassword = async () => {
                const newPasswordInput = document.getElementById('change-new-password');
                const confirmPasswordInput = document.getElementById('change-confirm-password');
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                const t = translations[currentLanguage];

                if (newPassword.length < 6) {
                    showToast(t.passwordTooShort);
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showToast(t.passwordsDoNotMatch);
                    return;
                }

                try {
                    await updatePassword(auth.currentUser, newPassword);
                    showToast(t.passwordUpdateSuccess);
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    closeModal();
                } catch (error) {
                    console.error("Error updating password:", error);
                    showToast(t.updatePasswordError.replace('%s', error.message));
                }
            };

            // NUOVA FUNZIONE: Apre il modale per creare una collezione
            const openCreateCollectionModal = () => {
                const t = translations[currentLanguage];
                const modalHTML = `
                <div id="create-collection-modal" class="modal-overlay visible">
                    <div class="modal-content" style="text-align: left; max-width: 400px;">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <h2 style="font-size: 20px; margin-bottom: 24px;">${t.createCollection}</h2>
                        <div class="input-group">
                            <label for="new-collection-name">${t.collectionName}</label>
                            <input type="text" id="new-collection-name" placeholder="${t.collectionNamePlaceholder}" style="margin-top: 8px;">
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button class="pill-btn" data-action="close-modal">${t.cancel}</button>
                            <button class="button" data-action="submit-create-collection">${t.createCollectionButton}</button>
                        </div>
                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;
                // Mette il focus sull'input field all'apertura del modale
                document.getElementById('new-collection-name')?.focus();
            };
            const handleLogout = async () => {
                if (currentUser && currentUser.uid) {
                    try {
                        // 1. Imposta lo stato a 'offline' su Firebase e attende il completamento
                        await updateUserOnlineStatus(currentUser.uid, false);

                        // 2. Solo dopo, esegue il logout da Firebase Auth
                        await signOut(auth);

                        // 3. Mostra un messaggio di successo
                        showToast(translations[currentLanguage].logout + " effettuato.");
                    } catch (error) {
                        console.error("Logout Error:", error);
                        showToast("Errore durante il logout.");
                    }
                }
            };
            // NUOVA FUNZIONE: Apre il modale per rinominare una collezione
            const openRenameCollectionModal = (collectionId, currentName) => {
                const t = translations[currentLanguage];
                const modalHTML = `
                <div id="rename-collection-modal" class="modal-overlay visible">
                    <div class="modal-content" style="text-align: left; max-width: 400px;">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <h2 style="font-size: 20px; margin-bottom: 24px;">${t.renameCollection}</h2>
                        <div class="input-group">
                            <label for="rename-collection-name">${t.collectionName}</label>
                            <input type="text" id="rename-collection-name" value="${currentName}" placeholder="${t.collectionNamePlaceholder}" style="margin-top: 8px;">
                        </div>
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button class="pill-btn" data-action="close-modal">${t.cancel}</button>
                            <button class="button" data-action="submit-rename-collection" data-collection-id="${collectionId}">${t.saveChanges}</button>
                        </div>
                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;
                document.getElementById('rename-collection-name')?.focus();
            };

            // NEW FUNCTION: Open Sent Reviews Modal
            const openSentReviewsModal = async () => {
                if (!currentUser.uid) return;
                const t = translations[currentLanguage];

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'sent-reviews', page: currentView }, '', '');

                const modalHTML = `
                <div id="sent-reviews-modal" class="sent-reviews-modal visible">
                    <div class="sent-reviews-modal-content">
                        <div class="sent-reviews-modal-header">
                            <h2 class="sent-reviews-modal-title" data-translate="sentReviews">Recensioni inviate</h2>
                            <button class="sent-reviews-modal-close" data-action="close-modal">×</button>
                        </div>
                        <div id="sent-reviews-container">
                            <div class="loading-reviews">${t.loadingReviews || 'Caricamento recensioni...'}</div>
                        </div>
                    </div>
                </div>`;

                el.modalContainer.innerHTML = modalHTML;
                await loadSentReviews();
            };

            // NEW FUNCTION: Load Sent Reviews (CORRECTED AND OPTIMIZED)
            const loadSentReviews = async () => {
                const container = document.getElementById('sent-reviews-container');
                if (!container || !currentUser.uid) return;

                const t = translations[currentLanguage];
                container.innerHTML = `<div class="loading-reviews">${t.loadingReviews || 'Caricamento recensioni...'}</div>`;

                try {
                    // Step 1: Use a Collection Group Query to find all reviews by the current user
                    const reviewsQuery = query(collectionGroup(db, 'reviews'), where('userId', '==', currentUser.uid));
                    const reviewsSnapshot = await getDocs(reviewsQuery);

                    if (reviewsSnapshot.empty) {
                        container.innerHTML = `<div class="no-sent-reviews">${t.noSentReviews || 'Non hai ancora inviato recensioni.'}</div>`;
                        return;
                    }

                    // Step 2: Prepare to fetch the tool data for each review
                    const reviewsWithToolData = [];
                    for (const reviewDoc of reviewsSnapshot.docs) {
                        const reviewData = reviewDoc.data();
                        const toolId = reviewDoc.ref.parent.parent.id; // Get the parent tool ID

                        // Find the tool in the local list (static + custom)
                        const tool = getAllToolsForCurrentUser().find(t => t.id === toolId);

                        if (tool) {
                            reviewsWithToolData.push({
                                id: reviewDoc.id,
                                toolId: toolId,
                                toolName: tool.name, // Use name from local data
                                toolLogoUrl: tool.logoUrl, // Use logo from local data
                                ...reviewData
                            });
                        }
                    }

                    // Step 3: Sort and render the reviews
                    reviewsWithToolData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    const reviewsHTML = reviewsWithToolData.map(review => {
                        const starsHTML = Array.from({ length: 5 }, (_, i) =>
                            `<span class="star ${i < review.rating ? '' : 'empty'}">★</span>`
                        ).join('');
                        const reviewDate = review.createdAt ? new Date(review.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';

                        return `
                        <div class="sent-review-item">
                            <div class="sent-review-header">
                                <div class="sent-review-tool-info">
                                    <img src="${review.toolLogoUrl}" alt="${review.toolName}" class="sent-review-tool-logo">
                                    <div class="sent-review-tool-name">${review.toolName}</div>
                                </div>
                                <div class="sent-review-actions">
                                    <button class="sent-review-edit-btn" data-action="edit-review" data-tool-id="${review.toolId}" data-review-id="${review.id}">Modifica</button>
                                    <button class="sent-review-delete-btn" data-action="delete-review" data-tool-id="${review.toolId}" data-review-id="${review.id}">Elimina</button>
                                </div>
                            </div>
                            <div class="sent-review-rating">${starsHTML}</div>
                            <div class="sent-review-text">${review.text}</div>
                            <div class="sent-review-date">${reviewDate}</div>
                        </div>`;
                    }).join('');

                    container.innerHTML = reviewsHTML;

                } catch (error) {
                    console.error('Error loading sent reviews:', error);
                    container.innerHTML = `<div class="no-sent-reviews">Errore nel caricamento delle recensioni.</div>`;
                    // Firestore often gives a helpful error message in the console with a link to create the required index for collection group queries.
                    if (error.message.includes('index')) {
                        container.innerHTML += `<p style="font-size:12px; color: #ff6b6b; margin-top: 10px;">Questo errore potrebbe richiedere la creazione di un indice in Firestore. Controlla la console del browser per un link di creazione automatica.</p>`;
                    }
                }
            };

            // NEW FUNCTION: Open All User Reviews Modal
            const openAllUserReviewsModal = async (toolId) => {
                const t = translations[currentLanguage];

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'all-user-reviews', page: currentView }, '', '');

                const modalHTML = `
                <div id="all-user-reviews-modal" class="sent-reviews-modal visible">
                    <div class="sent-reviews-modal-content">
                        <div class="sent-reviews-modal-header">
                            <h2 class="sent-reviews-modal-title" data-translate="allUserReviews">Tutte le recensioni utente</h2>
                            <button class="sent-reviews-modal-close" data-action="close-modal">×</button>
                        </div>
                        <div id="all-user-reviews-container">
                            <div class="loading-reviews">${t.loadingReviews || 'Caricamento recensioni...'}</div>
                        </div>
                    </div>
                </div>`;

                el.modalContainer.innerHTML = modalHTML;
                await loadAllUserReviews(toolId);
            };

            // NEW FUNCTION: Load All User Reviews for a specific tool
            const loadAllUserReviews = async (toolId) => {
                const container = document.getElementById('all-user-reviews-container');
                if (!container) return;

                try {
                    const t = translations[currentLanguage];
                    const reviewsRef = collection(db, 'tools', toolId, 'reviews');
                    const reviewsQuery = query(reviewsRef, orderBy('createdAt', 'desc'));
                    const reviewsSnapshot = await getDocs(reviewsQuery);

                    if (reviewsSnapshot.empty) {
                        container.innerHTML = `<div class="no-reviews">${t.noReviews}</div>`;
                        return;
                    }

                    let reviewsHTML = '';
                    for (const reviewDoc of reviewsSnapshot.docs) {
                        const review = reviewDoc.data();
                        let username = 'Utente Anonimo';
                        let userInitial = 'U';

                        if (review.userId) {
                            try {
                                const userDoc = await getDoc(doc(db, 'users', review.userId));
                                if (userDoc.exists()) {
                                    const userData = userDoc.data();
                                    username = userData.nickname || userData.name || 'Utente';
                                    userInitial = username.charAt(0).toUpperCase();
                                }
                            } catch (error) {
                                console.error('Error fetching user data:', error);
                            }
                        }

                        const starsHTML = Array.from({ length: 5 }, (_, i) =>
                            `<span class="star ${i < review.rating ? '' : 'empty'}">★</span>`
                        ).join('');

                        reviewsHTML += `
                        <div class="review-item">
                            <div class="review-header">
                                <div class="review-user">
                                    <div class="review-avatar">${userInitial}</div>
                                    <div class="review-user-info">
                                        <div class="review-username">${username}</div>
                                        <div class="review-date">${review.createdAt?.toDate().toLocaleDateString()}</div>
                                    </div>
                                </div>
                                <div class="review-rating">${starsHTML}</div>
                            </div>
                            <div class="review-text">${review.text}</div>
                        </div>`;
                    }

                    container.innerHTML = reviewsHTML;
                } catch (error) {
                    console.error('Error loading all user reviews:', error);
                    container.innerHTML = '<div class="no-reviews">Errore nel caricamento delle recensioni.</div>';
                }
            };

            // NEW FUNCTION: Open Edit Review Modal
            const openEditReviewModal = async (toolId, reviewId) => {
                if (!currentUser.uid) return;

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'edit-review', page: currentView }, '', '');

                try {
                    const reviewDoc = await getDoc(doc(db, 'tools', toolId, 'reviews', reviewId));
                    if (!reviewDoc.exists()) {
                        showToast('Recensione non trovata');
                        return;
                    }

                    const reviewData = reviewDoc.data();
                    const t = translations[currentLanguage];

                    const modalHTML = `
                    <div id="edit-review-modal" class="review-modal visible">
                        <div class="review-modal-content">
                            <div class="review-modal-header">
                                <h2 class="review-modal-title">Modifica Recensione</h2>
                                <button class="review-modal-close" data-action="close-modal">×</button>
                            </div>
                            <div class="rating-input-container">
                                <label class="rating-input-label">Valutazione</label>
                                <div class="stars-input">
                                    ${Array.from({ length: 5 }, (_, i) =>
                        `<span class="star-input ${i < reviewData.rating ? 'active' : ''}" data-rating="${i + 1}">★</span>`
                    ).join('')}
                                </div>
                            </div>
                            <div class="review-text-container">
                                <label class="review-text-label">Recensione</label>
                                <textarea class="review-text-input" id="edit-review-text" placeholder="Scrivi la tua recensione...">${reviewData.text}</textarea>
                            </div>
                            <div class="review-modal-actions">
                                <button class="review-cancel-btn" data-action="close-modal">Annulla</button>
                                <button class="review-submit-btn" id="update-review-btn" data-tool-id="${toolId}" data-review-id="${reviewId}">Aggiorna Recensione</button>
                            </div>
                        </div>
                    </div>`;

                    el.modalContainer.innerHTML = modalHTML;

                    // Set current rating
                    window.currentEditRating = reviewData.rating;

                    // Attach event listener for update
                    document.getElementById('update-review-btn')?.addEventListener('click', handleUpdateReview);
                } catch (error) {
                    console.error('Error opening edit review modal:', error);
                    showToast('Errore nel caricamento della recensione');
                }
            };

            // NEW FUNCTION: Handle Update Review
            const handleUpdateReview = async (event) => {
                const toolId = event.target.dataset.toolId;
                const reviewId = event.target.dataset.reviewId;
                const reviewText = document.getElementById('edit-review-text').value.trim();
                const rating = window.currentEditRating || 1;

                if (!reviewText) {
                    showToast('Inserisci il testo della recensione');
                    return;
                }

                try {
                    const reviewRef = doc(db, 'tools', toolId, 'reviews', reviewId);
                    await updateDoc(reviewRef, {
                        text: reviewText,
                        rating: rating,
                        updatedAt: new Date()
                    });

                    showToast('Recensione aggiornata con successo');
                    closeModal();

                    // Refresh the sent reviews modal if it's open
                    if (document.getElementById('sent-reviews-modal')) {
                        await loadSentReviews();
                    }
                } catch (error) {
                    console.error('Error updating review:', error);
                    showToast('Errore nell\'aggiornamento della recensione');
                }
            };

            // NEW FUNCTION: Confirm Delete Review
            const confirmDeleteReview = (toolId, reviewId) => {
                const t = translations[currentLanguage];

                const modalHTML = `
                <div id="confirm-delete-review-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <h2>Conferma Eliminazione</h2>
                        <p>Sei sicuro di voler eliminare questa recensione? Questa azione non può essere annullata.</p>
                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                            <button class="review-cancel-btn" data-action="close-modal">Annulla</button>
                            <button class="review-submit-btn" id="confirm-delete-review-btn" data-tool-id="${toolId}" data-review-id="${reviewId}" style="background-color: #ff6b6b;">Elimina</button>
                        </div>
                    </div>
                </div>`;

                el.modalContainer.innerHTML = modalHTML;

                // Attach event listener for delete confirmation
                document.getElementById('confirm-delete-review-btn')?.addEventListener('click', handleDeleteReview);
            };

            // NEW FUNCTION: Handle Delete Review
            const handleDeleteReview = async (event) => {
                const toolId = event.target.dataset.toolId;
                const reviewId = event.target.dataset.reviewId;

                try {
                    await deleteDoc(doc(db, 'tools', toolId, 'reviews', reviewId));
                    showToast('Recensione eliminata con successo');
                    closeModal();

                    // Refresh the sent reviews modal if it's open
                    if (document.getElementById('sent-reviews-modal')) {
                        await loadSentReviews();
                    }
                } catch (error) {
                    console.error('Error deleting review:', error);
                    showToast('Errore nell\'eliminazione della recensione');
                }
            };

            // NEW FUNCTION: Open Replace Featured Modal
            const openReplaceFeaturedModal = (staticToolId) => {
                // Allow any logged-in user to perform this action
                if (!currentUser.uid) return;
                const t = translations[currentLanguage];
                const userTools = currentUser.userTools || [];

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'replace-featured', page: currentView }, '', '');

                const toolListHTML = userTools.length > 0 ? userTools.map(tool => `
                 <div class="tool-list-item" data-action="select-user-tool-for-featured" data-static-id="${staticToolId}" data-user-id="${tool.id}">
                     <img src="${tool.logoUrl}" alt="${tool.name}" loading="lazy">
                     <div class="info">
                         <div class="tool-name">${tool.name}</div>
                         <div class="tool-subtext">${getTranslatedCategoryName(tool.category)}</div>
                     </div>
                 </div>
             `).join('') : `<div id="empty-state" style="padding: 20px 0;">${t.noUserApps}</div>`;


                const modalHTML = `
                 <div id="replace-featured-modal" class="modal-overlay visible">
                     <div class="modal-content">
                         <button class="modal-close-btn" data-action="close-modal">×</button>
                         <h2 data-translate="replaceFeaturedTitle">${t.replaceFeaturedTitle}</h2>
                         <p style="color: var(--Koda-text-secondary); font-size: 14px; margin-bottom: 20px;" data-translate="selectAppToFeature">${t.selectAppToFeature}</p>
                         <div class="list-container">
                             ${toolListHTML}
                         </div>
                     </div>
                 </div>
             `;
                el.modalContainer.innerHTML = modalHTML;
            };


            // NEW FUNCTION: Handle Add App submission (Firestore)
            const handleAddApp = async () => {
                const t = translations[currentLanguage];
                const name = document.getElementById('add-app-name').value.trim();
                const description = document.getElementById('add-app-description').value.trim();
                const website = document.getElementById('add-app-website').value.trim();
                const category = document.getElementById('add-app-category').value;

                // Validazione campi comuni
                if (!name) { showToast(t.appNameRequired); return; }
                if (!website) { showToast(t.appWebsiteRequired); return; }

                // Logica per utenti LOGGATI (usa Firebase e URL per il logo)
                if (currentUser.uid) {
                    const logoUrl = document.getElementById('add-app-logo-url').value.trim();
                    if (!logoUrl) { showToast(t.logoURLPlaceholder); return; } // Usa una traduzione appropriata se disponibile

                    const newTool = {
                        id: `user-${currentUser.uid}-${Date.now()}`,
                        name: name,
                        description: { it: description, en: description },
                        website: website,
                        logoUrl: logoUrl,
                        category: category,
                        country: 'User Added',
                    };

                    const userDocRef = doc(db, "users", currentUser.uid);
                    try {
                        // Aggiungi l'app e automaticamente ai preferiti
                        await updateDoc(userDocRef, {
                            userTools: arrayUnion(newTool),
                            favorites: arrayUnion(newTool.id)
                        });
                        currentUser.userTools = [...(currentUser.userTools || []), newTool];
                        currentUser.favorites = [...(currentUser.favorites || []), newTool.id];
                        showToast(t.addAppSuccess);
                    } catch (error) {
                        console.error("Errore nell'aggiungere l'app utente:", error);
                        showToast(t.addAppError.replace('%s', error.message));
                        return; // Esce in caso di errore
                    }
                }
                // Logica per utenti OSPITI (usa localStorage e caricamento file)
                else {
                    const logoInput = document.getElementById('add-app-logo');
                    const file = logoInput.files[0];
                    if (!file) { showToast(t.appLogoRequired); return; }

                    const logoUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });

                    const newTool = {
                        id: `guest-${Date.now()}`,
                        name: name,
                        description: description, // Per gli ospiti, una stringa semplice è sufficiente
                        website: website,
                        logoUrl: logoUrl, // Stringa Base64
                        category: category,
                        country: 'User Added',
                    };

                    let guestUserTools = JSON.parse(localStorage.getItem('guest-userTools')) || [];
                    guestUserTools.push(newTool);
                    localStorage.setItem('guest-userTools', JSON.stringify(guestUserTools));
                    currentUser.userTools = guestUserTools;

                    // Aggiungi automaticamente ai preferiti guest
                    let guestFavorites = JSON.parse(localStorage.getItem('guest-favorites')) || [];
                    if (!guestFavorites.includes(newTool.id)) {
                        guestFavorites.push(newTool.id);
                        localStorage.setItem('guest-favorites', JSON.stringify(guestFavorites));
                        currentUser.favorites = guestFavorites;
                    }

                    showToast(t.addAppSuccess);
                }

                // Azioni comuni dopo il successo
                closeModal();
                renderView();
            };

            // NEW FUNCTION: Open Edit App Modal
            const openEditAppModal = (toolId) => {
                if (!currentUser.uid) return;
                const t = translations[currentLanguage];
                const tool = (currentUser.userTools || []).find(t => t.id === toolId);
                if (!tool) {
                    showToast("App not found.");
                    return;
                }

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'edit-app', page: currentView }, '', '');

                const modalHTML = `
                 <div id="edit-app-modal" class="modal-overlay visible">
                     <div class="modal-content">
                         <button class="modal-close-btn" data-action="close-modal">×</button>
                         <h2 data-translate="editAppTitle">${t.editAppTitle}</h2>

                         <div class="input-group" style="margin-top: 24px;">
                             <label for="edit-app-name">${t.appNameLabel}</label>
                             <input type="text" id="edit-app-name" value="${tool.name}">
                         </div>
                         <div class="input-group">
                             <label for="edit-app-website">${t.appWebsiteLabel}</label>
                             <input type="url" id="edit-app-website" value="${tool.website}">
                         </div>
                         <div class="input-group">
                             <label>${currentLanguage === 'it' ? 'Logo App' : 'App Logo'}</label>
                             <div style="display: flex; flex-direction: column; gap: 12px; align-items: center; padding: 20px; background: var(--Koda-bg-light); border-radius: 8px; border: 2px dashed var(--Koda-text-secondary);">
                                 <img id="edit-app-logo-preview" src="${tool.logoUrl}" alt="Logo Preview" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px;">
                                 <input type="file" id="edit-app-logo" accept="image/*" style="display: none;">
                                 <button type="button" class="button" onclick="document.getElementById('edit-app-logo').click()" style="background: var(--Koda-accent); color: #000; padding: 10px 20px; font-size: 14px;">
                                     ${currentLanguage === 'it' ? '🔄 Cambia Immagine' : '🔄 Change Image'}
                                 </button>
                                 <p style="font-size: 12px; color: var(--Koda-text-secondary); text-align: center; margin: 0;">
                                     ${currentLanguage === 'it' ? 'PNG, JPG o GIF (max 5MB)' : 'PNG, JPG or GIF (max 5MB)'}
                                 </p>
                             </div>
                         </div>

                         <div style="display: flex; justify-content: space-between; gap: 12px; margin-top: 24px;">
                            <button class="button" id="delete-app-btn" data-id="${tool.id}" style="background-color: #cc3333; flex-grow: 1;">${t.deleteButton}</button>
                            <button class="button" id="update-app-btn" data-id="${tool.id}" style="flex-grow: 2;">${t.saveChanges}</button>
                         </div>
                     </div>
                 </div>
             `;
                el.modalContainer.innerHTML = modalHTML;

                // Listener per cambio logo
                const editLogoInput = document.getElementById('edit-app-logo');
                const editLogoPreview = document.getElementById('edit-app-logo-preview');
                if (editLogoInput && editLogoPreview) {
                    editLogoInput.addEventListener('change', (event) => {
                        const file = event.target.files[0];
                        if (file) {
                            // Verifica dimensione file (max 5MB)
                            if (file.size > 5 * 1024 * 1024) {
                                showToast(currentLanguage === 'it' ? 'Immagine troppo grande! Max 5MB' : 'Image too large! Max 5MB');
                                return;
                            }
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                editLogoPreview.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }

                document.getElementById('update-app-btn').addEventListener('click', (e) => {
                    console.log('update-app-btn clicked');
                    const id = e.currentTarget.dataset.id;
                    console.log('App ID:', id);
                    handleUpdateApp(id);
                });

                document.getElementById('delete-app-btn').addEventListener('click', (e) => {
                    if (confirm(t.confirmDeleteApp)) {
                        const id = e.currentTarget.dataset.id;
                        removeUserTool(id);
                    }
                });
            };

            // NEW FUNCTION: Handle guest app removal
            const removeGuestTool = (toolId) => {
                if (currentUser.uid) return; // Sicurezza: solo per ospiti
                let guestUserTools = JSON.parse(localStorage.getItem('guest-userTools')) || [];
                guestUserTools = guestUserTools.filter(tool => tool.id !== toolId);
                localStorage.setItem('guest-userTools', JSON.stringify(guestUserTools));
                currentUser.userTools = guestUserTools; // Aggiorna lo stato locale
                showToast("App rimossa con successo!");
                renderView(); // Ricarica la vista per mostrare la rimozione
            };
            // NEW FUNCTION: Handle app update
            const handleUpdateApp = async (toolId) => {
                console.log('handleUpdateApp called with toolId:', toolId);
                if (!currentUser.uid) {
                    console.log('No user logged in');
                    return;
                }

                const t = translations[currentLanguage];
                const nameInput = document.getElementById('edit-app-name');
                const websiteInput = document.getElementById('edit-app-website');

                const newName = nameInput.value.trim();
                const newWebsite = websiteInput.value.trim();

                if (!newName) {
                    showToast(t.appNameRequired);
                    return;
                }
                if (!newWebsite) {
                    showToast(t.appWebsiteRequired);
                    return;
                }

                try {
                    new URL(newWebsite);
                } catch (e) {
                    showToast("URL del sito web non valido.");
                    return;
                }

                const toolIndex = (currentUser.userTools || []).findIndex(t => t.id === toolId);

                if (toolIndex === -1) {
                    showToast("App non trovata.");
                    return;
                }

                // Controlla se è stata caricata una nuova immagine
                const editLogoPreview = document.getElementById('edit-app-logo-preview');
                const newLogoUrl = editLogoPreview ? editLogoPreview.src : updatedUserTools[toolIndex].logoUrl;

                const updatedUserTools = [...currentUser.userTools];
                updatedUserTools[toolIndex] = {
                    ...updatedUserTools[toolIndex],
                    name: newName,
                    website: newWebsite,
                    logoUrl: newLogoUrl
                };

                const userDocRef = doc(db, "users", currentUser.uid);

                try {
                    await updateDoc(userDocRef, {
                        userTools: updatedUserTools
                    });

                    currentUser.userTools = updatedUserTools;

                    showToast(t.appUpdateSuccess);
                    closeModal();
                    renderView();
                } catch (error) {
                    console.error("Errore durante l'aggiornamento dell'app:", error);
                    showToast(`Errore: ${error.message}`);
                }
            };


            // NEW FUNCTION: Add AI Suggestion
            window.addAiSuggestion = async () => {
                console.log('addAiSuggestion function called');
                if (!currentUser.uid) {
                    console.log('No user logged in, returning');
                    return;
                }

                const t = translations[currentLanguage];
                console.log('Creating AI suggestion modal');

                // Create modal for AI suggestion form
                const modalHTML = `
                <div id="add-ai-suggestion-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <h2>${t.addAiSuggestionTitle}</h2>
                        
                        <form id="ai-suggestion-form">
                            <div class="form-group">
                                <label for="app-name">${t.appNameLabel} *</label>
                                <input type="text" id="app-name" required placeholder="${t.appNamePlaceholder}">
                            </div>
                            
                            <div class="form-group">
                                <label for="app-description">${t.appDescriptionLabel} *</label>
                                <textarea id="app-description" required placeholder="${t.appDescriptionPlaceholder}" rows="4"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="app-website">${t.appWebsiteLabel} *</label>
                                <input type="url" id="app-website" required placeholder="${t.appWebsitePlaceholder}">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="app-category">${t.category} *</label>
                                    <select id="app-category" required>
                                        <option value="">${t.selectCategory}</option>
                                        <option value="Testo">Testo</option>
                                        <option value="Immagini">Immagini</option>
                                        <option value="Video">Video</option>
                                        <option value="Audio">Audio</option>
                                        <option value="Codice">Codice</option>
                                        <option value="Presentazioni">Presentazioni</option>
                                        <option value="Browser AI">Browser AI</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="app-country">${t.country} *</label>
                                    <select id="app-country" required>
                                        <option value="">${t.selectCountry}</option>
                                        <option value="USA">USA</option>
                                        <option value="Cina">Cina</option>
                                        <option value="Europe">Europe</option>
                                        
                                        <option value="Altro">Altro</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="button secondary" data-action="close-modal">${t.cancel}</button>
                                <button type="submit" class="button primary">${t.addAiSuggestionButton}</button>
                            </div>
                        </form>
                    </div>
                </div>`;

                el.modalContainer.innerHTML = modalHTML;

                // Add form submit handler
                document.getElementById('ai-suggestion-form').addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const appName = document.getElementById('app-name').value.trim();
                    const appDescription = document.getElementById('app-description').value.trim();
                    const appWebsite = document.getElementById('app-website').value.trim();
                    const appCategory = document.getElementById('app-category').value;
                    const appCountry = document.getElementById('app-country').value;

                    if (!appName || !appDescription || !appWebsite || !appCategory || !appCountry) {
                        showToast(t.allFieldsRequired);
                        return;
                    }

                    // Validate URL format
                    try {
                        new URL(appWebsite);
                    } catch (e) {
                        showToast("Inserisci un URL valido (es. https://example.com)");
                        return;
                    }

                    try {
                        // Show loading state
                        const submitBtn = document.querySelector('#ai-suggestion-form button[type="submit"]');
                        const originalText = submitBtn.textContent;
                        submitBtn.textContent = 'Salvando...';
                        submitBtn.disabled = true;

                        const userDocRef = doc(db, "users", currentUser.uid);
                        const newSuggestion = {
                            id: `suggestion-${currentUser.uid}-${Date.now()}`,
                            appName: appName,
                            description: appDescription,
                            website: appWebsite,
                            category: appCategory,
                            country: appCountry,
                            timestamp: Date.now()
                        };

                        await updateDoc(userDocRef, {
                            aiSuggestions: arrayUnion(newSuggestion)
                        });

                        // Update local state
                        currentUser.aiSuggestions = [...(currentUser.aiSuggestions || []), newSuggestion];

                        showToast(t.aiSuggestionAdded);
                        closeModal();
                        renderView(); // Re-render to show the new suggestion
                    } catch (error) {
                        console.error("Error adding AI suggestion:", error);
                        showToast(`Error: ${error.message}`);
                    } finally {
                        // Reset button state
                        const submitBtn = document.querySelector('#ai-suggestion-form button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.textContent = t.addAiSuggestionButton;
                            submitBtn.disabled = false;
                        }
                    }
                });
            };

            // NEW FUNCTION: Remove AI Suggestion
            const removeAiSuggestion = async (suggestionId) => {
                if (!currentUser.uid) return;

                const t = translations[currentLanguage];
                const userDocRef = doc(db, "users", currentUser.uid);

                try {
                    const updatedSuggestions = (currentUser.aiSuggestions || []).filter(s => s.id !== suggestionId);
                    await updateDoc(userDocRef, {
                        aiSuggestions: updatedSuggestions
                    });
                    currentUser.aiSuggestions = updatedSuggestions;
                    showToast(t.aiSuggestionRemoved);
                    renderView(); // Re-render to update the list
                } catch (error) {
                    console.error("Error removing AI suggestion:", error);
                    showToast(`Error: ${error.message}`);
                }
            };

            // NEW FUNCTION: Search Users (for button click)
            const searchUsers = async () => {
                if (!currentUser.uid) return;

                const searchInput = document.getElementById('user-search-input');
                const searchTerm = searchInput.value.trim();
                const t = translations[currentLanguage];

                if (!searchTerm) {
                    showToast("Inserisci un nickname da cercare.");
                    return;
                }

                await searchUsersByTerm(searchTerm);
            };

            // NEW FUNCTION: Create Test Users (for debugging)
            const createTestUsers = async () => {
                if (!currentUser.uid) return;

                try {
                    const testUsers = [
                        {
                            email: "mario.rossi@test.com",
                            nickname: "Mario",
                            aiSuggestions: [
                                {
                                    id: "test-1",
                                    appName: "ChatGPT",
                                    description: "Perfetto per la scrittura creativa e conversazioni",
                                    website: "https://chatgpt.com/",
                                    category: "Testo",
                                    country: "USA",
                                    timestamp: Date.now()
                                },
                                {
                                    id: "test-2",
                                    appName: "Midjourney",
                                    description: "Genera immagini artistiche di alta qualità",
                                    website: "https://www.midjourney.com/",
                                    category: "Immagini",
                                    country: "USA",
                                    timestamp: Date.now() - 86400000
                                }
                            ]
                        },
                        {
                            email: "lucia.bianchi@test.com",
                            nickname: "Lucia",
                            aiSuggestions: [
                                {
                                    id: "test-3",
                                    appName: "Claude",
                                    description: "Eccellente per la programmazione e sviluppo",
                                    website: "https://claude.ai/",
                                    category: "Codice",
                                    country: "USA",
                                    timestamp: Date.now()
                                },
                                {
                                    id: "test-4",
                                    appName: "Google AI Studio",
                                    description: "Per creare app e prototipi con Gemini",
                                    website: "https://aistudio.google.com/",
                                    category: "Codice",
                                    country: "USA",
                                    timestamp: Date.now() - 172800000
                                },
                                {
                                    id: "test-5",
                                    appName: "Perplexity",
                                    description: "La migliore AI per la ricerca web",
                                    website: "https://www.perplexity.ai/",
                                    category: "Testo",
                                    country: "USA",
                                    timestamp: Date.now() - 259200000
                                }
                            ]
                        },
                        {
                            email: "giovanni.verdi@test.com",
                            nickname: "Giovanni",
                            aiSuggestions: [
                                {
                                    id: "test-6",
                                    appName: "Leonardo AI",
                                    description: "Perfetto per asset di gioco e concept art",
                                    website: "https://leonardo.ai/",
                                    category: "Immagini",
                                    country: "USA",
                                    timestamp: Date.now()
                                }
                            ]
                        }
                    ];

                    for (const testUser of testUsers) {
                        const userDocRef = doc(db, "users", `test-${Date.now()}-${Math.random()}`);
                        await setDoc(userDocRef, testUser);
                    }

                    showToast("Utenti di test creati!");
                } catch (error) {
                    console.error("Error creating test users:", error);
                    showToast(`Error: ${error.message}`);
                }
            };

            // NEW FUNCTION: Search Users By Term (for real-time search)
            const searchUsersByTerm = async (searchTerm) => {
                if (!currentUser.uid) return;

                const t = translations[currentLanguage];
                const searchResults = document.getElementById('user-search-results');

                if (!searchResults) return;

                if (!searchTerm || searchTerm.trim().length < 2) {
                    searchResults.innerHTML = '';
                    return;
                }

                try {
                    // Search for users by nickname in Firestore
                    const usersRef = collection(db, "users");
                    const searchTermLower = searchTerm.toLowerCase();

                    // Get all users and filter client-side for better search
                    const querySnapshot = await getDocs(usersRef);

                    if (querySnapshot.empty) {
                        searchResults.innerHTML = `<div id="empty-state">${t.noUsersFound}</div>`;
                        return;
                    }

                    const users = [];
                    querySnapshot.forEach((doc) => {
                        const userData = doc.data();
                        if (doc.id !== currentUser.uid) { // Don't show current user
                            const nickname = userData.nickname || userData.email || '';
                            const email = userData.email || '';

                            // Search in both nickname and email
                            if (nickname.toLowerCase().includes(searchTermLower) ||
                                email.toLowerCase().includes(searchTermLower)) {
                                users.push({
                                    uid: doc.id,
                                    nickname: userData.nickname || userData.email?.split('@')[0] || 'Utente',
                                    email: userData.email || '',
                                    aiSuggestions: userData.aiSuggestions || []
                                });
                            }
                        }
                    });

                    // Limit results to first 10 users
                    const limitedUsers = users.slice(0, 10);

                    if (limitedUsers.length === 0) {
                        searchResults.innerHTML = `<div id="empty-state">${t.noUsersFound}</div>`;
                        return;
                    }

                    const usersHTML = limitedUsers.map(user => `
                    <div class="user-search-result stagger-item" data-uid="${user.uid}">
                        <div class="user-info">
                            <div class="user-nickname">${user.nickname}</div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-suggestions-count">${user.aiSuggestions.length} ${user.aiSuggestions.length === 1 ? t.suggestion : t.suggestions}</div>
                        </div>
                        <div class="user-actions">
                            <button class="view-suggestions-btn" data-action="view-user-suggestions" data-uid="${user.uid}" data-nickname="${user.nickname}">
                                ${t.viewSuggestions}
                            </button>
                            <button class="chat-button" data-action="start-user-chat" data-uid="${user.uid}" data-nickname="${user.nickname}">
                                <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16" fill="currentColor">
                                    <path d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                                </svg>
                                ${t.startChat}
                            </button>
                        </div>
                    </div>
                `).join('');

                    // Add message if there are more results
                    const moreResultsMessage = users.length > 10 ? `<div style="text-align: center; color: var(--Koda-text-secondary); font-size: 12px; margin-top: 8px;">Mostrando i primi 10 risultati di ${users.length}</div>` : '';

                    searchResults.innerHTML = usersHTML + moreResultsMessage;
                } catch (error) {
                    console.error("Error searching users:", error);
                    showToast(`Error: ${error.message}`);
                }
            };

            // NEW FUNCTION: View User Suggestions
            // NEW FUNCTION: Search Users for Chat
            const searchUsersForChat = async (searchTerm, currentUserId) => {
                const resultsContainer = document.getElementById('user-chat-search-results');
                if (!resultsContainer) return;

                const t = translations[currentLanguage];
                if (!searchTerm || searchTerm.trim().length < 2) {
                    resultsContainer.innerHTML = '';
                    return;
                }

                try {
                    const usersRef = collection(db, "users");
                    const searchTermLower = searchTerm.toLowerCase();
                    const querySnapshot = await getDocs(usersRef);

                    const users = [];
                    querySnapshot.forEach((doc) => {
                        const userData = doc.data();
                        if (doc.id !== currentUserId) { // Escludi l'utente corrente
                            const nickname = userData.nickname || '';
                            if (nickname.toLowerCase().includes(searchTermLower)) {
                                users.push({
                                    uid: doc.id,
                                    nickname: userData.nickname,
                                });
                            }
                        }
                    });

                    if (users.length === 0) {
                        resultsContainer.innerHTML = `<div id="empty-state">${t.noUsersFound}</div>`;
                        return;
                    }

                    // **MODIFICA APPLICATA QUI**
                    // Usiamo lo stesso stile della lista chat principale per un look pulito e coerente.
                    resultsContainer.innerHTML = users.slice(0, 10).map(user => `
                    <div class="simple-chat-search-item" onclick="window.handleReactChatStart('${user.uid}', '${user.nickname}')">
                        ${user.nickname}
                    </div>
                `).join('');

                } catch (error) {
                    console.error("Error searching users for chat:", error);
                    resultsContainer.innerHTML = `<div id="empty-state">Error searching users.</div>`;
                }
            };
            window.searchUsersForChat = searchUsersForChat;


            // NEW FUNCTION: View User Suggestions
            const viewUserSuggestions = async (userId, userNickname) => {
                if (!currentUser.uid) return;

                const t = translations[currentLanguage];

                try {
                    const userDocRef = doc(db, "users", userId);
                    const userDocSnap = await getDoc(userDocRef);

                    if (!userDocSnap.exists()) {
                        showToast("Utente non trovato.");
                        return;
                    }

                    const userData = userDocSnap.data();
                    const suggestions = userData.aiSuggestions || [];

                    const modalHTML = `
                    <div id="user-suggestions-modal" class="modal-overlay visible">
                        <div class="modal-content" style="max-width: 600px;">
                            <button class="modal-close-btn" data-action="close-modal">×</button>
                            <h2>${t.userSuggestionsTitle.replace('%s', userNickname)}</h2>
                            <div class="suggestions-list">
                                ${suggestions.length > 0 ? suggestions.map(suggestion => {
                        // Handle both old format (text) and new format (appName, description, etc.)
                        if (suggestion.text) {
                            // Old format - show as simple text
                            return `
                                            <div class="suggestion-item old-format">
                                                <div class="suggestion-text">${suggestion.text}</div>
                                                <div class="suggestion-date">${new Date(suggestion.timestamp).toLocaleDateString()}</div>
                                            </div>
                                        `;
                        } else {
                            // New format - show as app card
                            return `
                                            <div class="suggestion-item new-format">
                                                <div class="suggestion-header">
                                                    <h3 class="suggestion-app-name">${suggestion.appName}</h3>
                                                    <div class="suggestion-meta">
                                                        <span class="suggestion-category">${suggestion.category}</span>
                                                        <span class="suggestion-country">${suggestion.country}</span>
                                                    </div>
                                                </div>
                                                <div class="suggestion-description">${suggestion.description}</div>
                                                <div class="suggestion-actions">
                                                    <a href="${suggestion.website}" target="_blank" class="suggestion-website-btn">
                                                        🌐 ${t.visitWebsite}
                                                    </a>
                                                    <div class="suggestion-date">${new Date(suggestion.timestamp).toLocaleDateString()}</div>
                                                </div>
                                            </div>
                                        `;
                        }
                    }).join('') : `<div id="empty-state">${t.noSuggestions}</div>`}
                            </div>
                        </div>
                    </div>`;

                    el.modalContainer.innerHTML = modalHTML;
                } catch (error) {
                    console.error("Error viewing user suggestions:", error);
                    showToast(`Error: ${error.message}`);
                }
            };

            // NEW FUNCTION: Start User Chat
            const startUserChat = async (userId, userNickname) => {
                if (!currentUser.uid) return;

                try {
                    // Create or get existing chat
                    const chatId = await getOrCreateChat(currentUser.uid, userId);

                    // Navigate to user-chats view
                    currentView = 'user-chats';
                    renderView();

                    // If the user chat app is mounted, trigger the start chat function
                    if (window.startUserChat) {
                        window.startUserChat(userId, userNickname);
                    }
                } catch (error) {
                    console.error("Error starting user chat:", error);
                    showToast(`Error: ${error.message}`);
                }
            };


            // --- NUOVE FUNZIONI PER PROMPT OPTIMIZER E GALLERIA ---

            // Salva un prompt ottimizzato su localStorage per gli ospiti
            const saveOptimizedPromptToLocalStorage = (originalPrompt, optimizedPrompt) => {
                let savedPrompts = JSON.parse(localStorage.getItem('guest-savedPrompts')) || [];
                const newPrompt = {
                    id: `prompt-${Date.now()}`, // ID univoco per la gestione
                    originalPrompt,
                    optimizedPrompt,
                    timestamp: Date.now() // Usiamo un timestamp numerico per l'ordinamento
                };
                savedPrompts.push(newPrompt);
                localStorage.setItem('guest-savedPrompts', JSON.stringify(savedPrompts));
                showToast("Prompt salvato nel tuo browser!");
            };

            // Recupera i prompt salvati da localStorage per gli ospiti
            const getSavedPromptsFromLocalStorage = () => {
                const prompts = JSON.parse(localStorage.getItem('guest-savedPrompts')) || [];
                // Ordina i prompt dal più recente al più vecchio
                return prompts.sort((a, b) => b.timestamp - a.timestamp);
            };

            // Salva un prompt ottimizzato su Firebase
            const saveOptimizedPromptToFirebase = async (originalPrompt, optimizedPrompt) => {
                if (!currentUser.uid) {
                    showToast("Devi essere loggato per salvare i prompt.");
                    triggerAuthFlow();
                    return;
                }
                const savedPromptsRef = collection(db, "users", currentUser.uid, "savedPrompts");
                try {
                    await addDoc(savedPromptsRef, {
                        originalPrompt,
                        optimizedPrompt,
                        timestamp: serverTimestamp()
                    });
                    showToast("Prompt salvato nella galleria!");
                } catch (error) {
                    console.error("Errore nel salvataggio del prompt:", error);
                    showToast("Errore durante il salvataggio del prompt.");
                }
            };

            // Recupera i prompt salvati per l'utente corrente da Firebase
            const getSavedPromptsForUser = async (userId) => {
                const savedPromptsRef = collection(db, "users", userId, "savedPrompts");
                const q = query(savedPromptsRef, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                const prompts = [];
                querySnapshot.forEach((doc) => {
                    prompts.push({ id: doc.id, ...doc.data() });
                });
                return prompts;
            };

            // Gestisce il click sul pulsante "Salva" dell'optimizer
            const handleSaveOptimizedPrompt = async () => {
                const originalPrompt = document.getElementById('optimizer-original-prompt').value.trim();
                const optimizedPrompt = document.getElementById('optimizer-optimized-prompt').value.trim();

                if (!optimizedPrompt) {
                    showToast("Ottimizza prima un prompt per poterlo salvare.");
                    return;
                }

                // Trova il pulsante di salvataggio per dare feedback visivo
                const saveButton = document.querySelector('[data-action="save-optimized-prompt"]');
                const originalButtonText = saveButton ? saveButton.textContent : '';

                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.6';
                    saveButton.innerHTML = '✓ Salvato!';
                    saveButton.style.backgroundColor = 'var(--Koda-accent)';
                    saveButton.style.color = '#000';
                }

                if (currentUser.uid) {
                    await saveOptimizedPromptToFirebase(originalPrompt, optimizedPrompt);
                } else {
                    saveOptimizedPromptToLocalStorage(originalPrompt, optimizedPrompt);
                }

                // Ripristina il pulsante dopo 2 secondi
                if (saveButton) {
                    setTimeout(() => {
                        saveButton.innerHTML = originalButtonText;
                        saveButton.disabled = false;
                        saveButton.style.opacity = '1';
                        saveButton.style.backgroundColor = '';
                        saveButton.style.color = '';
                    }, 2000);
                }
            };

            // Gestisce il click sul pulsante "Copia" dell'optimizer
            const handleCopyOptimizedPrompt = () => {
                const optimizedPrompt = document.getElementById('optimizer-optimized-prompt').value;
                if (optimizedPrompt) {
                    navigator.clipboard.writeText(optimizedPrompt)
                        .then(() => showToast("Prompt ottimizzato copiato!"))
                        .catch(err => showToast("Errore nella copia."));
                } else {
                    showToast("Nessun prompt da copiare.");
                }
            };

            // Apre il modale della galleria con i prompt salvati
            const openPromptGalleryModal = async () => {
                const t = translations[currentLanguage];

                // 1. Mostra subito la struttura del modale con un loader
                const modalShellHTML = `
                    <div id="prompt-gallery-modal" class="modal-overlay visible">
                        <div class="modal-content">
                            <button class="modal-close-btn" data-action="close-modal">×</button>
                            <div class="gallery-header">
                                <h2>${t.promptGalleryTitle}</h2>
                                <div class="gallery-search-bar">
                                    <input type="text" class="gallery-search-input" placeholder="${t.searchPlaceholderGallery}" id="gallery-search-input">
                                </div>
                            </div>
                            <div class="gallery-list" id="gallery-list">
                                <div class="chat-bubble loading" style="margin: auto;"><span></span><span></span><span></span></div>
                            </div>
                        </div>
                    </div>
                `;
                el.modalContainer.innerHTML = modalShellHTML;

                // Aggiungi stato alla history per gestire il pulsante indietro
                history.pushState({ modal: 'prompt-gallery' }, '', '');

                // 2. Recupera i dati
                let savedPrompts = currentUser.uid ? await getSavedPromptsForUser(currentUser.uid) : getSavedPromptsFromLocalStorage();

                // Funzioni helper
                const formatDate = (timestamp) => {
                    if (!timestamp) return '';
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                };

                const generatePromptsHTML = (prompts) => {
                    if (prompts.length === 0) return `<div id="empty-state">Nessun prompt salvato.</div>`;
                    return prompts.map((p, index) => `
                        <div class="prompt-gallery-item" data-prompt-id="${p.id}" data-action="open-prompt-fullscreen" data-original="${p.originalPrompt}" data-optimized="${p.optimizedPrompt}" data-timestamp="${formatDate(p.timestamp)}">
                            <div class="prompt-gallery-item-header">
                                <div class="prompt-gallery-item-title">
                                    <span class="prompt-gallery-item-number">#${index + 1}</span>
                                    <div class="prompt-gallery-item-info">
                                        <h3>${p.originalPrompt.substring(0, 50)}${p.originalPrompt.length > 50 ? '...' : ''}</h3>
                                        <span class="prompt-gallery-item-date">${formatDate(p.timestamp)}</span>
                                    </div>
                                </div>
                                <div class="prompt-gallery-item-toggle">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor">
                                        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    `).join('');
                };

                // 3. Collega event listener
                const searchInput = document.getElementById('gallery-search-input');
                const galleryList = document.getElementById('gallery-list');

                const filterAndSortPrompts = () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    let filtered = savedPrompts.filter(p => p.originalPrompt.toLowerCase().includes(searchTerm) || p.optimizedPrompt.toLowerCase().includes(searchTerm));

                    // Funzione helper per ottenere il timestamp in millisecondi
                    const getTimestamp = (timestamp) => {
                        if (!timestamp) return 0;
                        return timestamp.toMillis ? timestamp.toMillis() : timestamp;
                    };

                    // Ordina sempre per più recenti
                    filtered.sort((a, b) => getTimestamp(b.timestamp) - getTimestamp(a.timestamp));

                    if (galleryList) galleryList.innerHTML = generatePromptsHTML(filtered);
                };

                if (searchInput) searchInput.addEventListener('input', filterAndSortPrompts);

                // 4. Popola il contenuto
                filterAndSortPrompts();
            };

            // --- FUNZIONI CORRETTE PER COPIA ED ELIMINAZIONE ---
            const handleCopyFromGallery = (targetId) => {
                const element = document.getElementById(targetId);
                if (!element) { showToast("Errore: Impossibile trovare il testo."); return; }
                navigator.clipboard.writeText(element.innerText || element.textContent)
                    .then(() => showToast("Copiato!"))
                    .catch(err => console.error('Errore nella copia:', err));
            };

            const handleDeleteSavedPrompt = (promptId) => {
                if (!promptId) return;
                const t = translations[currentLanguage];
                const modalHTML = `
                <div id="confirm-delete-prompt-modal" class="modal-overlay visible">
                    <div class="modal-content" style="text-align: left; max-width: 400px;">
                        <h2 style="font-size: 20px; margin-bottom: 16px;">${t.confirmDeletePromptTitle}</h2>
                        <p style="color: var(--Koda-text-secondary); line-height: 1.5; margin-bottom: 24px;">${t.confirmDeletePromptMessage}</p>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="pill-btn" data-action="close-modal">${t.cancel}</button>
                            <button class="button" data-action="execute-delete-saved-prompt" data-id="${promptId}" style="background-color: #ff6b6b; color: white;">${t.deleteButton}</button>
                        </div>
                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;
            };

            const executeDeleteSavedPrompt = async (promptId) => {
                if (!promptId) return;

                if (currentUser.uid) {
                    // Utente loggato: elimina da Firebase
                    const promptRef = doc(db, "users", currentUser.uid, "savedPrompts", promptId);
                    try {
                        await deleteDoc(promptRef);
                        showToast("Prompt eliminato con successo!");
                        await openPromptGalleryModal();
                    } catch (error) {
                        console.error("Errore nell'eliminazione del prompt:", error);
                        showToast("Impossibile eliminare il prompt.");
                    }
                } else {
                    // Utente non loggato: elimina da localStorage
                    try {
                        let savedPrompts = JSON.parse(localStorage.getItem('guest-savedPrompts')) || [];
                        savedPrompts = savedPrompts.filter(p => p.id !== promptId);
                        localStorage.setItem('guest-savedPrompts', JSON.stringify(savedPrompts));
                        showToast("Prompt eliminato con successo!");
                        await openPromptGalleryModal();
                    } catch (error) {
                        console.error("Errore nell'eliminazione del prompt:", error);
                        showToast("Impossibile eliminare il prompt.");
                    }
                }
            };


            // --- NUOVA FUNZIONE PER CATALOGO VIDEO (UTENTE) ---
            // FUNZIONE: Modale custom per modificare nome playlist
            const openEditPlaylistModal = (playlistId) => {
                const playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                const playlist = playlists.find(p => p.id === playlistId);

                if (!playlist) return;

                const modalHTML = `
                    <div class="playlist-modal visible">
                        <div class="playlist-modal-content">
                            <div class="playlist-modal-header">
                                <h3 class="playlist-modal-title">${currentLanguage === 'it' ? 'Modifica playlist' : 'Edit playlist'}</h3>
                                <button class="playlist-modal-close" data-action="close-playlist-modal">×</button>
                            </div>
                            <input type="text" class="playlist-input" id="edit-playlist-name" value="${playlist.name}" placeholder="${currentLanguage === 'it' ? 'Nome playlist' : 'Playlist name'}">
                            <button class="create-playlist-btn" data-action="save-playlist-name" data-playlist-id="${playlistId}">
                                ${currentLanguage === 'it' ? 'Salva' : 'Save'}
                            </button>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                setTimeout(() => {
                    const input = document.getElementById('edit-playlist-name');
                    if (input) {
                        input.focus();
                        input.select();
                    }
                }, 100);
            };

            // FUNZIONE: Apre il modale della policy Cinema (YouTube)
            const openCinemaPolicyModal = () => {
                const t = translations[currentLanguage];

                const policyContent = currentLanguage === 'it' ? `
                    <h3 style="margin-bottom: 16px;">Informativa sull'uso di Video YouTube</h3>
                    <p style="margin-bottom: 12px; line-height: 1.6;">
                        La sezione <strong>Cinema</strong> di questa applicazione utilizza video pubblici di YouTube 
                        incorporati tramite l'API ufficiale di YouTube.
                    </p>
                    <h4 style="margin: 16px 0 8px 0;">Come funziona:</h4>
                    <ul style="margin-bottom: 12px; padding-left: 20px; line-height: 1.6;">
                        <li>Tutti i video sono <strong>pubblici</strong> e disponibili su YouTube</li>
                        <li>I video vengono incorporati utilizzando l'<strong>API ufficiale di YouTube</strong></li>
                        <li>Cliccando su un video, verrai reindirizzato a YouTube per la visualizzazione</li>
                        <li>Non scarichiamo né ospitiamo alcun contenuto video</li>
                    </ul>
                    <h4 style="margin: 16px 0 8px 0;">Diritti d'autore:</h4>
                    <p style="margin-bottom: 12px; line-height: 1.6;">
                        Tutti i video appartengono ai rispettivi creatori su YouTube. 
                        Rispettiamo i <strong>Termini di Servizio di YouTube</strong> e le leggi sul copyright.
                    </p>
                    <h4 style="margin: 16px 0 8px 0;">Privacy:</h4>
                    <p style="margin-bottom: 12px; line-height: 1.6;">
                        Le tue playlist e preferiti sono salvati <strong>localmente</strong> sul tuo dispositivo 
                        e non vengono condivisi con terze parti.
                    </p>
                    <p style="margin-top: 16px; font-size: 13px; color: var(--Koda-text-secondary);">
                        Per maggiori informazioni, consulta i 
                        <a href="https://www.youtube.com/t/terms" target="_blank" style="color: var(--Koda-accent);">Termini di Servizio di YouTube</a>.
                    </p>
                ` : `
                    <h3 style="margin-bottom: 16px;">YouTube Video Usage Policy</h3>
                    <p style="margin-bottom: 12px; line-height: 1.6;">
                        The <strong>Cinema</strong> section of this application uses public YouTube videos 
                        embedded through the official YouTube API.
                    </p>
                    <h4 style="margin: 16px 0 8px 0;">How it works:</h4>
                    <ul style="margin-bottom: 12px; padding-left: 20px; line-height: 1.6;">
                        <li>All videos are <strong>public</strong> and available on YouTube</li>
                        <li>Videos are embedded using the <strong>official YouTube API</strong></li>
                        <li>Clicking on a video will redirect you to YouTube for viewing</li>
                        <li>We do not download or host any video content</li>
                    </ul>
                    <h4 style="margin: 16px 0 8px 0;">Copyright:</h4>
                    <p style="margin-bottom: 12px; line-height: 1.6;">
                        All videos belong to their respective creators on YouTube. 
                        We respect <strong>YouTube's Terms of Service</strong> and copyright laws.
                    </p>
                    <h4 style="margin: 16px 0 8px 0;">Privacy:</h4>
                    <p style="margin-bottom: 12px; line-height: 1.6;">
                        Your playlists and favorites are saved <strong>locally</strong> on your device 
                        and are not shared with third parties.
                    </p>
                    <p style="margin-top: 16px; font-size: 13px; color: var(--Koda-text-secondary);">
                        For more information, please see 
                        <a href="https://www.youtube.com/t/terms" target="_blank" style="color: var(--Koda-accent);">YouTube's Terms of Service</a>.
                    </p>
                `;

                const modalHTML = `
                    <div class="review-modal visible">
                        <div class="review-modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                            <div class="review-modal-header">
                                <h3 class="review-modal-title">${currentLanguage === 'it' ? 'Policy Cinema' : 'Cinema Policy'}</h3>
                                <button class="review-modal-close" data-action="close-cinema-policy">×</button>
                            </div>
                            <div style="text-align: left;">
                                ${policyContent}
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            };

            // FUNZIONE: Gestisce il cambio tab nella pagina Cinema
            const handleCinemaTabChange = (tab, addToHistory = true) => {
                const t = translations[currentLanguage];
                const videoFavorites = JSON.parse(localStorage.getItem('video-favorites') || '[]');
                const videoPlaylists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                const videoViewMode = localStorage.getItem('videoViewMode') || 'grid';
                const selectedCategories = JSON.parse(localStorage.getItem('video-selected-categories') || '[]');
                const filterMode = localStorage.getItem('video-filter-mode') || 'all'; // 'all' or 'categories'

                // Aggiorna anche la variabile globale
                window.currentVideoViewMode = videoViewMode;

                // NUOVO: Aggiungi alla cronologia del browser
                if (addToHistory) {
                    const state = { page: 'cinema', cinemaTab: tab };
                    history.pushState(state, '', `#cinema-${tab}`);
                }

                // Aggiorna i pulsanti attivi nella bottom nav
                document.querySelectorAll('.cinema-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === tab) {
                        btn.classList.add('active');
                    }
                });

                // Mostra/nascondi il FAB solo nella sezione playlists
                const cinemaFab = document.getElementById('cinema-fab-btn');
                if (cinemaFab) {
                    cinemaFab.style.display = tab === 'playlists' ? 'flex' : 'none';
                }

                // Funzione per generare card (copia dalla renderCinemaPage)
                const generateVideoCard = (video, index, viewMode = 'grid') => {
                    let videoId = '';
                    try {
                        const url = new URL(video.youtubeUrl);
                        videoId = url.hostname === 'youtu.be' ? url.pathname.slice(1) : url.searchParams.get('v');
                    } catch (e) { }

                    const thumbnailUrl = videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : '';
                    const videoDate = video.createdAt ? new Date(video.createdAt.seconds * 1000).toLocaleDateString(currentLanguage === 'it' ? 'it-IT' : 'en-US') : '';
                    const isFavorited = videoFavorites.includes(video.id);
                    const description = video.description[currentLanguage] || video.description['en'] || '';

                    if (viewMode === 'list') {
                        return `
                            <div class="video-card-list" data-action="open-video-detail" data-video-id="${video.id}" data-title="${video.title}">
                                <button class="video-options-btn" data-action="show-video-options" data-video-id="${video.id}">⋯</button>
                                <div class="video-options-menu" id="options-menu-${video.id}">
                                    <div class="video-options-item" data-action="add-to-playlist" data-video-id="${video.id}">${currentLanguage === 'it' ? 'Aggiungi a playlist' : 'Add to playlist'}</div>
                                </div>
                                <button class="video-favorite-btn ${isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-video-id="${video.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                    </svg>
                                </button>
                                <img src="${thumbnailUrl}" class="video-thumbnail" alt="Thumbnail">
                                <div class="video-info">
                                    <h4>${video.title}</h4>
                                    ${video.category ? `<div style="margin-top: 4px;">${getCategoryBadgeHTML(video.category)}</div>` : ''}
                                    ${description ? `<div class="video-description">${description}</div>` : ''}
                                    ${videoDate ? `<div class="video-date">${videoDate}</div>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="video-card-grid" data-action="open-video-detail" data-video-id="${video.id}" data-title="${video.title}">
                                <button class="video-options-btn" data-action="show-video-options" data-video-id="${video.id}">⋯</button>
                                <div class="video-options-menu" id="options-menu-${video.id}">
                                    <div class="video-options-item" data-action="add-to-playlist" data-video-id="${video.id}">${currentLanguage === 'it' ? 'Aggiungi a playlist' : 'Add to playlist'}</div>
                                </div>
                                <button class="video-favorite-btn ${isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-video-id="${video.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                    </svg>
                                </button>
                                <img src="${thumbnailUrl}" class="video-thumbnail" alt="Thumbnail">
                                <div class="video-info">
                                    <h4 style="margin: 0;">${video.title}</h4>
                                    ${video.category ? `<div style="margin-top: 4px;">${getCategoryBadgeHTML(video.category)}</div>` : ''}
                                    ${videoDate ? `<div class="video-date" style="margin-top: 4px;">${videoDate}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                };

                const contentArea = document.getElementById('cinema-content-area');

                // Se non siamo nella pagina cinema, naviga prima alla pagina cinema
                if (!contentArea) {
                    currentView = 'cinema';
                    renderView();
                    // Richiama la funzione dopo che la pagina è stata renderizzata
                    setTimeout(() => handleCinemaTabChange(tab, false), 100);
                    return;
                }

                if (tab === 'videos' || tab === 'home') {
                    // Filter videos based on selected categories
                    let filteredVideos = youtubeVideosData;
                    if (filterMode === 'categories' && selectedCategories.length > 0) {
                        filteredVideos = youtubeVideosData.filter(v => selectedCategories.includes(v.category));
                    }

                    const allVideosHTML = filteredVideos.map((v, i) => generateVideoCard(v, i, videoViewMode)).join('');
                    const categoryCountText = filterMode === 'categories' && selectedCategories.length > 0
                        ? ` (${selectedCategories.length})`
                        : '';

                    contentArea.innerHTML = `
                        <div class="video-search-bar">
                            <input type="text" class="video-search-input" placeholder="${currentLanguage === 'it' ? 'Cerca video...' : 'Search videos...'}" id="video-search-input">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 8px; flex-wrap: wrap;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="filter-btn ${filterMode === 'all' ? 'active' : ''}" data-action="set-filter-mode" data-mode="all">
                                    ${currentLanguage === 'it' ? 'Tutti' : 'All'}
                                </button>
                                <button class="filter-btn ${filterMode === 'categories' ? 'active' : ''}" data-action="open-category-modal">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2z"/></svg>
                                    ${currentLanguage === 'it' ? 'Categorie' : 'Categories'}${categoryCountText}
                                </button>
                            </div>
                            <div class="view-toggle-container">
                                <button class="view-toggle-btn ${videoViewMode === 'list' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="list">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                                </button>
                                <button class="view-toggle-btn ${videoViewMode === 'grid' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="grid">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="${videoViewMode === 'grid' ? 'video-grid' : 'video-list-view'}" id="video-grid-home" style="padding-bottom: 20px;">
                            ${allVideosHTML}
                        </div>
                    `;

                    // Riattiva la ricerca e aggiungi event listeners per le card
                    setTimeout(() => {
                        const searchInput = document.getElementById('video-search-input');
                        if (searchInput) {
                            searchInput.addEventListener('input', (e) => {
                                const query = e.target.value.toLowerCase();
                                const videoCards = document.querySelectorAll('#video-grid-home .video-card-grid, #video-grid-home .video-card-list');
                                videoCards.forEach(card => {
                                    const title = card.dataset.title.toLowerCase();
                                    card.style.display = title.includes(query) ? '' : 'none';
                                });
                            });
                        }

                        // Aggiungi click listener per aprire il modale video
                        const videoCards = document.querySelectorAll('.video-card-grid, .video-card-list');
                        videoCards.forEach(card => {
                            card.addEventListener('click', (e) => {
                                // Ignora click su pulsanti interni
                                if (e.target.closest('.video-favorite-btn') || e.target.closest('.video-options-btn')) {
                                    return;
                                }
                                const videoId = card.dataset.videoId;
                                if (videoId) {
                                    console.log('Card clicked, opening video:', videoId);
                                    window.openVideoDetailModal(videoId);
                                }
                            });
                        });
                    }, 100);

                } else if (tab === 'favorites') {
                    // Mostra solo i preferiti
                    let favoriteVideos = youtubeVideosData.filter(v => videoFavorites.includes(v.id));

                    // Apply category filter to favorites
                    if (filterMode === 'categories' && selectedCategories.length > 0) {
                        favoriteVideos = favoriteVideos.filter(v => selectedCategories.includes(v.category));
                    }

                    const favoritesHTML = favoriteVideos.length > 0
                        ? favoriteVideos.map((v, i) => generateVideoCard(v, i, videoViewMode)).join('')
                        : `<div id="empty-state">${translations[currentLanguage].emptyVideoFavorites}</div>`;

                    const categoryCountText = filterMode === 'categories' && selectedCategories.length > 0
                        ? ` (${selectedCategories.length})`
                        : '';

                    contentArea.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 8px; flex-wrap: wrap;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="filter-btn ${filterMode === 'all' ? 'active' : ''}" data-action="set-filter-mode" data-mode="all">
                                    ${currentLanguage === 'it' ? 'Tutti' : 'All'}
                                </button>
                                <button class="filter-btn ${filterMode === 'categories' ? 'active' : ''}" data-action="open-category-modal">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2z"/></svg>
                                    ${currentLanguage === 'it' ? 'Categorie' : 'Categories'}${categoryCountText}
                                </button>
                            </div>
                            <div class="view-toggle-container">
                                <button class="view-toggle-btn ${videoViewMode === 'list' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="list">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                                </button>
                                <button class="view-toggle-btn ${videoViewMode === 'grid' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="grid">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="${videoViewMode === 'grid' ? 'video-grid' : 'video-list-view'}" style="padding-bottom: 20px;">
                            ${favoritesHTML}
                        </div>
                    `;

                    // Aggiungi click listener per aprire il modale video
                    setTimeout(() => {
                        const videoCards = document.querySelectorAll('.video-card-grid, .video-card-list');
                        videoCards.forEach(card => {
                            card.addEventListener('click', (e) => {
                                // Ignora click su pulsanti interni
                                if (e.target.closest('.video-favorite-btn') || e.target.closest('.video-options-btn')) {
                                    return;
                                }
                                const videoId = card.dataset.videoId;
                                if (videoId) {
                                    console.log('Card clicked, opening video:', videoId);
                                    window.openVideoDetailModal(videoId);
                                }
                            });
                        });
                    }, 100);

                } else if (tab === 'uni') {
                    // Mostra solo i video con categoria "education"
                    const educationVideos = youtubeVideosData.filter(v => v.category === 'education');

                    const uniHTML = educationVideos.length > 0
                        ? educationVideos.map((v, i) => generateVideoCard(v, i, videoViewMode)).join('')
                        : `<div id="empty-state">${currentLanguage === 'it' ? 'Nessun video educativo disponibile' : 'No educational videos available'}</div>`;

                    contentArea.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 8px; flex-wrap: wrap;">
                            <span style="color: var(--Koda-text-secondary); font-size: 14px; font-weight: 500;">${translations[currentLanguage].educationalPurpose}</span>
                            <div class="view-toggle-container">
                                <button class="view-toggle-btn ${videoViewMode === 'list' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="list">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                                </button>
                                <button class="view-toggle-btn ${videoViewMode === 'grid' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="grid">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="${videoViewMode === 'grid' ? 'video-grid' : 'video-list-view'}" style="padding-bottom: 20px;">
                            ${uniHTML}
                        </div>
                    `;

                    // Aggiungi click listener per aprire il modale video
                    setTimeout(() => {
                        const videoCards = document.querySelectorAll('.video-card-grid, .video-card-list');
                        videoCards.forEach(card => {
                            card.addEventListener('click', (e) => {
                                // Ignora click su pulsanti interni
                                if (e.target.closest('.video-favorite-btn') || e.target.closest('.video-options-btn')) {
                                    return;
                                }
                                const videoId = card.dataset.videoId;
                                if (videoId) {
                                    console.log('Card clicked, opening video:', videoId);
                                    window.openVideoDetailModal(videoId);
                                }
                            });
                        });
                    }, 100);

                } else if (tab === 'playlists') {
                    // Genera le playlist in base alla modalità di visualizzazione
                    const generateCinemaPlaylistCard = (playlist, mode) => {
                        const logoUrl = currentTheme === 'light'
                            ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                            : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';

                        const coverHTML = playlist.coverImage
                            ? `<img src="${playlist.coverImage}" alt="${playlist.name}" style="width: 100%; height: 100%; object-fit: cover;">`
                            : `<img src="${logoUrl}" alt="Koda Logo" style="width: 100%; height: 100%; object-fit: cover; background: var(--Koda-card);">`;

                        if (mode === 'grid') {
                            return `
                                <div class="tool-card-grid" data-action="open-playlist" data-playlist-id="${playlist.id}" style="cursor: pointer; position: relative;">
                                    <div class="logo-container" style="position: relative;">
                                        ${coverHTML}
                                        <button class="video-options-btn" data-action="toggle-playlist-options" data-playlist-id="${playlist.id}" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.8); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">⋮</button>
                                    </div>
                                    <div class="tool-name">${playlist.name}</div>
                                    <p style="color: var(--Koda-text-secondary); font-size: 12px; margin: 4px 0 0 0;">${playlist.videos.length} ${currentLanguage === 'it' ? 'video' : 'videos'}</p>
                                    <div class="video-options-menu" id="playlist-options-${playlist.id}" style="position: absolute; top: 48px; right: 8px; z-index: 20; display: none; background: var(--Koda-card); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 150px;">
                                        <button data-action="edit-playlist" data-playlist-id="${playlist.id}" style="width: 100%; padding: 12px 16px; background: none; border: none; color: var(--Koda-text); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='var(--Koda-bg-light)'" onmouseout="this.style.background='none'">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                            ${currentLanguage === 'it' ? 'Modifica' : 'Edit'}
                                        </button>
                                        <button data-action="delete-playlist" data-playlist-id="${playlist.id}" style="width: 100%; padding: 12px 16px; background: none; border: none; color: #ff6b6b; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='var(--Koda-bg-light)'" onmouseout="this.style.background='none'">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                            ${currentLanguage === 'it' ? 'Elimina' : 'Delete'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="playlist-item" data-action="open-playlist" data-playlist-id="${playlist.id}" style="position: relative;">
                                    <div class="select-checkbox" data-playlist-id="${playlist.id}"></div>
                                    <div style="width: 160px; min-width: 160px; aspect-ratio: 16 / 9; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                                        ${coverHTML}
                                    </div>
                                    <div style="flex: 1;">
                                        <h4>${playlist.name}</h4>
                                        <p>${playlist.videos.length} ${currentLanguage === 'it' ? 'video' : 'videos'}</p>
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-left: auto;">
                                        <button class="global-btn" data-action="edit-playlist" data-playlist-id="${playlist.id}" title="${currentLanguage === 'it' ? 'Modifica' : 'Edit'}" style="padding: 8px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor">
                                                <path d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                            </svg>
                                        </button>
                                        <button class="global-btn" data-action="delete-playlist" data-playlist-id="${playlist.id}" title="${currentLanguage === 'it' ? 'Elimina' : 'Delete'}" style="padding: 8px; color: #ff6b6b;">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor">
                                                <path d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                    };

                    const playlistsHTML = videoPlaylists.length > 0
                        ? videoPlaylists.map(p => generateCinemaPlaylistCard(p, videoViewMode)).join('')
                        : '';

                    contentArea.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
                            <div class="view-toggle-container">
                                <button class="view-toggle-btn ${videoViewMode === 'list' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="list">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                                </button>
                                <button class="view-toggle-btn ${videoViewMode === 'grid' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="grid">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="${videoViewMode === 'grid' ? 'grid-container' : 'playlist-list'}" id="playlist-list-container" style="padding-bottom: 80px;">
                            ${playlistsHTML.length > 0 ? playlistsHTML : `<div id="empty-state">${translations[currentLanguage].emptyPlaylists}</div>`}
                        </div>
                    `;
                }
            };

            // NUOVA FUNZIONE: Renderizza la pagina Cinema (non più modale)
            const renderCinemaPage = (contentArea, t) => {
                console.log('renderCinemaPage called');
                console.log('youtubeVideosData:', youtubeVideosData);

                // Carica i dati da localStorage
                const videoFavorites = JSON.parse(localStorage.getItem('video-favorites') || '[]');
                const videoPlaylists = JSON.parse(localStorage.getItem('video-playlists') || '[]');

                // Stato per la visualizzazione (lista o griglia)
                let videoViewMode = localStorage.getItem('videoViewMode') || 'grid';

                // Sezione corrente (home, favorites, playlists)
                let currentVideoSection = 'home';

                // Verifica che ci siano video
                if (!youtubeVideosData || youtubeVideosData.length === 0) {
                    console.warn('No videos available');
                    contentArea.innerHTML = `
                        <div class="filters-container" style="top: 64px; margin-bottom: 20px;">
                            <div class="filter-pills" id="cinema-filters">
                                <button class="pill-btn active" data-action="set-cinema-tab" data-tab="home">${currentLanguage === 'it' ? 'Tutti' : 'All'}</button>
                                <button class="pill-btn" data-action="set-cinema-tab" data-tab="favorites">${currentLanguage === 'it' ? 'Preferiti' : 'Favorites'}</button>
                                <button class="pill-btn" data-action="set-cinema-tab" data-tab="playlists">${currentLanguage === 'it' ? 'Playlist' : 'Playlists'}</button>
                            </div>
                        </div>
                        <div id="cinema-content-area">
                            <div id="empty-state">${currentLanguage === 'it' ? 'Nessun video disponibile. Carica alcuni video nel database Firebase.' : 'No videos available. Please add some videos to the Firebase database.'}</div>
                        </div>
                    `;
                    return;
                }

                // Funzione per generare una card video
                const generateVideoCard = (video, index, viewMode = 'grid') => {
                    let videoId = '';
                    try {
                        const url = new URL(video.youtubeUrl);
                        videoId = url.hostname === 'youtu.be' ? url.pathname.slice(1) : url.searchParams.get('v');
                    } catch (e) { }

                    const thumbnailUrl = videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    const videoDate = video.createdAt ? new Date(video.createdAt.seconds * 1000).toLocaleDateString(currentLanguage === 'it' ? 'it-IT' : 'en-US') : '';
                    const isFavorited = videoFavorites.includes(video.id);
                    const description = video.description[currentLanguage] || video.description['en'] || '';

                    if (viewMode === 'list') {
                        return `
                            <div class="video-card-list" data-action="open-video-detail" data-video-id="${video.id}" data-title="${video.title}">
                                <button class="video-options-btn" data-action="show-video-options" data-video-id="${video.id}">⋯</button>
                                <div class="video-options-menu" id="options-menu-${video.id}">
                                    <div class="video-options-item" data-action="add-to-playlist" data-video-id="${video.id}">${currentLanguage === 'it' ? 'Aggiungi a playlist' : 'Add to playlist'}</div>
                                </div>
                                <button class="video-favorite-btn ${isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-video-id="${video.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                    </svg>
                                </button>
                                <img src="${thumbnailUrl}" class="video-thumbnail" alt="Thumbnail">
                                <div class="video-info">
                                    <h4>${video.title}</h4>
                                    ${video.category ? `<div style="margin-top: 4px;">${getCategoryBadgeHTML(video.category)}</div>` : ''}
                                    ${description ? `<div class="video-description">${description}</div>` : ''}
                                    ${videoDate ? `<div class="video-date">${videoDate}</div>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="video-card-grid" data-action="open-video-detail" data-video-id="${video.id}" data-title="${video.title}">
                                <button class="video-options-btn" data-action="show-video-options" data-video-id="${video.id}">⋯</button>
                                <div class="video-options-menu" id="options-menu-${video.id}">
                                    <div class="video-options-item" data-action="add-to-playlist" data-video-id="${video.id}">${currentLanguage === 'it' ? 'Aggiungi a playlist' : 'Add to playlist'}</div>
                                </div>
                                <button class="video-favorite-btn ${isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-video-id="${video.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                    </svg>
                                </button>
                                <img src="${thumbnailUrl}" class="video-thumbnail" alt="Thumbnail">
                                <div class="video-info">
                                    <h4 style="margin: 0;">${video.title}</h4>
                                    ${video.category ? `<div style="margin-top: 4px;">${getCategoryBadgeHTML(video.category)}</div>` : ''}
                                    ${videoDate ? `<div class="video-date" style="margin-top: 4px;">${videoDate}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                };

                // Load filter state
                const selectedCategories = JSON.parse(localStorage.getItem('video-selected-categories') || '[]');
                const filterMode = localStorage.getItem('video-filter-mode') || 'all';

                // Filter videos based on selected categories
                let filteredVideos = youtubeVideosData;
                if (filterMode === 'categories' && selectedCategories.length > 0) {
                    filteredVideos = youtubeVideosData.filter(v => selectedCategories.includes(v.category));
                }

                // Sezione Home/Tutti
                const allVideosHTML = filteredVideos.map((v, i) => generateVideoCard(v, i, videoViewMode)).join('');
                const categoryCountText = filterMode === 'categories' && selectedCategories.length > 0
                    ? ` (${selectedCategories.length})`
                    : '';

                // Sezione Preferiti
                const favoriteVideos = youtubeVideosData.filter(v => videoFavorites.includes(v.id));
                const favoritesHTML = favoriteVideos.length > 0
                    ? favoriteVideos.map((v, i) => generateVideoCard(v, i, videoViewMode)).join('')
                    : `<div id="empty-state">${translations[currentLanguage].emptyVideoFavorites}</div>`;

                // Sezione Playlist (come le collezioni)
                const playlistsHTML = videoPlaylists.length > 0
                    ? videoPlaylists.map(playlist => `
                        <div class="playlist-item" data-action="open-playlist" data-playlist-id="${playlist.id}">
                            <h4>${playlist.name}</h4>
                            <p>${playlist.videos.length} ${currentLanguage === 'it' ? 'video' : 'videos'}</p>
                        </div>
                    `).join('')
                    : `<div id="empty-state">${currentLanguage === 'it' ? '' : ''}</div>`;

                // Contenuto iniziale (sezione Video) - senza tab in alto
                let contentHTML = '';
                contentHTML += `
                    <div id="cinema-content-area" style="padding-bottom: 80px;">
                        <div class="video-search-bar">
                            <input type="text" class="video-search-input" placeholder="${currentLanguage === 'it' ? 'Cerca video...' : 'Search videos...'}" id="video-search-input">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 8px; flex-wrap: wrap;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="filter-btn ${filterMode === 'all' ? 'active' : ''}" data-action="set-filter-mode" data-mode="all">
                                    ${currentLanguage === 'it' ? 'Tutti' : 'All'}
                                </button>
                                <button class="filter-btn ${filterMode === 'categories' ? 'active' : ''}" data-action="open-category-modal">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm2 18h2v-2h-2v2zm8-8h2v-2h-2v2zm0 8c1.1 0 2-.9 2-2h-2v2zm0-12h2V7h-2v2zm0 8h2v-2h-2v2zm-4 4h2v-2h-2v2zm0-16h2V3h-2v2z"/></svg>
                                    ${currentLanguage === 'it' ? 'Categorie' : 'Categories'}${categoryCountText}
                                </button>
                            </div>
                            <div class="view-toggle-container">
                                <button class="view-toggle-btn ${videoViewMode === 'list' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="list" title="${t.viewList || 'Vista lista'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                                </button>
                                <button class="view-toggle-btn ${videoViewMode === 'grid' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="grid" title="${t.viewGrid || 'Vista griglia'}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="${videoViewMode === 'grid' ? 'video-grid' : 'video-list-view'}" id="video-grid-home">
                            ${allVideosHTML.length > 0 ? allVideosHTML : `<div id="empty-state">${currentLanguage === 'it' ? 'Nessun video disponibile.' : 'No videos available.'}</div>`}
                        </div>
                    </div>
                `;

                contentArea.innerHTML = contentHTML;

                // Gestione ricerca video in tempo reale e click sulle card
                setTimeout(() => {
                    const searchInput = document.getElementById('video-search-input');
                    if (searchInput) {
                        searchInput.addEventListener('input', (e) => {
                            const query = e.target.value.toLowerCase();
                            const videoCards = document.querySelectorAll('#video-grid-home .video-card-grid, #video-grid-home .video-card-list');
                            videoCards.forEach(card => {
                                const title = card.dataset.title.toLowerCase();
                                card.style.display = title.includes(query) ? '' : 'none';
                            });
                        });
                    }

                    // Aggiungi click listener per aprire il modale video
                    const videoCards = document.querySelectorAll('.video-card-grid, .video-card-list');
                    videoCards.forEach(card => {
                        card.addEventListener('click', (e) => {
                            // Ignora click su pulsanti interni
                            if (e.target.closest('.video-favorite-btn') || e.target.closest('.video-options-btn')) {
                                return;
                            }
                            const videoId = card.dataset.videoId;
                            if (videoId) {
                                console.log('Card clicked, opening video:', videoId);
                                window.openVideoDetailModal(videoId);
                            }
                        });
                    });
                }, 100);

                // Salva lo stato della modalità vista
                window.currentVideoViewMode = videoViewMode;
            };

            // MODIFICA 1-4: Funzione completamente rinnovata per il catalogo video con nav dedicata
            const openVideoCatalogModal = (addToHistory = true) => {
                const t = translations[currentLanguage];

                // NUOVO: Aggiungi alla cronologia del browser
                if (addToHistory) {
                    history.pushState({ modal: 'video-catalog' }, '', '');
                }

                // Carica i dati da localStorage
                const favorites = JSON.parse(localStorage.getItem('video-favorites') || '[]');
                const playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');

                // Stato per la visualizzazione (lista o griglia)
                let videoViewMode = localStorage.getItem('videoViewMode') || 'grid'; // 'list' o 'grid'

                // MODIFICA 2: Genera i controlli globali senza l'icona video
                const globalControls = getGlobalControlsHTML();
                // Rimuovi il pulsante video dai controlli
                const otherControlsWithoutVideo = globalControls.otherControls.replace(/<button id="video-catalog-btn"[^>]*>[\s\S]*?<\/button>/g, '');

                // Funzione per generare una card video in formato griglia o lista
                const generateVideoCard = (video, index, viewMode = 'grid') => {
                    let videoId = '';
                    try {
                        const url = new URL(video.youtubeUrl);
                        videoId = url.hostname === 'youtu.be' ? url.pathname.slice(1) : url.searchParams.get('v');
                    } catch (e) { }

                    const thumbnailUrl = videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    const videoDate = video.createdAt ? new Date(video.createdAt.seconds * 1000).toLocaleDateString(currentLanguage === 'it' ? 'it-IT' : 'en-US') : '';
                    const isFavorited = favorites.includes(video.id);
                    const description = video.description[currentLanguage] || video.description['en'] || '';

                    if (viewMode === 'list') {
                        return `
                            <div class="video-card-list" data-action="open-video-detail" data-video-id="${video.id}" data-title="${video.title}">
                                <button class="video-options-btn" data-action="show-video-options" data-video-id="${video.id}">⋯</button>
                                <div class="video-options-menu" id="options-menu-${video.id}">
                                    <div class="video-options-item" data-action="add-to-playlist" data-video-id="${video.id}">${currentLanguage === 'it' ? 'Aggiungi a playlist' : 'Add to playlist'}</div>
                                </div>
                                <button class="video-favorite-btn ${isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-video-id="${video.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                    </svg>
                                </button>
                                <img src="${thumbnailUrl}" class="video-thumbnail" alt="Thumbnail">
                                <div class="video-info">
                                    <h4>${video.title}</h4>
                                    ${video.category ? `<div style="margin-top: 4px;">${getCategoryBadgeHTML(video.category)}</div>` : ''}
                                    ${description ? `<div class="video-description">${description}</div>` : ''}
                                    ${videoDate ? `<div class="video-date">${videoDate}</div>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="video-card-grid" data-action="open-video-detail" data-video-id="${video.id}" data-title="${video.title}">
                                <button class="video-options-btn" data-action="show-video-options" data-video-id="${video.id}">⋯</button>
                                <div class="video-options-menu" id="options-menu-${video.id}">
                                    <div class="video-options-item" data-action="add-to-playlist" data-video-id="${video.id}">${currentLanguage === 'it' ? 'Aggiungi a playlist' : 'Add to playlist'}</div>
                                </div>
                                <button class="video-favorite-btn ${isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-video-id="${video.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                    </svg>
                                </button>
                                <img src="${thumbnailUrl}" class="video-thumbnail" alt="Thumbnail">
                                <div class="video-info">
                                    <h4 style="margin: 0;">${video.title}</h4>
                                    ${video.category ? `<div style="margin-top: 4px;">${getCategoryBadgeHTML(video.category)}</div>` : ''}
                                    ${videoDate ? `<div class="video-date" style="margin-top: 4px;">${videoDate}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                };

                // Sezione Home/Tutti
                const allVideosHTML = youtubeVideosData.map((v, i) => generateVideoCard(v, i, videoViewMode)).join('');

                // Sezione Preferiti
                const favoriteVideos = youtubeVideosData.filter(v => favorites.includes(v.id));
                const favoritesHTML = favoriteVideos.length > 0
                    ? favoriteVideos.map((v, i) => generateVideoCard(v, i, videoViewMode)).join('')
                    : `<div id="empty-state">${translations[currentLanguage].emptyVideoFavorites}</div>`;

                // Sezione Playlist - supporta sia lista che griglia
                const generatePlaylistCard = (playlist, mode) => {
                    const logoUrl = currentTheme === 'light'
                        ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                        : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';

                    const coverHTML = playlist.coverImage
                        ? `<img src="${playlist.coverImage}" alt="${playlist.name}" style="width: 100%; height: 100%; object-fit: cover;">`
                        : `<img src="${logoUrl}" alt="Koda Logo" style="width: 100%; height: 100%; object-fit: cover; background: var(--Koda-card);">`;

                    if (mode === 'grid') {
                        return `
                            <div class="video-card" data-action="open-playlist" data-playlist-id="${playlist.id}" style="cursor: pointer; position: relative;">
                                <div class="video-thumbnail" style="overflow: hidden; position: relative;">
                                    ${coverHTML}
                                    <button class="video-options-btn" data-action="toggle-playlist-options" data-playlist-id="${playlist.id}" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.8); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">⋮</button>
                                </div>
                                <div class="video-info">
                                    <h4>${playlist.name}</h4>
                                    <p style="color: var(--Koda-text-secondary); font-size: 14px; margin: 4px 0 0 0;">${playlist.videos.length} ${currentLanguage === 'it' ? 'video' : 'videos'}</p>
                                </div>
                                <div class="video-options-menu" id="playlist-options-${playlist.id}" style="position: absolute; top: 48px; right: 8px; z-index: 20; display: none; background: var(--Koda-card); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 150px;">
                                    <button data-action="edit-playlist" data-playlist-id="${playlist.id}" style="width: 100%; padding: 12px 16px; background: none; border: none; color: var(--Koda-text); text-align: left; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='var(--Koda-bg-light)'" onmouseout="this.style.background='none'">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                        ${currentLanguage === 'it' ? 'Modifica' : 'Edit'}
                                    </button>
                                    <button data-action="delete-playlist" data-playlist-id="${playlist.id}" style="width: 100%; padding: 12px 16px; background: none; border: none; color: #ff6b6b; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; transition: background 0.2s;" onmouseover="this.style.background='var(--Koda-bg-light)'" onmouseout="this.style.background='none'">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                        ${currentLanguage === 'it' ? 'Elimina' : 'Delete'}
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="playlist-item" data-action="open-playlist" data-playlist-id="${playlist.id}">
                                <h4>${playlist.name}</h4>
                                <p>${playlist.videos.length} ${currentLanguage === 'it' ? 'video' : 'videos'}</p>
                            </div>
                        `;
                    }
                };

                const playlistsHTML = playlists.length > 0
                    ? playlists.map(p => generatePlaylistCard(p, videoViewMode)).join('')
                    : `<div id="empty-state">${currentLanguage === 'it' ? '' : ''}</div>`;

                const modalHTML = `
                <div id="video-catalog-modal" class="modal-overlay visible">
                    <div class="modal-content">
                        <!-- Top Bar identica a quella dell'app principale -->
                        <div class="user-chat-header">
                            <button class="chat-header-btn" data-action="close-modal" title="${t.backToApp || 'Torna all\'app'}">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor">
                                    <path d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                                </svg>
                            </button>
                            <div id="profile-avatar-menu" style="margin-left: 8px;">${globalControls.avatar}</div>
                            <div class="user-chat-info" style="flex-grow: 1;">
                                <a href="#" class="privacy-link" id="privacy-link-video" data-translate="videoCatalogTitle">${t.videoCatalogTitle}</a>
                            </div>
                            <div id="global-controls">${otherControlsWithoutVideo}</div>
                        </div>
                        
                        <div class="video-list-container">
                            <!-- Sezione Home/Tutti -->
                            <div class="video-section active" id="video-section-home">
                                <div class="video-search-bar">
                                    <input type="text" class="video-search-input" placeholder="${currentLanguage === 'it' ? 'Cerca video...' : 'Search videos...'}" id="video-search-input">
                                </div>
                                <div class="view-toggle-container" style="margin-bottom: 16px; justify-content: flex-end;">
                                    <button class="view-toggle-btn ${videoViewMode === 'list' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="list" title="${t.viewList || 'Vista lista'}">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                                    </button>
                                    <button class="view-toggle-btn ${videoViewMode === 'grid' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="grid" title="${t.viewGrid || 'Vista griglia'}">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                                    </button>
                                </div>
                                <div class="${videoViewMode === 'grid' ? 'video-grid' : 'video-list-view'}" id="video-grid-home">
                                    ${allVideosHTML.length > 0 ? allVideosHTML : `<div id="empty-state">${currentLanguage === 'it' ? 'Nessun video disponibile.' : 'No videos available.'}</div>`}
                                </div>
                            </div>

                            <!-- Sezione Preferiti -->
                            <div class="video-section" id="video-section-favorites">
                                <div class="${videoViewMode === 'grid' ? 'video-grid' : 'video-list-view'}" id="video-grid-favorites">
                                    ${favoritesHTML}
                                </div>
                            </div>

                            <!-- Sezione Playlist -->
                            <div class="video-section" id="video-section-playlists">
                                <div class="view-toggle-container" style="margin-bottom: 16px; justify-content: flex-end;">
                                    <button class="view-toggle-btn ${videoViewMode === 'list' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="list" title="${t.viewList || 'Vista lista'}">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                                    </button>
                                    <button class="view-toggle-btn ${videoViewMode === 'grid' ? 'active' : ''}" data-action="set-video-view-mode" data-mode="grid" title="${t.viewGrid || 'Vista griglia'}">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                                    </button>
                                </div>
                                <div class="${videoViewMode === 'grid' ? 'video-grid' : 'playlist-list'}" id="playlist-list">
                                    ${playlistsHTML}
                                </div>
                            </div>
                        </div>

                        <!-- MODIFICA 5: FAB per creare playlist (visibile solo nella sezione playlist) -->
                        <button class="create-playlist-fab hidden" id="create-playlist-fab" data-action="create-playlist" title="${currentLanguage === 'it' ? 'Crea nuova playlist' : 'Create new playlist'}">
                            <svg xmlns="http://www.w3.org/2000/svg" height="28" viewBox="0 0 24 24" width="28" fill="currentColor">
                                <path d="M0 0h24v24H0z" fill="none"/>
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                        </button>

                        <!-- Barra di navigazione inferiore dedicata -->
                        <div class="video-catalog-bottom-nav">
                            <button class="video-catalog-nav-btn active" data-action="switch-video-section" data-section="home">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                                </svg>
                                <span>${currentLanguage === 'it' ? 'Tutti' : 'Home'}</span>
                            </button>
                            <button class="video-catalog-nav-btn" data-action="switch-video-section" data-section="favorites">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                                <span>${currentLanguage === 'it' ? 'Preferiti' : 'Favorites'}</span>
                            </button>
                            <button class="video-catalog-nav-btn" data-action="switch-video-section" data-section="playlists">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/>
                                </svg>
                                <span>${currentLanguage === 'it' ? 'Playlist' : 'Playlists'}</span>
                            </button>
                        </div>
                    </div>
                </div>`;

                el.modalContainer.innerHTML = modalHTML;

                // MODIFICA 2: Gestione ricerca video in tempo reale
                const searchInput = document.getElementById('video-search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const query = e.target.value.toLowerCase();
                        const videoCards = document.querySelectorAll('#video-grid-home .video-card-grid, #video-grid-home .video-card-list');
                        videoCards.forEach(card => {
                            const title = card.dataset.title.toLowerCase();
                            card.style.display = title.includes(query) ? '' : 'none';
                        });
                    });
                }

                // MODIFICA: Gestione cambio visualizzazione lista/griglia
                window.currentVideoViewMode = videoViewMode;
            };

            // NUOVO: Funzione per aprire il modale di selezione categorie AI
            const openAICategoryModal = () => {
                const t = translations[currentLanguage];
                const aiSelectedCategories = JSON.parse(localStorage.getItem('ai-selected-categories') || '[]');

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'ai-category-filter', page: currentView }, '', '');

                const aiCategories = [
                    { id: 'Testo', label: currentLanguage === 'it' ? 'Testo' : 'Text', icon: '📝' },
                    { id: 'Immagini', label: currentLanguage === 'it' ? 'Immagini' : 'Images', icon: '🖼️' },
                    { id: 'Video', label: 'Video', icon: '🎥' },
                    { id: 'Presentazioni', label: currentLanguage === 'it' ? 'Presentazioni' : 'Presentations', icon: '📊' },
                    { id: 'Codice', label: currentLanguage === 'it' ? 'Codice' : 'Code', icon: '💻' },
                    { id: 'Audio', label: 'Audio', icon: '🎵' },
                    { id: 'Automation Tools', label: currentLanguage === 'it' ? 'Automazioni' : 'Automation Tools', icon: '⚙️' },
                    { id: 'Browser AI', label: currentLanguage === 'it' ? 'Browser AI' : 'AI Browser', icon: '🌐' },
                    { id: 'AI Playground', label: 'AI Playground', icon: '🎮' }
                ];

                const categoriesHTML = aiCategories.map(cat => `
                    <div class="category-option ${aiSelectedCategories.includes(cat.id) ? 'selected' : ''}" data-category-id="${cat.id}">
                        <div class="category-checkbox"></div>
                        <div class="category-label">
                            <span>${cat.icon}</span>
                            <span>${cat.label}</span>
                        </div>
                    </div>
                `).join('');

                const modalHTML = `
                    <div class="category-modal visible" id="ai-category-modal">
                        <div class="category-modal-content">
                            <div class="category-modal-header">
                                <h3 class="category-modal-title">${currentLanguage === 'it' ? 'Seleziona Categorie AI' : 'Select AI Categories'}</h3>
                                <button class="category-modal-close" data-action="close-ai-category-modal">×</button>
                            </div>
                            <div class="category-options">
                                ${categoriesHTML}
                            </div>
                            <div class="category-modal-actions">
                                <button class="category-cancel-btn" data-action="close-ai-category-modal">
                                    ${currentLanguage === 'it' ? 'Annulla' : 'Cancel'}
                                </button>
                                <button class="category-apply-btn" data-action="apply-ai-category-filter">
                                    ${currentLanguage === 'it' ? 'Applica' : 'Apply'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Add click handlers for category options
                setTimeout(() => {
                    const categoryOptions = document.querySelectorAll('#ai-category-modal .category-option');
                    categoryOptions.forEach(option => {
                        option.addEventListener('click', () => {
                            option.classList.toggle('selected');
                        });
                    });
                }, 50);
            };

            const closeAICategoryModal = () => {
                const modal = document.getElementById('ai-category-modal');
                if (modal) {
                    modal.classList.remove('visible');
                    setTimeout(() => modal.remove(), 300);
                }
            };

            const applyAICategoryFilter = () => {
                const selectedOptions = document.querySelectorAll('#ai-category-modal .category-option.selected');
                const aiSelectedCategories = Array.from(selectedOptions).map(opt => opt.dataset.categoryId);

                // Save to localStorage
                localStorage.setItem('ai-selected-categories', JSON.stringify(aiSelectedCategories));

                // Close modal
                closeAICategoryModal();

                // Reload the explore view (preserve exploreFilter to stay in category view)
                currentView = 'explore';
                renderView();
            };

            // NUOVO: Funzione per aprire il modale di selezione prezzi AI
            const openAIPricingModal = () => {
                const t = translations[currentLanguage];
                const aiSelectedPricing = JSON.parse(localStorage.getItem('ai-selected-pricing') || '[]');

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'ai-pricing-filter', page: currentView }, '', '');

                const pricingOptions = [
                    { id: 'free', label: t.pricingFree || (currentLanguage === 'it' ? 'Gratuito' : 'Free'), icon: '💚' },
                    { id: 'freemium', label: t.pricingFreemium || 'Freemium', icon: '💛' },
                    { id: 'paid', label: t.pricingPaid || (currentLanguage === 'it' ? 'A Pagamento' : 'Paid'), icon: '💰' }
                ];

                const pricingHTML = pricingOptions.map(opt => `
                    <div class="category-option ${aiSelectedPricing.includes(opt.id) ? 'selected' : ''}" data-pricing-id="${opt.id}">
                        <div class="category-checkbox"></div>
                        <div class="category-label">
                            <span>${opt.icon}</span>
                            <span>${opt.label}</span>
                        </div>
                    </div>
                `).join('');

                const modalHTML = `
                    <div class="category-modal visible" id="ai-pricing-modal">
                        <div class="category-modal-content">
                            <div class="category-modal-header">
                                <h3 class="category-modal-title">${currentLanguage === 'it' ? 'Seleziona Prezzo' : 'Select Price'}</h3>
                                <button class="category-modal-close" data-action="close-ai-pricing-modal">×</button>
                            </div>
                            <div class="category-options">
                                ${pricingHTML}
                            </div>
                            <div class="category-modal-actions">
                                <button class="category-cancel-btn" data-action="close-ai-pricing-modal">
                                    ${currentLanguage === 'it' ? 'Annulla' : 'Cancel'}
                                </button>
                                <button class="category-apply-btn" data-action="apply-ai-pricing-filter">
                                    ${currentLanguage === 'it' ? 'Applica' : 'Apply'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Add click handlers for pricing options
                setTimeout(() => {
                    const pricingOptions = document.querySelectorAll('#ai-pricing-modal .category-option');
                    pricingOptions.forEach(option => {
                        option.addEventListener('click', () => {
                            option.classList.toggle('selected');
                        });
                    });
                }, 50);
            };

            const closeAIPricingModal = () => {
                const modal = document.getElementById('ai-pricing-modal');
                if (modal) {
                    modal.classList.remove('visible');
                    setTimeout(() => modal.remove(), 300);
                }
            };

            const applyAIPricingFilter = () => {
                const selectedOptions = document.querySelectorAll('#ai-pricing-modal .category-option.selected');
                const aiSelectedPricing = Array.from(selectedOptions).map(opt => opt.dataset.pricingId);

                // Save to localStorage
                localStorage.setItem('ai-selected-pricing', JSON.stringify(aiSelectedPricing));

                // Close modal
                closeAIPricingModal();

                // Reload the explore view (preserve exploreFilter to stay in category view)
                currentView = 'explore';
                renderView();
            };

            // NUOVO: Funzione per aprire il modale di selezione categorie
            const openCategoryModal = () => {
                const t = translations[currentLanguage];
                const selectedCategories = JSON.parse(localStorage.getItem('video-selected-categories') || '[]');

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'category-filter', page: currentView }, '', '');

                const categories = [
                    { id: 'tutorial', label: t.categoryTutorial || 'Tutorial', icon: '📚' },
                    { id: 'education', label: t.categoryEducation || 'Education', icon: '🎓' },
                    { id: 'development', label: t.categoryDevelopment || 'Development', icon: '💻' },
                    { id: 'news', label: t.categoryNews || 'News', icon: '📰' }
                ];

                const categoriesHTML = categories.map(cat => `
                    <div class="category-option ${selectedCategories.includes(cat.id) ? 'selected' : ''}" data-category-id="${cat.id}">
                        <div class="category-checkbox"></div>
                        <div class="category-label">
                            <span>${cat.icon}</span>
                            <span>${cat.label}</span>
                        </div>
                    </div>
                `).join('');

                const modalHTML = `
                    <div class="category-modal visible" id="category-modal">
                        <div class="category-modal-content">
                            <div class="category-modal-header">
                                <h3 class="category-modal-title">${currentLanguage === 'it' ? 'Seleziona Categorie' : 'Select Categories'}</h3>
                                <button class="category-modal-close" data-action="close-category-modal">×</button>
                            </div>
                            <div class="category-options">
                                ${categoriesHTML}
                            </div>
                            <div class="category-modal-actions">
                                <button class="category-cancel-btn" data-action="close-category-modal">
                                    ${currentLanguage === 'it' ? 'Annulla' : 'Cancel'}
                                </button>
                                <button class="category-apply-btn" data-action="apply-category-filter">
                                    ${currentLanguage === 'it' ? 'Applica' : 'Apply'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // Add click handlers for category options
                setTimeout(() => {
                    const categoryOptions = document.querySelectorAll('.category-option');
                    categoryOptions.forEach(option => {
                        option.addEventListener('click', () => {
                            option.classList.toggle('selected');
                        });
                    });
                }, 50);
            };

            const closeCategoryModal = () => {
                const modal = document.getElementById('category-modal');
                if (modal) {
                    modal.classList.remove('visible');
                    setTimeout(() => modal.remove(), 300);
                }
            };

            const applyCategoryFilter = () => {
                const selectedOptions = document.querySelectorAll('.category-option.selected');
                const selectedCategories = Array.from(selectedOptions).map(opt => opt.dataset.categoryId);

                // Save to localStorage
                localStorage.setItem('video-selected-categories', JSON.stringify(selectedCategories));

                // Set filter mode to categories if any are selected, otherwise to all
                if (selectedCategories.length > 0) {
                    localStorage.setItem('video-filter-mode', 'categories');
                } else {
                    localStorage.setItem('video-filter-mode', 'all');
                }

                // Close modal
                closeCategoryModal();

                // Reload current tab with new filter
                const activeNavBtn = document.querySelector('.cinema-nav-btn.active');
                if (activeNavBtn) {
                    const currentTab = activeNavBtn.dataset.tab;
                    handleCinemaTabChange(currentTab);
                }
            };

            // MODIFICA 4: Funzioni per gestire le playlist video
            const openAddToPlaylistModal = (videoId) => {
                const playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                const video = youtubeVideosData.find(v => v.id === videoId);

                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'add-to-playlist', page: currentView }, '', '');

                const playlistsHTML = playlists.map(playlist => `
                    <div class="playlist-modal-item" data-action="add-video-to-playlist" data-playlist-id="${playlist.id}" data-video-id="${videoId}">
                        ${playlist.name} (${playlist.videos.length} video)
                    </div>
                `).join('');

                const modalHTML = `
                    <div class="playlist-modal visible">
                        <div class="playlist-modal-content">
                            <div class="playlist-modal-header">
                                <h3 class="playlist-modal-title">${currentLanguage === 'it' ? 'Aggiungi a playlist' : 'Add to playlist'}</h3>
                                <button class="playlist-modal-close" data-action="close-playlist-modal">×</button>
                            </div>
                            <div class="playlist-modal-list" style="margin-bottom: 16px;">
                                ${playlists.length > 0 ? playlistsHTML : `<p style="text-align: center; color: var(--Koda-text-secondary); padding: 16px 0;">${currentLanguage === 'it' ? 'Nessuna playlist disponibile' : 'No playlists available'}</p>`}
                            </div>
                            <button class="create-playlist-btn" data-action="create-playlist-from-modal" data-video-id="${videoId}" style="margin-top: 8px;">
                                ${currentLanguage === 'it' ? '+ Crea nuova playlist' : '+ Create new playlist'}
                            </button>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
            };

            const openCreatePlaylistModal = (videoIdToAdd = null) => {
                // Aggiungi alla cronologia del browser
                history.pushState({ modal: 'create-playlist', page: currentView }, '', '');

                const modalHTML = `
                    <div class="playlist-modal visible">
                        <div class="playlist-modal-content">
                            <div class="playlist-modal-header">
                                <h3 class="playlist-modal-title">${currentLanguage === 'it' ? 'Crea nuova playlist' : 'Create new playlist'}</h3>
                                <button class="playlist-modal-close" data-action="close-playlist-modal">×</button>
                            </div>
                            <input type="text" class="playlist-input" id="new-playlist-name" placeholder="${currentLanguage === 'it' ? 'Nome playlist' : 'Playlist name'}">
                            <button class="create-playlist-btn" data-action="save-new-playlist" data-video-id="${videoIdToAdd || ''}">
                                ${currentLanguage === 'it' ? 'Salva' : 'Save'}
                            </button>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                setTimeout(() => document.getElementById('new-playlist-name').focus(), 100);
            };

            // Variabili per la selezione multipla nelle playlist
            let playlistSelectionMode = false;
            let selectedPlaylistVideos = new Set();
            let activePlaylistId = null;

            const openPlaylistDetailModal = (playlistId) => {
                const playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                const playlist = playlists.find(p => p.id === playlistId);

                if (!playlist) return;

                activePlaylistId = playlistId;
                playlistSelectionMode = false;
                selectedPlaylistVideos.clear();

                // Nascondi il catalogo video e mostra la pagina playlist
                const videoCatalog = document.getElementById('video-catalog-modal');
                if (videoCatalog) videoCatalog.style.display = 'none';

                renderPlaylistDetailPage(playlistId);
            };

            const renderPlaylistDetailPage = (playlistId) => {
                const playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                const playlist = playlists.find(p => p.id === playlistId);

                if (!playlist) return;

                const videosHTML = playlist.videos.map(videoId => {
                    const video = youtubeVideosData.find(v => v.id === videoId);
                    if (!video) return '';

                    let videoIdYT = '';
                    try {
                        const url = new URL(video.youtubeUrl);
                        videoIdYT = url.hostname === 'youtu.be' ? url.pathname.slice(1) : url.searchParams.get('v');
                    } catch (e) { }

                    const thumbnailUrl = videoIdYT ? `https://img.youtube.com/vi/${videoIdYT}/mqdefault.jpg` : '';

                    return `
                        <div class="video-card" style="position: relative;">
                            ${playlistSelectionMode ? `
                                <div class="selection-checkbox ${selectedPlaylistVideos.has(videoId) ? 'selected' : ''}" 
                                     data-action="toggle-playlist-video-selection" 
                                     data-video-id="${videoId}"
                                     style="position: absolute; top: 8px; left: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                </div>
                            ` : ''}
                            <img src="${thumbnailUrl}" class="video-thumbnail" alt="Thumbnail">
                            <div class="video-info">
                                <h4>${video.title} ${video.category ? getCategoryBadgeHTML(video.category) : ''}</h4>
                                <button class="button" data-action="watch-youtube-video" data-url="${video.youtubeUrl}">${currentLanguage === 'it' ? 'Guarda' : 'Watch'}</button>
                            </div>
                        </div>
                    `;
                }).join('');

                const logoUrl = currentTheme === 'light'
                    ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                    : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';

                const coverHTML = playlist.coverImage
                    ? `<img src="${playlist.coverImage}" alt="${playlist.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`
                    : `<img src="${logoUrl}" alt="Koda Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; background: var(--Koda-card);">`;

                const pageHTML = `
                    <div class="playlist-detail-page" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--Koda-bg); z-index: 10000; overflow-y: auto;">
                        <div style="max-width: 1200px; margin: 0 auto; padding: 24px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                                <button class="pill-btn" data-action="close-playlist-detail" style="display: inline-flex; align-items: center; gap: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                                    ${currentLanguage === 'it' ? 'Indietro' : 'Back'}
                                </button>
                                <h2 style="margin: 0; flex: 1;">${playlist.name}</h2>
                                ${playlist.videos.length > 0 ? `
                                    <button class="pill-btn ${playlistSelectionMode ? 'active' : ''}" data-action="toggle-playlist-selection-mode" style="display: inline-flex; align-items: center; gap: 8px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                        ${playlistSelectionMode ? (currentLanguage === 'it' ? 'Annulla' : 'Cancel') : (currentLanguage === 'it' ? 'Seleziona' : 'Select')}
                                    </button>
                                ` : ''}
                            </div>

                            ${playlistSelectionMode ? `
                                <div class="selection-bar" style="position: relative; top: 0; margin-bottom: 24px;">
                                    <div class="selection-bar-content">
                                        <span id="playlist-selection-count">${selectedPlaylistVideos.size} ${currentLanguage === 'it' ? 'selezionati' : 'selected'}</span>
                                        <div class="selection-bar-actions">
                                            <button class="selection-bar-btn" data-action="remove-selected-from-playlist" ${selectedPlaylistVideos.size === 0 ? 'disabled' : ''}>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                                ${currentLanguage === 'it' ? 'Rimuovi' : 'Remove'}
                                            </button>
                                            <button class="selection-bar-btn" data-action="cancel-playlist-selection">
                                                ${currentLanguage === 'it' ? 'Annulla' : 'Cancel'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <div style="background: var(--Koda-card-bg); padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                                <div style="display: flex; gap: 24px; align-items: start;">
                                    <div style="position: relative; flex-shrink: 0;">
                                        <div style="width: 200px; height: 133px;">${coverHTML}</div>
                                        <button class="pill-btn" data-action="change-playlist-cover" data-playlist-id="${playlistId}" style="position: absolute; bottom: 8px; right: 8px; padding: 8px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                        </button>
                                    </div>
                                    <div style="flex: 1;">
                                        <p style="color: var(--Koda-text-secondary); margin: 0 0 8px 0;">${playlist.videos.length} ${currentLanguage === 'it' ? 'video' : 'videos'}</p>
                                        <p style="color: var(--Koda-text-secondary); margin: 0;">${currentLanguage === 'it' ? '' : ''} ${new Date(playlist.createdAt).toLocaleDateString()}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="video-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; min-height: 40vh;">
                                ${videosHTML.length > 0 ? videosHTML : `<div id="empty-state" style="grid-column: 1 / -1;">${translations[currentLanguage].emptyPlaylist}</div>`}
                            </div>
                        </div>
                    </div>
                `;

                // Rimuovi pagine playlist esistenti
                document.querySelectorAll('.playlist-detail-page').forEach(p => p.remove());
                document.body.insertAdjacentHTML('beforeend', pageHTML);
            };

            const togglePlaylistSelectionMode = () => {
                playlistSelectionMode = !playlistSelectionMode;
                selectedPlaylistVideos.clear();
                renderPlaylistDetailPage(activePlaylistId);
            };

            const togglePlaylistVideoSelection = (videoId) => {
                if (selectedPlaylistVideos.has(videoId)) {
                    selectedPlaylistVideos.delete(videoId);
                } else {
                    selectedPlaylistVideos.add(videoId);
                }

                // Aggiorna il contatore
                const count = selectedPlaylistVideos.size;
                const countText = currentLanguage === 'it' ? `${count} selezionati` : `${count} selected`;
                const countElement = document.getElementById('playlist-selection-count');
                if (countElement) {
                    countElement.textContent = countText;
                }

                // Aggiorna lo stato del pulsante Rimuovi
                const removeBtn = document.querySelector('[data-action="remove-selected-from-playlist"]');
                if (removeBtn) {
                    if (count === 0) {
                        removeBtn.setAttribute('disabled', 'true');
                    } else {
                        removeBtn.removeAttribute('disabled');
                    }
                }

                // Aggiorna visivamente la checkbox
                const checkboxes = document.querySelectorAll(`[data-action="toggle-playlist-video-selection"][data-video-id="${videoId}"]`);
                checkboxes.forEach(cb => {
                    cb.classList.toggle('selected', selectedPlaylistVideos.has(videoId));
                });
            };

            const removeSelectedFromPlaylist = async () => {
                if (selectedPlaylistVideos.size === 0 || !activePlaylistId) return;

                const count = selectedPlaylistVideos.size;
                const confirmed = await showConfirmModal({
                    title: currentLanguage === 'it' ? 'Rimuovi dalla playlist' : 'Remove from playlist',
                    message: currentLanguage === 'it'
                        ? `Sei sicuro di voler rimuovere ${count} ${count === 1 ? 'video' : 'video'} da questa playlist?`
                        : `Are you sure you want to remove ${count} ${count === 1 ? 'video' : 'videos'} from this playlist?`,
                    icon: '🗑️',
                    confirmText: currentLanguage === 'it' ? 'Rimuovi' : 'Remove',
                    cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                });

                if (!confirmed) return;

                let playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                const playlist = playlists.find(p => p.id === activePlaylistId);

                if (playlist) {
                    playlist.videos = playlist.videos.filter(id => !selectedPlaylistVideos.has(id));
                    localStorage.setItem('video-playlists', JSON.stringify(playlists));
                    showToast(currentLanguage === 'it' ? `${count} video rimossi` : `${count} videos removed`);
                    selectedPlaylistVideos.clear();
                    playlistSelectionMode = false;
                    renderPlaylistDetailPage(activePlaylistId);
                }
            };

            const changePlaylistCover = async (playlistId) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const imageData = event.target.result;

                        // Mostra modale di conferma con preview
                        const modalHTML = `
                            <div class="playlist-modal visible">
                                <div class="playlist-modal-content">
                                    <div class="playlist-modal-header">
                                        <h3 class="playlist-modal-title">${currentLanguage === 'it' ? 'Conferma copertina' : 'Confirm cover'}</h3>
                                        <button class="playlist-modal-close" data-action="close-playlist-modal">×</button>
                                    </div>
                                    <div style="text-align: center; margin: 16px 0;">
                                        <img src="${imageData}" alt="Preview" style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                                    </div>
                                    <div style="display: flex; gap: 12px;">
                                        <button class="button" data-action="close-playlist-modal" style="flex: 1; background: var(--Koda-card-bg); color: var(--Koda-text);">
                                            ${currentLanguage === 'it' ? 'Annulla' : 'Cancel'}
                                        </button>
                                        <button class="button" data-action="confirm-playlist-cover" data-playlist-id="${playlistId}" data-image="${imageData}" style="flex: 1;">
                                            ${currentLanguage === 'it' ? 'Salva' : 'Save'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.body.insertAdjacentHTML('beforeend', modalHTML);
                    };
                    reader.readAsDataURL(file);
                };
                input.click();
            };

            const confirmPlaylistCover = (playlistId, imageData) => {
                let playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                const playlist = playlists.find(p => p.id === playlistId);

                if (playlist) {
                    playlist.coverImage = imageData;
                    localStorage.setItem('video-playlists', JSON.stringify(playlists));
                    showToast(currentLanguage === 'it' ? 'Copertina aggiornata' : 'Cover updated');
                    document.querySelectorAll('.playlist-modal').forEach(m => m.remove());
                    renderPlaylistDetailPage(playlistId);
                }
            };

            // Gestori eventi per le azioni delle playlist
            document.addEventListener('click', async (e) => {
                const action = e.target.dataset.action;

                if (action === 'close-playlist-modal') {
                    document.querySelectorAll('.playlist-modal').forEach(m => m.remove());
                }

                if (action === 'add-video-to-playlist') {
                    const playlistId = e.target.dataset.playlistId;
                    const videoId = e.target.dataset.videoId;
                    let playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                    const playlist = playlists.find(p => p.id === playlistId);

                    if (playlist && !playlist.videos.includes(videoId)) {
                        // Mostra conferma prima di aggiungere
                        const confirmed = await showConfirmModal({
                            title: currentLanguage === 'it' ? 'Aggiungi a playlist?' : 'Add to playlist?',
                            message: currentLanguage === 'it' ? `Vuoi aggiungere questo video alla playlist "${playlist.name}"?` : `Do you want to add this video to the playlist "${playlist.name}"?`,
                            icon: '📝',
                            confirmText: currentLanguage === 'it' ? 'Aggiungi' : 'Add',
                            cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                        });

                        if (confirmed) {
                            playlist.videos.push(videoId);
                            localStorage.setItem('video-playlists', JSON.stringify(playlists));
                            showToast(currentLanguage === 'it' ? 'Video aggiunto alla playlist' : 'Video added to playlist');
                            document.querySelectorAll('.playlist-modal').forEach(m => m.remove());
                            document.querySelectorAll('.video-options-menu').forEach(m => m.classList.remove('visible'));
                        }
                    } else if (playlist && playlist.videos.includes(videoId)) {
                        showToast(currentLanguage === 'it' ? 'Video già presente nella playlist' : 'Video already in playlist');
                    }
                }

                if (action === 'create-playlist-from-modal') {
                    const videoId = e.target.dataset.videoId;
                    document.querySelectorAll('.playlist-modal').forEach(m => m.remove());
                    openCreatePlaylistModal(videoId);
                }

                if (action === 'save-new-playlist') {
                    const nameInput = document.getElementById('new-playlist-name');
                    const name = nameInput ? nameInput.value.trim() : '';
                    const videoId = e.target.dataset.videoId;

                    if (!name) {
                        showToast(currentLanguage === 'it' ? 'Inserisci un nome per la playlist' : 'Enter a playlist name');
                        return;
                    }

                    let playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                    const newPlaylist = {
                        id: 'playlist-' + Date.now(),
                        name: name,
                        videos: videoId ? [videoId] : []
                    };

                    playlists.push(newPlaylist);
                    localStorage.setItem('video-playlists', JSON.stringify(playlists));
                    showToast(currentLanguage === 'it' ? 'Playlist creata' : 'Playlist created');
                    document.querySelectorAll('.playlist-modal').forEach(m => m.remove());

                    // Aggiorna la vista se siamo nella pagina Cinema
                    if (currentView === 'cinema') {
                        const activeNavBtn = document.querySelector('.cinema-nav-btn.active');
                        if (activeNavBtn && activeNavBtn.dataset.tab === 'playlists') {
                            handleCinemaTabChange('playlists');
                        }
                    }
                }

                // Gestori rimossi - ora gestiti tramite data-action nel nuovo sistema
            });

            // Chiudi menu opzioni quando si clicca fuori
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.video-options-btn') && !e.target.closest('.video-options-menu')) {
                    document.querySelectorAll('.video-options-menu').forEach(m => m.classList.remove('visible'));
                }

                // Gestione click su checkbox playlist
                if (e.target.classList.contains('select-checkbox')) {
                    const playlistItem = e.target.closest('.playlist-item');
                    if (playlistItem && playlistItem.classList.contains('multi-select-mode')) {
                        e.stopPropagation();
                        playlistItem.classList.toggle('selected');

                        // Mostra/nascondi pulsante elimina
                        const selectedCount = document.querySelectorAll('.playlist-item.selected').length;
                        const deleteBtn = document.getElementById('playlist-delete-selected-btn');
                        if (deleteBtn) {
                            deleteBtn.style.display = selectedCount > 0 ? 'inline-block' : 'none';
                        }
                    }
                }

                // Previeni apertura playlist quando si è in modalità selezione o si clicca sui pulsanti
                if (e.target.closest('.playlist-item')?.classList.contains('multi-select-mode') &&
                    !e.target.classList.contains('select-checkbox') &&
                    !e.target.closest('[data-action="edit-playlist"]') &&
                    !e.target.closest('[data-action="delete-single-playlist"]')) {
                    const playlistItem = e.target.closest('.playlist-item');
                    if (playlistItem) {
                        e.stopPropagation();
                        playlistItem.classList.toggle('selected');

                        const selectedCount = document.querySelectorAll('.playlist-item.selected').length;
                        const deleteBtn = document.getElementById('playlist-delete-selected-btn');
                        if (deleteBtn) {
                            deleteBtn.style.display = selectedCount > 0 ? 'inline-block' : 'none';
                        }
                    }
                }

                // Previeni apertura playlist quando si clicca sui pulsanti modifica/elimina
                if (e.target.closest('[data-action="edit-playlist"]') ||
                    e.target.closest('[data-action="delete-single-playlist"]')) {
                    e.stopPropagation();
                }
            });

            // --- FUNZIONE PER OTTIMIZZARE I PROMPT ---
            const handlePromptOptimization = async () => {
                const originalPromptTextarea = document.getElementById('optimizer-original-prompt');
                const optimizedPromptTextarea = document.getElementById('optimizer-optimized-prompt');
                const optimizeBtn = document.getElementById('optimizer-submit-btn');

                const originalPrompt = originalPromptTextarea.value.trim();
                if (!originalPrompt) {
                    showToast("Per favore, inserisci un prompt da ottimizzare.");
                    return;
                }

                optimizeBtn.disabled = true;
                optimizeBtn.textContent = 'Optimizing...';
                optimizedPromptTextarea.value = ''; // Pulisce l'output precedente

                const lang = currentLanguage;
                const instructions = {
                    it: `Sei un esperto di prompt engineering. Migliora il prompt dell'utente rendendolo più chiaro, specifico ed efficace. Mantieni l'intento originale ma ottimizza la formulazione. Rispondi SOLO con il prompt migliorato, senza testo aggiuntivo.`,
                    en: `You are a prompt engineering expert. Improve the user's prompt by making it clearer, more specific, and more effective. Maintain the original intent but optimize the wording. Respond ONLY with the improved prompt, without any additional text.`
                };

                try {
                    // Utilizziamo le stesse utility del chatbot principale
                    const optimizerChat = window.ai.chats.create({
                        model: window.modelName,
                        config: {
                            systemInstruction: instructions[lang],
                            maxOutputTokens: 8192,
                            temperature: 0.9,
                            topP: 0.95,
                            topK: 40
                        }
                    });

                    const stream = window.sendMessageStream(optimizerChat, originalPrompt);

                    for await (const chunk of stream) {
                        optimizedPromptTextarea.value += chunk;
                    }

                } catch (error) {
                    console.error("Optimization Error:", error);
                    optimizedPromptTextarea.value = "An error occurred during optimization. Please try again.";
                    showToast("Optimization failed.");
                } finally {
                    optimizeBtn.disabled = false;
                    optimizeBtn.textContent = translations[lang].optimizeButton;
                }
            };

            // --- INITIALIZATION LOGIC ---

            const initializeAppForGuest = () => {
                // Initialize currentUser with default empty state and load data from localStorage
                const guestFavorites = JSON.parse(localStorage.getItem('guest-favorites')) || [];
                const guestUserTools = JSON.parse(localStorage.getItem('guest-userTools')) || [];
                currentUser = { uid: null, name: 'Guest', nickname: 'Guest', favorites: guestFavorites, isPrivileged: false, userTools: guestUserTools, userFeaturedTools: [], userFeaturedReplacements: {}, aiSuggestions: [] };
                loadConversations();
                unmountReactApp();
                el.appContainer.style.display = 'flex';
                el.authOverlay.style.display = 'none';
                el.authOverlay.innerHTML = ''; // Ensure auth overlay is empty

                // NUOVO: Inizializza lo stato della cronologia del browser
                if (!window.history.state) {
                    history.replaceState({ page: currentView }, '', `#${currentView}`);
                }

                renderView();
            };

            const initializeAppWithUser = async (user) => {
                const userDocRef = doc(db, "users", user.uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        // Fetch all user data from Firestore
                        const data = userDocSnap.data();
                        currentUser = {
                            uid: user.uid,
                            name: user.email, // Use email as name for now
                            nickname: data.nickname || user.email.split('@')[0], // Use nickname or email prefix as fallback
                            favorites: data.favorites || [],
                            userTools: data.userTools || [],
                            userFeaturedTools: data.userFeaturedTools || [],
                            userFeaturedReplacements: data.userFeaturedReplacements || {}, // Fetch replacements
                            isPrivileged: data.isPrivileged || false, // Load privileged status from Firestore
                            aiSuggestions: data.aiSuggestions || [], // Load AI suggestions
                            role: data.role || 'user' // NUOVO: Carica il ruolo dell'utente, con 'user' come default
                        };
                    } else {
                        // Create user doc if it doesn't exist with initial empty arrays and non-privileged status
                        const initialUserData = {
                            email: user.email,
                            nickname: user.email.split('@')[0], // Use email prefix as default nickname
                            favorites: [],
                            userTools: [],
                            userFeaturedTools: [],
                            userFeaturedReplacements: {}, // Initialize replacements
                            isPrivileged: false, // Default to non-privileged
                            aiSuggestions: [] // Initialize AI suggestions
                        };
                        await setDoc(userDocRef, initialUserData).catch(e => console.error("Error creating user doc:", e));
                        currentUser = { uid: user.uid, name: user.email, ...initialUserData };
                    }
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    // Fallback to minimal user data if Firestore fails
                    currentUser = { uid: user.uid, name: user.email, favorites: [], userTools: [], userFeaturedTools: [], userFeaturedReplacements: {}, isPrivileged: false };
                    showToast("Could not load user data."); // Inform user
                }

                loadConversations();
                el.authOverlay.classList.add('hidden');
                el.authOverlay.addEventListener('transitionend', () => {
                    el.authOverlay.style.display = 'none';
                    el.authOverlay.innerHTML = ''; // Clear content after transition
                }, { once: true });
                el.appContainer.style.display = 'flex';

                // NUOVO: Inizializza lo stato della cronologia del browser
                if (!window.history.state) {
                    history.replaceState({ page: currentView }, '', `#${currentView}`);
                }

                renderView(); // Render the app view
            };

            // Apply theme on initial load
            document.body.classList.toggle('light-mode', currentTheme === 'light');

            // NUOVA FUNZIONE PER APRIRE IL MODALE DI CONFERMA
            const openConfirmDeleteAllModal = () => {
                const t = translations[currentLanguage];
                const modalHTML = `
                <div id="confirm-delete-modal" class="modal-overlay visible">
                    <div class="modal-content" style="text-align: left; max-width: 400px;">
                        <h2 style="font-size: 20px; margin-bottom: 16px;">${t.deleteAll}</h2>
                        <p style="color: var(--Koda-text-secondary); line-height: 1.5; margin-bottom: 24px;">${t.confirmDeleteAll}</p>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="pill-btn" data-action="close-modal">${t.cancel || 'Annulla'}</button>
                            <button class="button" data-action="confirm-delete-all-chats" style="background-color: #ff4444; color: white;">${t.deleteAll}</button>
                        </div>
                    </div>
                </div>
            `;
                el.modalContainer.innerHTML = modalHTML;
            };

            // NUOVA FUNZIONE: Apre il modale per aggiungere uno strumento globale (solo admin) - STILE MIGLIORATO
            const openAddGlobalToolModal = () => {
                if (currentUser.role !== 'admin') return;
                const t = translations[currentLanguage];

                const categoryOptions = categories.map(cat => `<option value="${cat.id}">${cat.name[currentLanguage]}</option>`).join('');

                const modalHTML = `
                <div id="add-global-tool-modal" class="modal-overlay visible">
                    <div class="modal-content add-ai-modal" style="text-align: left;">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <h2>${t.addAIToDatabase}</h2>
                        
                        <div class="add-ai-form">
                            <div class="input-group">
                                <label for="global-tool-name">${t.aiNameLabel}</label>
                                <input type="text" id="global-tool-name" placeholder="${t.aiNamePlaceholder}">
                            </div>

                            <div class="input-group">
                                <label for="global-tool-desc-it">${t.descriptionITLabel}</label>
                                <textarea id="global-tool-desc-it" placeholder="${t.descriptionITPlaceholder}"></textarea>
                            </div>
                            
                            <div class="input-group">
                                <label for="global-tool-desc-en">${t.descriptionENLabel}</label>
                                <textarea id="global-tool-desc-en" placeholder="${t.descriptionENPlaceholder}"></textarea>
                            </div>

                            <div class="input-group">
                                <label for="global-tool-website">${t.websiteLinkLabel}</label>
                                <input type="url" id="global-tool-website" placeholder="${t.websiteLinkPlaceholder}">
                            </div>
                            
                            <div class="input-group">
                                <label for="global-tool-logo">${t.logoURLLabel}</label>
                                <input type="url" id="global-tool-logo" placeholder="${t.logoURLPlaceholder}">
                            </div>

                            <div class="input-group">
                                <label for="global-tool-category">${t.categoryLabel}</label>
                                <select id="global-tool-category">${categoryOptions}</select>
                            </div>
                            
                            <div class="input-group">
                                <label for="global-tool-country">${t.countryLabel}</label>
                                <input type="text" id="global-tool-country" placeholder="${t.countryPlaceholder}">
                            </div>

                            <button class="button" data-action="submit-global-tool">${t.saveToDatabase}</button>
                        </div>
                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;
            };

            // NUOVA FUNZIONE: Apre il modale per MODIFICARE uno strumento globale (solo admin)
            const openEditGlobalToolModal = (toolId) => {
                if (currentUser.role !== 'admin') return;

                const toolToEdit = aiToolsData.find(t => t.id === toolId);
                if (!toolToEdit) {
                    showToast("Strumento non trovato.");
                    return;
                }

                const t = translations[currentLanguage];
                const categoryOptions = categories.map(cat => `<option value="${cat.id}" ${cat.id === toolToEdit.category ? 'selected' : ''}>${cat.name[currentLanguage]}</option>`).join('');
                const modalHTML = `
                <div id="edit-global-tool-modal" class="modal-overlay visible">
                    <div class="modal-content add-ai-modal" style="text-align: left;">
                        <button class="modal-close-btn" data-action="close-modal">×</button>
                        <h2>${t.editAIInDatabase}</h2>
                        
                        <div class="add-ai-form">
                            <div class="input-group">
                                <label>${t.documentIdLabel}</label>
                                <input type="text" value="${toolToEdit.id}" disabled style="background-color: var(--Koda-bg);">
                            </div>

                            <div class="input-group">
                                <label for="edit-global-tool-name">${t.aiNameLabel}</label>
                                <input type="text" id="edit-global-tool-name" value="${toolToEdit.name || ''}">
                            </div>

                            <div class="input-group">
                                <label for="edit-global-tool-desc-it">${t.descriptionITLabel}</label>
                                <textarea id="edit-global-tool-desc-it">${toolToEdit.description.it || ''}</textarea>
                            </div>
                            
                            <div class="input-group">
                                <label for="edit-global-tool-desc-en">${t.descriptionENLabel}</label>
                                <textarea id="edit-global-tool-desc-en">${toolToEdit.description.en || ''}</textarea>
                            </div>

                            <div class="input-group">
                                <label for="edit-global-tool-website">${t.websiteLinkLabel}</label>
                                <input type="url" id="edit-global-tool-website" value="${toolToEdit.website || ''}">
                            </div>
                            
                            <div class="input-group">
                                <label for="edit-global-tool-logo">${t.logoURLLabel}</label>
                                <input type="url" id="edit-global-tool-logo" value="${toolToEdit.logoUrl || ''}">
                            </div>

                            <div class="input-group">
                                <label for="edit-global-tool-category">${t.categoryLabel}</label>
                                <select id="edit-global-tool-category">${categoryOptions}</select>
                            </div>
                            
                            <div class="input-group">
                                <label for="edit-global-tool-country">${t.countryLabel}</label>
                                <input type="text" id="edit-global-tool-country" value="${toolToEdit.country || ''}">
                            </div>

                            <button class="button" data-action="submit-edit-global-tool" data-id="${toolToEdit.id}">${t.saveChanges}</button>
                        </div>
                    </div>
                </div>`;
                el.modalContainer.innerHTML = modalHTML;
            };

            // NUOVA FUNZIONE: Salva le modifiche dello strumento globale su Firestore
            const handleEditGlobalTool = async (toolId) => {
                console.log('handleEditGlobalTool called with toolId:', toolId);
                if (currentUser.role !== 'admin' || !toolId) {
                    console.log('User is not admin or no toolId, role:', currentUser.role, 'toolId:', toolId);
                    return;
                }

                // Recuperiamo il tool esistente per mantenere i campi non modificabili
                const existingTool = aiToolsData.find(t => t.id === toolId);
                if (!existingTool) {
                    console.log('Tool not found in aiToolsData');
                    showToast("Strumento non trovato.");
                    return;
                }

                const updatedToolData = {
                    id: toolId, // Manteniamo l'ID
                    name: document.getElementById('edit-global-tool-name').value.trim(),
                    description: {
                        it: document.getElementById('edit-global-tool-desc-it').value.trim(),
                        en: document.getElementById('edit-global-tool-desc-en').value.trim()
                    },
                    website: document.getElementById('edit-global-tool-website').value.trim(),
                    logoUrl: document.getElementById('edit-global-tool-logo').value.trim(),
                    category: document.getElementById('edit-global-tool-category').value,
                    country: document.getElementById('edit-global-tool-country').value.trim(),
                    isFeatured: existingTool.isFeatured || false
                };

                // Validazione base
                if (!updatedToolData.name || !updatedToolData.website || !updatedToolData.logoUrl) {
                    showToast("Nome, Sito Web e URL Logo sono obbligatori.");
                    return;
                }

                try {
                    const toolDocRef = doc(db, "tools", toolId);
                    // Usiamo updateDoc per aggiornare il documento esistente
                    await updateDoc(toolDocRef, updatedToolData);

                    showToast("Strumento AI aggiornato con successo!");
                    closeModal();

                    // Ricarica i dati e la vista per mostrare le modifiche
                    [aiToolsData, aiRankingsData] = await Promise.all([
                        fetchToolsFromFirestore(),
                        fetchRankingsFromFirestore()
                    ]);
                    renderView();

                } catch (error) {
                    console.error("Errore nell'aggiornamento dello strumento:", error);
                    showToast(`Errore: ${error.message}`);
                }
            };
            // NUOVA FUNZIONE: Salva il nuovo strumento globale su Firestore
            const handleAddGlobalTool = async () => {
                console.log('handleAddGlobalTool called');
                if (currentUser.role !== 'admin') {
                    console.log('User is not admin, role:', currentUser.role);
                    return;
                }

                // Rimosso il tentativo di leggere un ID inesistente.

                const newToolData = {
                    // L'ID non viene più specificato qui. Verrà generato da Firestore.
                    name: document.getElementById('global-tool-name').value.trim(),
                    description: {
                        it: document.getElementById('global-tool-desc-it').value.trim(),
                        en: document.getElementById('global-tool-desc-en').value.trim()
                    },
                    website: document.getElementById('global-tool-website').value.trim(),
                    logoUrl: document.getElementById('global-tool-logo').value.trim(),
                    category: document.getElementById('global-tool-category').value,
                    country: document.getElementById('global-tool-country').value.trim(),
                    isFeatured: false // Valore di default per i nuovi strumenti
                };

                // Validazione base
                if (!newToolData.name || !newToolData.website || !newToolData.logoUrl) {
                    showToast("Nome, Sito Web e URL Logo sono obbligatori.");
                    return;
                }

                try {
                    // Usa addDoc per creare un nuovo documento con un ID generato automaticamente
                    const toolsCollectionRef = collection(db, "tools");
                    await addDoc(toolsCollectionRef, newToolData);

                    showToast("Strumento AI aggiunto con successo al database!");
                    closeModal();

                    // Ricarica i dati e la vista per mostrare il nuovo strumento
                    [aiToolsData, aiRankingsData] = await Promise.all([
                        fetchToolsFromFirestore(),
                        fetchRankingsFromFirestore()
                    ]);
                    renderView();

                } catch (error) {
                    console.error("Errore nell'aggiunta dello strumento globale:", error);
                    showToast(`Errore: ${error.message}`);
                }
            };
            // NUOVO: Sistema completo di gestione della cronologia del browser
            window.addEventListener('popstate', (event) => {
                // 1. Gestisci il side menu
                const sideMenu = document.getElementById('side-menu');
                const sideMenuOverlay = document.getElementById('side-menu-overlay');
                if (sideMenu && sideMenu.classList.contains('visible')) {
                    toggleSideMenu(false);
                    return;
                }

                // 2. Gestisci i modali custom (review-modal, confirm-modal, sent-reviews-modal, etc.)
                const customModals = document.querySelectorAll('.review-modal.visible, .confirm-modal.visible, .sent-reviews-modal.visible, .privacy-modal.visible, .privacy-reminder-modal.visible, .playlist-modal.visible, .category-modal.visible, .add-to-collection-modal.visible');
                if (customModals.length > 0) {
                    customModals.forEach(modal => {
                        modal.classList.remove('visible');
                        setTimeout(() => modal.remove(), 300);
                    });
                    return;
                }

                // 3. Gestisci i modali standard (modal-overlay)
                const modalOverlay = document.querySelector('.modal-overlay.visible');
                if (modalOverlay) {
                    const fullscreenModal = document.getElementById('prompt-fullscreen-modal');
                    if (fullscreenModal) {
                        openPromptGalleryModal();
                        return;
                    }
                    el.modalContainer.innerHTML = '';
                    return;
                }

                // 4. Gestisci il dropdown del profilo utente
                const userProfileDropdown = document.querySelector('.user-profile-dropdown.visible');
                if (userProfileDropdown) {
                    closeUserProfileDropdown();
                    return;
                }

                // 5. Gestisci il ritorno dalla modalità cinema
                const cinemaNav = document.querySelector('.cinema-bottom-nav');
                if (cinemaNav && (!event.state || event.state.page !== 'cinema')) {
                    cinemaNav.remove();
                }

                // 6. Gestisci il ripristino dei filtri
                if (event.state && event.state.exploreFilter) {
                    exploreFilter = event.state.exploreFilter;
                    renderView();
                    return;
                }

                if (event.state && event.state.rankingFilter) {
                    rankingFilter = event.state.rankingFilter;
                    renderView();
                    return;
                }

                if (event.state && event.state.activeFilter) {
                    activeFilter = event.state.activeFilter;
                    renderView();
                    return;
                }

                // 7. Gestisci il ripristino di un modale di dettaglio AI
                if (event.state && event.state.modal === 'detail' && event.state.toolId) {
                    window.openDetailModal(event.state.toolId, false);
                    return;
                }

                // 8. Gestisci il ripristino della pagina video-detail
                if (event.state && event.state.page === 'video-detail' && event.state.videoId) {
                    window.currentVideoId = event.state.videoId;
                    currentView = 'video-detail';
                    renderView();
                    return;
                }

                // 9. Gestisci il ripristino del catalogo video (vecchio modale - deprecato)
                if (event.state && event.state.modal === 'video-catalog') {
                    openVideoCatalogModal(false);
                    return;
                }

                // 10. Gestisci il cambio di pagina
                if (event.state && event.state.page) {
                    currentView = event.state.page;

                    // Ripristina i filtri se presenti nello stato
                    if (event.state.exploreFilter !== undefined) {
                        exploreFilter = event.state.exploreFilter;
                    }
                    if (event.state.rankingFilter !== undefined) {
                        rankingFilter = event.state.rankingFilter;
                    }
                    if (event.state.activeFilter !== undefined) {
                        activeFilter = event.state.activeFilter;
                    }

                    renderView();

                    // Se lo stato include un tab del cinema, ripristinalo (senza aggiungere alla cronologia)
                    if (event.state.cinemaTab) {
                        setTimeout(() => {
                            handleCinemaTabChange(event.state.cinemaTab, false);
                        }, 100);
                    }
                } else {
                    // Se non viene trovato alcuno stato (es. caricamento iniziale), vai alla home
                    currentView = 'home';
                    exploreFilter = { type: null, value: null };
                    rankingFilter = 'All';
                    activeFilter = 'All';
                    renderView();
                }
            });

            // --- MAIN EVENT LISTENER ---
            document.body.addEventListener('click', async (e) => {
                const target = e.target;

                // 1. Handle navigation buttons FIRST
                const navBtn = target.closest('.nav-btn');
                if (navBtn && navBtn.dataset.page !== currentView) {
                    const newView = navBtn.dataset.page;
                    currentView = newView;

                    // --- INSERT THIS CODE ---
                    const state = { page: newView };
                    const title = ''; // Title is ignored by most browsers
                    const url = `#${newView}`; // Update the URL with a hash
                    history.pushState(state, title, url);
                    // --- END OF INSERTION ---

                    // Reset filters when changing main pages
                    activeFilter = 'All'; exploreFilter = { type: null, value: null }; rankingFilter = 'All'; // Reset all filters
                    renderView();
                    el.mainContent.scrollTop = 0; // Scroll to top on page change
                    e.preventDefault(); // Prevent default link behavior
                    return; // Stop processing
                }




                // 3. Handle elements with data-action (excluding the K button which is handled above)
                const actionTarget = target.closest('[data-action]');
                if (actionTarget && actionTarget.id !== 'privileged-unlock-btn') { // Explicitly exclude K button
                    const action = actionTarget.dataset.action;

                    switch (action) {
                        // NUOVE AZIONI ADMIN
                        case 'open-add-global-tool-modal':
                            openAddGlobalToolModal();
                            break;
                        case 'submit-global-tool':
                            console.log('submit-global-tool action triggered');
                            handleAddGlobalTool();
                            break;
                        case 'open-edit-global-tool-modal':
                            openEditGlobalToolModal(actionTarget.dataset.id);
                            break;
                        case 'submit-edit-global-tool':
                            console.log('submit-edit-global-tool action triggered');
                            handleEditGlobalTool(actionTarget.dataset.id);
                            break;
                        case 'navigate-to-optimizer':
                            const optimizer = document.getElementById('optimizer-overlay');
                            if (optimizer) {
                                optimizer.classList.add('visible');
                                // Blocchiamo lo scroll del body quando l'overlay è attivo
                                document.body.style.overflow = 'hidden';
                            }
                            break;
                        case 'close-optimizer':
                            const optimizerToClose = document.getElementById('optimizer-overlay');
                            if (optimizerToClose) {
                                optimizerToClose.classList.remove('visible');
                                // Ripristiniamo lo scroll del body
                                document.body.style.overflow = '';
                            }
                            break;
                        case 'optimize-prompt':
                            handlePromptOptimization();
                            break;
                        // --- AZIONI PER OPTIMIZER E GALLERIA (NUOVE) ---
                        case 'copy-optimized-prompt':
                            handleCopyOptimizedPrompt();
                            break;
                        case 'save-optimized-prompt':
                            handleSaveOptimizedPrompt();
                            break;
                        case 'show-prompt-gallery':
                            openPromptGalleryModal();
                            break;
                        case 'copy-gallery-prompt':
                            // Chiama la nuova funzione helper per la copia
                            handleCopyFromGallery(actionTarget.dataset.targetId);
                            break;
                        case 'delete-saved-prompt':
                            handleDeleteSavedPrompt(actionTarget.dataset.id); // Ora apre il modale di conferma
                            break;
                        case 'execute-delete-saved-prompt': // NUOVA AZIONE
                            executeDeleteSavedPrompt(actionTarget.dataset.id);
                            break;
                        case 'open-prompt-fullscreen':
                            // Apri il prompt a tutto schermo
                            const promptItem = actionTarget.closest('.prompt-gallery-item');
                            if (promptItem) {
                                const originalPrompt = promptItem.dataset.original;
                                const optimizedPrompt = promptItem.dataset.optimized;
                                const timestamp = promptItem.dataset.timestamp;
                                const promptId = promptItem.dataset.promptId;

                                const fullscreenHTML = `
                                    <div id="prompt-fullscreen-modal" class="modal-overlay visible">
                                        <div class="modal-content" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0; display: flex; flex-direction: column; padding: 0;">
                                            <div class="gallery-header" style="padding: 20px 24px; border-bottom: 1px solid rgba(128, 128, 128, 0.2);">
                                                <button class="modal-close-btn" data-action="close-fullscreen-prompt" style="position: absolute; top: 20px; right: 24px;">×</button>
                                                <h2 style="margin: 0; font-size: 24px;">Prompt Salvato</h2>
                                                <p style="color: var(--Koda-text-secondary); font-size: 14px; margin-top: 8px;">${timestamp}</p>
                                            </div>
                                            <div style="flex: 1; overflow-y: auto; padding: 24px;">
                                                <div style="margin-bottom: 32px;">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                        <label style="font-weight: 600; font-size: 16px;">${translations[currentLanguage].originalPromptLabel}</label>
                                                        <button class="prompt-gallery-copy-btn" data-action="copy-fullscreen-text" data-text="${originalPrompt.replace(/"/g, '&quot;')}">${translations[currentLanguage].copyButton}</button>
                                                    </div>
                                                    <div style="background-color: var(--Koda-bg-light); padding: 16px; border-radius: 8px; line-height: 1.6; white-space: pre-wrap;">${originalPrompt}</div>
                                                </div>
                                                <hr style="border: none; border-top: 1px solid rgba(128, 128, 128, 0.2); margin: 24px 0;">
                                                <div>
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                                        <label style="font-weight: 600; font-size: 16px;">${translations[currentLanguage].optimizedPromptLabel}</label>
                                                        <button class="prompt-gallery-delete-btn" title="Elimina prompt" data-action="delete-saved-prompt" data-id="${promptId}">
                                                            <svg xmlns="http://www.w3.org/2000/svg" height="16" viewBox="0 0 24 24" width="16" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                                        </button>
                                                    </div>
                                                    <div style="background: linear-gradient(135deg, rgba(29, 185, 84, 0.15) 0%, rgba(29, 185, 84, 0.05) 100%); border: 2px solid var(--Koda-accent); padding: 16px; border-radius: 8px; line-height: 1.6; white-space: pre-wrap; color: var(--Koda-text);">${optimizedPrompt}</div>
                                                    <button class="button" data-action="copy-fullscreen-text" data-text="${optimizedPrompt.replace(/"/g, '&quot;')}" style="width: 100%; margin-top: 16px; background-color: var(--Koda-accent); color: #000; font-weight: 600;">${translations[currentLanguage].copyButton}</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                el.modalContainer.innerHTML = fullscreenHTML;

                                // Aggiungi stato alla history per gestire il pulsante indietro
                                history.pushState({ modal: 'prompt-fullscreen' }, '', '');
                            }
                            break;
                        case 'close-fullscreen-prompt':
                            // Torna alla galleria
                            openPromptGalleryModal();
                            break;
                        case 'copy-fullscreen-text':
                            const textToCopy = actionTarget.dataset.text;
                            if (textToCopy) {
                                navigator.clipboard.writeText(textToCopy)
                                    .then(() => showToast("Copiato!"))
                                    .catch(err => console.error('Errore nella copia:', err));
                            }
                            break;
                        // AZIONI CATALOGO VIDEO (UTENTE) - Ora naviga alla pagina cinema
                        case 'open-video-catalog':
                            // Azzera il badge quando si apre il Cinema
                            localStorage.setItem('lastCinemaVisit', Date.now().toString());
                            updateCinemaNotificationBadge();

                            currentView = 'cinema';
                            history.pushState({ page: 'cinema' }, '', '#cinema');
                            renderView();
                            el.mainContent.scrollTop = 0;
                            break;
                        // NUOVO: Esci dal cinema e torna alla home
                        case 'exit-cinema':
                            // Rimuovi la bottom nav del Cinema
                            const cinemaNav = document.querySelector('.cinema-bottom-nav');
                            if (cinemaNav) cinemaNav.remove();

                            currentView = 'home';
                            history.pushState({ page: 'home' }, '', '#home');
                            renderView();
                            el.mainContent.scrollTop = 0;
                            break;
                        // NUOVO: Torna al cinema dalla pagina video-detail
                        case 'back-to-cinema':
                            currentView = 'cinema';
                            history.pushState({ page: 'cinema' }, '', '#cinema');
                            renderView();
                            el.mainContent.scrollTop = 0;
                            break;
                        // NUOVO: Toggle preferito dalla pagina video-detail
                        case 'toggle-video-favorite':
                            const videoIdToToggle = actionTarget.dataset.videoId;
                            if (videoIdToToggle) {
                                const videoFavorites = JSON.parse(localStorage.getItem('video-favorites') || '[]');
                                const index = videoFavorites.indexOf(videoIdToToggle);
                                if (index > -1) {
                                    videoFavorites.splice(index, 1);
                                    showToast(currentLanguage === 'it' ? 'Rimosso dai preferiti' : 'Removed from favorites');
                                } else {
                                    videoFavorites.push(videoIdToToggle);
                                    showToast(currentLanguage === 'it' ? 'Aggiunto ai preferiti' : 'Added to favorites');
                                }
                                localStorage.setItem('video-favorites', JSON.stringify(videoFavorites));
                                // Aggiorna la vista
                                renderView();
                            }
                            break;
                        // NUOVO: Apri policy Cinema (YouTube)
                        case 'open-cinema-policy':
                            event.preventDefault();
                            openCinemaPolicyModal();
                            break;
                        // NUOVO: Chiudi policy Cinema
                        case 'close-cinema-policy':
                            document.querySelectorAll('.review-modal').forEach(m => m.remove());
                            break;
                        // NUOVO: Toggle selezione multipla playlist
                        case 'toggle-playlist-multi-select':
                            const playlistContainer = document.getElementById('playlist-list-container');
                            const playlistItems = playlistContainer.querySelectorAll('.playlist-item');
                            const isMultiSelectActive = playlistContainer.classList.contains('multi-select-mode');

                            if (isMultiSelectActive) {
                                // Disattiva selezione multipla
                                playlistContainer.classList.remove('multi-select-mode');
                                playlistItems.forEach(item => {
                                    item.classList.remove('multi-select-mode', 'selected');
                                });
                                document.getElementById('playlist-multi-select-btn').textContent = currentLanguage === 'it' ? 'Seleziona' : 'Select';
                                document.getElementById('playlist-delete-selected-btn').style.display = 'none';
                            } else {
                                // Attiva selezione multipla
                                playlistContainer.classList.add('multi-select-mode');
                                playlistItems.forEach(item => {
                                    item.classList.add('multi-select-mode');
                                });
                                document.getElementById('playlist-multi-select-btn').textContent = currentLanguage === 'it' ? 'Annulla' : 'Cancel';
                            }
                            break;
                        // NUOVO: Modifica playlist
                        case 'edit-playlist':
                            event.stopPropagation();
                            const editPlaylistId = actionTarget.dataset.playlistId;
                            openEditPlaylistModal(editPlaylistId);
                            break;
                        // NUOVO: Elimina playlist
                        case 'delete-playlist':
                            event.stopPropagation();
                            const delPlaylistId = actionTarget.dataset.playlistId;

                            const confirmDelete = await showConfirmModal({
                                title: currentLanguage === 'it' ? 'Elimina playlist' : 'Delete playlist',
                                message: currentLanguage === 'it' ? 'Sei sicuro di voler eliminare questa playlist?' : 'Are you sure you want to delete this playlist?',
                                icon: '🗑️',
                                confirmText: currentLanguage === 'it' ? 'Elimina' : 'Delete',
                                cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                            });

                            if (confirmDelete) {
                                let playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                                playlists = playlists.filter(p => p.id !== delPlaylistId);
                                localStorage.setItem('video-playlists', JSON.stringify(playlists));
                                showToast(currentLanguage === 'it' ? 'Playlist eliminata' : 'Playlist deleted');

                                // Se siamo nella pagina dettaglio, torna al catalogo
                                if (activePlaylistId === delPlaylistId) {
                                    document.querySelectorAll('.playlist-detail-page').forEach(p => p.remove());
                                    const videoCatalog = document.getElementById('video-catalog-modal');
                                    if (videoCatalog) videoCatalog.style.display = 'block';
                                    activePlaylistId = null;
                                }

                                // Aggiorna la vista
                                if (currentView === 'cinema') {
                                    handleCinemaTabChange('playlists');
                                } else {
                                    openVideoCatalogModal();
                                    document.getElementById('video-section-playlists').classList.add('active');
                                    document.getElementById('video-section-home').classList.remove('active');
                                }
                            }
                            break;
                        // NUOVO: Toggle menu opzioni playlist
                        case 'toggle-playlist-options':
                            event.stopPropagation();
                            const playlistIdForMenu = actionTarget.dataset.playlistId;
                            const playlistOptionsMenu = document.getElementById(`playlist-options-${playlistIdForMenu}`);
                            if (playlistOptionsMenu) {
                                // Chiudi tutti gli altri menu
                                document.querySelectorAll('.video-options-menu').forEach(m => {
                                    if (m !== playlistOptionsMenu) {
                                        m.style.display = 'none';
                                    }
                                });
                                // Toggle il menu corrente
                                playlistOptionsMenu.style.display = playlistOptionsMenu.style.display === 'none' ? 'block' : 'none';
                            }
                            break;
                        // NUOVO: Elimina singola playlist
                        case 'delete-single-playlist':
                            event.stopPropagation();
                            const deletePlaylistId = actionTarget.dataset.playlistId;
                            let deletePlaylists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                            const deletePlaylist = deletePlaylists.find(p => p.id === deletePlaylistId);

                            if (deletePlaylist) {
                                const confirmed = await showConfirmModal({
                                    title: currentLanguage === 'it' ? 'Elimina playlist?' : 'Delete playlist?',
                                    message: currentLanguage === 'it' ? `Sei sicuro di voler eliminare la playlist "${deletePlaylist.name}"?` : `Are you sure you want to delete the playlist "${deletePlaylist.name}"?`,
                                    icon: '🗑️',
                                    confirmText: currentLanguage === 'it' ? 'Elimina' : 'Delete',
                                    cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                                });

                                if (confirmed) {
                                    deletePlaylists = deletePlaylists.filter(p => p.id !== deletePlaylistId);
                                    localStorage.setItem('video-playlists', JSON.stringify(deletePlaylists));
                                    showToast(currentLanguage === 'it' ? 'Playlist eliminata' : 'Playlist deleted');
                                    handleCinemaTabChange('playlists');
                                }
                            }
                            break;
                        // NUOVO: Elimina playlist selezionate
                        case 'delete-selected-playlists':
                            const selectedPlaylists = document.querySelectorAll('.playlist-item.selected');
                            if (selectedPlaylists.length === 0) {
                                showToast(currentLanguage === 'it' ? 'Nessuna playlist selezionata' : 'No playlists selected');
                                return;
                            }

                            const confirmed = await showConfirmModal({
                                title: currentLanguage === 'it' ? 'Elimina playlist?' : 'Delete playlists?',
                                message: currentLanguage === 'it' ? `Sei sicuro di voler eliminare ${selectedPlaylists.length} playlist?` : `Are you sure you want to delete ${selectedPlaylists.length} playlists?`,
                                icon: '🗑️',
                                confirmText: currentLanguage === 'it' ? 'Elimina' : 'Delete',
                                cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                            });

                            if (confirmed) {
                                let playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                                selectedPlaylists.forEach(item => {
                                    const playlistId = item.dataset.playlistId;
                                    playlists = playlists.filter(p => p.id !== playlistId);
                                });
                                localStorage.setItem('video-playlists', JSON.stringify(playlists));
                                showToast(currentLanguage === 'it' ? 'Playlist eliminate' : 'Playlists deleted');
                                handleCinemaTabChange('playlists');
                            }
                            break;
                        case 'open-video-detail':
                            event.stopPropagation();
                            const detailVideoId = actionTarget.dataset.videoId;
                            console.log('Opening video detail for:', detailVideoId);
                            if (detailVideoId) {
                                window.openVideoDetailModal(detailVideoId);
                            }
                            break;
                        case 'watch-youtube-video':
                            const url = actionTarget.dataset.url;
                            if (url) window.open(url, '_blank');
                            break;
                        // MODIFICA 1: Cambio sezione nel catalogo video (vecchio modale - non più usato)
                        case 'switch-video-section':
                            const section = actionTarget.dataset.section;
                            document.querySelectorAll('.video-section').forEach(s => s.classList.remove('active'));
                            document.querySelectorAll('.video-catalog-nav-btn').forEach(b => b.classList.remove('active'));
                            document.getElementById(`video-section-${section}`).classList.add('active');
                            actionTarget.classList.add('active');
                            break;
                        // MODIFICA 3 & 4: Toggle preferito con conferma per rimozione
                        case 'toggle-favorite':
                            event.stopPropagation();
                            const videoId = actionTarget.dataset.videoId;

                            // Se è un video (ha videoId), gestisci come video
                            if (videoId) {
                                let favorites = JSON.parse(localStorage.getItem('video-favorites') || '[]');

                                if (favorites.includes(videoId)) {
                                    // MODIFICA 4: Mostra modale di conferma per rimozione
                                    const confirmed = await showConfirmModal({
                                        title: currentLanguage === 'it' ? 'Rimuovi dai preferiti?' : 'Remove from favorites?',
                                        message: currentLanguage === 'it' ? 'Sei sicuro di voler rimuovere questo video dai preferiti?' : 'Are you sure you want to remove this video from favorites?',
                                        icon: '❤️',
                                        confirmText: currentLanguage === 'it' ? 'Rimuovi' : 'Remove',
                                        cancelText: currentLanguage === 'it' ? 'Annulla' : 'Cancel'
                                    });

                                    if (confirmed) {
                                        favorites = favorites.filter(id => id !== videoId);
                                        actionTarget.classList.remove('favorited');
                                        showToast(currentLanguage === 'it' ? 'Rimosso dai preferiti' : 'Removed from favorites');
                                        localStorage.setItem('video-favorites', JSON.stringify(favorites));

                                        // Aggiorna la vista Cinema se siamo nella pagina Cinema
                                        if (currentView === 'cinema') {
                                            const activeNavBtn = document.querySelector('.cinema-nav-btn.active');
                                            if (activeNavBtn) {
                                                const currentTab = activeNavBtn.dataset.tab;
                                                handleCinemaTabChange(currentTab);
                                            }
                                        }
                                        // Aggiorna la sezione preferiti se visibile (vecchio modale)
                                        else if (document.getElementById('video-section-favorites')?.classList.contains('active')) {
                                            openVideoCatalogModal();
                                            document.getElementById('video-section-favorites').classList.add('active');
                                            document.getElementById('video-section-home').classList.remove('active');
                                            document.querySelectorAll('.video-catalog-nav-btn')[1].classList.add('active');
                                            document.querySelectorAll('.video-catalog-nav-btn')[0].classList.remove('active');
                                        }
                                    }
                                } else {
                                    // Aggiungi senza conferma
                                    favorites.push(videoId);
                                    actionTarget.classList.add('favorited');
                                    showToast(currentLanguage === 'it' ? 'Aggiunto ai preferiti' : 'Added to favorites');
                                    localStorage.setItem('video-favorites', JSON.stringify(favorites));
                                }
                            } else {
                                // Se è un'AI (ha id invece di videoId), gestisci come AI
                                toggleFavorite(actionTarget.dataset.id);
                            }
                            break;
                        // MODIFICA 4: Mostra menu opzioni video
                        case 'show-video-options':
                            event.stopPropagation();
                            const optionsVideoId = actionTarget.dataset.videoId;
                            const optionsMenu = document.getElementById(`options-menu-${optionsVideoId}`);
                            // Chiudi tutti gli altri menu
                            document.querySelectorAll('.video-options-menu').forEach(m => m.classList.remove('visible'));
                            optionsMenu.classList.toggle('visible');
                            break;
                        // MODIFICA 4: Aggiungi a playlist
                        case 'add-to-playlist':
                            event.stopPropagation();
                            const addVideoId = actionTarget.dataset.videoId;
                            openAddToPlaylistModal(addVideoId);
                            break;
                        // MODIFICA 4: Crea nuova playlist
                        case 'create-playlist':
                            openCreatePlaylistModal();
                            break;
                        // MODIFICA 4: Apri playlist
                        case 'open-playlist':
                            const playlistId = actionTarget.dataset.playlistId;
                            openPlaylistDetailModal(playlistId);
                            break;
                        // NUOVO: Chiudi dettaglio playlist
                        case 'close-playlist-detail':
                            document.querySelectorAll('.playlist-detail-page').forEach(p => p.remove());
                            const videoCatalog = document.getElementById('video-catalog-modal');
                            if (videoCatalog) videoCatalog.style.display = 'block';
                            activePlaylistId = null;
                            playlistSelectionMode = false;
                            selectedPlaylistVideos.clear();
                            break;
                        // NUOVO: Chiudi modali playlist (per modifica, aggiungi, crea)
                        case 'close-playlist-modal':
                            document.querySelectorAll('.playlist-modal').forEach(m => m.remove());
                            break;
                        // NUOVO: Chiudi modale categorie
                        case 'close-category-modal':
                            closeCategoryModal();
                            break;
                        // NUOVO: Applica filtro categorie
                        case 'apply-category-filter':
                            applyCategoryFilter();
                            break;
                        // NUOVO: Toggle selezione multipla playlist
                        case 'toggle-playlist-selection-mode':
                            togglePlaylistSelectionMode();
                            break;
                        // NUOVO: Toggle selezione video in playlist
                        case 'toggle-playlist-video-selection':
                            event.stopPropagation();
                            const playlistVideoId = actionTarget.dataset.videoId;
                            if (playlistVideoId) togglePlaylistVideoSelection(playlistVideoId);
                            break;
                        // NUOVO: Rimuovi video selezionati dalla playlist
                        case 'remove-selected-from-playlist':
                            removeSelectedFromPlaylist();
                            break;
                        // NUOVO: Annulla selezione playlist
                        case 'cancel-playlist-selection':
                            playlistSelectionMode = false;
                            selectedPlaylistVideos.clear();
                            renderPlaylistDetailPage(activePlaylistId);
                            break;
                        // NUOVO: Cambia copertina playlist
                        case 'change-playlist-cover':
                            event.stopPropagation();
                            const coverPlaylistId = actionTarget.dataset.playlistId;
                            if (coverPlaylistId) changePlaylistCover(coverPlaylistId);
                            break;
                        // NUOVO: Conferma copertina playlist
                        case 'confirm-playlist-cover':
                            const confirmPlaylistId = actionTarget.dataset.playlistId;
                            const imageData = actionTarget.dataset.image;
                            if (confirmPlaylistId && imageData) confirmPlaylistCover(confirmPlaylistId, imageData);
                            break;
                        // MODIFICA: Cambio visualizzazione video (lista/griglia)
                        case 'set-video-view-mode':
                            const videoMode = actionTarget.dataset.mode;
                            if (videoMode && videoMode !== window.currentVideoViewMode) {
                                localStorage.setItem('videoViewMode', videoMode);
                                window.currentVideoViewMode = videoMode;
                                // Ricarica il tab corrente con la nuova visualizzazione
                                const activeNavBtn = document.querySelector('.cinema-nav-btn.active');
                                if (activeNavBtn) {
                                    const currentTab = activeNavBtn.dataset.tab;
                                    handleCinemaTabChange(currentTab);
                                }
                            }
                            break;
                        // NUOVO: Gestisce il filtro "Tutti"
                        case 'set-filter-mode':
                            const filterMode = actionTarget.dataset.mode;
                            if (filterMode) {
                                localStorage.setItem('video-filter-mode', filterMode);
                                // Ricarica il tab corrente con il nuovo filtro
                                const activeNavBtn = document.querySelector('.cinema-nav-btn.active');
                                if (activeNavBtn) {
                                    const currentTab = activeNavBtn.dataset.tab;
                                    handleCinemaTabChange(currentTab);
                                }
                            }
                            break;
                        // NUOVO: Apre il modale di selezione categorie
                        case 'open-category-modal':
                            openCategoryModal();
                            break;
                        // NUOVO: Pulisce tutti i filtri AI
                        case 'clear-ai-filters':
                            localStorage.setItem('ai-selected-categories', '[]');
                            localStorage.setItem('ai-selected-pricing', '[]');
                            // Ricarica la vista explore
                            currentView = 'explore';
                            exploreFilter = {};
                            renderView();
                            break;
                        // NUOVO: Apre il modale di selezione categorie AI
                        case 'open-ai-category-modal':
                            openAICategoryModal();
                            break;
                        // NUOVO: Chiudi modale categorie AI
                        case 'close-ai-category-modal':
                            closeAICategoryModal();
                            break;
                        // NUOVO: Applica filtro categorie AI
                        case 'apply-ai-category-filter':
                            applyAICategoryFilter();
                            break;
                        // NUOVO: Apre il modale di selezione prezzi AI
                        case 'open-ai-pricing-modal':
                            openAIPricingModal();
                            break;
                        // NUOVO: Chiudi modale prezzi AI
                        case 'close-ai-pricing-modal':
                            closeAIPricingModal();
                            break;
                        // NUOVO: Applica filtro prezzi AI
                        case 'apply-ai-pricing-filter':
                            applyAIPricingFilter();
                            break;
                        // NUOVO: Gestisce il click sull'icona della password
                        case 'toggle-password-visibility':
                            handlePasswordVisibilityToggle(actionTarget);
                            break;
                        // NUOVO: Gestisce i filtri della Libreria
                        case 'set-library-tab':
                            const tab = actionTarget.dataset.tab;
                            if (tab && tab !== libraryTab) {
                                libraryTab = tab;
                                renderView(); // Un re-render completo è il modo più semplice per aggiornare tutto
                            }
                            break;
                        // NUOVO: Gestisce i tab della pagina Cinema
                        case 'set-cinema-tab':
                            const cinemaTab = actionTarget.dataset.tab;
                            handleCinemaTabChange(cinemaTab);
                            break;
                        // NUOVO: Gestisce il cambio di visualizzazione (lista/griglia)
                        case 'set-view-mode':
                            const mode = actionTarget.dataset.mode;
                            if (mode && mode !== libraryViewMode) {
                                libraryViewMode = mode;
                                localStorage.setItem('libraryViewMode', mode);
                                renderView();
                            }
                            break;
                        // NUOVO: Crea nuova collezione
                        case 'create-collection':
                            openCreateCollectionModal();
                            break;
                        // NUOVO: Apri menu contestuale collezione
                        case 'open-collection-menu':
                            event.stopPropagation();
                            const collectionId = actionTarget.dataset.collectionId;
                            openCollectionContextMenu(collectionId, actionTarget);
                            break;
                        // NUOVO: Aggiungi a collezione
                        case 'add-to-collection':
                            const addToolId = actionTarget.dataset.toolId;
                            openAddToCollectionModal(addToolId);
                            break;
                        // RIMOSSO: add-tools-to-collection e add-videos-to-playlist
                        // RIMOSSO: toggle-tool-selection-for-add e toggle-video-selection-for-add
                        // RIMOSSO: Tutti i gestori per i modali di aggiunta AI/Video
                        // RIMOSSO: confirm-add-multiple-tools e confirm-add-multiple-videos
                        case 'close-add-to-collection-modal':
                            // Mostra messaggio di conferma solo se ci sono collezioni
                            if (collections.length > 0) {
                                showToast(currentLanguage === 'it' ? 'Modifiche salvate!' : 'Changes saved!');
                            }
                            // NUOVO: Aggiorna il pulsante quando si chiude il modal
                            if (currentToolIdInModal) {
                                updateAddToCollectionButton(currentToolIdInModal);
                            }
                            closeAddToCollectionModal();
                            break;
                        case 'toggle-tool-in-collection':
                            const collId = actionTarget.dataset.collectionId;
                            const tId = actionTarget.dataset.toolId;
                            await toggleToolInCollection(collId, tId);
                            break;
                        case 'create-collection-from-modal':
                            // Chiude il modale "Aggiungi a" prima di aprirne un altro
                            closeAddToCollectionModal();
                            openCreateCollectionModal();
                            break;
                        case 'rename-collection':
                            handleRenameCollection(actionTarget.dataset.collectionId);
                            break;
                        case 'change-collection-cover':
                            handleChangeCollectionCover(actionTarget.dataset.collectionId);
                            break;
                        case 'delete-collection':
                            handleDeleteCollection(actionTarget.dataset.collectionId);
                            break;
                        case 'back-to-collections':
                            activeCollectionId = null;
                            selectionMode = false;
                            selectedTools.clear();
                            renderView();
                            updateBottomNavFAB('collections'); // Aggiorna il FAB per tornare a creare collezione
                            break;
                        // NUOVO: Gestione selezione multipla
                        case 'toggle-selection-mode':
                            toggleSelectionMode();
                            break;
                        case 'toggle-tool-selection':
                            const toolIdToToggle = actionTarget.dataset.toolId || actionTarget.dataset.id;
                            if (exploreMultiSelectMode) {
                                // Modalità selezione multipla per explore
                                const index = exploreSelectedTools.indexOf(toolIdToToggle);
                                if (index > -1) {
                                    exploreSelectedTools.splice(index, 1);
                                } else {
                                    exploreSelectedTools.push(toolIdToToggle);
                                }
                                updateMultiSelectUI();
                            } else if (typeof toggleToolSelection === 'function') {
                                // Modalità selezione per collezioni (esistente)
                                toggleToolSelection(toolIdToToggle);
                            }
                            break;
                        case 'remove-selected-from-collection':
                            removeSelectedFromCollection();
                            break;
                        case 'cancel-selection':
                            selectionMode = false;
                            selectedTools.clear();
                            renderView();
                            break;
                        case 'remove-from-collection':
                            if (activeCollectionId) {
                                const removed = await removeToolFromCollection(activeCollectionId, actionTarget.dataset.id);
                                if (removed) {
                                    renderView();
                                }
                            }
                            break;
                        case 'submit-create-collection':
                            const nameInput = document.getElementById('new-collection-name');
                            if (nameInput) {
                                const collectionName = nameInput.value.trim();
                                if (collectionName) {
                                    createCollection(collectionName);
                                    showToast(translations[currentLanguage].collectionCreated);
                                    closeModal();
                                    renderView();
                                }
                            }
                            break;
                        case 'submit-rename-collection':
                            const collectionIdToRename = actionTarget.dataset.collectionId;
                            const renameInput = document.getElementById('rename-collection-name');
                            if (renameInput && collectionIdToRename) {
                                const newName = renameInput.value.trim();
                                const collection = getCollectionById(collectionIdToRename);
                                if (collection && newName && newName !== collection.name) {
                                    renameCollection(collectionIdToRename, newName);
                                    showToast(translations[currentLanguage].collectionRenamed);
                                    closeModal();
                                    renderView();
                                } else {
                                    closeModal(); // Chiude il modale anche se non ci sono modifiche
                                }
                            }
                            break;
                        // Global Controls
                        case 'toggle-theme':
                            // Cambia il tema
                            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                            document.body.classList.toggle('light-mode', currentTheme === 'light');
                            localStorage.setItem('koda-theme', currentTheme);

                            // Aggiorna l'icona del tema manually senza ri-renderizzare tutto
                            const themeBtn = document.getElementById('theme-toggle-btn');
                            if (themeBtn) {
                                themeBtn.innerHTML = currentTheme === 'dark' ? sunIcon : moonIcon;
                            }

                            // Aggiorna l'immagine del profilo in base al tema
                            const isGuest = !currentUser.uid;
                            if (isGuest) {
                                const avatarImageUrl = currentTheme === 'light'
                                    ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                                    : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';
                                const avatarImages = document.querySelectorAll('.user-avatar img, .user-profile-avatar img');
                                avatarImages.forEach(img => {
                                    img.src = avatarImageUrl;
                                });
                            }

                            // Aggiorna i loghi delle collezioni e playlist
                            const newLogoUrl = currentTheme === 'light'
                                ? 'https://i.postimg.cc/15Fy64s4/LOGO-KODA.png'
                                : 'https://i.postimg.cc/d03sh61v/LOGO-KODA-Copia-1.png';

                            // Aggiorna tutte le immagini con alt="Koda Logo"
                            const logoImages = document.querySelectorAll('img[alt="Koda Logo"]');
                            logoImages.forEach(img => {
                                img.src = newLogoUrl;
                            });

                            break;
                        case 'toggle-lang':
                            // Cambia la lingua a livello globale
                            currentLanguage = currentLanguage === 'it' ? 'en' : 'it';
                            localStorage.setItem('koda-lang', currentLanguage);
                            localStorage.setItem('language', currentLanguage);

                            // Aggiorna il testo del pulsante stesso
                            const langBtn = document.getElementById('lang-toggle-btn');
                            if (langBtn) {
                                langBtn.textContent = currentLanguage.toUpperCase();
                            }

                            // Applica le traduzioni agli elementi HTML non gestiti da React
                            applyTranslations(currentLanguage);

                            // Dispatch event for privacy modal
                            window.dispatchEvent(new Event('languageChanged'));

                            // **NUOVA LOGICA:** Se siamo nella vista chat e la funzione-ponte esiste,
                            // la usiamo per aggiornare lo stato interno di React senza ricaricare.
                            if (currentView === 'user-chats' && typeof window.updateUserChatLanguage === 'function') {
                                window.updateUserChatLanguage(currentLanguage);
                            } else if (currentView === 'cinema') {
                                // NUOVO: Se siamo nel cinema, aggiorna la nav e il contenuto mantenendo il tab attivo
                                const activeTab = document.querySelector('.cinema-nav-btn.active');
                                const currentTab = activeTab ? activeTab.dataset.tab : 'videos';

                                // Aggiorna la bottom nav con le nuove traduzioni
                                createOrUpdateCinemaNav();

                                // Aggiorna il contenuto
                                renderView();

                                // Ripristina il tab attivo dopo il render
                                setTimeout(() => {
                                    handleCinemaTabChange(currentTab, false);
                                }, 100);
                            } else if (currentView === 'video-detail') {
                                // NUOVO: Se siamo nella pagina video-detail, aggiorna il contenuto
                                renderView();
                            } else {
                                // Altrimenti, per tutte le altre pagine, eseguiamo un re-render completo
                                renderView();
                            }
                            break;
                        case 'toggle-menu':
                            toggleSideMenu(true);
                            break;
                        case 'open-settings-modal':
                            if (!currentUser.uid) { triggerAuthFlow(); } else { window.openSettingsModal(); }
                            break;
                        case 'logout':
                            // NUOVO: Imposta lo stato offline prima del logout
                            if (currentUser && currentUser.uid) {
                                updateUserOnlineStatus(currentUser.uid, false);
                            }

                            // NUOVO: Rimuovi i listener di stato
                            if (window.userStatusListeners) {
                                document.removeEventListener('visibilitychange', window.userStatusListeners.visibilitychange);
                                window.removeEventListener('focus', window.userStatusListeners.focus);
                                window.removeEventListener('blur', window.userStatusListeners.blur);
                                window.userStatusListeners = null;
                            }

                            // NUOVO: Pulisci l'interval dello stato online
                            if (window.onlineStatusInterval) {
                                clearInterval(window.onlineStatusInterval);
                                window.onlineStatusInterval = null;
                            }

                            signOut(auth).catch(error => console.error("Logout Error:", error));
                            break; // Rimuovi il logout dal global controls

                        // Side Menu
                        case 'new-chat': startNewChat(); break;
                        case 'delete-all-chats':
                            openConfirmDeleteAllModal(); // Ora apre il modale personalizzato
                            break;
                        case 'confirm-delete-all-chats': // NUOVA AZIONE
                            conversations = {};
                            localStorage.removeItem(getStorageKey());
                            localStorage.removeItem(`activeConversationId_${currentUser.uid || 'guest'}`);
                            startNewChat(true); // Esegue la cancellazione
                            closeModal(); // Chiude il modale di conferma
                            break;
                        case 'select-conversation':
                            const newActiveId = actionTarget.dataset.id;
                            if (newActiveId !== activeConversationId) {
                                activeConversationId = newActiveId;
                                saveActiveConversationId();
                                renderView(); // Re-render with the selected conversation
                            }
                            toggleSideMenu(false); // Close menu
                            break;

                        // Auth Prompts (from Library page)
                        case 'prompt-login': triggerAuthFlow('login-card'); break;
                        case 'prompt-register': triggerAuthFlow('register-card'); break;

                        // Explore/Top AI Filters
                        case 'back-to-explore':
                            exploreFilter = { type: null, value: null };
                            exploreMultiSelectMode = false;
                            exploreSelectedTools = [];
                            renderView();
                            break;
                        case 'set-explore-filter':
                            exploreFilter.type = actionTarget.dataset.filterType;
                            exploreFilter.value = actionTarget.dataset.filterValue;
                            exploreMultiSelectMode = false;
                            exploreSelectedTools = [];
                            // Aggiungi alla cronologia del browser
                            history.pushState({
                                page: currentView,
                                exploreFilter: { ...exploreFilter }
                            }, '', `#explore-${exploreFilter.type}-${exploreFilter.value}`);
                            renderView();
                            break;
                        case 'toggle-multi-select':
                            exploreMultiSelectMode = !exploreMultiSelectMode;
                            exploreSelectedTools = [];
                            updateMultiSelectUI();
                            break;
                        case 'cancel-multi-select':
                            exploreMultiSelectMode = false;
                            exploreSelectedTools = [];
                            updateMultiSelectUI();
                            break;
                        case 'multi-select-favorites':
                            addSelectedToFavorites();
                            break;
                        case 'multi-select-collection':
                            openCollectionSelectorForMultiSelect();
                            break;
                        case 'set-ranking-filter':
                            rankingFilter = actionTarget.dataset.filter;
                            // Aggiungi alla cronologia del browser
                            history.pushState({
                                page: currentView,
                                rankingFilter: rankingFilter
                            }, '', `#ranking-${rankingFilter}`);
                            renderView(); // Re-render to apply ranking filter
                            break;
                        case 'set-favorite-filter':
                            activeFilter = actionTarget.dataset.filter;
                            // Aggiungi alla cronologia del browser
                            history.pushState({
                                page: currentView,
                                activeFilter: activeFilter
                            }, '', `#library-${activeFilter}`);
                            renderView(); // Re-render to apply favorite filter
                            break;

                        case 'navigate':
                            const page = actionTarget.dataset.page;
                            if (page && page !== currentView) {
                                currentView = page;
                                renderView();
                            }
                            break;
                        // Modals (Detail, Settings, Add App, Replace Featured)
                        case 'close-modal': closeModal(); break;
                        // NUOVO: Gestione recensioni
                        case 'add-review': openReviewModal(actionTarget.dataset.toolId); break;
                        case 'close-review-modal': closeReviewModal(); break;
                        case 'submit-review': submitReview(); break;
                        case 'open-detail-modal': // For recommendation box in detail modal
                            window.openDetailModal(actionTarget.dataset.id);
                            break;
                        case 'open-add-app-modal':
                            // Ora qualsiasi utente (loggato o ospite) può aprire il modale.
                            openAddAppModal();
                            break;
                        case 'open-edit-app-modal':
                            if (currentUser.uid) {
                                openEditAppModal(actionTarget.dataset.id);
                            } else {
                                triggerAuthFlow();
                            }
                            break;
                        case 'remove-guest-tool':
                            removeGuestTool(actionTarget.dataset.id);
                            break;
                        case 'toggle-user-featured': // Triggered by pencil on user featured apps in Library
                            // Allow any logged-in user to perform this action
                            if (currentUser.uid) {
                                toggleUserFeatured(actionTarget.dataset.id);
                            } else {
                                triggerAuthFlow();
                            }
                            break;
                        case 'replace-featured-static': // Triggered by pencil on static featured apps in Top AI
                            // Allow any logged-in user to perform this action
                            if (currentUser.uid) {
                                openReplaceFeaturedModal(actionTarget.dataset.id);
                            } else {
                                triggerAuthFlow();
                            }
                            break;
                        case 'select-user-tool-for-featured': // Triggered by clicking a user app in the replace modal
                            // Allow any logged-in user to perform this action
                            if (currentUser.uid) {
                                replaceFeaturedStatic(actionTarget.dataset.staticId, actionTarget.dataset.userId);
                            } else {
                                triggerAuthFlow();
                            }
                            break;
                        case 'remove-user-tool': // Triggered by pencil on user apps in the main Library list
                            // Allow any logged-in user to perform this action
                            if (currentUser.uid) {
                                removeUserTool(actionTarget.dataset.id);
                            } else {
                                triggerAuthFlow();
                            }
                            break;
                        case 'add-ai-suggestion': // Triggered by add AI suggestion button
                            console.log('add-ai-suggestion action triggered');
                            if (currentUser.uid) {
                                console.log('User logged in, calling addAiSuggestion');
                                window.addAiSuggestion();
                            } else {
                                console.log('No user logged in, triggering auth flow');
                                triggerAuthFlow();
                            }
                            break;
                        case 'remove-ai-suggestion': // Triggered by remove AI suggestion button
                            if (currentUser.uid) {
                                removeAiSuggestion(actionTarget.dataset.id);
                            } else {
                                triggerAuthFlow();
                            }
                            break;
                        case 'search-users': // Triggered by search users button
                            if (currentUser.uid) {
                                searchUsers();
                            } else {
                                triggerAuthFlow();
                            }
                            break;
                        case 'view-user-suggestions': // Triggered by view suggestions button
                            if (currentUser.uid) {
                                viewUserSuggestions(actionTarget.dataset.uid, actionTarget.dataset.nickname);
                            } else {
                                triggerAuthFlow();
                            }
                            break;
                        case 'start-user-chat': // Triggered by start chat button
                            if (currentUser.uid) {
                                startUserChat(actionTarget.dataset.uid, actionTarget.dataset.nickname);
                            } else {
                                triggerAuthFlow();
                            }
                            break;


                        // Auth Overlay actions are handled by attachAuthListeners on the overlay itself
                        case 'close-auth': // Handled by attachAuthListeners
                        case 'show-login': // Handled by attachAuthListeners
                        case 'show-register': // Handled by attachAuthListeners
                        case 'show-forgot': // Handled by attachAuthListeners
                            // Let the specific auth overlay listener handle these
                            return;
                        case 'profile-avatar-click':
                            if (currentUser.uid) {
                                toggleUserProfileDropdown();
                            }
                            break;
                        case 'open-settings':
                            closeUserProfileDropdown();
                            window.openSettingsModal();
                            break;
                        case 'change-nickname':
                            closeUserProfileDropdown();
                            openChangeNicknameModal();
                            break;
                        case 'change-password':
                            closeUserProfileDropdown();
                            openChangePasswordModal();
                            break;
                        case 'view-sent-reviews':
                            closeUserProfileDropdown();
                            openSentReviewsModal();
                            break;
                        case 'view-all-user-reviews':
                            const reviewToolId = actionTarget.dataset.toolId;
                            if (reviewToolId) {
                                openAllUserReviewsModal(reviewToolId);
                            }
                            break;
                        case 'edit-review':
                            const editToolId = actionTarget.dataset.toolId;
                            const editReviewId = actionTarget.dataset.reviewId;
                            if (editToolId && editReviewId) {
                                openEditReviewModal(editToolId, editReviewId);
                            }
                            break;
                        case 'delete-review':
                            const deleteToolId = actionTarget.dataset.toolId;
                            const deleteReviewId = actionTarget.dataset.reviewId;
                            if (deleteToolId && deleteReviewId) {
                                confirmDeleteReview(deleteToolId, deleteReviewId);
                            }
                            break;
                        case 'logout':
                            closeUserProfileDropdown();
                            handleLogout(); // Usa la nuova funzione centralizzata
                            break;
                    }
                    // Prevent default for any element with data-action
                    e.preventDefault();
                    return; // Stop processing after handling a data-action
                }

                // 4. Handle clicks on collection cards
                const collectionCard = target.closest('.collection-card');
                if (collectionCard && !target.closest('.collection-menu-btn')) {
                    const collectionId = collectionCard.dataset.collectionId;
                    openCollectionDetail(collectionId);
                    return;
                }

                // 5. Handle clicks on tool/ranking cards (excluding favorite icon and edit icon which have data-actions)
                const toolCard = target.closest('.tool-card-grid, .tool-card-list, .ranking-item, .tool-item-horizontal, .tool-shelf-item');
                if (toolCard && !target.closest('.favorite-icon') && !target.closest('.edit-icon') && !target.closest('.select-checkbox')) {
                    // Se siamo in modalità multi-select, seleziona/deseleziona invece di aprire il modale
                    if (exploreMultiSelectMode && toolCard.classList.contains('tool-card-list')) {
                        const toolId = toolCard.dataset.id;
                        const index = exploreSelectedTools.indexOf(toolId);
                        if (index > -1) {
                            exploreSelectedTools.splice(index, 1);
                        } else {
                            exploreSelectedTools.push(toolId);
                        }
                        updateMultiSelectUI();
                    } else {
                        window.openDetailModal(toolCard.dataset.id);
                    }
                    return;
                }

                // 5. Handle clicks outside side menu/modals to close them
                if (target.id === 'side-menu-overlay') { toggleSideMenu(false); return; }
                if (target.matches('.modal-overlay')) { closeModal(); return; }

                // 6. Close user profile dropdown when clicking outside
                closeUserProfileDropdown();

                // If none of the above were clicked, let the default behavior happen
            });

            // NUOVO: Event listeners per le stelle del rating
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('star-input')) {
                    const rating = parseInt(e.target.dataset.rating);
                    // Check if we're in edit mode
                    if (document.getElementById('edit-review-modal')) {
                        window.currentEditRating = rating;
                        const starsInput = document.querySelectorAll('.star-input');
                        starsInput.forEach((star, index) => {
                            star.classList.toggle('active', index < rating);
                        });
                    } else {
                        setRating(rating);
                    }
                }
            });

            // NUOVO: Event listener per chiudere il modal delle recensioni cliccando fuori
            document.addEventListener('click', (e) => {
                const reviewModal = document.getElementById('review-modal');
                if (e.target === reviewModal) {
                    closeReviewModal();
                }
            });

            const getExploreFeedHTML = () => {
                const t = translations[currentLanguage];
                const toolsByCategory = {};
                const allTools = getAllToolsForCurrentUser();
                allTools.forEach(tool => {
                    const category = tool.category;
                    if (!toolsByCategory[category]) {
                        toolsByCategory[category] = [];
                    }
                    toolsByCategory[category].push(tool);
                });

                let feedHTML = '';
                categories.forEach(category => {
                    const categoryId = category.id;
                    const categoryName = getTranslatedCategoryName(categoryId);
                    const tools = toolsByCategory[categoryId] || [];

                    if (tools.length > 0) {
                        const seeAllText = (t && t.browseAll) ? t.browseAll : 'Vedi tutti';
                        feedHTML += `
                        <div class="feed-section">
                            <div class="feed-section-header">
                                <h2 class="feed-section-title">${categoryName}</h2>
                                <button class="see-all-btn" data-action="set-explore-filter" data-filter-type="category" data-filter-value="${categoryId}">
                                    ${seeAllText} >
                                </button>
                            </div>
                            <div class="horizontal-scroll-container">
                                ${tools.map(tool => `
                                    <div class="tool-item-horizontal stagger-item" data-id="${tool.id}">
                                        <div class="tool-item-logo-container">
                                            <img src="${tool.logoUrl}" class="tool-logo" alt="${tool.name}" loading="lazy">
                                        </div>
                                        <div class="tool-item-name">${tool.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    }
                });
                return feedHTML;
            };

            // --- SEARCH INPUT LISTENER ---
            el.mainContent.addEventListener('input', e => {
                if (e.target.id === 'search-input') {
                    const searchTerm = e.target.value.toLowerCase();
                    const contentArea = document.getElementById('content-area');
                    if (!contentArea) return;

                    const allTools = getAllToolsForCurrentUser(); // Search across all tools
                    const t = translations[currentLanguage];

                    if (searchTerm.length > 1) {
                        const toolsToShow = allTools.filter(tool =>
                            tool.name.toLowerCase().includes(searchTerm) ||
                            (typeof tool.description === 'string' ? tool.description.toLowerCase().includes(searchTerm) : (typeof tool.description === 'object' ? (tool.description[currentLanguage] || tool.description['en'] || '').toLowerCase().includes(searchTerm) : false))
                        );

                        // Pass context 'explore' to createListCard for search results
                        contentArea.innerHTML = toolsToShow.length > 0 ? `<div class="list-container">${toolsToShow.map(tool => createListCard(tool, 'explore')).join('')}</div>` : `<div id="empty-state">${t.noResultsFor} "${searchTerm}"</div>`;
                    } else {
                        // If search term is cleared, restore the original feed view WITHOUT a full re-render
                        contentArea.innerHTML = getExploreFeedHTML();
                    }
                    applyTranslations(currentLanguage); // Apply translations to search results/empty state
                }
            });

            // Add event listener for user search input
            el.mainContent.addEventListener('input', e => {
                if (e.target.id === 'user-search-input') {
                    const searchTerm = e.target.value.trim();
                    const searchResults = document.getElementById('user-search-results');
                    if (!searchResults) return;

                    // Clear previous timeout
                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }

                    if (searchTerm.length > 1) {
                        // Debounce search to avoid too many Firebase calls
                        searchTimeout = setTimeout(() => {
                            searchUsersByTerm(searchTerm);
                        }, 300);
                    } else {
                        searchResults.innerHTML = '';
                    }
                }
            });

            // --- FIREBASE AUTH STATE CHANGE LISTENER ---
            onAuthStateChanged(auth, async (user) => { // Aggiungi "async" qui
                // AUTOMATIC SILENT LOGOUT: Force logout any authenticated user
                if (user) {
                    console.log("Auto-logout: Signing out user silently...");
                    try {
                        await signOut(auth);
                        // Clear any user-related data from localStorage
                        localStorage.removeItem('currentUser');
                        console.log("Auto-logout: User signed out successfully");
                        return; // Exit early, the listener will be triggered again with user = null
                    } catch (error) {
                        console.error("Auto-logout error:", error);
                    }
                }

                // --- INSERT THIS CODE ---
                // Check the URL hash to set the initial view
                const initialHash = window.location.hash.substring(1); // e.g., 'explore' from '#explore'
                const validPages = ['home', 'top-ai', 'explore', 'user-chats', 'favorites', 'cinema']; // Add any other valid page keys here

                if (initialHash && validPages.includes(initialHash)) {
                    currentView = initialHash;
                } else {
                    // Default to home view if hash is missing or invalid
                    currentView = 'home';
                    // Use replaceState to set the initial history entry without creating a new one
                    history.replaceState({ page: 'home' }, '', '#home');
                }
                // --- END OF INSERTION ---
                // Carica tutti i dati da Firestore PRIMA di inizializzare l'app
                [aiToolsData, aiRankingsData, youtubeVideosData] = await Promise.all([
                    fetchToolsFromFirestore(),
                    fetchRankingsFromFirestore(),
                    fetchVideosFromFirestore()
                ]);

                // Aggiorna il badge di notifica del Cinema dopo aver caricato i video
                setTimeout(() => updateCinemaNotificationBadge(), 100);

                // Rimuovi la playlist predefinita "Guarda più tardi" se esiste nel localStorage
                const removeDefaultPlaylist = () => {
                    let playlists = JSON.parse(localStorage.getItem('video-playlists') || '[]');
                    const filteredPlaylists = playlists.filter(p => p.id !== 'default-guarda-piu-tardi');
                    if (filteredPlaylists.length !== playlists.length) {
                        localStorage.setItem('video-playlists', JSON.stringify(filteredPlaylists));
                        console.log('Playlist predefinita "Guarda più tardi" rimossa dal localStorage');
                    }
                };
                removeDefaultPlaylist();

                if (user) {
                    // L'utente è loggato, avvia l'app con i suoi dati.
                    console.log("User is logged in:", user.uid);
                    initializeAppWithUser(user); // Funzione già esistente, la usiamo qui

                    // NUOVO: Imposta lo stato online quando l'utente si autentica
                    updateUserOnlineStatus(user.uid, true);

                    // NUOVO: Aggiungi listener per la visibilità della pagina e focus della finestra
                    const handleVisibilityChange = () => {
                        if (document.visibilityState === 'visible') {
                            updateUserOnlineStatus(user.uid, true);
                        }
                    };

                    const handleWindowFocus = () => {
                        updateUserOnlineStatus(user.uid, true);
                    };

                    const handleWindowBlur = () => {
                        // Non impostare subito offline, aspetta un po' per evitare falsi positivi
                        setTimeout(() => {
                            if (document.visibilityState === 'hidden') {
                                updateUserOnlineStatus(user.uid, false);
                            }
                        }, 30000); // 30 secondi di delay
                    };

                    // Aggiungi gli event listener
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                    window.addEventListener('focus', handleWindowFocus);
                    window.addEventListener('blur', handleWindowBlur);

                    // Salva i listener per poterli rimuovere al logout
                    window.userStatusListeners = {
                        visibilitychange: handleVisibilityChange,
                        focus: handleWindowFocus,
                        blur: handleWindowBlur
                    };

                    // NUOVO: Aggiorna lo stato online ogni 30 secondi quando l'utente è attivo
                    window.onlineStatusInterval = setInterval(() => {
                        if (document.visibilityState === 'visible') {
                            updateUserOnlineStatus(user.uid, true);
                        }
                    }, 30000); // 30 secondi - più responsivo

                } else {
                    // L'utente non è loggato (o ha fatto logout), avvia l'app in modalità ospite.
                    console.log("User is a guest or logged out.");

                    // NUOVO: Rimuovi i listener di stato se esistono
                    if (window.userStatusListeners) {
                        document.removeEventListener('visibilitychange', window.userStatusListeners.visibilitychange);
                        window.removeEventListener('focus', window.userStatusListeners.focus);
                        window.removeEventListener('blur', window.userStatusListeners.blur);
                        window.userStatusListeners = null;
                    }

                    // NUOVO: Pulisci l'interval dello stato online
                    if (window.onlineStatusInterval) {
                        clearInterval(window.onlineStatusInterval);
                        window.onlineStatusInterval = null;
                    }

                    initializeAppForGuest();
                }
            });
        });
    </script>

    <!-- Modal recensioni rimosso -->

    <!-- Privacy Modal -->
    <div class="privacy-modal" id="privacy-modal">
        <div class="privacy-modal-content">
            <div class="privacy-modal-header">
                <h2 class="privacy-modal-title" id="privacy-modal-title-text"></h2>
                <button class="privacy-modal-close" id="privacy-modal-close">×</button>
            </div>
            <div class="privacy-modal-body" id="privacy-modal-body-content">
            </div>
        </div>
    </div>

    <!-- Privacy Reminder Modal -->
    <div class="privacy-reminder-modal" id="privacy-reminder-modal">
        <div class="privacy-reminder-content">
            <div class="privacy-reminder-icon">🔒</div>
            <h2 class="privacy-reminder-title" id="privacy-reminder-title-text"></h2>
            <p class="privacy-reminder-message" id="privacy-reminder-message-text"></p>
            <div class="privacy-reminder-checkbox">
                <input type="checkbox" id="dont-show-again-checkbox">
                <label for="dont-show-again-checkbox" id="privacy-reminder-checkbox-label"></label>
            </div>
            <div class="privacy-reminder-actions">
                <button class="privacy-read-btn" id="privacy-read-btn"></button>
                <button class="privacy-continue-btn" id="privacy-continue-btn"></button>
            </div>
        </div>
    </div>

    <script>
        // Privacy Modal Functions
        (function () {
            const privacyModal = document.getElementById('privacy-modal');
            const privacyReminderModal = document.getElementById('privacy-reminder-modal');
            const privacyModalClose = document.getElementById('privacy-modal-close');
            const dontShowAgainCheckbox = document.getElementById('dont-show-again-checkbox');
            const privacyReadBtn = document.getElementById('privacy-read-btn');
            const privacyContinueBtn = document.getElementById('privacy-continue-btn');

            // Function to update privacy modal content with current language
            function updatePrivacyModalContent() {
                // Get current language from localStorage or default to 'it'
                const currentLang = localStorage.getItem('language') || 'it';
                const t = window.translations ? window.translations[currentLang] : null;

                if (!t) return;

                // Update modal title
                document.getElementById('privacy-modal-title-text').textContent = t.privacyPolicyTitle;

                // Update modal body content
                const bodyContent = `
                    <h3>${t.privacySubtitle}</h3>
                    <p><strong>${t.privacyLastUpdate}</strong></p>
                    <p>${t.privacyIntro}</p>
                    
                    <h3>${t.privacyDataControllerTitle}</h3>
                    <p><strong>${t.privacyDataController}</strong><br>
                    ${t.privacyContactEmail}</p>
                    
                    <h3>${t.privacyDataTypesTitle}</h3>
                    <p>${t.privacyDataTypesIntro}</p>
                    <p>${t.privacyDataTypesNote}</p>
                    <p><strong>${t.privacyNavigationData}</strong> ${t.privacyNavigationDataDesc}</p>
                    <p><strong>${t.privacyUserData}</strong> ${t.privacyUserDataDesc}</p>
                    
                    <h3>${t.privacyLocalStorageTitle}</h3>
                    <p>${t.privacyLocalStorageIntro}</p>
                    <p><strong>${t.privacyLocalStorageWhatTitle}</strong></p>
                    <p>${t.privacyLocalStoragePreferences}<br>
                    ${t.privacyLocalStorageHistory}<br>
                    ${t.privacyLocalStorageCollections}<br>
                    ${t.privacyLocalStorageState}</p>
                    <p><strong>${t.privacyLocalStorageImportantTitle}</strong></p>
                    <p>${t.privacyLocalStoragePoint1}<br>
                    ${t.privacyLocalStoragePoint2}<br>
                    ${t.privacyLocalStoragePoint3}<br>
                    ${t.privacyLocalStoragePoint4}</p>
                    
                    <h3>${t.privacyPurposeTitle}</h3>
                    <p>${t.privacyPurposeDesc}</p>
                    <p>${t.privacyPurposeNote}</p>
                    
                    <h3>${t.privacyThirdPartiesTitle}</h3>
                    <p>${t.privacyThirdPartiesIntro}</p>
                    <p><strong>${t.privacyThirdPartiesGoogle}</strong><br>
                    ${t.privacyThirdPartiesGoogleDesc}<br>
                    ${t.privacyThirdPartiesLocation}</p>
                    
                    <h3>${t.privacyRightsTitle}</h3>
                    <p>${t.privacyRightsIntro}</p>
                    <p>${t.privacyRightsList.replace(/\n/g, '<br>')}</p>
                    <p>${t.privacyRightsNote}</p>
                    
                    <h3>${t.privacyChangesTitle}</h3>
                    <p>${t.privacyChangesDesc}</p>
                `;
                document.getElementById('privacy-modal-body-content').innerHTML = bodyContent;

                // Update reminder modal
                document.getElementById('privacy-reminder-title-text').textContent = t.privacyReminderTitle;
                document.getElementById('privacy-reminder-message-text').textContent = t.privacyReminderMessage;
                document.getElementById('privacy-reminder-checkbox-label').textContent = t.privacyReminderDontShow;
                privacyReadBtn.textContent = t.privacyReminderReadBtn;
                privacyContinueBtn.textContent = t.privacyReminderContinueBtn;
            }

            // Function to show privacy modal
            function showPrivacyModal() {
                updatePrivacyModalContent();
                privacyModal.classList.add('visible');
            }

            // Function to hide privacy modal
            function hidePrivacyModal() {
                privacyModal.classList.remove('visible');
            }

            // Function to show privacy reminder
            function showPrivacyReminder() {
                updatePrivacyModalContent();
                privacyReminderModal.classList.add('visible');
            }

            // Function to hide privacy reminder
            function hidePrivacyReminder() {
                privacyReminderModal.classList.remove('visible');
            }

            // Check if user has seen the privacy reminder
            function checkPrivacyReminder() {
                const hasSeenReminder = localStorage.getItem('privacyReminderSeen');
                if (!hasSeenReminder) {
                    // Show reminder after a short delay
                    setTimeout(() => {
                        showPrivacyReminder();
                    }, 1000);
                }
            }

            // Event listeners for privacy links
            document.addEventListener('click', function (e) {
                if (e.target && (e.target.id === 'privacy-link-top' || e.target.id === 'privacy-link-chat' || e.target.classList.contains('privacy-link'))) {
                    e.preventDefault();
                    showPrivacyModal();
                }
            });

            // Close privacy modal
            privacyModalClose.addEventListener('click', hidePrivacyModal);
            privacyModal.addEventListener('click', function (e) {
                if (e.target === privacyModal) {
                    hidePrivacyModal();
                }
            });

            // Privacy reminder - Read button
            privacyReadBtn.addEventListener('click', function () {
                hidePrivacyReminder();
                showPrivacyModal();
                if (dontShowAgainCheckbox.checked) {
                    localStorage.setItem('privacyReminderSeen', 'true');
                }
            });

            // Privacy reminder - Continue button
            privacyContinueBtn.addEventListener('click', function () {
                if (dontShowAgainCheckbox.checked) {
                    localStorage.setItem('privacyReminderSeen', 'true');
                }
                hidePrivacyReminder();
            });

            // Check and show privacy reminder on page load
            window.addEventListener('load', checkPrivacyReminder);

            // Listen for language changes
            window.addEventListener('languageChanged', updatePrivacyModalContent);
        })();
    </script>
</body>

</html>
